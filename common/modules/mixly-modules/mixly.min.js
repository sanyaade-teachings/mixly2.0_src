function toByteArray(t){var o=[];for(let e=0;e<t.length;e++){var r=t.charCodeAt(e);r<=255&&o.push(r)}return o}function fromByteArray(e){return String.fromCharCode.apply(String,e)}function crc32(t,e=0){t instanceof Array&&(t=fromByteArray(t));var o=[];for(let t,e=0;e<256;e++){t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;o[e]=t}let r=-1-e;for(let e=0;e<t.length;e++)r=r>>>8^o[255&(r^t.charCodeAt(e))];return(-1^r)>>>0}function zipLongest(){var o=[].slice.call(arguments);return o.reduce(function(e,t){return e.length>t.length?e:t},[]).map(function(e,t){return o.map(function(e){return e[t]})})}goog.loadJs("common",()=>{"use strict";goog.require("microbitFs"),goog.provide("fsWrapper");var l=null,i=["create","exists","getStorageRemaining","getStorageSize","getStorageUsed","getUniversalHex","ls","read","readBytes","remove","size","write"];fsWrapper.setupFilesystem=function(){var t=null,o=null,e=$.get("../common/micropython/microbit-micropython-v1.hex",function(e){t=e}).fail(function(){console.error("Could not load the MicroPython v1 file.")}),r=$.get("../common/micropython/microbit-micropython-v2.hex",function(e){o=e}).fail(function(){console.error("Could not load the MicroPython v2 file.")});return $.when(e,r).done(function(){t&&o||console.error("There was an issue loading the MicroPython Hex files."),l=new microbitFs.MicropythonFsHex([{hex:t,boardId:39169},{hex:o,boardId:39171}],{maxFsSize:20480}),i.forEach(function(e){fsWrapper[e]=function(){return l[e].apply(l,arguments)}})})},fsWrapper.getBytesForBoardId=function(e){if("9900"==e||"9901"==e)return l.getIntelHexBytes(39169);if("9903"==e||"9904"==e)return l.getIntelHexBytes(39171);throw Error("Could not recognise the Board ID "+e)},fsWrapper.getIntelHexForBoardId=function(e){if("9900"==e||"9901"==e)var t=l.getIntelHex(39169);else{if("9903"!=e&&"9904"!=e)throw Error("Could not recognise the Board ID "+e);t=l.getIntelHex(39171)}for(var o=new Uint8Array(t.length),r=0,i=t.length;r<i;r++)o[r]=t.charCodeAt(r);return o.buffer},fsWrapper.importHexFiles=function(e){e=l.importFilesFromHex(e,{overwrite:!0,formatFirst:!0});if(e.length)return e;throw new Error("The filesystem in the hex file was empty")},fsWrapper.importHexAppended=function(e){e=microbitFs.getIntelHexAppendedScript(e);if(e)return l.ls().forEach(function(e){l.remove(e)}),l.write("main.py",e),["main.py"];throw new Error("No appended code found in the hex file")}}),goog.loadJs("common",()=>{goog.provide("Mixly")}),goog.loadJs("common",()=>{goog.require("Mixly"),goog.provide("Mixly.MJSON");const a=Mixly["MJSON"];a.operate=(e,t)=>{for(var o in e){var r=e[o];if(0<r.length&&"object"==typeof r||"object"==typeof r){var i,l=a.operate(r,t);for(i in l)e[o][i]=l[i]}else if("string"==typeof r)try{e[o]=t(e[o])}catch(e){}}return e},a.decode=e=>{var t={};return $.extend(!0,t,e),a.operate(t,decodeURIComponent)},a.encode=e=>{var t={};return $.extend(!0,t,e),a.operate(t,encodeURIComponent)},a.parse=e=>{let t=null;try{t=JSON.parse(e)}catch(e){console.log(e)}return t},a.stringify=e=>{let t="";try{t=JSON.stringify(e)}catch(e){console.log(e)}return t},a.get=e=>goog.getJSON(e)}),goog.loadJs("common",()=>{goog.require("Mixly"),goog.provide("Mixly.MString");var e=Mixly["MString"];e.tpl=(e,t)=>{if("string"==typeof e&&t instanceof Object)for(var o in t){var r=new RegExp("{[s]*"+o+"[s]*}","gim");e=e.replace(r,t[o])}return e}}),goog.loadJs("common",()=>{goog.require("PouchDB"),goog.require("Mixly"),goog.provide("Mixly.Storage")}),goog.loadJs("common",()=>{goog.require("Mixly"),goog.provide("Mixly.Url");const{Url}=Mixly;Url.urlToJson=e=>{function a(e,t,o){var r;if(-1!==t.indexOf("."))r=t.substring(0,t.indexOf(".")),t=t.substring(t.indexOf(".")+1,t.length),void 0===e[r]&&(e[r]={}),e[r]=a(e[r],t,o);else{var i=decodeURIComponent(o),l=decodeURIComponent(t);if(isNaN(i))switch(i.toLowerCase()){case"true":e[l]=!0;break;case"false":e[l]=!1;break;case"undefined":e[l]=void 0;break;case"null":e[l]=null;break;default:e[l]=i}else e[l]=+i}return e}for(var t,o={},r=e.slice(e.indexOf("?")+1).split("&"),i=0;i<r.length;i++){t=r[i].split("=");try{o=a(o,t[0].replaceAll("@","=").replaceAll("$","&"),t[1].replaceAll("@","=").replaceAll("$","&"))}catch(e){o=a(o,t[0],t[1])}}return o},Url.jsonToUrl=(t,o=null)=>{var r="";if(t instanceof String||t instanceof Number||t instanceof Boolean)try{var e=(e=o.toString().replaceAll("=","@")).replaceAll("&","$"),i=(i=t.toString().replaceAll("=","@")).replaceAll("&","$");r+="&"+e+"="+encodeURIComponent(i)}catch(e){r+="&"+o+"="+encodeURIComponent(t)}else $.each(t,function(e){e=null==o?e:o+(t instanceof Array?"["+e+"]":"."+e);r+="&"+Url.jsonToUrl(this,e)});return r.substr(1)},Url.getConfig=()=>{var t="";try{t=window.location.href.replaceAll("#","")}catch(e){t=window.location.href}t=t.substring(t.indexOf("?")+1,t.length);return Url.urlToJson(t)},Url.changeURLArg=(url,arg,argVal)=>{var pattern=arg+"=([^&]*)",replaceText=arg+"="+argVal,tmp,tmp;return url.match(pattern)?(tmp="/("+arg+"=)([^&]*)/gi",tmp=url.replace(eval(tmp),replaceText),tmp):url.match("[?]")?url+"&"+replaceText:url+"?"+replaceText},Url.CRC32=(e,t=10)=>{var o=function(){let t;var o=[];for(let e=0;e<256;e++){t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;o[e]=t}return o}(),r=function(t){t=t.replace(/\r\n/g,"\n");let o="";for(let e=0;e<t.length;e++){var r=t.charCodeAt(e);r<128?o+=String.fromCharCode(r):o=127<r&&r<2048?(o+=String.fromCharCode(r>>6|192))+String.fromCharCode(63&r|128):(o=(o+=String.fromCharCode(r>>12|224))+String.fromCharCode(r>>6&63|128))+String.fromCharCode(63&r|128)}return o}(e);let i=-1;for(let e=0;e<r.length;e++)i=i>>>8^o[255&(i^r.charCodeAt(e))];return(i=(-1^i)>>>0).toString(t)},Url.initFingerprintJS=()=>{FingerprintJS.load().then(e=>e.get()).then(e=>{var e=e.visitorId,t=parseInt(e,16).toString(32);Config.BOARD.visitorId={str16:e,str32:t,str16CRC32b:Url.CRC32(e,16),str32CRC32b:Url.CRC32(t,16)},console.log(Config.BOARD)}).catch(e=>{console.error(e),console.log(Config.BOARD)})},Url.getIPAddress=()=>{var e=window.location.host.match(/[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/g);return e&&0<e.length?e[0]:null}}),goog.provide("Mixly.Web.Utilities");class struct{static lut={b:{u:DataView.prototype.getInt8,p:DataView.prototype.setInt8,bytes:1},B:{u:DataView.prototype.getUint8,p:DataView.prototype.setUint8,bytes:1},h:{u:DataView.prototype.getInt16,p:DataView.prototype.setInt16,bytes:2},H:{u:DataView.prototype.getUint16,p:DataView.prototype.setUint16,bytes:2},i:{u:DataView.prototype.getInt32,p:DataView.prototype.setInt32,bytes:4},I:{u:DataView.prototype.getUint32,p:DataView.prototype.setUint32,bytes:4},q:{u:DataView.prototype.getInt64,p:DataView.prototype.setInt64,bytes:8},Q:{u:DataView.prototype.getUint64,p:DataView.prototype.setUint64,bytes:8}};static pack(...e){var t=e[0];let o=0;var r=e.slice(1);if(t.replace(/[<>]/,"").length!=r.length)throw"Pack format to Argument count mismatch";let i=[],l=!0;for(let e=0;e<t.length;e++)if("<"==t[e])l=!0;else if(">"==t[e])l=!1;else{c=s=n=a=void 0;var a=t[e],n=r[o];if(!(a in struct.lut))throw"Unhandled character '"+a+"' in pack format";var s=struct.lut[a].bytes,c=new DataView(new ArrayBuffer(s));(a=struct.lut[a].p.bind(c))(0,n,l);for(let e=0;e<s;e++)i.push(c.getUint8(e));o++}return i}static unpack(e,t){let o=0,r=[],i=!0;for(var l of e)if("<"==l)i=!0;else if(">"==l)i=!1;else{s=n=a=void 0;var a=l;if(!(a in struct.lut))throw"Unhandled character '"+a+"' in unpack format";var n=struct.lut[a].bytes,s=new DataView(new ArrayBuffer(n));for(let e=0;e<n;e++)s.setUint8(e,255&t[o+e]);a=struct.lut[a].u.bind(s),r.push(a(0,i)),o+=n}return r}static calcsize(t){let o=0;for(let e=0;e<t.length;e++)"<"!=t[e]&&">"!=t[e]&&(o+=struct.lut[t[e]].bytes);return o}}function*makeFileIterator(e){for(var t of e.split(/\r?\n/))yield t.trim();return""}goog.loadJs("web",()=>{goog.require("Mixly"),goog.provide("Mixly.Web")}),goog.loadJs("web",()=>{goog.require("Mixly"),goog.provide("Mixly.WebCompiler")}),goog.loadJs("web",()=>{goog.require("Mixly"),goog.provide("Mixly.WebSocket")}),goog.loadJs("common",()=>{goog.require("Mixly.Url"),goog.provide("Mixly.Config");const{Config:n,Url:s}=Mixly,c=(n.SELECTED_BOARD={},n.BOARD={},{thirdPartyBoard:!(n.SOFTWARE={})}),d={burn:"None",upload:"None",nav:"None",serial:"None",saveMixWithCode:!0},g={version:"Mixly2.0"};n.init=()=>{var e,t,o,r,i,l={...c,...s.getConfig()},a=(n.BOARD=goog.getJSON("./config.json",d),"object"==typeof l&&({thirdPartyBoard:a,boardImg:e,boardIndex:t,boardType:o,boardName:r,filePath:i}=l,a=a??!1,n.BOARD={...n.BOARD,thirdPartyBoard:a,boardImg:e,boardIndex:t,boardType:o,boardName:r,filePath:i},delete l.thirdPartyBoard,delete l.boardImg,delete l.boardIndex,delete l.boardType,delete l.boardName,delete l.filePath),console.log("Config.BOARD:",n.BOARD),"../../../");n.SOFTWARE=goog.getJSON(a+"sw-config.json",g),"object"==typeof l&&(n.SOFTWARE={...n.SOFTWARE,...l}),n.pathPrefix=a,console.log("Config.SOFTWARE:",n.SOFTWARE),$.getScript("../../../common/modules/web-modules/fp.min.js",()=>{}).fail(()=>{})},n.init(),n.USER={theme:"light",language:"zh-hans",winSize:1,blockRenderer:"geras",compileCAndH:"true"}}),goog.loadJs("common",()=>{goog.require("Mixly.Config"),goog.provide("Mixly.Env");var{Env:e,Config:t}=Mixly,t=t["SOFTWARE"];e.isElectron=!0,e.hasSocketServer=!!t?.webSocket?.enabled,e.hasCompiler=!!t?.webCompiler?.enabled,e.clientPath=null,e.currentPlatform=null,e.python3Path=null,e.pyFilePath=null,e.indexDirPath=null,e.srcDirPath=null,e.winSize=null,e.defaultXML=null,e.thirdPartyCSS=[],e.thirdPartyJS=[],e.templatePath=goog.normalizePath_(goog.basePath+"../template/"),e.msgPath=goog.normalizePath_(goog.basePath+"../msg/"),e.isElectron=!!window?.process?.versions?.electron,e.isElectron&&(e.indexDirPath=__dirname)}),goog.loadJs("common",()=>{goog.require("tippy"),goog.require("Mixly"),goog.provide("Mixly.FooterLayer");const o={allowHTML:!0,trigger:"manual",interactive:!0,hideOnClick:!1,maxWidth:"none",offset:[0,6]};Mixly.FooterLayer=class{constructor(e,t){this.config={...o,...t??{}},this.domId=e,this.layer=null,this.createLayer(),this.addSharedMethod(),this.addContainerOnclickEvent()}createLayer(){const{onShown:t,onAfterUpdate:o}=this.config;this.layer=tippy("#"+this.domId,{...this.config})[0],this.layer.props.onShown=e=>{"function"==typeof t&&t(e),this.addCloseBtnOnclickEvent(e)},this.layer.props.onAfterUpdate=e=>{this.layer.props.onShown(e),"function"==typeof o&&o(e)}}addCloseBtnOnclickEvent(e){$(e.popper).find(".footer-layer-close").off().click(()=>{e.hide()})}addSharedMethod(){var e;for(e of["hide","show","destroy","setProps","setContent"])this[e]=this.layer[e]}addContainerOnclickEvent(){$("#"+this.domId).off().click(()=>{this.layer.state.isShown?this.hide():this.show()})}}}),goog.provide("Mixly.JSFuncs"),goog.require("Mixly.Config"),Mixly.JSFuncs.getPlatform=function(){return Mixly.Config.BOARD.boardType},goog.loadJs("common",()=>{goog.require("Mixly"),goog.provide("Mixly.LocalStorage");const i=Mixly["LocalStorage"],o=window["localStorage"];i.write=(e,t)=>{o&&(o[e]=t)},i.read=e=>o&&o[e]?o[e]:"",i.writeJson=(e,t,o=!0)=>{o||(t={...t,...i.readJson(e)});try{var r=JSON.stringify(t);i.write(e,r)}catch(e){console.log(e)}},i.readJson=e=>{e=i.read(e);try{return JSON.parse(e)}catch(e){return console.log(e),null}}}),goog.loadJs("common",()=>{goog.require("Mixly"),goog.provide("Mixly.MArray");const r=Mixly["MArray"];r.equals=(e,t)=>{if(e!==t){if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var o in e)if(e.hasOwnProperty(o)){if(!t.hasOwnProperty(o))return!1;if(e[o]!==t[o]){if("object"!=typeof e[o])return!1;if(!r.equals(e[o],t[o]))return!1}}for(o in t)if(t.hasOwnProperty(o)&&!e.hasOwnProperty(o))return!1}return!0},r.remove=(e,t)=>{t=e.indexOf(t);return e.splice(t,1),e},r.unique=e=>Array.from(new Set(e))}),goog.loadJs("common",()=>{goog.require("Mixly.Env"),goog.provide("Mixly.Modules");const{Env:e,Modules:t}=Mixly;var o,r,i;e.isElectron&&(t.path=require("path"),t.child_process=require("child_process"),t.fs=require("fs"),t.fs_extra=require("fs-extra"),t.fs_extend=require("../../../common/modules/node-modules/fsExtend.js"),t.compressing=require("compressing"),t.json2md=require("json2md"),t.electron=require("electron"),t.chokidar=require("chokidar"),t.clipboard=t.electron.clipboard,t.electron_localshortcut=require("electron-localshortcut"),t.os=require("os"),t.electron_remote=require("@electron/remote"),o=t.electron_remote,{path:o,fs_extend:r,app:i}=(t.app=o.app,t.currentWebContents=o.getCurrentWebContents(),t.currentWindow=o.getCurrentWindow(),t.lodash_fp=require("lodash/fp"),t.node_downloader_helper=require("node-downloader-helper"),e.currentPlatform=t.os.platform(),t),"darwin"===e.currentPlatform?e.clientPath=o.resolve(i.getPath("exe"),"../../../../"):e.clientPath=o.resolve(i.getPath("exe"),"../"),e.pyFilePath=o.resolve(e.clientPath,"mixpyBuild/mixly.py"),"win32"===e.currentPlatform?e.python3Path=o.resolve(e.clientPath,"mixpyBuild/win_python3/python3.exe"):(e.python3Path="/usr/bin/python3",r.isfile("/usr/local/bin/python3")&&(e.python3Path="/usr/local/bin/python3")),e.srcPath=o.resolve(e.indexDirPath,"../"))}),goog.loadJs("common",()=>{goog.require("Mixly.MJSON"),goog.require("Mixly.Config"),goog.require("Mixly.Env"),goog.require("Blockly"),goog.require("Blockly.Lang.ZhHans"),goog.require("Blockly.Lang.ZhHant"),goog.require("Blockly.Lang.En"),goog.provide("Mixly.Msg");const{Msg:t,MJSON:e,Config:o,Env:r}=Mixly;var i=o["USER"];const{ZhHans:l,ZhHant:a,En:n}=Blockly.Lang;t.PATH={"zh-hans":r.msgPath+"./mixly/zh-hans.json","zh-hant":r.msgPath+"./mixly/zh-hant.json",en:r.msgPath+"./mixly/en.json"},t.LANG={"zh-hans":e.get(t.PATH["zh-hans"]),"zh-hant":e.get(t.PATH["zh-hant"]),en:e.get(t.PATH.en)},t.nowLang=i.language??"zh-hans",t.getLang=e=>t.LANG[t.nowLang][e],t.changeTo=e=>{switch(Mixly.Msg.Lang=t.LANG[e??"zh-hans"],e){case"zh-hant":Blockly.Msg=a;break;case"en":Blockly.Msg=n;break;default:Blockly.Msg=l}},t.changeTo(t.nowLang),console.log("Msg.LANG",t.LANG)}),goog.provide("Mixly.ScriptLoader"),goog.require("Mixly.Env"),goog.require("Mixly.Config"),Mixly.ScriptLoader.loadScript=function(e){for(var t,o=!0,r=document.getElementsByTagName("script"),i=0;i<r.length;i++)r[i]&&r[i].src&&-1!=r[i].src.indexOf(e)&&(o=!1);o&&((t=document.createElement("script")).setAttribute("type","text/javascript"),t.setAttribute("src",e),document.getElementsByTagName("head").item(0).appendChild(t))},Mixly.ScriptLoader.removeScript=function(e){var t=document.getElementsByTagName("script");-1!==e.indexOf("../")&&(e=e.substring(e.lastIndexOf("../")+3,e.length));for(var o=0;o<t.length;o++)t[o]&&t[o].src&&-1!=t[o].src.indexOf(e)&&t[o].parentNode.removeChild(t[o])},Mixly.ScriptLoader.loadLangJs=function(t,o,e){var r,i=document.querySelectorAll("script"),l=[];for(let e=0;e<i.length;e++)i[e]&&i[e].src&&-1!=i[e].src.indexOf(t+".js")&&(r=i[e].src.replace(t+".js",o+".js"),i[e].parentNode.removeChild(i[e]),l.push(r));for(let e=0;e<Mixly.Env.thirdPartyJS.length;e++)Mixly.Env.thirdPartyJS[e]=Mixly.Env.thirdPartyJS[e].replace(t+".js",o+".js");LazyLoad.js(l,function(){e()})},Mixly.ScriptLoader.commonJs=[],Mixly.ScriptLoader.clientJs=[],Mixly.ScriptLoader.webJs=[],Mixly.ScriptLoader.load=function(){var o=Mixly.Config.pathPrefix;function e(t){for(let e=0;e<t.length;e++)Mixly.ScriptLoader.loadScript(o+t[e])}Mixly.Env.isElectron?e(Mixly.ScriptLoader.clientJs):e(Mixly.ScriptLoader.webJs)};class Regression{constructor(){this.x=[],this.y=[],this.n=0,this.beta=1,this.alpha=0}fit(e,t){this.x=e,this.y=t,this.n=e.length,this.beta=this.getBeta(),this.alpha=this.getAlpha(this.beta)}predict(e){var t=[];for(const o of e=Array.isArray(e)?e:[e])t.push(this.alpha+o*this.beta);return t}getBeta(){return(this.sum(this.x,(e,t)=>e*this.y[t])*this.n-this.sum(this.x)*this.sum(this.y))/(this.sum(this.x,e=>e*e)*this.n-Math.pow(this.sum(this.x),2))}getAlpha(e){return this.avg(this.y)-this.avg(this.x)*e}sum(t,e=(e,t)=>e){let o=0;var r=e;for(let e=0;e<t.length;e++){var i=t[e];o+=r(i,e)}return o}avg(e){return this.sum(e)/e.length}}const regression=new Regression;function resetOptions(){var e,t=Mixly.Modules.highcharts.getOptions();for(e in t)"function"!=typeof t[e]&&delete t[e];Mixly.Modules.highcharts.setOptions(Mixly.Charts.lightTheme)}function getCol(e,t){for(var o=[],r=0;r<e.length;r++)o[r]=e[r][t];return o}function reverseMatrix(e){for(var t=[],o=0;o<e[0].length;o++){t[o]=[];for(var r=0;r<e.length;r++)t[o][r]=e[r][o]}return t}function getNumber(e){var t=e.match(/-?([0-9]\d*(\.\d*)*(\e\+[0-9]*)*|0\.[0-9]\d*)/g),o=[];if(t)for(var r=0;r<t.length;r++)o.push(parseFloat(t[r]));return o}goog.require("Highcharts"),goog.require("Mixly.Env"),goog.require("Mixly.Modules"),goog.require("Mixly.Config"),goog.require("Mixly.Msg"),goog.provide("Mixly.Charts"),Mixly.Modules.highcharts=Highcharts,Mixly.Charts.startTime=0,Mixly.Charts.oldTime=0,Mixly.Charts.nowTime=0,Mixly.Charts.pointNum=100,Mixly.Charts.xData=[],Mixly.Charts.yData=[],Mixly.Charts.data=[],Mixly.Charts.darkTheme={colors:"#2b908f #90ee7e #f45b5b #7798BF #aaeeee #ff0066 #eeaaee #55BF3B #DF5353 #7798BF #aaeeee".split(" "),chart:{backgroundColor:{linearGradient:{x1:0,y1:0,x2:1,y2:1},stops:[[0,"#2a2a2b"],[1,"#3e3e40"]]},style:{fontFamily:"'Unica One', sans-serif"},plotBorderColor:"#606063"},title:{style:{color:"#E0E0E3",textTransform:"uppercase",fontSize:"20px"}},subtitle:{style:{color:"#E0E0E3",textTransform:"uppercase"}},xAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",title:{style:{color:"#A0A0A3"}}},yAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",tickWidth:1,title:{style:{color:"#A0A0A3"}}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",style:{color:"#F0F0F0"}},plotOptions:{series:{dataLabels:{color:"#F0F0F3",style:{fontSize:"13px"}},marker:{lineColor:"#333"}},boxplot:{fillColor:"#505053"},candlestick:{lineColor:"white"},errorbar:{color:"white"}},legend:{backgroundColor:"rgba(0, 0, 0, 0.5)",itemStyle:{color:"#E0E0E3"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#606063"},title:{style:{color:"#C0C0C0"}}},credits:{style:{color:"#666"}},labels:{style:{color:"#707073"}},drilldown:{activeAxisLabelStyle:{color:"#F0F0F3"},activeDataLabelStyle:{color:"#F0F0F3"}},navigation:{buttonOptions:{symbolStroke:"#DDDDDD",theme:{fill:"#505053"}}},rangeSelector:{buttonTheme:{fill:"#505053",stroke:"#000000",style:{color:"#CCC"},states:{hover:{fill:"#707073",stroke:"#000000",style:{color:"white"}},select:{fill:"#000003",stroke:"#000000",style:{color:"white"}}}},inputBoxBorderColor:"#505053",inputStyle:{backgroundColor:"#333",color:"silver"},labelStyle:{color:"silver"}},navigator:{handles:{backgroundColor:"#666",borderColor:"#AAA"},outlineColor:"#CCC",maskFill:"rgba(255,255,255,0.1)",series:{color:"#7798BF",lineColor:"#A6C7ED"},xAxis:{gridLineColor:"#505053"}},scrollbar:{barBackgroundColor:"#808083",barBorderColor:"#808083",buttonArrowColor:"#CCC",buttonBackgroundColor:"#606063",buttonBorderColor:"#606063",rifleColor:"#FFF",trackBackgroundColor:"#404043",trackBorderColor:"#404043"}},Mixly.Charts.lightTheme={colors:"#7cb5ec #f7a35c #90ee7e #7798BF #aaeeee #ff0066 #eeaaee #55BF3B #DF5353 #7798BF #aaeeee".split(" "),chart:{backgroundColor:null,style:{fontFamily:"Dosis, sans-serif"}},title:{style:{fontSize:"16px",fontWeight:"bold",textTransform:"uppercase"}},tooltip:{borderWidth:0,backgroundColor:"rgba(219,219,216,0.8)",shadow:!1},legend:{backgroundColor:"#F0F0EA",itemStyle:{fontWeight:"bold",fontSize:"13px"}},xAxis:{gridLineWidth:1,labels:{style:{fontSize:"12px"}}},yAxis:{minorTickInterval:"auto",title:{style:{textTransform:"uppercase"}},labels:{style:{fontSize:"12px"}}},plotOptions:{candlestick:{lineColor:"#404048"}}},Mixly.Modules.highcharts.setOptions(Mixly.Charts.lightTheme),Mixly.Charts.lightTheme=$.extend(!0,{},Mixly.Modules.highcharts.getOptions(),{}),Mixly.Charts.chart=null,Mixly.Charts.draw=null,Mixly.Charts.addData=null,Mixly.Charts.init=function(e,t){var o=Mixly.Config["USER"],{dataDrawId:o,yMinId:r,yMaxId:i}=("dark"===o.theme?Mixly.Modules.highcharts.setOptions(Mixly.Charts.darkTheme):resetOptions(),Mixly.Charts.startTime=Number(new Date),Mixly.Charts.nowTime=Mixly.Charts.startTime,Mixly.Charts.oldTime=Mixly.Charts.nowTime,Mixly.Charts.xData=[],Mixly.Charts.yData=[],Mixly.Charts.data=[],t.id),r=$("#"+r),i=$("#"+i);Mixly.Charts.chart=Mixly.Modules.highcharts.chart(o,{chart:{type:"line"},title:{text:Mixly.Msg.Lang["串口数据"]},credits:{enabled:!1},xAxis:{title:{enabled:!0,text:Mixly.Msg.Lang["时间/ms"]},lineWidth:2},yAxis:{title:{text:Mixly.Msg.Lang["串口数据"]},endOnTick:!0,lineWidth:2},series:[{name:Mixly.Msg.Lang["串口数据"]+"1",data:[]}]}),i.val()&&r.val()&&void 0!==Mixly.Charts?.chart?.yAxis&&(o=i.val()||100,i=r.val()||0,Mixly.Charts.chart.yAxis[0].setExtremes(i,o)),e&&(Mixly.Charts.draw=window.setInterval(()=>{Mixly.Charts.drawLines(t)},100))},Mixly.Charts.drawLines=function(e){var{yMinId:t,yMaxId:o}=e.id,t=$("#"+t),o=$("#"+o),t=(o.val()&&t.val()&&void 0!==Mixly.Charts?.chart?.yAxis&&(o=o.val()||100,t=t.val()||0,Mixly.Charts.chart.yAxis[0].setExtremes(t,o)),0),o=(t=0<Mixly.Charts.data.length&&0<Mixly.Charts.data[0].length?Mixly.Charts.data[0][0]:t)+100,r=(0<Mixly.Charts.data.length&&Mixly.Charts.data.length<Mixly.Charts.pointNum?(regression.fit(Mixly.Charts.xData,Mixly.Charts.yData),o=regression.predict([Mixly.Charts.pointNum]),0<Mixly.Charts.data.length&&o<Mixly.Charts.data[Mixly.Charts.data.length-1][0]&&(o=Mixly.Charts.data[Mixly.Charts.data.length-1][0]),Mixly.Charts.chart.xAxis[0].setExtremes(t,o)):Mixly.Charts.data.length>=Mixly.Charts.pointNum&&(o=Mixly.Charts.data[Mixly.Charts.pointNum-1][0],Mixly.Charts.chart.xAxis[0].setExtremes(t,o)),[]);r[0]=getCol(Mixly.Charts.data,0);for(var i=0;i<Mixly.Charts.chart.series.length;i++)r[1]=getCol(Mixly.Charts.data,i+1),Mixly.Charts.chart.series[i].setData(reverseMatrix(r),!0,!1,!1);Mixly.Charts.update(e)},Mixly.Charts.addData=function(e){var t=Number(new Date),o=getNumber(e);if(50<t-Mixly.Charts.nowTime&&o&&0<o.length){Mixly.Charts.oldTime=Mixly.Charts.nowTime,Mixly.Charts.nowTime=t;for(var r=[Mixly.Charts.nowTime-Mixly.Charts.startTime,o[0]],i=1;i<o.length;i++)r.push(o[i]);for(;Mixly.Charts.data.length>Mixly.Charts.pointNum;)Mixly.Charts.data.shift();for(Mixly.Charts.data.length<Mixly.Charts.pointNum&&(Mixly.Charts.xData.push(Mixly.Charts.data.length),Mixly.Charts.yData.push(Mixly.Charts.nowTime-Mixly.Charts.startTime)),Mixly.Charts.data.push(r);Mixly.Charts.chart&&Mixly.Charts.chart.series&&Mixly.Charts.chart.series.length<o.length;)Mixly.Charts.chart.addSeries({name:Mixly.Msg.Lang["串口数据"]+(Mixly.Charts.chart.series.length+1),data:[]})}},Mixly.Charts.update=function(e){var t=e.id["pointNumId"];if(+$("#"+t+" option:selected").val()!=Mixly.Charts.pointNum){try{Mixly.Charts.chart.destroy()}catch(e){console.log(e)}Mixly.Charts.pointNum=+$("#"+t+" option:selected").val(),Mixly.Charts.draw&&(clearInterval(Mixly.Charts.draw),Mixly.Charts.init(!0,e))}},Mixly.Charts.destroy=()=>{try{Mixly.Charts.chart&&Mixly.Charts.chart.destroy(),Mixly.Charts.chart=null}catch(e){console.log(e)}Mixly.Charts.stopRefresh()},Mixly.Charts.stopRefresh=()=>{Mixly.Charts.draw&&clearInterval(Mixly.Charts.draw),Mixly.Charts.addData&&clearInterval(Mixly.Charts.addData)},goog.loadJs("common",()=>{goog.provide("Mixly.Title"),goog.require("Mixly.Config");let{Config:e,Title:o}=Mixly;var{BOARD:t,SOFTWARE:r}=e;r?.version&&t?.boardType?(o.title=r.version+" For "+t.boardType,document.title=o.title):o.title=document.title,o.NOWTITLE=o.title,o.updeteVersionNumber=e=>{try{o.NOWTITLE=document.title.replace(/Mixly[\s]?[\d.]+/g,"Mixly "+e),document.title=o.NOWTITLE}catch(e){console.log(e)}},o.getVersionNumber=()=>{try{return o.NOWTITLE=document.title.match(/Mixly[\s]?[\d.]+/g),o.NOWTITLE}catch(e){return console.log(e),""}},o.updeteFilePath=function(e){try{var t=o.NOWTITLE.match(/\([^\n\r]+\)/g);o.NOWTITLE=t?document.title.replace(/\([^\n\r]+\)/g,"("+e+")"):document.title+" ("+e+")",document.title=o.NOWTITLE}catch(e){console.log(e)}},o.getFilePath=()=>{try{var e=document.title.match(/(?<=\()[^\n\r]+(?=\))/g);if(e&&0<e.length)return e[0]}catch(e){console.log(e)}return null},o.updateTitle=e=>{o.NOWTITLE=e,document.title=e}}),goog.provide("Mixly.Tools"),goog.require("Mixly.Config"),Mixly.Tools.messageDecode=t=>{if(t)try{let e=decodeURIComponent(t.replace(/_([0-9a-fA-F]{2})/gm,"%$1"));return e=unescape(e.replace(/\\(u[0-9a-fA-F]{4})/gm,"%$1"))}catch(e){}return t},Mixly.Tools.strToByte=e=>{for(var t,o=e.length,r=[],i=0;i<o;i++)65536<=(t=e.charCodeAt(i))&&t<=1114111?(r.push(t>>18&7|240),r.push(t>>12&63|128),r.push(t>>6&63|128),r.push(63&t|128)):2048<=t&&t<=65535?(r.push(t>>12&15|224),r.push(t>>6&63|128),r.push(63&t|128)):128<=t&&t<=2047?(r.push(t>>6&31|192),r.push(63&t|128)):r.push(255&t);return new Int8Array(r)},Mixly.Tools.uint8ArrayToStr=e=>{for(var t="",o=0;o<e.length;o++)var r=e[o].toString(16),t=t+" "+(r=r.length%2==1?"0"+r:r).toUpperCase();return t},goog.loadJs("electron",()=>{goog.require("Mixly.Url"),goog.require("Mixly.Modules"),goog.provide("Mixly.Electron");const{Modules:e,Env:r,Electron:t}=Mixly,{electron_remote:o,path:i}=e,{Menu:l,BrowserWindow:a}=o;t.newBrowserWindow=(e,t={})=>{l.setApplicationMenu(null);const o=new a({show:!1,minHeight:400,minWidth:700,width:0,height:0,icon:i.resolve(r.indexDirPath,"../../../files/mixly.ico"),webPreferences:{nodeIntegration:!0,enableRemoteModule:!0,contextIsolation:!1,spellcheck:!1},...t.window??{}});return o.loadFile(e),o.once("ready-to-show",()=>{o.maximize(),o.show()}),o}}),goog.loadJs("web",()=>{goog.require("Mixly.Web"),goog.provide("Mixly.Web.Bluetooth");var e=Mixly["Web"];const l=e["Bluetooth"];l.output=[],l.mtu=100,l.encoder=new TextEncoder("utf-8"),l.decoder=new TextDecoder("utf-8"),l.nordicUartServiceUuid=65520,l.uartRxCharacteristicUuid=65522,l.uartTxCharacteristicUuid=65521,l.obj=null,l.server=null,l.service=null,l.uartRxCharacteristic=null,l.uartTxCharacteristic=null,l.connect=(e=0,o=e=>{})=>new Promise((e,t)=>{l.isConnected()?e():navigator.bluetooth.requestDevice({optionalServices:[l.nordicUartServiceUuid],acceptAllDevices:!0}).then(e=>(l.obj=e).gatt.connect()).then(e=>(l.server=e).getPrimaryService(l.nordicUartServiceUuid)).then(e=>(l.service=e).getCharacteristic(l.uartRxCharacteristicUuid)).then(e=>(l.uartRxCharacteristic=e,l.service.getCharacteristic(l.uartTxCharacteristicUuid))).then(e=>(l.uartTxCharacteristic=e).startNotifications()).then(()=>{l.onDataLine=o,l.addReadEvent(o),e()}).catch(e=>{l.obj=null,l.server=null,l.service=null,l.uartRxCharacteristic=null,l.uartTxCharacteristic=null,t(e)})}),l.close=async()=>{l.isConnected()&&(await l.obj.gatt.disconnect(),l.obj=null,l.server=null,l.service=null,l.uartRxCharacteristic=null,l.uartTxCharacteristic=null)},l.isConnected=()=>l.obj&&l.obj.gatt.connected,l.addReadEvent=(i=e=>{})=>{l.uartTxCharacteristic.addEventListener("characteristicvaluechanged",t=>{var o=l.decoder.decode(t.target.value).split("\n");if(o.length){var r;l.output.length&&(t=l.output.pop(),l.output.push(t+o.shift()),o.length)&&i(l.output[l.output.length-1]);let e=0;for(r of o)e++,l.output.push(r),e<o.length&&i(r);for(;500<l.output.length;)l.output.shift()}})},l.AddOnConnectEvent=e=>{},l.AddOnDisconnectEvent=e=>{l.obj.addEventListener("gattserverdisconnected",()=>{e()})},l.writeString=async e=>{e=l.encoder.encode(e);await l.writeByteArr(e)},l.writeByteArr=async t=>{t=new Uint8Array(t);for(let e=0;e<Math.ceil(t.length/l.mtu);e++){var o=l.mtu*e,r=l.mtu*(e+1);await l.uartRxCharacteristic.writeValueWithResponse(t.slice(o,r)).catch(e=>{if("NetworkError: GATT operation already in progress."!=e)return Promise.reject(e);l.writeByteArr(t)})}await l.sleep(200)},l.writeCtrlA=async()=>{await l.writeByteArr([1,13,10])},l.writeCtrlB=async()=>{await l.writeByteArr([2,13,10])},l.writeCtrlC=async()=>{await l.writeByteArr([3,13,10])},l.writeCtrlD=async()=>{await l.writeByteArr([3,4])},l.write=async(e,t,o)=>"string"!==e?(await l.writeByteArr(t),l.writeString(o)):l.writeString(t+o),l.setSignals=async(e,t)=>{},l.setBaudRate=async e=>{},l.sleep=t=>new Promise(e=>setTimeout(e,t))}),goog.loadJs("web",()=>{goog.require("Mixly.Web"),goog.provide("Mixly.Web.SerialPort");var e=Mixly["Web"];const a=e["SerialPort"];a.output=[],a.inputBuffer=[],a.outputBuffer=[],a.refreshInputBuffer=!1,a.refreshOutputBuffer=!0,a.obj=null,a.onDataLine=null,a.encoder=new TextEncoder("utf8"),a.decoder=new TextDecoder("utf8"),a.dtr=!1,a.rts=!1,a.connect=(o=115200,r=e=>{})=>new Promise((e,t)=>{a.isConnected()?e():navigator.serial.requestPort().then(e=>(a.obj=e).open({baudRate:o})).then(()=>{a.keepReading=!0,a.onDataLine=r,a.addReadEvent(r),e()}).catch(e=>{a.obj=null,t(e)})}),a.close=async()=>{if(a.isConnected()&&(a.keepReading=!1,a.isConnected())){var e=a.obj;if(e.readable&&e.readable.locked)try{await a.reader.cancel(),a.reader.releaseLock()}catch(e){console.log(e)}if(e.writable&&e.writable.locked)try{a.writer.releaseLock()}catch(e){console.log(e)}try{await e.close()}catch(e){console.log(e)}a.obj=null}},a.isConnected=()=>a.obj,a.readLine=()=>{for(var e,t="",o=!1;(e=a.readChar()).length&&("\n"===e?o=!0:t+=e),e.length&&!o;);return{text:t,endWithLF:o}},a.readChar=()=>{for(var e=[],t=0,o="",r=a.outputBuffer.length,i=0;i<r;i++){var l=a.outputBuffer.shift();if(0==(128&l)){o=String.fromCharCode(l);break}if(128==(192&l)){if(e.push(l),t<=e.length){o=a.decoder.decode(new Uint8Array(e));break}}else{switch(224&l){case 252:t=6;break;case 248:t=5;break;case 240:t=4;break;case 224:t=3;break;default:t=2}e.push(l)}}return o},a.startReadLine=(o=e=>{})=>{a.readLineTimer=window.setTimeout(()=>{if(a.keepReading){do{var e=a.readLine(),t=e.endWithLF,e=e["text"];a.output.push((a.output.length?a.output.pop():"")+e),t&&((e=a.output.length)&&o(a.output[e-1]),a.output.push(""))}while(t);for(;500<a.output.length;)a.output.shift();a.keepReading&&a.startReadLine(o)}else window.clearTimeout(a.readLineTimer)},100)},a.addReadEvent=async(e=e=>{})=>{for(a.output=[],a.inputBuffer=[],a.outputBuffer=[],a.refreshInputBuffer=!1,a.refreshOutputBuffer=!0,a.startReadLine(e);a.obj.readable&&a.keepReading;){a.reader=a.obj.readable.getReader();try{for(;;){var{value:t,done:o}=await a.reader.read();if(a.refreshOutputBuffer&&t&&(a.outputBuffer=[...a.outputBuffer,...t]),a.refreshInputBuffer&&t&&(a.inputBuffer=[...a.inputBuffer,...t]),o)break}}catch(e){console.log(e)}finally{a.reader.releaseLock()}}},a.AddOnConnectEvent=t=>{navigator.serial.addEventListener("connect",e=>{t()})},a.AddOnDisconnectEvent=t=>{navigator.serial.addEventListener("disconnect",e=>{a.obj&&a.close(),t()})},a.writeString=async e=>{e=a.encoder.encode(e);await a.writeByteArr(e)},a.writeByteArr=async e=>{var t=a.obj.writable.getWriter();await t.write(new Int8Array(e).buffer),t.releaseLock(),await a.sleep(200)},a.writeCtrlA=async()=>{await a.writeByteArr([1,13,10])},a.writeCtrlB=async()=>{await a.writeByteArr([2,13,10])},a.writeCtrlC=async()=>{await a.writeByteArr([3,13,10])},a.writeCtrlD=async()=>{await a.writeByteArr([3,4])},a.setBaudRate=async e=>{a.keepReading=!1;var t=a.obj;await a.close(),await t.open({baudRate:+e}),a.obj=t,a.keepReading=!0,a.setSignals(a.dtr,a.rts),a.addReadEvent(a.onDataLine)},a.setDTR=async e=>{a.dtr=e,await a.obj.setSignals({dataTerminalReady:e})},a.setRTS=async e=>{a.rts=e,await a.obj.setSignals({requestToSend:e})},a.setSignals=async(e,t)=>{a.dtr=e,a.rts=t,await a.obj.setSignals({dataTerminalReady:e,requestToSend:t})},a.sleep=t=>new Promise(e=>setTimeout(e,t))}),goog.loadJs("web",()=>{goog.require("Mixly.Web"),goog.provide("Mixly.Web.USB");var e=Mixly["Web"];const l=e["USB"];l.output=[],l.encoder=new TextEncoder("utf8"),l.decoder=new TextDecoder("utf8"),l.obj=null,l.onDataLine=null,l.connect=(o=115200,r=e=>{})=>new Promise((e,t)=>{l.isConnected()?e():navigator.usb.requestDevice({filters:[{vendorId:3368}]}).then(e=>(l.obj=e,l.WebUSB=new DAPjs.WebUSB(e),l.DAPLink=new DAPjs.DAPLink(l.WebUSB),l.DAPLink.connect())).then(()=>l.setBaudRate(o)).then(()=>{l.onDataLine=r,l.addReadEvent(r),e()}).catch(t)}),l.close=()=>{l.isConnected()&&(l.DAPLink.removeAllListeners(DAPjs.DAPLink.EVENT_SERIAL_DATA),l.DAPLink.stopSerialRead(),l.DAPLink.disconnect().then(()=>l.WebUSB.close()).then(()=>l.obj.close()).catch(e=>{console.log(e)}))},l.isConnected=()=>l.obj&&l.obj.opened,l.addReadEvent=(i=e=>{})=>{l.DAPLink.removeAllListeners(DAPjs.DAPLink.EVENT_SERIAL_DATA),l.DAPLink.on(DAPjs.DAPLink.EVENT_SERIAL_DATA,t=>{var o=t.split("\n");if(o.length){var r;l.output.length&&(t=l.output.pop(),l.output.push(t+o.shift()),o.length)&&i(l.output[l.output.length-1]);let e=0;for(r of o)e++,l.output.push(r),e<o.length&&i(r);for(;500<l.output.length;)l.output.shift()}}),l.DAPLink.startSerialRead(l.obj)},l.AddOnConnectEvent=t=>{navigator.usb.addEventListener("connect",e=>{t()})},l.AddOnDisconnectEvent=t=>{navigator.usb.addEventListener("disconnect",e=>{t()})},l.writeString=async e=>{await l.DAPLink.serialWrite(e),await l.sleep(200)},l.writeByteArr=async e=>{"function"==typeof e.unshift&&(e.unshift(e.length),e=new Uint8Array(e).buffer),await l.DAPLink.send(132,e),await l.sleep(200)},l.writeCtrlA=async()=>{await l.writeByteArr([1,13,10])},l.writeCtrlB=async()=>{await l.writeByteArr([2,13,10])},l.writeCtrlC=async()=>{await l.writeByteArr([3,13,10])},l.writeCtrlD=async()=>{await l.writeByteArr([3,4])},l.write=async(e,t,o)=>"string"!==e?(await l.writeByteArr(t),l.writeString(o)):l.writeString(t+o),l.setSignals=async(e,t)=>{},l.setBaudRate=e=>l.DAPLink.setSerialBaudrate(e),l.flash=e=>l.DAPLink.flash(e),l.sleep=t=>new Promise(e=>setTimeout(e,t))}),goog.loadJs("common",()=>{goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Modules"),goog.provide("Mixly.BoardConfigItem");const{Env:o,Config:e,Modules:r}=Mixly,{USER:i,BOARD:l}=e;Mixly.BoardConfigItem=class{constructor(e,t){this.name=e,this.config={...t.config},this.ignore=[],t instanceof String?this.key=t:t instanceof Object?(this.key=t.key,this.ignore=t.ignore??[]):this.key=e,this.generateOptions()}generateOptions(){if(this.options=[],this.selectedOptions={},this.defaultOptions={},this.optionsInfo={},this.config instanceof Object){for(var e in this.config){var t=this.config[e];if(t.options instanceof Object&&t.options.length){this.defaultOptions[t.key]={...t.options[0]},this.optionsInfo[t.key]={key:[],label:[]};var o,r=[];for(o in t.options){var i=t.options[o];i instanceof Object&&(r.push({title:i.label,id:i.key}),this.optionsInfo[t.key].label.push(i.label),this.optionsInfo[t.key].key.push(i.key))}this.options.push({name:t.label,key:t.key,options:r})}}this.selectedOptions={...this.defaultOptions}}}optionIsLegal(e,t){return!!(Object.keys(this.defaultOptions).includes(e)&&this.optionsInfo[e].key.includes(t.key)&&this.optionsInfo[e].label.includes(t.label))}setSelectedOption(e,t){this.optionIsLegal(e,t)&&(this.selectedOptions[e]={...t})}setSelectedOptions(e){if(e instanceof Object)for(var t in this.selectedOptions=this.selectedOptions??{},e)this.setSelectedOption(t,e[t])}writeSelectedOptions=()=>{if(o.isElectron){i.board=i.board??{};var e=i["board"],{fs_extra:e,path:t}=(e[l.boardType]=e[l.boardType]??{},e[l.boardType].key=this.key,e[l.boardType].default={...this.selectedOptions},r);try{e.outputJsonSync(t.resolve(o.clientPath,"setting/config.json"),i,{spaces:"    "})}catch(e){console.log(e)}}};getCommandParam(){}}}),goog.loadJs("common",()=>{"use strict";goog.require("Blockly"),goog.require("Mixly.Env"),goog.require("Mixly.Modules"),goog.require("Mixly.Config"),goog.require("Mixly.ScriptLoader"),goog.require("Mixly.Msg"),goog.provide("Code");const{Env,Modules,Config,ScriptLoader}=Mixly,{fs}=Modules,{BOARD,USER}=Config;Code.LANGUAGE_NAME={"zh-hans":"简体中文","zh-hant":"繁體中文",en:"English",spa:"Español"},Code.LANGUAGE_RTL=["ar","fa","he","lki"],Code.workspace=null,Code.getStringParamFromUrl=function(e,t){e=location.search.match(new RegExp("[?&]"+e+"=([^&]+)"));return e?decodeURIComponent(e[1].replace(/\+/g,"%20")):t},Code.getLang=function(){var e=Code.getStringParamFromUrl("lang","");return e=void 0===Code.LANGUAGE_NAME[e]?"zh-hans":e},Code.isRtl=function(){return-1!=Code.LANGUAGE_RTL.indexOf(Code.LANG)},Code.loadBlocks=function(e){try{var t=window.sessionStorage.loadOnceBlocks}catch(e){t=null}var o;"BlocklyStorage"in window&&1<window.location.hash.length?BlocklyStorage.retrieveXml(window.location.hash.substring(1)):t?(delete window.sessionStorage.loadOnceBlocks,o=Blockly.Xml.textToDom(t),Blockly.Xml.domToWorkspace(o,Code.workspace)):e?(o=Blockly.Xml.textToDom(e),Blockly.Xml.domToWorkspace(o,Code.workspace)):"BlocklyStorage"in window&&window.setTimeout(BlocklyStorage.restoreBlocks,0)},Code.changeEditorTheme=function(){var e=document.getElementById("aceTheme"),e=e.options[e.selectedIndex].value;null!=editor&&editor.setOption("theme",e),null!=editor_side_code&&editor_side_code.setOption("theme",e)},Code.bindClick=function(e,t){(e="string"==typeof e?document.getElementById(e):e)&&(e.addEventListener("click",t,!0),e.addEventListener("touchend",t,!0))},Code.importPrettify=function(){},Code.getBBox_=function(e){for(var t=e.offsetHeight,o=e.offsetWidth,r=0,i=0;r+=e.offsetLeft,i+=e.offsetTop,e=e.offsetParent;);return{height:t,width:o,x:r,y:i}},Code.LANG=Code.getLang(),Code.TABS_=["blocks","arduino","xml"],Code.selected="blocks",Code.tabClick=function(e){if("tabon"==document.getElementById("tab_xml").className){var t=document.getElementById("content_xml").value,o=null;try{o=Blockly.Xml.textToDom(t)}catch(e){if(!window.confirm(MSG.badXml.replace("%1",e)))return}o&&(Code.workspace.clear(),Blockly.Xml.domToWorkspace(o,Code.workspace))}"tabon"==document.getElementById("tab_blocks").className&&Code.workspace.setVisible(!1);for(var r=0;r<Code.TABS_.length;r++){var i=Code.TABS_[r];document.getElementById("tab_"+i).className="taboff",document.getElementById("content_"+i).style.visibility="hidden"}Code.selected=e,document.getElementById("tab_"+e).className="tabon",document.getElementById("content_"+e).style.visibility="visible",Code.renderContent(),"blocks"==e&&Code.workspace.setVisible(!0),Blockly.svgResize(Code.workspace)},Code.renderContent=function(){var e,t,o=document.getElementById("content_"+Code.selected);"content_xml"==o.id?(e=document.getElementById("content_xml"),t=Blockly.Xml.workspaceToDom(Code.workspace),t=Blockly.Xml.domToPrettyText(t),e.value=t,e.focus()):"content_javascript"==o.id?Code.attemptCodeGeneration(Blockly.JavaScript):"content_python"==o.id?Code.attemptCodeGeneration(Blockly.Python):"content_php"==o.id?Code.attemptCodeGeneration(Blockly.PHP):"content_dart"==o.id?Code.attemptCodeGeneration(Blockly.Dart):"content_lua"==o.id&&Code.attemptCodeGeneration(Blockly.Lua),"object"==typeof PR&&PR.prettyPrint()},Code.attemptCodeGeneration=function(e){var t=document.getElementById("content_"+Code.selected);t.textContent="",Code.checkAllGeneratorFunctionsDefined(e)&&(e=e.workspaceToCode(Code.workspace),t.textContent=e,t.className=t.className.replace("prettyprinted",""))},Code.checkAllGeneratorFunctionsDefined=function(e){for(var t=Code.workspace.getAllBlocks(!1),o=[],r=0;r<t.length;r++){var i=t[r].type;e[i]||-1==o.indexOf(i)&&o.push(i)}var l,a=0==o.length;return a||(l="The generator code for the following blocks not specified for "+e.name_+":\n - "+o.join("\n - "),Blockly.alert(l)),a},Code.init=function(){Code.initLanguage(!0),document.getElementById("aceTheme")&&document.getElementById("aceTheme").addEventListener("change",Code.changeEditorTheme,!0);Code.isRtl()},Code.initLanguage=function(e=!1){var t,o=Code.isRtl(),r=(document.dir=o?"rtl":"ltr",Code.LANG=USER.language??"zh-hans",document.head.parentElement.setAttribute("lang",Code.LANG),[]);for(t in Code.LANGUAGE_NAME)r.push([Code.LANGUAGE_NAME[t],t]);r.sort(function(e,t){return e[0]>t[0]?1:e[0]<t[0]?-1:0});for(var i=document.getElementById("toolbox").getElementsByTagName("category"),l=0;l<i.length;l++)Blockly.Msg.MSG[i[l].id]&&(i[l].setAttribute("name",Blockly.Msg.MSG[i[l].id]),e?i[l].hasAttribute("toolboxitemid")||(i[l].setAttribute("toolboxitemid",i[l].id),i[l].setAttribute("name",Blockly.Msg.MSG[i[l].id])):document.getElementById(i[l].id+".label")&&(document.getElementById(i[l].id+".label").innerText=Blockly.Msg.MSG[i[l].id]));document.getElementById("copyright").textContent=Blockly.Msg.MSG.copyright;for(var a,n=document.getElementsByClassName("textVar"),l=0;a=n[l];l++)a.textContent=Blockly.Msg.MSG.textVariable;for(var s,c=document.getElementsByClassName("listVar"),l=0;s=c[l];l++)s.textContent=Blockly.Msg.MSG.listVariable},Code.runJS=function(){Blockly.JavaScript.INFINITE_LOOP_TRAP="  checkTimeout();\n";var timeouts=0,checkTimeout=function(){if(1e6<timeouts++)throw MSG.timeout},code=Blockly.JavaScript.workspaceToCode(Code.workspace);Blockly.JavaScript.INFINITE_LOOP_TRAP=null;try{eval(code)}catch(e){alert(MSG.badCode.replace("%1",e))}},Code.discard=function(){var e=Code.workspace.getAllBlocks().length;(e<2||window.confirm(Blockly.Msg.DELETE_ALL_BLOCKS.replace("%1",e)))&&(Code.workspace.clear(),window.location.hash)&&(window.location.hash="")},Code.LANG=USER.language??"zh-hans",window.addEventListener("load",Code.init)}),goog.loadJs("common",()=>{goog.require("Mixly.Config"),goog.require("Mixly.MJSON"),goog.provide("Mixly.Command");const{Config:e,Command:l,MJSON:t}=Mixly,a=e["SOFTWARE"];l.DEFAULT={obj:"",func:"",args:[]},l.parse=e=>t.decode(t.parse(e)),l.run=t=>{if(a?.debug&&console.log("收到指令：",t),"object"==typeof t){var{obj:t,func:o,args:r}=t={...l.DEFAULT,...t},t=t.split(".");if(0!==t.length){let e=window[t[0]];if(e){t.shift();for(var i of t)if(!(e=e[i]))return;try{e[o]&&e[o](...r)}catch(e){console.log(e)}}}}}}),goog.provide("Mixly.CssLoader"),goog.require("Mixly.Config"),goog.require("Mixly.Env"),Mixly.CssLoader.loadCss=function(e){for(var t,o=!0,r=document.getElementsByTagName("link"),i=0;i<r.length;i++)r[i]&&r[i].href&&-1!=r[i].href.indexOf(e)&&(o=!1);o&&((t=document.createElement("link")).setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.getElementsByTagName("head").item(0).appendChild(t))},Mixly.CssLoader.removeCss=function(e){for(var t=document.getElementsByTagName("link"),o=0;o<t.length;o++){t[o].href;t[o]&&t[o].href&&-1!=t[o].href.indexOf(e)&&t[o].parentNode.removeChild(t[o])}},Mixly.CssLoader.commonCss=["common/css/root.css","common/ui/bootstrap/css/bootstrap.min.css","common/ui/layui/css/layui.css","common/ui/layui/css/layui-theme-dark.css","common/css/ACEfont.css","common/css/fontello.css","common/css/nav.css","common/css/library.css","common/css/drag.css","common/css/button.css","common/css/xscrollbar.css","common/css/tippy-ext.css","common/css/scrollbar.css","common/css/select2.min.css","common/css/select2-ext.css","common/css/xterm.css","common/css/footer-layer.css"],Mixly.CssLoader.clientCss=[],Mixly.CssLoader.webCss=[],Mixly.CssLoader.load=function(){var o=Mixly.Config.pathPrefix;function e(t){for(let e=0;e<t.length;e++)Mixly.CssLoader.loadCss(o+t[e])}e(Mixly.CssLoader.commonCss),Mixly.Env.isElectron?e(Mixly.CssLoader.clientCss):e(Mixly.CssLoader.webCss)},Mixly.CssLoader.load(),goog.loadJs("common",()=>{goog.require("layui"),goog.require("store"),goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Modules"),goog.require("Mixly.LocalStorage"),goog.require("Mixly.CssLoader"),goog.provide("Mixly.Loading");var e,{Env:t,Config:o,Modules:r,Loading:i}=Mixly,l=layui["laytpl"];let a=null;if((a=t.isElectron?({fs_extra:e,path:s}=r,s=s.resolve(t.clientPath,"./setting/config.json"),e.readJsonSync(s,{throws:!1})):store.get("mixly2.0-config"))&&(o.USER={...o.USER,...a}),o.USER.themeAuto&&(e=window.matchMedia("(prefers-color-scheme: light)"),o.USER.theme=e.matches?"light":"dark"),o.USER.languageAuto)switch(navigator.language){case"zh-CN":o.USER.language="zh-hans";break;case"zh-HK":case"zh-SG":case"zh-TW":o.USER.language="zh-hant";break;default:o.USER.language="en"}console.log("Config.USER",o.USER);let n;n="dark"===o.USER.theme?"#181818":"#fff",i.CSS_CONFIG={dark:{loading:"#181818",loadingLeftDiv:"#333333",loadingTopDiv:"#2F4056",loadingBottomDiv:"#007acc",body:"#181818"},light:{loading:"#fff",loadingLeftDiv:"#ddd",loadingTopDiv:"#009688",loadingBottomDiv:"#05bbaa",body:"#fff"}},i.TEMPLATE_RAW=goog.get(t.templatePath+"/skeleton.html"),i.TEMPLATE_RENDER=l(i.TEMPLATE_RAW).render(i.CSS_CONFIG[o.USER.theme]);var s=r.currentWindow;const c=o.USER.theme;s&&s.setBackgroundColor(n),$("html").append(i.TEMPLATE_RENDER),"dark"===o.USER.theme?$("html").attr("data-bs-theme","dark"):$("html").attr("data-bs-theme","light"),window.addEventListener("DOMContentLoaded",()=>{"dark"===c?$("body").addClass("dark"):$("body").addClass("light")})}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Mixly.Tools"),goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Msg"),goog.require("Code"),goog.provide("Mixly.XML");const{Env:e,Config:t,Msg:o,XML:r}=Mixly;var i,l=t["BOARD"];const a=layui["laytpl"];r.TEMPLATE_DIR_PATH=goog.normalizePath_(goog.basePath+"../template/"),r.TEMPLATE_CONFIG=[{type:"LOADER_DIV",path:"/loader-div.html",config:{btnName:o.Lang["取消"]},appendToBody:!0},{type:"SELECTOR_DIV",path:"/selector-div.html",config:{btn1Name:o.Lang["取消"],btn2Name:o.Lang["确定"]},appendToBody:!0},{type:"SIMULATOR_DIV",path:"/simulator-div.html",config:{},appendToBody:!0},{type:"BOARD_SELECTOR",path:"/board-selector-div.html",config:{},appendToBody:!1},{type:"PORT_SELECTOR",path:"/port-selector-div.html",config:{selectPort:o.Lang["选择串口"],noPort:o.Lang["无可用串口"]},appendToBody:!1},{type:"PARSE_MIX_ERROR_DIV",path:"/parse-mix-error-div.html",config:{},appendToBody:!1},{type:"READ_BITMAP_DIV",path:"/read-bitmap-div.html",config:{},appendToBody:!1},{type:"SEARCH_DIV",path:"/search-div.html",config:{search:o.Lang["查找"]},appendToBody:!1},{type:"PROGRESS_BAR_DIV",path:"/progress-bar-div.html",config:{},appendToBody:!1},{type:"LIB_MANAGER_DIV",path:"/lib-manager-div.html",config:{},appendToBody:!1},{type:"APP_DIV",path:"/app.html",config:{outputAceName:o.Lang["输出"],row:o.Lang["行"],column:o.Lang["列"],unknown:o.Lang["未知"],config:o.Lang["配置板卡"],selected:o.Lang["已选择"],on:o.Lang["在"],message:"消息"},appendToBody:!1},{type:"BOARD_CONFIG_MENU_DIV",path:"/board-config-menu-div.html",config:{},appendToBody:!1},{type:"EXAMPLE_MENU_DIV",path:"/example-menu-div.html",config:{},appendToBody:!1}],r.TEMPLATE_ENV={LOADER_DIV:!0,SELECTOR_DIV:!0,SIMULATOR_DIV:e.isElectron&&l?.nav?.compile,BOARD_SELECTOR:!0,PORT_SELECTOR:!(l?.nav?.run||l?.nav?.cancel||l?.nav?.webrun||l?.nav?.webcancel||!e.isElectron&&!e.hasSocketServer),PARSE_MIX_ERROR_DIV:!0,READ_BITMAP_DIV:!0,SEARCH_DIV:!0,PROGRESS_BAR_DIV:e.isElectron&&l?.nav?.setting?.thirdPartyLibrary,LIB_MANAGER_DIV:e.isElectron&&l?.nav?.setting?.thirdPartyLibrary,APP_DIV:!0,BOARD_CONFIG_MENU_DIV:!0,EXAMPLE_MENU_DIV:!0},r.TEMPLATE_STR={},r.TEMPLATE_STR_RENDER={},r.TEMPLATE_DOM={},r.CATEGORIES_STR={},r.getDom=(e,t={})=>$(a(e).render(t)),r.render=(e,t={})=>{var o,r={};for(o in t)"function"==typeof t[o]?r[o]=t[o]():r[o]=t[o];return a(e).render(r)},r.convert=function(e,t){for(var o="",r=!0,i=e.length,l=0;l<i;l++)"<"===e[l]?r=!1:">"===e[l]&&(r=!0),t&&!r&&l+1<i&&"\\"===e[l]&&'"'===e[l+1]&&(l+=1),!t&&!r&&0<l&&"\\"!==e[l-1]&&'"'===e[l]&&(o+="\\"),o+=e[l];return o};for(i of r.TEMPLATE_CONFIG){var{type:n,path:s,config:c,appendToBody:d}=i;r.TEMPLATE_ENV[n]&&(s=goog.get(r.TEMPLATE_DIR_PATH+s))&&(r.TEMPLATE_STR[n]=s,r.TEMPLATE_STR_RENDER[n]=r.render(s,c),r.TEMPLATE_DOM[n]=r.getDom(s,c),d)&&$("body").append(r.TEMPLATE_DOM[n])}if("object"===layui._typeof(l.board))for(var g in l.board){var u=l.board[g];"object"===layui._typeof(u)&&"string"===layui._typeof(u.xmlPath)&&(u=goog.get(u.xmlPath))&&(r.CATEGORIES_STR[g]=u)}window.addEventListener("load",()=>{for(var e of r.TEMPLATE_CONFIG){var{type:e,appendToBody:t}=e;r.TEMPLATE_ENV[e]&&r.TEMPLATE_DOM[e]&&t&&$("body").append(r.TEMPLATE_DOM[e])}})}),goog.loadJs("electron",()=>{goog.require("Mixly.Modules"),goog.require("Mixly.Env"),goog.require("Mixly.Electron"),goog.provide("Mixly.Electron.CloudDownload");var{Modules:e,Electron:t}=Mixly;const r=t["CloudDownload"],{fs_extra:s,fs_extend:c,node_downloader_helper:d,path:g}=e;r.getJson=(e,t,o)=>{e?r.download(e,t).then(e=>{if(e[0])throw e[0];return s.readJson(e[1])}).then(e=>{o([null,e])}).catch(e=>{o([e,null])}):o(["url读取出错！",null])},r.download=(l,a,n={})=>new Promise((t,e)=>{var o={progress:null,end:null,error:null};n="object"!=typeof n?o:{...o,...n};try{s.ensureDirSync(a);var r=g.basename(l),i=g.resolve(a,"./"+r);c.isfile(i)&&s.removeSync(i)}catch(e){return void t([e,l])}o=d.DownloaderHelper,r=new o(l,a,{override:!0,timeout:15e3,retry:!1});r.on("progress",e=>{"function"==typeof n.progress&&n.progress(e)}),r.on("end",e=>{"function"==typeof n.end&&n.end(e),t([null,e.filePath])}),r.on("error",e=>{console.log("Download Failed",e),"function"==typeof n.error&&n.error(e),t([e,l])}),r.on("timeout",()=>{console.log("Download Timeout"),"function"==typeof n.timeout&&n.timeout("Download Timeout"),t(["Download Timeout",l])}),r.start().catch(e=>{console.log("Download Failed",e),"function"==typeof n.error&&n.error(e),t([e,l])})})}),goog.loadJs("electron",()=>{goog.require("Mixly.Command"),goog.require("Mixly.Modules"),goog.require("Mixly.Config"),goog.require("Mixly.Electron"),goog.provide("Mixly.Electron.Events");const{Command:o,Modules:e,Config:t,Electron:r}=Mixly;var{}=r;const i=t["SOFTWARE"];e.ipcRenderer=require("electron").ipcRenderer,e.ipcRenderer.on("command",(e,t)=>{i.debug&&console.log("receive -> ",t);t=o.parse(t);o.run(t)})}),goog.loadJs("electron",()=>{goog.require("Code"),goog.require("Mixly.Modules"),goog.require("Mixly.Config"),goog.require("Mixly.Env"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron"),goog.provide("Mixly.Electron.WikiManager");const{Modules:e,Config:t,Env:s,Msg:c,Electron:o}=Mixly,r=o["WikiManager"],d=t["BOARD"],{path:g,fs:u,fs_extra:p,fs_extend:A,json2md:h,electron_remote:i,electron_localshortcut:l}=e,a=i["ipcMain"];class n{constructor(e,t=null){this.gotoInfo=t,this.updateContentFile(),this.win=o.newBrowserWindow(e),this.isDestroyed=!1,this.addReceiveCommandEvent(),this.addLocalShortcutEvent(),this.win.on("close",()=>{this.isDestroyed=!0}),$(window).unload(()=>{this.isDestroyed||this.win.close()})}addLocalShortcutEvent(){l.register(this.win,"CmdOrCtrl+Shift+I",()=>{this.isDestroyed||this.win.webContents.toggleDevTools()}),l.register(this.win,"CmdOrCtrl+R",()=>{this.reload()})}addReceiveCommandEvent(){a.on("command",(e,t)=>{"object"==typeof t&&"getPath"===t.func&&this.updateWiki()})}sendCommand(e){this.isDestroyed||"object"!=typeof e||this.win.webContents.send("command",e)}reload(){this.isDestroyed||(this.updateContentFile(),this.win.reload())}getPagePath(e,t){if("object"!=typeof t||!e.length)return null;if(1===e.length){for(var o in t){o=t[o];if(o?.link?.title===e[0]){var{title:o,source:r}=o.link;if(o===e[0]&&"string"==typeof r)try{var i=r.match(/(?<=(\?file=))[^\s]*/g);if(i?.length)return i[0]}catch(e){console.log(e)}return null}}return null}for(var l in t){var a,l=t[l];if(l&&2===l.length&&l[0].h5===e[0])return(a=[...e]).shift(),this.getPagePath(a,l[1].ul)}}goto(e,t){var o=[],r=this.getPagePath(e,this.contentList);e&&(o.push(r),t&&o.push(t),this.sendCommand({func:"goto",args:o}),this.win.focus())}updateContentFile(){var e,t=g.resolve(s.indexDirPath,"./wiki/content.md"),o=g.resolve(s.indexDirPath,"./wiki/wiki-libs/"+Code.LANG),r=g.resolve(o,"./home"),i=g.resolve(s.indexDirPath,"./libraries/ThirdParty/"),l=(g.resolve(s.clientPath,"./CHANGELOG"),[]);if(A.isfile(r+".md")&&l.push({h4:{link:{title:c.Lang["首页"],source:"?file="+encodeURIComponent(r)}}}),A.isdir(o)&&(r=this.getContentJson(o,d.boardType))&&l.push(r),A.isdir(i))for(e of u.readdirSync(i)){var a=g.resolve(i,"./"+e+"/wiki/"+Code.LANG);A.isdir(a)&&(a=this.getContentJson(a,e))&&l.push(a)}this.contentList=l;try{var n=h(l).split("\n");for(let e=0;e<n.length;e++)n[e].replaceAll(" ","")?n[e].indexOf("#####")||(n[e]="\n"+n[e]):(n.splice(e,1),e--);p.outputFile(t,n.join("\n"))}catch(e){console.log(e)}}updateWiki(){var e,t,o,r,i=[{default:g.resolve(s.indexDirPath,"./wiki/wiki-libs/"),thirdParty:g.resolve(s.indexDirPath,"./libraries/ThirdParty/"),content:g.resolve(s.indexDirPath,"./wiki/content.md")}];this.gotoInfo&&({page:e,scrollPos:t}=this.gotoInfo,(o=this.getPagePath(this.gotoInfo.page,this.contentList))&&((r=[]).push(o),t&&r.push(t),i[0].goto=r),this.gotoInfo=null),this.sendCommand({func:"setPath",args:i})}getContentJson(e,t=null){var o=g.basename(e).split("-");if(2!==o.length&&!t)return null;var r,i=[],l=(i.push({h5:t??o[1]}),i.push({ul:[]}),i[1])["ul"];for(r of u.readdirSync(e)){var a,n=g.resolve(e,"./"+r);A.isdir(n)?(a=this.getContentJson(n))&&a[1].ul.length&&l.push(a):".md"===g.extname(r)&&2===(a=g.basename(r,".md").split("-")).length&&(n=g.resolve(g.dirname(n),"./"+g.basename(r,".md")),l.push({link:{title:a[1],source:"?file="+encodeURIComponent(n)+' "'+a[1]+'"'}}))}return i}}r.WikiPage=n,r.openWiki=e=>{var t,e=e&&"object"==typeof e?e[Code.LANG]:null;!r.wiki||r.wiki.isDestroyed?(t=g.resolve(s.indexDirPath,"../../../common/wiki/index.html"),A.isfile(t)?r.wiki=new n(t,e):layer.msg(c.Lang["未找到Wiki页"],{time:1e3})):(t=r.wiki["win"],t&&t.focus(),e&&({page:t,scrollPos:e}=e,r.wiki.goto(t,e)))},r.registerContextMenu=()=>{var e={displayText:c.Lang["打开Wiki"],preconditionFn:function(e){e=e.block.wiki;return"object"==typeof e&&"object"==typeof e[Code.LANG]&&"object"==typeof e[Code.LANG].page?"enabled":"hidden"},callback:function(e){e=e.block.wiki;r.openWiki(e)},scopeType:Blockly.ContextMenuRegistry.ScopeType.BLOCK,id:"wiki_open",weight:200};Blockly.ContextMenuRegistry.registry.register(e)}}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("tippy"),goog.require("Mixly.FooterLayer"),goog.require("Mixly.MArray"),goog.require("Mixly.Env"),goog.require("Mixly.XML"),goog.require("Mixly.Msg"),goog.provide("Mixly.BoardConfigMenu");const{FooterLayer:e,Env:o,XML:t,Msg:r}=Mixly,a=layui["dropdown"];class i extends e{constructor(e,t){super(e,{onHidden:e=>{this.boardsInfo[this.boardName].writeSelectedOptions()},onMount:e=>{this.renderMenu(e)},onShown:t=>{$(t.popper).find(".footer-layer-reset").off().click(()=>{var e=this.boardName,e=this.boardsInfo[e]["defaultOptions"];this.setSelectedOptions(t,e)})}}),this.containerId=e,this.boardsInfo=t,this.boardName=null,this.template=goog.get(o.templatePath+"/board-config-menu-div.html"),this.dropdownItems={}}getOptionsByBoardName(e){}renderMenu(e){var t=this.boardName,{options:t,selectedOptions:o}=this.boardsInfo[t];this.renderTemplate(t),this.setSelectedOptions(e,o),this.renderOptions(e,t)}setSelectedOptions(e,t){var o,r=this.boardName,i=this.boardsInfo[r];Object.keys(i.defaultOptions);for(o in t){let e=i.defaultOptions[o].label;i.optionIsLegal(o,t[o])&&(e=t[o].label),$("#board-config-"+o).find("p").text(e),i.setSelectedOption(o,t[o])}e.setProps({})}renderOptions(r,e){const i=this.boardName,l=this;for(let o of e){var t;$("#board-config-"+o.key).length&&(t={elem:"#board-config-"+o.key,align:"right",data:o.options,anywhereClose:!0,className:"mixly-scrollbar editor-dropdown-menu board-config-menu",style:"display:inline-block;box-shadow:1px 1px 30px rgb(0 0 0 / 12%);",ready:function(e,t){var e=$(e),t=$(t),o=(e.css({left:"auto",right:"calc(100vw - "+(t.offset().left+t.outerWidth())+"px)","min-width":t.outerWidth()+"px"}),t.find("p")),r=e.find("li");for(let e=0;r[e];e++){var i=$(r[e]).children("div");i.text()===o.text()&&($(r[e]).css("background-color","#5FB878"),i.css("color","#fff"))}},click:function(e,t){$(this.elem).children("p").text(e.title),l.boardsInfo[i].setSelectedOption(o.key,{key:e.id,label:e.title}),r.setProps({})}},this.dropdownItems[o.key]?this.dropdownItems[o.key].reload(t):this.dropdownItems[o.key]=a.render(t))}}renderTemplate(e){e=t.render(this.template,{options:e,reset:r.Lang["使用默认配置"],close:r.Lang["关闭窗口"]});this.setContent(e)}changeTo(e){this.boardName!==e&&(this.boardsInfo[e]&&this.boardsInfo[e].options.length?$("#"+this.containerId).css("display","inline-flex"):($("#"+this.containerId).css("display","none"),this.hide()),this.boardName=e,this.layer.state.isShown)&&this.renderMenu(this.layer)}}Mixly.BoardConfigMenu=i}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Mixly.Config"),goog.require("Mixly.XML"),goog.require("Mixly.Env"),goog.require("Mixly.Msg"),goog.provide("Mixly.DomOperator");const{DomOperator:t,Config:e,Env:r,Msg:o}=Mixly;var{}=e;const i=layui["laytpl"],l=(t.SerialDom={times:0,getTimes:()=>(this.times=void 0!==this.times?this.times+1:0,10<this.times&&(this.times=0),this.times)},t)["SerialDom"];l.generate=class{constructor(e,t,o){this.mark=l.getTimes(),this.id=this.getId(),this.filter=this.getFilter(),this.lang=o,this.shade=t,this.config=this.getConfig(e),this.htmlTemplatePath=r.templatePath+"/serial-tool.html",this.htmlStr=this.getHtmlStr(),this.generateDom(),this.destroyed=!1,this.width=null,this.height=null,this.prevPort=null,this.nowPort=null}getConfig(e){return t.getConfig(e,{baudRates:9600,ctrlCBtn:!1,ctrlDBtn:!1,receiveStr:!0,scroll:!0,sendStr:!0,sendWith:"\\r\\n",dtr:!0,rts:!0,pointNum:100,yMax:100,yMin:0})}getHtmlStr(){return this.htmlTemplate=goog.get(this.htmlTemplatePath),i(this.htmlTemplate).render({...this.id,...this.filter,baudRates:[9600,19200,28800,38400,57600,115200],selectedBaud:this.config.baudRates,pointList:[50,100,150,200,250,300],pointNum:this.config.pointNum,ctrlCBtn:this.config.ctrlCBtn,ctrlDBtn:this.config.ctrlDBtn,Msg:{monitor:o.Lang["串口监视器"],visualization:o.Lang["串口可视化"],serial:o.Lang["串口"],open:o.Lang["打开"],sendData:o.Lang["发送数据"],send:o.Lang["发送"],string:o.Lang["字符串"],input:o.Lang["请输入内容"],receiveData:o.Lang["接收数据"],scroll:o.Lang["滚屏"],clear:o.Lang["清空"],interrupt:o.Lang["中断"],reset:o.Lang["复位"],min:o.Lang["最小"],max:o.Lang["最大"],pointNum:o.Lang["点数"]}})}generateDom(){let o=this.id["formId"],r=this.filter["formFilter"],i=this;layui.use(["layer","form"],function(){var e=layui.form,t=document.createElement("div");t.innerHTML=i.htmlStr,t.className="layui-form layui-form-pane",t.id=o,t.style.display="none",t.setAttribute("lay-filter",r),document.body.appendChild(t),e.render(null,r)})}updateDom(){let o=this.id["formId"],r=this.filter["formFilter"],i=this;layui.use(["layer","form"],function(){var e=layui.form,t=document.getElementById(o);i.htmlStr=i.getHtmlStr(),t.innerHTML=i.htmlStr,e.render(null,r)})}getId(){return{pageId:"serial-page-"+this.mark,formId:"serial-"+this.mark,setDtrId:"serial-set-dtr-"+this.mark,setRtsId:"serial-set-rts-"+this.mark,selectPortId:"serial-selectport-"+this.mark,selectBaudId:"serial-selectbaud-"+this.mark,connectBtnId:"serial-connectbtn-"+this.mark,sendTypeId:"serial-sendtype-"+this.mark,sendId:"serial-send-"+this.mark,sendWithId:"serial-sendwith-"+this.mark,sendBtnId:"serial-sendbtn-"+this.mark,receiveTypeId:"serial-receivetype-"+this.mark,scrollId:"serial-scroll-"+this.mark,receiveId:"serial-receive-"+this.mark,clearBtnId:"serial-clearbtn-"+this.mark,ctrlCBtnId:"serial-interruptbtn-"+this.mark,ctrlDBtnId:"serial-resetbtn-"+this.mark,yMinId:"serial-ymin-"+this.mark,yMaxId:"serial-ymax-"+this.mark,pointNumId:"serial-pointnum-"+this.mark,chartSendTypeId:"serial-chartsendType-"+this.mark,chartSendId:"serial-chartsend-"+this.mark,chartSendWithId:"serial-chartsendWith-"+this.mark,chartSendBtnId:"serial-chartsendBtn-"+this.mark,dataDrawId:"serial-datadraw-"+this.mark,moveId:"serial-move-"+this.mark}}getFilter(){return{formFilter:"serial-filter-"+this.mark,setDtrFilter:"serial-set-dtr-filter-"+this.mark,setRtsFilter:"serial-set-rts-filter-"+this.mark,selectPortFilter:"serial-select-port-filter-"+this.mark,selectBaudFilter:"serial-select-baud-filter-"+this.mark,sendTypeFilter:"serial-send-type-filter-"+this.mark,sendWithFilter:"serial-send-with-filter-"+this.mark,chartSendTypeFilter:"serial-chart-send-type-filter-"+this.mark,tabFilter:"serial-tab-filter-"+this.mark,receiveTypeFilter:"serial-set-receive-type-filter-"+this.mark,scrollFilter:"serial-scroll-filter-"+this.mark,selectPointNumFilter:"serial-select-point-num-filter-"+this.mark,connectBtnFilter:"serial-connect-btn-filter-"+this.mark}}adjustSerialTool(e,t){var o=this.id.pageId,r=(e.css({minWidth:"350px",minHeight:"200px",maxWidth:"710px",maxHeight:"600px",borderRadius:"5px"}),$(window).height()),i=$(window).width();e.css({left:(i-e.width())/2+"px",top:(r-e.height())/2+"px"}),$("#"+o).css({height:"100%",overflow:"hidden",maxWidth:"710px",maxHeight:"600px",minWidth:"350px",minHeight:"200px",borderRadius:"8px"})}open(s=()=>{},c=()=>{}){let d=this;var e=$(window).height(),t=$(window).width();let g=["90%","95%"];this.height&&e>this.height&&100*this.height/e<95&&(g[1]=100*this.height/e+"%"),this.width&&t>this.width&&100*this.width/t<90&&(g[0]=100*this.width/t+"%"),layui.use(["layer","form"],()=>{var e=layui.layer;let r=layui.form,{formId:t,moveId:o,pageId:i,receiveId:l}=d.id,a=d.filter["formFilter"],n=$("#"+l);d.tool=e.open({type:1,id:i,title:!1,area:g,shade:this.shade,closeBtn:1,anim:0,resize:!0,fixed:!0,move:$("#"+o),content:$("#"+t),success:(e,t)=>{var o=e[0].childNodes[1].childNodes[0]["classList"];o.remove("layui-layer-close2"),o.add("layui-layer-close1"),n.val(""),r.render(null,a),d.adjustSerialTool(e,t),s(d)},end:()=>{$(".layui-layer-shade").remove(),c(this.nowPort)},resizing:e=>{var t=$(window).height(),o=$(window).width();e.css({width:e.width()/o*100+"%",height:e.height()/t*100+"%"}),$("#"+i).css("height","100%"),this.width=e[0].clientWidth,this.height=e[0].clientHeight}})})}close(){layer.close(this.tool)}updateTool(e){this.config=this.getConfig(e);var t,o,r,{setDtrId:e,setRtsId:i,selectPortId:l,selectBaudId:a,sendTypeId:n,sendWithId:s,receiveTypeId:c,scrollId:d,yMinId:g,yMaxId:u,pointNumId:p}=this.id,A=layui["form"],e=$("#"+e),i=$("#"+i),l=$("#"+l),a=$("#"+a),n=$("#"+n),s=$("#"+s),h={dtr:e,rts:i,sendStr:n,receiveStr:$("#"+c),scroll:$("#"+d)},y={port:l,baudRates:a,sendWith:s,yMin:$("#"+g),yMax:$("#"+u),pointNum:$("#"+p)};for(t in h)void 0!==this.config[t]&&h[t].prop("checked",this.config[t]);for(o in y)void 0!==this.config[o]&&(r=y[o],$(r).val(this.config[o]));A.render()}formOnClick(e,o,r){layui.use(["layer","form"],()=>{layui.form.on(e+"("+o+")",e=>{var t=this.filter["selectPortFilter"];o===t?e.value!==this.nowPort&&(this.prevPort=this.nowPort,this.nowPort=e.value,r(this.prevPort,this.nowPort,e)):r(this.nowPort,e)})})}elementOnClick(e,t,o){layui.use(["layer","element"],()=>{layui.element.on(e+"("+t+")",e=>{o(this.nowPort,e)})})}btnOnClick(e,t){$("#"+e).off("click").click(()=>{t(this.nowPort)})}onClickSetDtr(e){var t=this.filter["setDtrFilter"];this.formOnClick("checkbox",t,e)}onClickSetRts(e){var t=this.filter["setRtsFilter"];this.formOnClick("checkbox",t,e)}onClickSendType(e){var t=this.filter["sendTypeFilter"];this.formOnClick("checkbox",t,e)}onClickReceiveType(e){var t=this.filter["receiveTypeFilter"];this.formOnClick("checkbox",t,e)}onClickScroll(e){var t=this.filter["scrollFilter"];this.formOnClick("checkbox",t,e)}onClickSelectPort(e){var t=this.filter["selectPortFilter"];this.formOnClick("select",t,e)}onClickSelectBaud(e){var t=this.filter["selectBaudFilter"];this.formOnClick("select",t,e)}onClickSelectPointNum(e){var t=this.filter["selectPointNumFilter"];this.formOnClick("select",t,e)}onClickSelectSendWith(e){var t=this.filter["sendWithFilter"];this.formOnClick("select",t,e)}onClickTab(e){var t=this.filter["tabFilter"];this.elementOnClick("tab",t,e)}onClickConnectBtn(e){var t=this.id["connectBtnId"];this.btnOnClick(t,e)}onClickSendBtn(e){var t=this.id["sendBtnId"];this.btnOnClick(t,e)}onClickChartSendBtn(e){var t=this.id["chartSendBtnId"];this.btnOnClick(t,e)}onClickCtrlCBtn(e){var t=this.id["ctrlCBtnId"];t&&this.btnOnClick(t,e)}onClickCtrlDBtn(e){var t=this.id["ctrlDBtnId"];t&&this.btnOnClick(t,e)}onClickClearBtn(e){var t=this.id["clearBtnId"];this.btnOnClick(t,e)}destroy(){this.tool&&layer.close(this.tool);var e=this.id["formId"];$("#"+e).remove(),this.destroyed=!0}},t.LoaderDomGenerator=(e,t)=>{};t.getConfig=(e,t)=>{var o,r={};for(o in t)if("object"==typeof t[o])if(void 0===e[o])r[o]=t[o];else for(var i in r[o]={},t[o])r[o][i]=e[o][i]??t[o][i];else r[o]=e[o]??t[o];return r}}),goog.loadJs("common",()=>{goog.require("Mixly.Env"),goog.require("Mixly.XML"),goog.require("Mixly.Msg"),goog.require("Mixly.FooterLayer"),goog.provide("Mixly.FooterBar");const{Env:e,XML:r,Msg:i,FooterLayer:t,FooterBar:o}=Mixly;o.init=()=>{let o=goog.get(e.templatePath+"/footer-layer.html");new t("mixly-message",{onMount:function(e){var t=r.render(o,{close:i.Lang["关闭窗口"],list:[{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"primary"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"secondary"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"success"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"danger"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"warning"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"info"},{type:1,src:"../../../common/media/mixly.png",message:"一段测试文本<br/>测试换行功能",style:"light"},{message:"一段测试文本<br/>测试换行功能",style:"primary"},{message:"一段测试文本<br/>测试换行功能",style:"secondary"},{message:"一段测试文本<br/>测试换行功能",style:"success"},{message:"一段测试文本<br/>测试换行功能",style:"danger"},{message:"一段测试文本<br/>测试换行功能",style:"warning"},{message:"一段测试文本<br/>测试换行功能",style:"info"},{message:"一段测试文本<br/>测试换行功能",style:"light"}]});e.setContent(t),e.setProps({})}})},o.add=()=>{}}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Mixly.DomOperator"),goog.require("Mixly.Config"),goog.provide("Mixly.LayerExt");const{LayerExt:h,Config:e,DomOperator:r}=Mixly,t=e["USER"],y=layui["layer"];h.SHADE={dark:[[.005,"rgb(46 64 86)"],[.005,"rgb(46 64 86)","40px"]],light:[[.005,"#009688"],[.005,"#009688","40px"]]},h.SHADE_ALL=h.SHADE.light[0],h.SHADE_NAV=h.SHADE.light[1],h.DEFAULT_TITLE_HEIGHT=42,h.DEFAULT_CONFIG={area:["50%","50%"],max:["850px","543px"],min:["350px","243px"],title:"信息",id:"info",content:"",resize:!0,shade:h.SHADE_ALL,success:null,end:null,cancel:null,resizing:null,offset:"auto",fixed:!0,borderRadius:"8px",maxmin:!1,zIndex:19891014},h.updateShade=()=>{["light","dark"].includes(t.theme)||(t.theme="light"),h.SHADE_ALL=h.SHADE[t.theme][0],h.SHADE_NAV=h.SHADE[t.theme][1]},h.openSerialTool=(e,t,o)=>{e=new r.SerialDom.generate(e,h.SHADE_ALL,Code.LANG);return e.open(t,o),e},h.open=a=>{const{id:n,area:e,title:t,content:o,resize:r,shade:i,resizing:l,offset:s,fixed:c,borderRadius:d,maxmin:g,zIndex:u}=a="object"!=typeof a?h.DEFAULT_CONFIG:{...h.DEFAULT_CONFIG,...a};let p=42,A=null;return A=t?"object"!=typeof t||isNaN(parseInt(t[1]))?t:(p=parseInt(t[1]),t[0]):(p=0,!1),y.open({type:1,id:n,title:A,area:e,content:o,shade:i,closeBtn:1,resize:r,fixed:c,offset:s,maxmin:g,zIndex:u,success:function(e,t){y.style(t,{borderRadius:d});var{max:o,min:r,success:i}=a,l=$("#"+n),o=(l.addClass("mixly-scrollbar"),"object"==typeof o&&(e.css({maxWidth:o[0],maxHeight:o[1]}),l.css("maxWidth",o[0]),-1!==o[1].indexOf("%")?l.css("maxHeight",o[1]):l.css("maxHeight",parseInt(o[1])-p+"px")),"object"==typeof r&&(e.css({minHeight:r[1],minWidth:r[0]}),l.css("minWidth",r[0]),-1!==r[1].indexOf("%")?l.css("minHeight",r[1]):l.css("minHeight",parseInt(r[1])-p+"px")),$(window).height()),r=$(window).width(),r=(e.css({left:(r-e.width())/2+"px",top:(o-e.height())/2+"px"}),e.find(".layui-layer-title")),o=(r.css("borderRadius",d+" "+d+" 0px 0px"),l.css("borderRadius","0px 0px "+d+" "+d),e.find(".layui-layer-setwin"));p&&42!==p&&(r.css({height:p+"px","line-height":p+"px"}),o.css({right:"10px",top:"10px"}),l.css({height:e.height()-p+"px"})),"function"==typeof i&&i(e,t)},end:function(){var e=a["end"];"function"==typeof e&&e()},cancel:function(e,t){$("#layui-layer-shade"+e).remove();var o=a["cancel"];"function"==typeof o&&o(e,t)},resizing:function(e){var t=$(window).height(),o=$(window).width(),o=e.width()/o*100+"%",t=e.height()/t*100+"%";e.css({width:o,height:t}),"function"==typeof l&&(e=e.children(".layui-layer-content"),l({layero:[o,t],content:[e.width(),e.height()]}))}})}}),goog.loadJs("common",()=>{goog.require("Code"),goog.require("layui"),goog.require("Blockly"),goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Command"),goog.require("Mixly.XML"),goog.provide("Mixly.Nav");const{Env:e,Config:t,Nav:y,XML:m}=Mixly,{BOARD:f,USER:o}=t,{element:b,form:x}=layui;y.DEFAULT_CONFIG={burn:!1,upload:!1,compile:!1,simulate:!1,run:!1,cancel:!1,webrun:!1,webcancel:!1,save:{ino:!1,bin:!1,hex:!1,py:!1,img:!1},setting:{thirdPartyLibrary:!1,wiki:!1}};let i,l="electron",a="electron";y.CONFIG={...y.DEFAULT_CONFIG,...f?.nav??{}},i=y.CONFIG.compile?"c":y.CONFIG.run||y.CONFIG.webrun?y.CONFIG.run?"py":"webpy":"mpy",l=e.hasSocketServer?"websocket":e.hasCompiler?"webcompiler":e.isElectron?"electron":"web",a=e.isElectron?"electron":"web",y.codeEnv=i,y.workingEnv=l,y.operatingEnv=a,y.LEFT_BTN_CONFIG=[{type:"UNDO",class:"icon-ccw",id:"undo-btn",title:"undo(ctrl+z)",href:"#",onclick:"Mixly.Editor.undo()"},{type:"REDO",class:"icon-cw",id:"redo-btn",title:"redo(ctrl+y)",href:"#",onclick:"Mixly.Editor.redo()"},{type:"CONNECT",class:"icon-link",id:"connect-btn",title:"",href:"#",onclick:{web:"Mixly.Web.BU.clickConnect()",webcompiler:"Mixly.Web.BU.clickConnect()"}},{type:"BURN",class:"icon-upload-1",id:"burn-btn",title:"",href:"#",onclick:{electron:{mpy:"Mixly.Electron.BU.initBurn()",c:"Mixly.Electron.ArduShell.burn()"},web:{mpy:"Mixly.Web.BU.initBurn()"},websocket:{mpy:"Mixly.WebSocket.BU.initBurn()"},webcompiler:{mpy:"Mixly.Web.BU.initBurn()"}}},{type:"COMPILE",class:"icon-check",id:"compile-btn",title:"",href:"#",onclick:{electron:{c:"Mixly.Electron.ArduShell.initCompile()"},websocket:{c:"Mixly.WebSocket.ArduShell.initCompile()"},webcompiler:{c:"Mixly.WebCompiler.Compiler.compile()"}}},{type:"UPLOAD",class:"icon-upload",id:"upload-btn",title:"",href:"#",onclick:{electron:{c:"Mixly.Electron.ArduShell.initUpload()",mpy:"Mixly.Electron.BU.initUpload()"},web:{mpy:"Mixly.Web.BU.initUpload()"},webcompiler:{c:"Mixly.WebCompiler.Compiler.upload()",mpy:"Mixly.Web.BU.initUpload()"},websocket:{c:"Mixly.WebSocket.ArduShell.initUpload()",mpy:"Mixly.WebSocket.BU.initUpload()"}}},{type:"SIMULATE",class:"icon-play-circled",id:"simulate_btn",title:"",href:"#",onclick:{electron:{c:"Mixly.AvrSimulate.initSimulate()"}}},{type:"RUN",class:"icon-play-circled",id:"run-btn",title:"",href:"#",onclick:{electron:{py:"Mixly.Electron.PythonShell.run()"}}},{type:"STOP",class:"icon-cancel",id:"stop-btn",title:"",href:"#",onclick:{electron:{py:"Mixly.Electron.PythonShell.stop()"}}},{type:"WEBPY_SETP_RUN",class:"icon-play-circled",id:"step-run-btn",title:"",href:"#",onclick:"pyengine.steprun()"},{type:"WEBPY_RUN",class:"icon-play-circled",id:"run-btn",title:"",href:"#",onclick:"pyengine.run()"},{type:"WEBPY_STOP",class:"icon-cancel",id:"stop-btn",title:"",href:"#",onclick:"pyengine.kill()"},{type:"SERIAL",class:"icon-usb",id:"serial-btn",title:"",href:"#",onclick:{electron:{mpy:"Mixly.Electron.Serial.openTool()",c:"Mixly.Electron.Serial.openTool()"},web:{mpy:"Mixly.Web.Serial.openTool()"},webcompiler:{mpy:"Mixly.Web.Serial.openTool()",c:"Mixly.Web.Serial.openTool()"},websocket:{mpy:"Mixly.WebSocket.Serial.openTool()",c:"Mixly.WebSocket.Serial.openTool()"}}},{type:"STATUS_BAR",class:"icon-window",id:"statusbar-btn",title:"",href:"#",onclick:"Mixly.StatusBar.show(0)"}],y.LEFT_BTN_ENV={UNDO:!0,REDO:!0,CONNECT:!e.isElectron&&"py"!=i&&"webpy"!=i,BURN:y.CONFIG.burn&&!(!e.isElectron&&"MixGo AI"===f?.boardType&&!e.hasSocketServer),COMPILE:y.CONFIG.compile,UPLOAD:y.CONFIG.upload,SIMULATE:y.CONFIG.simulate,RUN:y.CONFIG.run,STOP:y.CONFIG.cancel,WEBPY_SETP_RUN:y.CONFIG.websteprun,WEBPY_RUN:y.CONFIG.webrun,WEBPY_STOP:y.CONFIG.webcancel,SERIAL:"py"!=i&&"webpy"!=i},y.RIGHT_BTN_CONFIG=[{type:"FILE",class:"",id:"file-btn",title:"",href:"javascript:;",onclick:"",children:[{type:"NEW_FILE",class:"icon-doc-new",id:"new-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.File.newFile()",web:"Mixly.Web.File.new()",webcompiler:"Mixly.Web.File.new()",websocket:"Mixly.Web.File.new()"}},{type:"OPEN_FILE",class:"icon-folder-open-empty",id:"open-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.File.open()",web:"Mixly.Web.File.open()",websocket:{electron:"Mixly.Electron.File.open()",web:"Mixly.Web.File.open()"},webcompiler:{electron:"Mixly.Electron.File.open()",web:"Mixly.Web.File.open()"}}},{type:"OPEN_FROM_CLOUD",class:"icon-download-cloud-1",id:"open-from-cloud-btn",title:"",href:"#",onclick:{websocket:{web:"Mixly.WebSocket.File.openFromCloud()"}}},{type:"SAVE_FILE",class:"icon-floppy",id:"save-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.File.save()",websocket:{electron:"Mixly.Electron.File.save()",web:"Mixly.Web.File.save()"},webcompiler:{electron:"Mixly.Electron.File.save()",web:"Mixly.Web.File.save()"},web:"Mixly.Web.File.save()"}},{type:"SAVE_AS_FILE",class:"icon-save-as",id:"save-as-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.File.saveAs()",websocket:{electron:"Mixly.Electron.File.saveAs()",web:"Mixly.Web.File.saveAs()"},webcompiler:{electron:"Mixly.Electron.File.saveAs()",web:"Mixly.Web.File.saveAs()"},web:"Mixly.Web.File.saveAs()"}},{type:"SAVE_TO_CLOUD",class:"icon-upload-cloud-1",id:"save-to-cloud-btn",title:"",href:"#",onclick:{websocket:{web:"Mixly.WebSocket.File.saveToCloud()"}}},{type:"SAVE_XML",class:"icon-floppy",id:"save-xml-btn",title:"",href:"#",onclick:{web:"save()",websocket:{web:"save()"},webcompiler:{web:"save()"}}},{type:"SAVE_PY",class:"icon-file-code",id:"save-py-btn",title:"",href:"#",onclick:{web:"mixlyjs.savePyFileAs()",websocket:{web:"mixlyjs.savePyFileAs()"},webcompiler:{web:"mixlyjs.savePyFileAs()"}}},{type:"SAVE_INO",class:"icon-file-code",id:"save-ino-btn",title:"",href:"#",onclick:{web:"mixlyjs.saveInoFileAs()",websocket:{web:"mixlyjs.saveInoFileAs()"},webcompiler:{web:"mixlyjs.saveInoFileAs()"}}},{type:"SAVE_HEX",class:"icon-file-code",id:"save-hex-btn",title:"",href:"#",onclick:{web:"mixlyjs.compileMicrobitPy()",websocket:{web:"mixlyjs.compileMicrobitPy()"},webcompiler:{web:"mixlyjs.compileMicrobitPy()"}}},{type:"SAVE_IMG",class:"icon-floppy",id:"save-img-btn",title:"",href:"#",onclick:{web:"mixlyjs.saveBlockImg()",websocket:{web:"mixlyjs.saveBlockImg()"},webcompiler:{web:"mixlyjs.saveBlockImg()"}}},{type:"EXPORT_LIB",class:"icon-export",id:"export-libraries-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.File.exportLib()"}}]},{type:"SETTING",class:"",id:"setting-btn",title:"",href:"javascript:;",onclick:"",children:[{type:"MANAGE_LIB",class:"icon-menu",id:"manage-libraries-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.LibManager.showManageDialog()"}},{type:"OTHER_BIN",class:"icon-upload-1",id:"other-burn-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.BU.burnWithSpecialBin()"}},{type:"WS_CONNECT",class:"icon-link",id:"socket-connect-btn",title:"",href:"#",onclick:{websocket:"Mixly.WebSocket.Socket.clickConnect()"}},{type:"PYTHON_TO_BLOCKLY",class:"toggle-off-1",id:"python-to-blockly-btn",title:"",href:"#",onclick:"Mixly.Editor.py2BlockEditorChangeStatus()"},{type:"OPEN_WIKI",class:"icon-book-open",id:"wiki-btn",title:"",href:"#",onclick:{electron:"Mixly.Electron.WikiManager.openWiki()"}},{type:"FEED_BACK",class:"icon-comment-1",id:"feedback-btn",title:"",href:"#",onclick:"Mixly.Interface.feedback()"}]}],y.RIGHT_BTN_ENV={SETTING:!0,EXPORT_LIB:e.isElectron&&y.CONFIG.setting.thirdPartyLibrary,MANAGE_LIB:e.isElectron&&y.CONFIG.setting.thirdPartyLibrary,OTHER_BIN:y.CONFIG.burn&&"object"==typeof f?.burn?.special,WS_CONNECT:"websocket"===l,FILE:!0,NEW_FILE:!0,OPEN_FILE:!0,OPEN_FROM_CLOUD:!e.isElectron&&e.hasSocketServer,SAVE_FILE:e.isElectron,SAVE_AS_FILE:e.isElectron,SAVE_XML:!e.isElectron,SAVE_PY:!e.isElectron&&y.CONFIG.save.py,SAVE_INO:!e.isElectron&&y.CONFIG.save.ino,SAVE_HEX:!e.isElectron&&y.CONFIG.save.py&&y.CONFIG.save.hex,SAVE_IMG:!e.isElectron&&y.CONFIG.save.img,SAVE_TO_CLOUD:!e.isElectron&&e.hasSocketServer,PYTHON_TO_BLOCKLY:y.CONFIG?.setting?.pythonToBlockly&&["mpy","py","webpy"].includes(i),OPEN_WIKI:e.isElectron&&y.CONFIG.setting.wiki,FEED_BACK:!0},y.generateBtnConfig=(e,t=null)=>{var o={class:e.class,id:e.id,title:e.title,href:e.href},e=e["onclick"];if("string"==typeof e)o.onclick=e;else if("object"==typeof e){e=e[l];if("string"==typeof e)o.onclick=e;else if("object"==typeof e)if(["electron","web"].includes(l)){var r=e[i];if("string"==typeof r)o.onclick=r;else{if(!t)return null;o.onclick=t}}else if(["websocket","webcompiler"].includes(l)){r=e[i],e=e[a];if("string"==typeof r)o.onclick=r;else if("string"==typeof e)o.onclick=e;else if("object"==typeof e){r=e[i];if("string"==typeof r)o.onclick=r;else{if(!t)return null;o.onclick=t}}else{if(!t)return null;o.onclick=t}}else{if(!t)return null;o.onclick=t}else{if(!t)return null;o.onclick=t}}return o};var r,n={type:null,class:"",id:"id",title:"",href:"#",onclick:"",children:null},s=[];for(r of y.LEFT_BTN_CONFIG){var c=(r={...n,...r})["type"];y.LEFT_BTN_ENV[c]&&(c=y.generateBtnConfig(r))&&s.push(c)}var d,g,u=[];for(d of y.RIGHT_BTN_CONFIG){var{type:p,children:A}=d={...n,...d};if(y.RIGHT_BTN_ENV[p]&&"object"==typeof A){var h,p=d["children"],C=y.generateBtnConfig(d,"");C.children=[];for(h of p){var v=h.type;y.RIGHT_BTN_ENV[v]&&(v=y.generateBtnConfig(h))&&C.children.push(v)}u.push(C)}}console.log(s),console.log(u),y.LEFT_BTN_DOM_STR=["",""];for(let e=0;e<s.length;e++)"object"==typeof s[e]&&(g=s[e],y.LEFT_BTN_DOM_STR[0]+="<dd lay-unselect>"+`<a href="${g.href}" class="${g.class}" id="operate-${g.id}" onclick="${g.onclick}"></a>`+"</dd>",y.LEFT_BTN_DOM_STR[1]+=`<button 
                                    type="button"
                                    id="li_${g.id}"
                                    class="layui-btn layui-btn-xs layui-btn-primary"
                                    title="${g.title}"
                                    onclick="${g.onclick}"
                                >
                                    <a id="${g.id}" class="${g.class}"></a>
                                </button>`);y.RIFHT_BTN_DOM_STR="";for(let t=0;t<u.length;t++){y.RIFHT_BTN_DOM_STR+=`<li class="layui-nav-item" style="float:right" lay-unselect>
                                <a href="javascript:;" id="${u[t].id}" style="white-space: nowrap;"></a>
                                <dl class="layui-nav-child">`;for(let e=0;e<u[t].children.length;e++){var{id:B,title:w,href:E,onclick:M}=u[t].children[e],I=u[t].children[e].class;y.RIFHT_BTN_DOM_STR+=`<dd lay-unselect>
                                    <a href='${E}' id='${B}' class='${I}' title='${w}' onclick='${M}'></a>
                                </dd>`}y.RIFHT_BTN_DOM_STR+="</dl></li>"}function k(e,t){var o=document.getElementById(e);o&&("A"==o.tagName&&-1!=o.parentNode.innerHTML.indexOf("<dl")?o.innerHTML=Blockly.Msg.MSG[t]+'<i class="layui-icon layui-icon-down layui-nav-more"></i>':document.getElementById(e).innerHTML=Blockly.Msg.MSG[t])}y.DOM_STR=`
<ul
    id="nav"
    class="layui-nav ${"light"===o.theme?"layui-bg-green":"layui-bg-cyan"}"
    lay-filter="nav-filter"
    style="width: 100vw;display: flex;flex-direction: row;justify-content: space-between;"
>
    <div
        id="nav-left-btn-list"
        style="display: flex;flex-direction: row;justify-content: flex-start;align-items: center;"
    >
        <button
            type="button"
            id="mixly-path"
            class="layui-btn layui-btn-xs layui-btn-primary"
            style="cursor:pointer;"
            onclick="Mixly.${"electron"===l?"Electron.Loader":"Interface"}.onbeforeunload()"
        >
            Mixly
        </button>
        <li class="layui-nav-item" id="li_operate" style="display:none;" lay-unselect>
            <a href="javascript:;" id="operate-btn" style="white-space: nowrap;">
                <span class="layui-nav-more"></span>
            </a>
            <dl class="layui-nav-child">
                <!-- 二级菜单 -->
                ${y.LEFT_BTN_DOM_STR[0]}
            </dl>
        </li>
        ${y.LEFT_BTN_DOM_STR[1]}
    </div>
    <div style="display: inline-flex;flex-direction: row;align-items: center;">
        <a id="copyright"></a>
    </div>
    <div
        id="nav-right-btn-list"
        style="display: inline-flex;flex-direction: row;justify-content: flex-end;align-items: center;"
    >
        <button
            title='状态栏'
            m-id="h-bar"
            class="layui-btn layui-btn-xs layui-btn-primary"
            style="padding: 0 2px;"
        >
            <a
                href="javascript:;"
                class="icon-show-bar-s"
            ></a>
        </button>
        <button
            m-id="v-bar"
            title='侧边栏'
            class="layui-btn layui-btn-xs layui-btn-primary"
            style="padding: 0 2px;"
        >
            <a
                href="javascript:;"
                class="icon-show-bar-e"
            ></a>
        </button>
        <button
            m-id="code-area"
            title='模式切换'
            class="layui-btn layui-btn-xs layui-btn-primary"
            style="padding: 0 2px;"
        >
            <a
                href="javascript:;"
                class="icon-code-1"
                style="font-size: 16px;"
            ></a>
        </button>
        ${m.TEMPLATE_STR_RENDER.BOARD_SELECTOR??""}
        ${m.TEMPLATE_STR_RENDER.PORT_SELECTOR??""}
        ${y.RIFHT_BTN_DOM_STR}
    </div>
</ul>
`,y.LEFT_BTN_LIST=s,y.RIGHT_BTN_LIST=u,Mixly.Nav.MsgById={"undo-btn":"undo","redo-btn":"redo","connect-btn":"connect","burn-btn":"burn","compile-btn":"compile","upload-btn":"upload","step-run-btn":"step_run","run-btn":"run","stop-btn":"stop","serial-btn":"catSerialPort","statusbar-btn":"statusbar","file-btn":"file","new-btn":"new","open-btn":"open","open-from-cloud-btn":"open_from_cloud","save-btn":"save","save-xml-btn":"save_blocks","save-ino-btn":"save_ino","save-img-btn":"save_img","save-py-btn":"save_py","save-hex-btn":"save_hex","save-to-cloud-btn":"save_ser","save-as-btn":"save_as","setting-btn":"setting","language-btn":"language","theme-btn":"theme","import-libraries-btn":"import_libraries","export-libraries-btn":"export_libraries","manage-libraries-btn":"manage_libraries","windows-size-btn":"windowSize","socket-connect-btn":"connect","other-burn-btn":"other_firmware","wiki-btn":"wiki","feedback-btn":"feedback"},y.init=()=>{if($("body").append(y.DOM_STR),y.navBtnConfig={leftBtn:y.LEFT_BTN_LIST,rightBtn:y.RIGHT_BTN_LIST},k("tab_blocks","tab_blocks"),k("tab_arduino","tab_arduino"),"1"===$("#changemod-btn").attr("value")?k("changemod-btn","tab_blocks"):k("changemod-btn","tab_arduino"),y.RIGHT_BTN_ENV.PYTHON_TO_BLOCKLY&&(e=$("#python-to-blockly-btn"),f?.pythonToBlockly??!1?e.html(Blockly.Msg.MSG.disablePythonToBlockly).attr("class","icon-toggle-on-1"):e.html(Blockly.Msg.MSG.enablePythonToBlockly).attr("class","icon-toggle-off-1")),document.getElementById("boardSelector")&&(document.getElementById("boardSelector").placeholder=Blockly.Msg.MSG.fn),k("operate-btn","operate"),k("operate_save_ser_btn","save_ser"),k("change_board_btn","change_board"),k("view_btn","view_btn"),k("save_ser_btn","save_ser"),k("view_file","view_file"),"object"==typeof Mixly.Nav.navBtnConfig.leftBtn){var t=Mixly.Nav.navBtnConfig.leftBtn.length;for(let e=0;e<t;e++){var o=Mixly.Nav.navBtnConfig.leftBtn[e].id,r=Mixly.Nav.MsgById[o];r&&(k(o,r),k("operate-"+o,r))}}if("object"==typeof Mixly.Nav.navBtnConfig.rightBtn){var i=Mixly.Nav.navBtnConfig["rightBtn"],l=i.length;for(let e=0;e<l;e++){var a=i[e].id,n=Mixly.Nav.MsgById[a],s=(n&&k(a,n),Mixly.Nav.navBtnConfig.rightBtn[e])["children"];if("object"==typeof s){var c=s.length;for(let e=0;e<c;e++){var d=s[e].id,g=Mixly.Nav.MsgById[d];g&&k(d,g)}}}}if(b.init(),x.render("select","boards-type-filter"),m.TEMPLATE_ENV.PORT_SELECTOR&&x.render("select","ports-type-filter"),y.navItemId=[],"object"==typeof y.LEFT_BTN_LIST){var u=y.LEFT_BTN_LIST.length;for(let e=0;e<u;e++){var p=y.LEFT_BTN_LIST[e].id;y.navItemId.push("li_"+p)}}var e=$("#nav"),A=$("#nav-left-btn-list"),h=$("#li_operate");if(y.leftWidth=A.offset().left+A.width(),e[0].scrollWidth>e[0].offsetWidth){for(let e=0;e<y.navItemId.length;e++)$("#"+y.navItemId[e]).css("display","none");h.css("display","-webkit-box")}}}),goog.loadJs("common",()=>{goog.require("Blockly"),goog.require("Mixly.Config"),goog.require("Mixly.Nav"),goog.require("Mixly.XML"),goog.require("Mixly.Msg"),goog.provide("Mixly.Editor");const{Config:i,XML:o,Msg:r,Editor:d}=Mixly,{BOARD:g,USER:l,SOFTWARE:e}=i;d.DIV_NAME={CODE:"code-editor",BLOCK:"block-editor"},d.selected="BLOCK",d.init=()=>{$("#mixly-footer-codelang").html(g.language??"未知"),d.codeEditorInit(),d.blockEditorInit();const{blockEditor:a,codeEditor:n}=d;let s;switch(g.language){case"Python":case"CircuitPython":case"MicroPython":s=Blockly.Python,n.getSession().setMode("ace/mode/python"),n.getSession().setTabSize(4),"dark"===l.theme?n.setTheme("ace/theme/dracula"):n.setTheme("ace/theme/crimson_editor"),d.py2BlockEditorInit(n);break;case"C/C++":s=Blockly.Arduino,n.getSession().setTabSize(2),n.getSession().setMode("ace/mode/c_cpp"),"dark"===l.theme?n.setTheme("ace/theme/dracula"):n.setTheme("ace/theme/xcode");break;default:s=Blockly.Python??Blockly.Arduino}function c(){let e=g.boardIndex??"";return e=e.replaceAll("\\","/"),(g.thirdPartyBoard?e.match(/(?<=boards\/extend\/)[^?\/\\、*\"><|]+/g):e.match(/(?<=boards\/default\/)[^?\/\\、*\"><|]+/g))[0]}d.codeChangeEvent=a.addChangeListener(function(e){if(e.type!==Blockly.Events.UI&&"BLOCK"===d.selected){var t=s.workspaceToCode(a)||"";if(t=t.replace(/(_E[0-9A-F]{1}_[0-9A-F]{2}_[0-9A-F]{2})+/g,function(t){try{return decodeURIComponent(t.replace(/_/g,"%"))}catch(e){return t}}),-1!==g.boardIndex.indexOf("/python_mixpy/"))try{t.match(/(?<![\w+])input\(/g)&&(t="\n"+t)}catch(e){console.log(e)}else if(!("python_skulpt_mixtoy"!==c()&&"python_skulpt_car"!==c()||-1==t.indexOf("import blocktool")&&-1==t.indexOf("import blocklygame")&&-1==t.indexOf("from blocklygame import"))){var o=[];o=t.split("\n");for(var r,i,l=0;l<o.length;l++)0<=o[l].indexOf("block_id")&&(r="",null!=(i=/,?'block_id=[\s\S]*'/.exec(o[l])))&&(r=i[0],o[l]=o[l].replace(r,"")),(0<=o[l].indexOf("import blocktool")||0<=o[l].indexOf("blocktool.highlight"))&&(o[l]="delete");t="";for(l=0;l<o.length;l++)"delete"!=o[l]&&(t+=o[l]+"\n")}n.setValue(t,-1)}}),"true"===e?.socketServer?.enabled&&Mixly.WebSocket.Socket.init()},d.blockEditorInit=()=>{var e=i.pathPrefix+"common/media/",t=$("#toolbox")[0],o=["geras","zelos"].includes(l.blockRenderer)?l.blockRenderer:"geras",r="yes"===l.blocklyShowGrid?{spacing:20,length:3,colour:"#ccc",snap:!0}:{};d.blockEditor=Blockly.inject($("#"+d.DIV_NAME.BLOCK)[0],{media:e,toolbox:t,renderer:o,zoom:{controls:!0,wheel:!0,scaleSpeed:1.03},grid:r}),"dark"===l.theme?d.blockEditor.setTheme(Blockly.Themes.Dark):d.blockEditor.setTheme(Blockly.Themes.Classic)},d.codeEditorInit=()=>{d.codeEditor=ace.edit(d.DIV_NAME.CODE);var e=d["codeEditor"];e.setFontSize(Math.max($("body").width()/85,$("body").height()/85,12)),e.setShowPrintMargin(!1),e.setReadOnly(!0),e.setScrollSpeed(.8),e.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}),d.codeEditorAddCommands(),d.codeEditorAddBtn(),d.codeEditorMenuRender(),d.codeEditorAddEvent()},d.py2BlockEditorInit=e=>{var t;"object"==typeof Sk&&"function"==typeof PythonToBlocks&&"function"==typeof Py2blockEditor&&(t=new PythonToBlocks,d.py2BlockEditor=new Py2blockEditor(t,e),Sk.python3=!0)},d.redo=()=>{var{blockEditor:e,codeEditor:t}=d;"BLOCK"===d.selected?e.undo(1):t.redo()},d.undo=()=>{var{blockEditor:e,codeEditor:t}=d;"BLOCK"===d.selected?e.undo(0):t.undo()},d.codeEditorAddCommands=()=>{var e=d["codeEditor"];e.commands.addCommands([{name:"increaseFontSize",bindKey:"Ctrl-=|Ctrl-+",exec:function(e){var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(t+1)}},{name:"decreaseFontSize",bindKey:"Ctrl+-|Ctrl-_",exec:function(e){var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(t-1||1))}},{name:"resetFontSize",bindKey:"Ctrl+0|Ctrl-Numpad0",exec:function(e){e.setFontSize(Math.max($("body").width()/85,$("body").height()/85,12))}},{name:"exitCodeEditor",bindKey:"Ctrl+E",exec:function(e){"BLOCK"!==d.selected&&d.items.vDrag.full("POSITIVE")}}])},d.codeEditorAddBtn=()=>{var e=$("#"+d.DIV_NAME.CODE);e.append('<div id="resetFontSize" m-id="resetFontSize" class="code-editor-btn setFontSize" width="32" height="32" style="cursor:hand;display:none;"></div>'),e.append('<div id="increaseFontSize" m-id="increaseFontSize" class="code-editor-btn setFontSize" width="32" height="32" style="cursor:hand;display:none;"></div>'),e.append('<div id="decreaseFontSize" m-id="decreaseFontSize" class="code-editor-btn setFontSize" width="32" height="32" style="cursor:hand;display:none;"></div>'),e.children(".code-editor-btn").click(function(){switch($(this).attr("m-id")){case"resetFontSize":d.codeEditorRstFontSize();break;case"increaseFontSize":d.codeEditorIncFontSize();break;case"decreaseFontSize":d.codeEditorDecFontSize()}})},d.codeEditorShowBtn=()=>{$("#"+d.DIV_NAME.CODE).children(".code-editor-btn").css("display","block")},d.codeEditorHideBtn=()=>{$("#"+d.DIV_NAME.CODE).children(".code-editor-btn").css("display","none")},d.codeEditorMenuRender=()=>{const i=d["codeEditor"];var e='<div style="float:left;">{{d.name}}&nbsp</div><div style="float:right;">&nbsp{{d.hotKey}}</div>';let t=[];if("CODE"===d.selected)switch(t=[{title:o.render(e,{name:r.Lang["剪切"],hotKey:"Ctrl+X"}),id:"cut"},{title:o.render(e,{name:r.Lang["复制"],hotKey:"Ctrl+C"}),id:"copy"},{title:o.render(e,{name:r.Lang["粘贴"],hotKey:"Ctrl+V"}),id:"paste"},{type:"-"},{title:o.render(e,{name:r.Lang["全选"],hotKey:"Ctrl+A"}),id:"selectall"},{title:o.render(e,{name:r.Lang["查找"],hotKey:"Ctrl+F"}),id:"find"},{type:"-"},{title:o.render(e,{name:r.Lang["切换行注释"],hotKey:"Ctrl+/"}),id:"togglecomment"},{title:o.render(e,{name:r.Lang["切换块注释"],hotKey:"Ctrl+Shift+/"}),id:"toggleBlockComment"},{type:"-"},{title:o.render(e,{name:r.Lang["退出代码编辑器"],hotKey:"Ctrl+E"}),id:"exitCodeEditor"}],g.language){case"Python":case"CircuitPython":case"MicroPython":t.splice(8,1)}else t=[{title:o.render(e,{name:r.Lang["打开代码编辑器"],hotKey:""}),id:"openCodeEditor"}];layui.dropdown.render({elem:"#code-editor",trigger:"contextmenu",data:t,className:"editor-dropdown-menu",click:(t,e)=>{switch(t.id){case"selectall":case"find":case"togglecomment":case"toggleBlockComment":case"openCommandPallete":i.execCommand(t.id);break;case"cut":var o=i.selection.isEmpty()?i.selection.getLineRange():i.selection.getRange();i._emit("cut",o),o.isEmpty()||(r=i.session.getTextRange(o),navigator.clipboard.writeText(r).then(e=>{}).catch(e=>{}),i.session.remove(o)),i.clearSelection();break;case"copy":var r=i.getSelectedText();i.clearSelection(),r&&navigator.clipboard.writeText(r).then(e=>{}).catch(e=>{});break;case"paste":navigator.clipboard.readText().then(e=>{i.execCommand(t.id,e)}).catch(e=>{});break;case"openCodeEditor":"CODE"!==d.selected&&d.items.vDrag.full("NEGATIVE");break;case"exitCodeEditor":"BLOCK"!==d.selected&&d.items.vDrag.full("POSITIVE")}}})},d.codeEditorIncFontSize=()=>{var e=d["codeEditor"],t=parseInt(e.getFontSize(),10)||12;e.setFontSize(t+1)},d.codeEditorDecFontSize=()=>{var e=d["codeEditor"],t=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(t-1||1))},d.codeEditorRstFontSize=()=>{var e=d["codeEditor"];e.setFontSize(Math.max($("body").width()/85,$("body").height()/85,12))},d.codeEditorAddEvent=()=>{const t=d["codeEditor"],o=($("#mixly-footer-cursor").hide(),t.on("focus",function(){$("#mixly-footer-cursor").show()}),t.on("blur",function(){$("#mixly-footer-cursor").hide()}),t.getSession())["selection"];o.on("changeCursor",function(){var e=o.getCursor();$("#mixly-footer-row").html(e.row+1),$("#mixly-footer-column").html(e.column+1)}),o.on("changeSelection",function(){var e;o.isEmpty()?$("#mixly-footer-selected").parent().hide():(e=o.getRange(),e=t.session.getTextRange(e),$("#mixly-footer-selected").parent().css("display","inline-flex"),$("#mixly-footer-selected").html(e.length))})},d.blockEditorUpdateCode=()=>{var e=d["blockEditor"];e.fireChangeListener(d.codeChangeEvent)},d.py2BlockEditorChangeStatus=()=>{var e=$("#python-to-blockly-btn");g.pythonToBlockly??!1?(e.html(MSG.enablePythonToBlockly).attr("class","icon-toggle-off-1"),g.pythonToBlockly=!1):(e.html(MSG.disablePythonToBlockly).attr("class","icon-toggle-on-1"),g.pythonToBlockly=!0)}}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Mixly.Editor"),goog.require("Mixly.Msg"),goog.provide("Mixly.LevelSelector");const{Editor:o,Msg:r,LevelSelector:i}=Mixly,e=layui["form"];i.nowLevel=-1,i.XML_STR=[`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_1">
        </block>
    </xml>`,`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_2">
        </block>
    </xml>`,`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_3">
        </block>
    </xml>`,`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_4">
        </block>
    </xml>`,`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_5">
        </block>
    </xml>`,`<xml xmlns="https://developers.google.com/blockly/xml">
        <block type="initSettedMap_6">
        </block>
    </xml>`],i.init=()=>{$("#nav-right-btn-list").prepend(`
        <div
            id="level-selector"
            class="layui-form mixly-scrollbar"
            lay-filter="level-selector-filter"
            style="
                width: 90px;
                height: 28px;
                margin-right: 10px;
            "
        >
            <select id="level-type" spellcheck="false" lay-filter="level-type-filter"></select>
        </div>
    `);var t=$("#level-type");t.empty();for(let e=1;e<7;e++)t.append(`<option value="${e}">${r.Lang["关卡"]} ${e}</option>`);e.render("select","level-selector-filter"),e.on("select(level-type-filter)",function(e){i.nowLevel!==e.value&&(i.nowLevel=e.value,i.xmlToWorkspace(e.value))})},i.xmlToWorkspace=e=>{if(!(e<1||6<e)){e=i.XML_STR[--e];try{o.blockEditor.clear();var t=Blockly.Xml.textToDom(e);Blockly.Xml.domToWorkspace(t,o.blockEditor),o.blockEditor.scrollCenter()}catch(e){o.blockEditor.clear(),console.log(e)}}}}),goog.loadJs("common",()=>{goog.require("Blockly"),goog.require("Mixly.XML"),goog.require("Mixly.Editor"),goog.require("Mixly.Msg"),goog.provide("Mixly.ToolboxSearcher");const{XML:t,Editor:x,Msg:C,ToolboxSearcher:e}=Mixly;e.init=function(){this.workspace=new Blockly.Workspace(new Blockly.Options({toolbox:""}));var e=t.TEMPLATE_DOM.SEARCH_DIV;$(".blocklyToolboxDiv").append(e),this.btnDom=e.find("button"),this.inputDom=e.find("input"),this.preKeyText="",this.btnDom.click(()=>{this.startSearch()}),this.inputDom.change(e=>{this.startSearch()}),this.inputDom.bind("input propertychange",e=>{var t=x.blockEditor.getToolbox(),o=t.getToolboxItemById("catSearch"),e=e.target.value;try{if(!e.replaceAll(" ",""))return o.hide(),void this.btnDom.addClass("layui-btn-disabled");o.show(),$(t.HtmlDiv).scrollTop(t.HtmlDiv.scrollHeight)}catch(e){console.log(e)}e===this.preKeyText?this.btnDom.addClass("layui-btn-disabled"):this.btnDom.removeClass("layui-btn-disabled")})},e.getCategoryPath=e=>{let t="";for(;e;e=e.getParent())t=e.toolboxItemDef_.name+(t&&" > "+t);return t},e.searchBlocks=function(b){return new Promise((e,t)=>{var o=x.blockEditor.getToolbox(),r=o.getToolboxItemById("catSearch"),i=[],l=o.getToolboxItems();for(let e=0;l[e];e++){var a,n=l[e];if("catSearch"!==n.id_&&"function"==typeof n.getContents){let o=!0;for(a of n.getContents()){var s,{kind:c,blockxml:d}=a;if("BLOCK"===c){this.workspace.clear();try{Blockly.Xml.domToBlock(d,this.workspace)}catch(e){console.log(e);continue}let t=!1;for(s of this.workspace.getAllBlocks(!0)){var g,u=[...b],p=s["inputList"];for(g of p){var A,h=g["fieldRow"];for(A of h){var y,m=A.getText().toLowerCase();for(let e=0;e<u.length;e++)if(-1!==m.indexOf(u[e])&&(u.splice(e,1),e--,!u.length)){o&&(y=this.getCategoryPath(n),i.push({kind:"LABEL",text:y}),o=!1),i.push(a),t=!0;break}if(t)break}if(t)break}if(t)break}}}}}if(this.workspace.clear(),30<i.length){let e=0;for(;!(i.length<=30&&"LABEL"===i[i.length-1].kind);)"BLOCK"===i[i.length-1].kind&&e++,i.pop();i.pop();let t=0;for(var f of i)"BLOCK"===f.kind&&t++;i.unshift({kind:"LABEL",text:C.Lang["共搜索到图形块"]+": "+(e+t)+"，"+C.Lang["显示"]+": "+t+"，"+C.Lang["请添加关键词以显示全部。例如：管脚 数字"]})}r.updateFlyoutContents(i.length?i:[{kind:"LABEL",text:C.Lang["无数据"]}]),o.refreshSelection(),$(r.getDiv()).children().first().hasClass("blocklyTreeSelected")||r.getClickTarget().click(),$(o.HtmlDiv).scrollTop(o.HtmlDiv.scrollHeight),e()})},e.startSearch=function(){if(!this.btnDom.hasClass("layui-btn-disabled")){let r=this.inputDom.val();this.preKeyText=r,this.btnDom.addClass("layui-btn-disabled");try{if(!r.replaceAll(" ",""))return}catch(e){console.log(e)}this.inputDom.attr("disabled",!0);const i=this.btnDom.children("i");i.removeClass("layui-icon-search"),i.addClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),window.setTimeout(()=>{var e,t=r.split(" "),o=[];for(e in t)t[e]&&o.push(t[e].toLowerCase());this.searchBlocks(o).then(()=>{}).catch(e=>{console.log(e)}).finally(()=>{i.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),i.addClass("layui-icon-search"),this.inputDom.removeAttr("disabled")})},100)}},e.restart=function(){this.preKeyText="";var e=x.blockEditor.getToolbox().getToolboxItemById("catSearch");this.inputDom.val(""),e.hide()}}),goog.loadJs("common",()=>{goog.require("tippy"),goog.require("layui"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.XML"),goog.require("Mixly.Env"),goog.require("Mixly.ToolboxSearcher"),goog.require("Mixly.Modules"),goog.require("Mixly.MString"),goog.require("Mixly.Editor"),goog.require("Mixly.FooterLayer"),goog.require("Mixly.Msg"),goog.require("Mixly.BoardConfigMenu"),goog.require("Mixly.BoardConfigItem"),goog.require("Mixly.FooterBar"),goog.provide("Mixly.Boards");const{Config:e,XML:l,Env:m,ToolboxSearcher:a,Modules:f,MString:b,Editor:n,Msg:s,Boards:x,BoardConfigItem:r,BoardConfigMenu:i}=Mixly,c=layui["form"],{BOARD:C,USER:d,SELECTED_BOARD:v}=e;x.INFO={},x.NAME=[],x.HAS_CONFIG_SETTING=!1,x.init=()=>{if(x.dict={},C.board instanceof Object||C.board instanceof String)for(var e in C.board)x.dict[e]=new r(e,C.board[e]),d.board&&d.board[C.boardType]&&x.dict[e].setSelectedOptions(d.board[C.boardType].default);else x.dict[C.boardType]=new r(C.boardType,C.boardType);x.NAME=Object.keys(x.dict),x.configMenu=new i("mixly-board-config",x.dict);var t=$("#boards-type");if(t.length){t.empty();for(var o of Object.keys(x.dict))t.append(`<option value="${x.dict[o].key}">${o}</option>`);c.render("select","boards-type-filter")}Mixly.FooterBar.init()},x.getType=()=>{let e=C.boardIndex??"";return e=e.replaceAll("\\","/"),(C.thirdPartyBoard?e.match(/(?<=boards\/extend\/)[^?\/\\、*\"><|]+/g):e.match(/(?<=boards\/default\/)[^?\/\\、*\"><|]+/g))[0]},x.getSelectedBoardName=()=>$("#boards-type option:selected").text(),x.getSelectedBoardKey=()=>$("#boards-type option:selected").val(),x.setSelectedBoard=(e,t)=>{var o=e.indexOf("@");-1!==o&&(e=e.substring(o+1,e.length)),x.NAME.includes(e)&&((o=x.dict[e])&&o.key&&($("#boards-type").val(o.key),o.setSelectedOptions(t),c.render("select","boards-type-filter")),x.changeTo(e),x.updateCategories(e),"object"==typeof profile)&&profile[e]&&(profile.default=profile[e])},x.getSelectedBoardConfig=()=>{var e=x.getSelectedBoardName();return x.dict[e]?.selectedOptions??null},x.getBoardCommandParam=e=>{if(!x.dict[e])return null;e=x.dict[e];let{key:t,ignore:o=[]}=e;var r=e["selectedOptions"];if(!t)return null;e=t.indexOf("@");let i=t=-1!==e?t.substring(0,e):t;if("object"==typeof r){for(var l in i+=":",r)o.includes(l)||(i+=l+"="+r[l].key+",");i=i.substring(0,i.length-1)}return i},x.getSelectedBoardCommandParam=()=>{var e=x.getSelectedBoardName();return x.getBoardCommandParam(e)},x.getSelectedBoardConfigParam=e=>{var t=x.getSelectedBoardConfig();return t&&"object"==typeof t?t[e].key??"":""},x.changeTo=e=>{(profile="object"==typeof profile?profile:{})[e]?profile.default=profile[e]:profile.default=profile.default??{};var t,o,r,i=x.dict[e].key;for(t in v)delete v[t];for(o in C)C[o]instanceof Object?v[o]={...C[o]}:v[o]=C[o];if(C.web instanceof Object)for(var l of[{type:"burn",obj:C.web.burn},{type:"upload",obj:C.web.upload}])if(l.obj instanceof Object){let e;for(var a in e=l.obj[i]?{...l.obj,...l.obj[i]}:{...l.obj},x.dict){a=x.dict[a].key;e[a]&&delete e[a]}v.web[l.type]=e}for(r of[{type:"burn",obj:C.burn},{type:"upload",obj:C.upload}])if(r.obj instanceof Object){let t;for(var n in t=r.obj[i]?{...r.obj,...r.obj[i]}:{...r.obj},x.dict){n=x.dict[n].key;t[n]&&delete t[n]}var s={path:m.clientPath,indexPath:m.indexDirPath,srcPath:m.srcPath};switch(t.type){case"volume":if("win32"==m.currentPlatform)if("string"==typeof t.volumeName)t.volume="VolumeName='"+t.volumeName+"'";else if("object"==typeof t.volumeName){t.volume="VolumeName='"+t.volumeName[0]+"'";for(let e=1;e<t.volumeName.length;e++)t.volume+=" or VolumeName='"+t.volumeName[e]+"'"}else t.volume="VolumeName='CIRCUITPY'";else if("string"==typeof t.volumeName)t.volume=t.volumeName;else if("object"==typeof t.volumeName){t.volume=t.volumeName[0];for(var c=1;c<t.volumeName.length;c++)t.volume+="/"+t.volumeName[c]}else t.volume="CIRCUITPY";break;case"command":var d,g={},u={esptool:"esptool.py",kflash:"kflash.py",stm32loader:"stm32loader.py",stm32bl:"stm32bl.py",ampy:"ampy/cli.py"};for(d in u)g[d]=m.python3Path+'" "{srcPath}/pyTools/'+u[d];if(t.reset){let e="{}";try{e=(e=JSON.stringify(t.reset)).replaceAll('"','\\"'),g.reset=e}catch(e){console.log(e)}}if(t.command=b.tpl(t.command,g),t.command=b.tpl(t.command,s),t.special&&t.special instanceof Array)for(var p in t.special)t.special[p]?.name&&t.special[p]?.command&&(t.special[p].command=b.tpl(t.special[p].command,g),t.special[p].command=b.tpl(t.special[p].command,s))}if("upload"===r.type&&(m.isElectron||m.hasSocketServer)&&t.copyLib){var A=f["path"];if(t.libPath){var h,y=[];for(h of t.libPath)y.push(b.tpl(h,s));t.libPath=y}else m.isElectron?t.libPath=[A.resolve(m.indexDirPath,"build/lib/")]:t.libPath=goog.normalizePath_(m.indexDirPath+"/build/lib/")}(m.isElectron||m.hasSocketServer)&&(A=f["path"],t.filePath?t.filePath=b.tpl(t.filePath,s):m.isElectron?t.filePath=A.resolve(m.indexDirPath,"build/main.py"):t.filePath=goog.normalizePath_(m.indexDirPath+"/build/main.py")),v[r.type]=t}},x.updateCategories=(t,o=!1)=>{if(x.selected!==t||o){x.selected=t,$("#mixly-footer-boardname").html(t),x.configMenu.changeTo(t);let e="";m.isElectron&&(e=m.thirdPartyXML.join(""));var o='<category id="catSearch" hidden="true" colour="#ff6666"><label text="'+s.Lang["无数据"]+'"></label></category>',r=(e=x.selectCategories(t,e),$("#toolbox")),i=(r.html(x.selectCategories(t,l.CATEGORIES_STR[t]??m.defaultXML)),r.append(e),r.append(o),r.find("category"));for(let e=0;i[e];e++)i[e].hasAttribute("toolboxitemid")||i[e].setAttribute("toolboxitemid",i[e].id);Code.initLanguage(!1),n.blockEditor&&(n.blockEditor.updateToolbox(r[0]),a.restart(),n.blockEditor.scrollCenter(),Blockly.hideChaff())}},x.selectCategories=(e,t)=>{var o=(x.dict[e]?x.dict[e].key:"").split(":");if(!o.length)return t;var e=$("<xml></xml>"),r=(e.html(t),e.find("category"));for(let e=0;r[e];e++)if(!x.removeBlocks($(r[e]),o)){var i=$(r[e]).children("block");for(let e=0;i[e];e++)x.removeBlocks($(i[e]),o)}return e.html()},x.removeBlocks=(t,o)=>{var r,i=t.attr("m-show"),l=t.attr("m-hide");if(i||l){let e=!!i;for(r of(i||l).split(" ")){var a=r.split(":"),n=a.length;if([1,2,3].includes(n)){if([2,3].includes(n)){n=3===n?String(a[2]).split(","):[];if(a[0]===o[0]&&a[1]===o[1]){if(!n.length){e=!i;break}for(var s of n)if(s===o[2]){e=!i;break}}}else if(a[0]===o[2]){e=!i;break}if(!e&&i||e&&!i)break}}if(e)return t.remove(),!0}return!1}}),goog.loadJs("common",()=>{goog.require("Mixly.Editor"),goog.require("Mixly.Config"),goog.provide("Mixly.Drag");const{Editor:l,Config:e,Drag:a}=Mixly,n=e["BOARD"];class t{constructor(e,t){this.config={type:"h",elem:null,min:null,full:[!0,!0],ondragStart:null,ondragEnd:null,onfull:null,exitfull:null,sizeChanged:null,...t},this.$container=$("#"+e),this.config.elem||(this.config.elem=[],t=this.$container.children(),this.config.elem.push([$(t.get(0))],[$(t.get(1))]));let o=$("<div></div>"),r=$("<div></div>");e="h"===this.config.type?"s":"w";this.$container.addClass("drag-"+e+"-container"),r.addClass("drag-"+e+"-elem-container"),"h"===this.config.type?(r.css({height:100*this.config.elem[0][0].height()/this.$container.height()+"%"}),o.addClass("drag-s-elem horizontal-line")):(r.css({width:100*this.config.elem[0][0].width()/this.$container.width()+"%"}),(o=$("<div></div>")).addClass("drag-w-elem vertical-line")),r.append(o),this.$container.prepend(r),this.$dragElemContainer=r,this.$dragElem=o,this.size=["100%","0%"],this.onfullMark="POSITIVE",this.prevSize=this.size,this.addEventListener()}addEventListener(){const a=this.$dragElem[0],n=this,s=this.$container[0],{type:c,min:d,elem:e,ondragStart:g,ondragEnd:u,full:p,onfull:A,exitfull:h}=this.config;e[0],e[1];a.onmousedown=function(e){let l;if("h"===c?(l=e.clientY,a.top=a.offsetTop,$("body").addClass("drag-s-resize")):(l=e.clientX,a.left=a.offsetLeft,$("body").addClass("drag-w-resize")),document.onmousemove=function(e){"function"==typeof g&&g();let t,o,r=parseInt(d),i;if(i="h"===c?(t=a.top+(e.clientY-l),o=s.clientHeight-r,e.movementY):(t=a.left+(e.clientX-l),o=s.clientWidth-r,e.movementX),t+=4,p[0]&&i<0&&t<r-.6*r)n.changeSize("0%"),"function"==typeof A&&A("NEGATIVE"),n.onfullMark="NEGATIVE";else if(p[1]&&0<i&&t>o+.8*r)n.changeSize("100%"),"function"==typeof A&&A("POSITIVE"),n.onfullMark="POSITIVE";else if(t<o&&t>r){switch(n.onfullMark){case"NEGATIVE":if("function"!=typeof h||h("POSITIVE"))break;return;case"POSITIVE":if("function"!=typeof h||h("NEGATIVE"))break;return}n.onfullMark=null,n.changeSize(t)}return"function"==typeof u&&u(),!1},document.onmouseup=function(){"h"===c?$("body").removeClass("drag-s-resize"):$("body").removeClass("drag-w-resize"),document.onmousemove=null,document.onmouseup=null},n.end)return!1}}changeSize(t){var e,o,{type:r,elem:i,sizeChanged:l}=this.config,a="h"===r?"height":"width";let n,s,[c,d]=i;if("string"==typeof t&&-1!==t.indexOf("%"))n=t,s=100-parseFloat(n)+"%";else{let e;e="h"===r?this.$container.height():this.$container.width(),n=100*parseFloat(t)/e+"%",s=100*(1-parseFloat(t)/e)+"%"}this.prevSize=this.size,this.size=[n,s],parseFloat(n)?c=[this.$dragElemContainer,...c]:"h"===r?this.$dragElemContainer.css("height","4px"):this.$dragElemContainer.css("width","4px");for(e of c)e.css(a,n);for(o of d)o.css(a,s);"function"==typeof l&&l()}full(e){var{exitfull:t,onfull:o}=this.config;if("function"==typeof t)switch(this.onfullMark){case"NEGATIVE":t("POSITIVE");break;case"POSITIVE":t("NEGATIVE")}"NEGATIVE"===e?(this.onfullMark="NEGATIVE",this.changeSize("0%")):(this.onfullMark="POSITIVE",this.changeSize("100%")),o(e)}exitfull(){if(this.onfullMark){var e=this.config["exitfull"];if("function"==typeof e)switch(this.onfullMark){case"NEGATIVE":e("POSITIVE");break;case"POSITIVE":e("NEGATIVE")}this.onfullMark=null,this.changeSize(this.prevSize[0])}}show(){var e=this.config["exitfull"];if("function"==typeof e)switch(this.onfullMark){case"NEGATIVE":e("POSITIVE");break;case"POSITIVE":e("NEGATIVE")}this.onfullMark=null,this.prevSize&&parseInt(this.prevSize[0])<100&&0<parseInt(this.prevSize[0])?this.changeSize(this.prevSize[0]):this.changeSize("70%")}}a.elems={};a.HorizontalDrag=class extends t{constructor(e,t){super(e,{...t,type:"h"})}},a.VerticalDrag=class extends t{constructor(e,t){super(e,{...t,type:"v"})}},a.init=()=>{a.items={vDrag:a.EditorBarInit(),hDrag:a.statusBarInit()},l.items={...a.items},a.addBtnClickEvent()},a.EditorBarInit=()=>{const{blockEditor:e,codeEditor:o}=l,r=$("#nav").find('button[m-id="v-bar"]').children("a"),i=$("#nav").find('button[m-id="code-area"]').children("a");return new a.VerticalDrag("v-container",{min:"200px",full:[!0,!0],sizeChanged:function(){$(e.getParentSvg()).attr({width:$("#"+l.DIV_NAME.BLOCK).width(),height:$("#"+l.DIV_NAME.BLOCK).height()}),o.resize(),Blockly.fireUiEvent(window,"resize")},onfull:function(e){switch(e){case"POSITIVE":r.removeClass("icon-hide-bar-e").addClass("icon-show-bar-e"),o.setReadOnly(!0),l.codeEditorHideBtn(),l.selected="BLOCK";break;case"NEGATIVE":i.removeClass("icon-code-1").addClass("icon-block"),i.parent().attr("m-id","block-area"),o.setReadOnly(!1),l.codeEditorShowBtn(),l.selected="CODE";var t=l["py2BlockEditor"];t&&n.pythonToBlockly&&(t.fromCode=!0)}l.codeEditorMenuRender()},exitfull:function(e){switch(o.setReadOnly(!0),l.selected="BLOCK",l.codeEditorMenuRender(),l.codeEditorHideBtn(),e){case"POSITIVE":i.removeClass("icon-block").addClass("icon-code-1"),i.parent().attr("m-id","code-area");var t=l["py2BlockEditor"];t&&n.pythonToBlockly&&"function"==typeof t.updateBlock&&t.updateBlock(),l.blockEditorUpdateCode();break;case"NEGATIVE":r.removeClass("icon-show-bar-e").addClass("icon-hide-bar-e")}return!0}})},a.statusBarInit=()=>{const{blockEditor:e,codeEditor:t}=l,o=$("#nav").find('button[m-id="h-bar"]').children("a");return new a.HorizontalDrag("h-container",{min:"50px",sizeChanged:function(){$(e.getParentSvg()).attr({width:$("#"+l.DIV_NAME.BLOCK).width(),height:$("#"+l.DIV_NAME.BLOCK).height()}),t.resize(),Blockly.fireUiEvent(window,"resize")},onfull:function(e){"POSITIVE"===e&&o.removeClass("icon-hide-bar-s").addClass("icon-show-bar-s")},exitfull:function(e){switch(e){case"POSITIVE":break;case"NEGATIVE":o.removeClass("icon-show-bar-s").addClass("icon-hide-bar-s")}return!0}})},a.addBtnClickEvent=()=>{const{vDrag:t,hDrag:o}=a.items,r=$("#nav").find('button[m-id="v-bar"]').children("a");var i=$("#nav").find("button");for(let e=0;i[e];e++){const l=$(i[e]);l.click(function(){var e=l.children("a");l.attr("m-id");switch(l.attr("m-id")){case"h-bar":e.hasClass("icon-hide-bar-s")?(e.removeClass("icon-hide-bar-s"),e.addClass("icon-show-bar-s"),o.full("POSITIVE")):(e.removeClass("icon-show-bar-s"),e.addClass("icon-hide-bar-s"),o.show());break;case"v-bar":e.hasClass("icon-hide-bar-e")?(e.removeClass("icon-hide-bar-e"),e.addClass("icon-show-bar-e"),t.full("POSITIVE")):(e.removeClass("icon-show-bar-e"),e.addClass("icon-hide-bar-e"),t.show());break;case"code-area":l.attr("m-id","block-area"),e.removeClass("icon-code-1").addClass("icon-block"),r.removeClass("icon-show-bar-e").addClass("icon-hide-bar-e"),t.full("NEGATIVE");break;case"block-area":l.attr("m-id","code-area"),e.removeClass("icon-block").addClass("icon-code-1"),r.removeClass("icon-hide-bar-e").addClass("icon-show-bar-e"),t.full("POSITIVE")}})}}}),goog.loadJs("common",()=>{goog.require("fsWrapper"),goog.require("Mixly.Config"),goog.require("Mixly.Editor"),goog.require("Mixly.Drag"),goog.provide("Mixly.MicrobitFs");const{Config:e,MicrobitFs:a}=Mixly;var t=e["BOARD"],{nav:t={}}=t;a.init=()=>{fsWrapper.setupFilesystem().then(()=>{console.log("初始化成功")}).fail(()=>{console.log("初始化失败")})},!t.compile&&t.upload&&t.save?.hex&&a.init(),a.loadHex=(e,o)=>{var r=[];try{r=fsWrapper.importHexFiles(o)}catch(t){try{r=fsWrapper.importHexAppended(o)}catch(e){console.log(t.message)}}o="";-1<r.indexOf(e)?o=fsWrapper.read(e):alert("no "+e),Drag.items.vDrag.full("NEGATIVE"),Editor.codeEditor.setValue(o,-1)},a.loadFileToFilesystem=(t,e)=>{if("main.py"!==t)try{fsWrapper.exists(t)?(fsWrapper.remove(t),fsWrapper.create(t,e)):fsWrapper.write(t,e);fsWrapper.getUniversalHex()}catch(e){return fsWrapper.exists(t)&&fsWrapper.remove(t),alert(t+"\n"+e.message)}},a.updateMainPy=t=>{try{fsWrapper.exists("main.py")&&fsWrapper.remove("main.py");for(var o=0;o<py_module.length;o++)fsWrapper.exists(py_module[o].filename)&&fsWrapper.remove(py_module[o].filename);t&&fsWrapper.create("main.py",t);var r=t,i=new Array;r.trim().split("\n").forEach(function(e,t){i.push(e)});let e="";for(o=0;o<i.length;o++)if(0==i[o].indexOf("from")){if(e=(e=i[o].substring(4,i[o].indexOf("import"))).replace(/(^\s*)|(\s*$)/g,""),!fsWrapper.exists(e+".py"))for(var l=0;l<py_module.length;l++)py_module[l].filename==e+".py"&&a.loadFileToFilesystem(py_module[l].filename,py_module[l].code)}else if(0==i[o].indexOf("import")&&(e=(e=i[o].substring(6)).replace(/(^\s*)|(\s*$)/g,""),!fsWrapper.exists(e+".py")))for(l=0;l<py_module.length;l++)py_module[l].filename==e+".py"&&a.loadFileToFilesystem(py_module[l].filename,py_module[l].code)}catch(e){throw new Error(e.message)}},a.getHex=e=>{try{return a.updateMainPy(e),output=fsWrapper.getUniversalHex()}catch(e){return alert(e.message),null}}}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Boards"),goog.require("Mixly.Editor"),goog.provide("Mixly.NavEvents");const e=layui["form"],{NavEvents:t,Boards:r,Editor:i}=Mixly;t.init=()=>{$(".layui-nav-third-child").hide(),$(".third-class").hover(function(){$(".layui-nav-third-child").hide(),$(this).next().css("left",$(this).parent().parent().width()+1),$(this).next().toggle()},function(){$(".layui-nav-third-child").hide()}),$(".layui-nav-third-child").hover(function(){$(this).toggle()},function(){$(".layui-nav-third-child").hide()}),$(".layui-nav-item").hover(function(){"0px"==$(this).find("dl").css("right")&&($(this).find("dl").css("left",parseInt(parseInt($(this).width()-parseInt($(this).find("dl").width()))/2)),$(this).find("dl").css("right","auto"))},function(){}),e.on("select(boards-type)",function(e){var t=r.getSelectedBoardName();if(r.changeTo(t),r.selected!==t)try{var o=Blockly.Xml.workspaceToDom(i.blockEditor);i.blockEditor.clear(),Blockly.Xml.domToWorkspace(i.blockEditor,o),"BLOCK"===i.selected&&i.blockEditorUpdateCode()}catch(e){console.log(e)}r.updateCategories(t)}),e.on("select(ports-type)",function(e){$("#mixly-footer-port-div").css("display","inline-flex"),$("#mixly-footer-port").html(e.value)})}}),goog.loadJs("common",()=>{goog.require("Mixly.Env"),goog.require("Mixly.XML"),goog.require("Mixly.Config"),goog.require("Mixly.Drag"),goog.provide("Mixly.StatusBar");const{StatusBar:i,Config:e,Drag:o}=Mixly,t=(i.selected=!1,e)["USER"];let l;i.init=()=>{l=ace.edit("div_inout_middle"),i.Ace=l,"dark"===t.theme?l.setOption("theme","ace/theme/terminal"):l.setOption("theme","ace/theme/xcode"),l.getSession().setMode("ace/mode/python"),l.setFontSize(document.body.clientWidth/95),l.setReadOnly(!1),l.setScrollSpeed(.3),l.setShowPrintMargin(!1),l.renderer.setShowGutter(!1),l.commands.addCommands([{name:"increaseFontSize",bindKey:"Ctrl-=|Ctrl-+",exec:e=>{var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(t+1)}},{name:"decreaseFontSize",bindKey:"Ctrl+-|Ctrl-_",exec:e=>{var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(t-1||1))}},{name:"resetFontSize",bindKey:"Ctrl+0|Ctrl-Numpad0",exec:e=>{e.setFontSize(12)}},{name:"sendCtrlC",bindKey:"Ctrl-Shift-C",exec:e=>{(Mixly.Env.isElectron?Mixly.Electron:Mixly.Web).Serial.writeCtrlC()}},{name:"sendCtrlD",bindKey:"Ctrl-Shift-D",exec:e=>{(Mixly.Env.isElectron?Mixly.Electron:Mixly.Web).Serial.writeCtrlD()}},{name:"Empty",bindKey:"Ctrl-E",exec:e=>{i.setValue("")}}])},i.show=e=>{var t=o.items["hDrag"];switch(e){case 1:t.show();break;case 2:t.full("POSITIVE");break;default:t.onfull&&"POSITIVE"===t.onfull?t.show():t.full("POSITIVE")}},i.setValue=(e,t=!0)=>{var o,r;l&&(l.updateSelectionMarkers(),o=l["selection"],r=o.getCursor(),i.getValue()!==e)&&(l.setValue(e,-1),t?(l.gotoLine(l.session.getLength()),o.moveCursorLineEnd()):(o.moveCursorTo(r.row,r.column,!0),o.clearSelection()))},i.getValue=function(){return l?l.getValue():""},i.addValue=(e,t=!0)=>{var o,r,i;l&&(l.updateSelectionMarkers(),{selection:o,session:r}=l,i=o.getCursor(),l.gotoLine(r.getLength()),o.moveCursorLineEnd(),l.insert(e),t?(l.gotoLine(r.getLength()),o.moveCursorLineEnd()):o.moveCursorTo(i.row,i.column,!0))},i.scrollToTheBottom=()=>{l&&(l.updateSelectionMarkers(),l.gotoLine(l.session.getLength()))},i.scrollToTheTop=()=>{l&&l.gotoLine(0)}}),goog.loadJs("electron",()=>{goog.require("LazyLoad"),goog.require("layui"),goog.require("Code"),goog.require("Mixly.Env"),goog.require("Mixly.Modules"),goog.require("Mixly.XML"),goog.require("Mixly.ScriptLoader"),goog.require("Mixly.CssLoader"),goog.require("Mixly.Boards"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.Nav"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron.CloudDownload"),goog.provide("Mixly.Electron.LibManager");const{Env:h,Modules:e,Electron:t,XML:y,ScriptLoader:o,CssLoader:r,Boards:i,LayerExt:a,Config:l,Nav:u,Msg:A}=Mixly,{fs:m,fs_extra:p,fs_extend:f,path:b,compressing:n,electron_remote:s}=e;var c=l["BOARD"];const{CloudDownload:x,LibManager:C}=t,{table:v,element:B}=layui,{dialog:d,shell:w}=s;C.URL={mixly:c?.lib?.mixly?.url[0],arduino:c?.lib?.arduino?.url[0],python:c?.lib?.python?.url[0]},C.LOCAL_IMPORT_FILTERS={MIXLY:[{name:"Mixly Lib File",extensions:["xml","mil","zip"]}],ARDUINO:[{name:"ZIP File",extensions:["zip"]}],PYTHON:[{name:"Python File",extensions:["py"]}]},C.getDefaultXML=()=>{return $("#toolbox").html()},C.getLibs=e=>{var t,r=[],i=[],l=[];if(f.isdir(e))for(t of m.readdirSync(e)){var o,a=b.resolve(e,"./"+t);if(f.isdir(a))for(o of m.readdirSync(a)){var n=b.extname(o);if(".xml"===n){var n=m.readFileSync(b.resolve(a,"./"+o),"utf8"),s=y.getDom(n,{libPath:a});for(let o=0;s[o];o++)if(["SCRIPT","LINK"].includes(s[o].nodeName)){let e,t;t="SCRIPT"==s[o].nodeName?(e=i,s[o].src):(e=l,s[o].href);try{t=decodeURIComponent(t.replace("file:///",""));var c=b.relative(h.indexDirPath,t),d=b.relative(h.indexDirPath,b.resolve(a,c)),g=b.resolve(h.indexDirPath,c),u=b.resolve(h.indexDirPath,d);f.isfile(g)?e.push(c):f.isfile(u)&&e.push(d)}catch(e){console.log(e)}}else"CATEGORY"==s[o].nodeName&&r.push(s[o].outerHTML)}}else{var p=b.extname(a),A=b.basename(a,".mil");".mil"===p&&(p=m.readFileSync(a,"utf8"),(A=$('<category name="'+A+'" colour="#74a55b"></category>')).append($(p).html()),r.push(A[0].outerHTML))}}return{xml:r,js:i,css:l}},C.convertLibs=e=>{var t;if(f.isdir(e))for(t of m.readdirSync(e)){var o=b.resolve(e,"./"+t);if(f.isdir(o)){var r,i,l=m.readdirSync(o),a=b.resolve(o,"./block");for(r of l){var n=b.extname(r);if(".xml"===n){n=b.resolve(o,"./"+r);let e=m.readFileSync(n,"utf8");try{e=(e=e.replace(/\.\.\/\.\.\/blocks\/company\//g,"libraries/ThirdParty/"+t+"/block/")).replace(/\.\.\/\.\.\/generators\/arduino\/company\//g,"libraries/ThirdParty/"+t+"/generator/"),m.writeFileSync(n,e)}catch(e){console.log(e)}}}if(!f.isdir(a))return;for(i of m.readdirSync(a)){var s=b.resolve(a,"./"+i);if(!f.isdir(s)){let e=m.readFileSync(s,"utf8");try{e=(e=(e=(e=e.replace(/\.\.\/\.\.\/media\//g,"./libraries/ThirdParty/"+t+"/media/")).replace(/Blockly\.Block\.obtain\([\s]*workspace[\s]*\,/g,"workspace.newBlock(")).replace(/Blockly\.FieldTextArea/g,"Blockly.FieldMultilineInput")).replace(/Blockly\.Blocks\.[\u4E00-\u9FA5A-Za-z0-9_]+\.[\u4E00-\u9FA5A-Za-z0-9_]+/g,function(e){var t=e.split(".");return 4!==t.length?e:`Blockly.Msg['${t[2].toUpperCase()}_${t[3].toUpperCase()}']`}),m.writeFileSync(s,e)}catch(e){console.log(e)}}}}}},C.loadLibsAndUpdateJsCssList=(e=()=>{})=>{const{js:o,css:r,xml:t}=C.getLibs(b.resolve(h.indexDirPath,"./libraries/ThirdParty/"));h.thirdPartyXML=t;var i=[];o.length&&i.push(new Promise((e,t)=>{LazyLoad.js(o,function(){e()})})),r.length&&i.push(new Promise((e,t)=>{LazyLoad.css(r,function(){e()})})),i.length?Promise.all(i).catch(e=>{console.log(e)}).finally(()=>{e()}):e(),h.thirdPartyCSS=[...h.thirdPartyCSS,...r??[]],h.thirdPartyJS=[...h.thirdPartyJS,...o??[]]},C.init=()=>{h.defaultXML=C.getDefaultXML(),h.thirdPartyXML=[],C.reloadThirdPartyLibs()},C.reloadThirdPartyLibs=()=>{C.convertLibs(b.resolve(h.indexDirPath,"./libraries/ThirdParty/"));for(let e=0;e<h.thirdPartyJS.length;e++)o.removeScript(h.thirdPartyJS[e]);for(let e=0;e<h.thirdPartyCSS.length;e++)r.removeCss(h.thirdPartyCSS[e]);h.thirdPartyJS=[],h.thirdPartyCSS=[],$("#toolbox").html(h.defaultXML),C.loadLibsAndUpdateJsCssList(function(){var e=i.getSelectedBoardName();i.updateCategories(e,!0)})},C.menuAddEvent=e=>{const d=b.resolve(h.indexDirPath,"./libraries/ThirdParty");let g=[0,0,0];B.tab({headerElem:"#libs-menu-options>li",bodyElem:"#libs-menu-body>.menu-body"}),B.render("nav","libs-menu-filter"),B.on("tab(libs-menu-filter)",function(e){e=e.index;e!==g[0]&&(e?C.onclickManageLibs():C.onclickImportLibs(),g[0]=e)}),B.on("tab(import-lib-page-filter)",function(e){var t=e["index"];t!==g[1]&&(e.index,g[1]=t)}),B.on("tab(del-lib-page-filter)",function(e){var t=e["index"];t!==g[2]&&(e.index,g[2]=t)}),e.find("button").off().click(function(){var t=$(this).attr("m-id");let o,r;switch(o=g[1]?"c"===u.codeEnv?"ARDUINO":"PYTHON":"MIXLY",r=g[2]?"c"===u.codeEnv?"ARDUINO":"PYTHON":"MIXLY",t){case"cloud-import":var i=g[1]?"cloud-code-lib-table":"cloud-mixly-lib-table",l=v.checkStatus(i).data,a=[];for(let e=0;e<l.length;e++)a.push({desPath:d,...l[e]});0<a.length?C.showCloudImportProgress(a):layer.msg(A.Lang["请选择至少一个库"]+"!",{time:1e3});break;case"local-import":C.showLocalImportDialog(o);break;case"del":var i=g[2]?"del-code-lib-table":"del-mixly-lib-table",l=v.checkStatus(i).data,n=[];for(let e=0;e<l.length;e++)n.push(l[e].path);0<n.length?C.showDelLibsProgress(e=>{C.delLibs(r,n,e)}):layer.msg(A.Lang["请选择至少一个库"]+"!",{time:1e3});break;case"open-folder":var s=b.resolve(h.indexDirPath,"libraries/myLib"),c=b.resolve(h.indexDirPath,"build/lib");let e;switch(r){case"ARDUINO":e=s;break;case"PYTHON":e=c;break;default:e=d}p.ensureDir(e).then(()=>w.openPath(e)).catch(console.log)}})},C.showManageDialog=()=>{var e=y.render(y.TEMPLATE_STR.LIB_MANAGER_DIV,{importBoard:A.Lang["导入库"],delBoard:A.Lang["管理库"],mixlyLib:"Mixly",codeLib:"c"===u.codeEnv?"Arduino":"Python",cloudImport:A.Lang["云端导入"],localImport:A.Lang["本地导入"],openFolder:A.Lang["打开对应文件夹"],del:A.Lang["删除"]});a.open({title:[A.Lang["库管理器"],"35px"],id:"lib-manage-layer",content:e,shade:a.SHADE_ALL,area:["60%","60%"],min:["400px","200px"],max:["800px","400px"],success:e=>{C.onclickImportLibs(),C.menuAddEvent(e)}})},C.compareLibConfig=e=>{var{version:t,url:o}=e,o=(e.downloadIndex=!0,b.resolve(h.indexDirPath,"libraries/ThirdParty",b.basename(o,".zip")));return f.isdir(o)?(o=b.resolve(o,"./config.json"),null!==(o=p.readJsonSync(o,{throws:!1}))&&o.version===t&&(e.downloadIndex=!1),e.downloadIndex?e.status=A.Lang["待更新"]:e.status=A.Lang["已安装"]):e.status=A.Lang["待安装"],e},C.onclickImportLibs=()=>{let r={id:"cloud-mixly-lib-table",elem:"#import-mixly-lib-page",data:[],defaultToolbar:[],title:A.Lang["云端库"],cols:[[{type:"checkbox",unresize:!1,align:"center"},{field:"status",title:A.Lang["状态"],sort:!0,unresize:!1,align:"center",minWidth:100},{field:"name",title:A.Lang["名称"],sort:!0,unresize:!1,align:"center",minWidth:200},{field:"version",title:A.Lang["版本"],unresize:!1,align:"center",minWidth:80},{field:"desc",title:A.Lang["介绍"],unresize:!1,align:"center",minWidth:250}]],limit:1e3,skin:"line",even:!1,size:"sm"},i={id:"cloud-code-lib-table",elem:"#import-code-lib-page",data:[],defaultToolbar:[],title:A.Lang["云端库"],cols:[[{type:"checkbox",unresize:!1,align:"center"},{field:"name",title:A.Lang["名称"],sort:!0,unresize:!1,align:"center",minWidth:200},{field:"version",title:A.Lang["版本"],unresize:!1,align:"center",minWidth:80},{field:"desc",title:A.Lang["介绍"],unresize:!1,align:"center",minWidth:250}]],limit:1e3,skin:"line",even:!1,size:"sm"};v.render({...r,text:{none:A.Lang["云端库JSON下载中"]+"..."}}),v.render({...i,text:{none:A.Lang["云端库JSON下载中"]+"..."}}),v.on("row(import-mixly-lib-page-filter)",function(e){var t=e.tr.first().find(".layui-form-checkbox");e.setRowChecked({checked:!t.hasClass("layui-form-checked")})});var e=b.resolve(h.indexDirPath,"./libraries/ThirdParty");C.URL.mixly?x.getJson(C.URL.mixly,e,e=>{if(e[0])console.log(e[0]),v.render({...r,text:{none:A.Lang["无数据"]}});else{var t,o=[];for(t of e[1])o.push(C.compareLibConfig({...t}));r.data=o,v.render(r)}}):v.render({...r,text:{none:A.Lang["无数据"]}});let t,o;(o="c"===u.codeEnv?(t=b.resolve(h.indexDirPath,"./libraries/myLib"),C.URL.arduino):(t=b.resolve(h.indexDirPath,"./build/lib"),C.URL.python))?x.getJson(o,t,e=>{if(e[0])console.log(e[0]),v.render({...i,text:{none:A.Lang["无数据"]}});else{var t,o=[];for(t of e[1])o.push(C.compareLibConfig({...t}));i.data=o,v.render(i)}}):v.render({...i,text:{none:A.Lang["无数据"]}})},C.onclickManageLibs=()=>{var e={id:"del-mixly-lib-table",elem:"#del-mixly-lib-page",data:[],defaultToolbar:[],title:A.Lang["管理库"],cols:[[{type:"checkbox",unresize:!1,align:"center"},{field:"name",title:A.Lang["名称"],sort:!0,unresize:!1,align:"center",minWidth:150},{field:"path",title:A.Lang["路径"],unresize:!1,align:"center",minWidth:300}]],limit:1e3,skin:"line",even:!1,size:"sm"},t={id:"del-code-lib-table",elem:"#del-code-lib-page",data:[],defaultToolbar:[],title:A.Lang["管理库"],cols:e.cols,limit:1e3,skin:"line",even:!1,size:"sm"},o=(v.render({...e,text:{none:A.Lang["本地库读取中"]+"..."}}),v.render({...t,text:{none:A.Lang["本地库读取中"]+"..."}}),b.resolve(h.indexDirPath,"libraries/ThirdParty")),r=b.resolve(h.indexDirPath,"libraries/myLib"),l=b.resolve(h.indexDirPath,"build/lib");for(let i of[{path:o,tableConfig:e},{path:"c"===u.codeEnv?r:l,tableConfig:t}])f.isdir(i.path)?m.readdir(i.path,(e,t)=>{if(e)console.log(e),v.render({...i.tableConfig,text:{none:A.Lang["读取失败"]}});else{var o,r=[];for(o of t)".json"!==b.extname(o)&&r.push({name:o,path:b.resolve(i.path,o)});r.length?v.render({...i.tableConfig,data:r}):v.render({...i.tableConfig,text:{none:A.Lang["无数据"]}})}}):v.render({...i.tableConfig,text:{none:A.Lang["无数据"]}})},C.showLocalImportDialog=t=>{e.currentWindow.focus();let o;d.showOpenDialog(e.currentWindow,{title:A.Lang["导入库"],defaultPath:h.clientPath,buttonLabel:A.Lang["确定"],filters:C.LOCAL_IMPORT_FILTERS[t],properties:["openFile","showHiddenFiles"],message:A.Lang["导入库"]}).then(e=>{e=e.filePaths[0];e&&(console.log("待导入文件路径：",e),C.importFromLocal(t,e,()=>{o=layer.open({type:1,id:"import-local-lib-layer",title:A.Lang["导入中"]+"...",content:$("#mixly-loader-div"),shade:a.SHADE_ALL,closeBtn:0,success:function(e){$("#mixly-loader-btn").css("display","none")},end:function(){$("#mixly-loader-btn").css("display","inline-block"),$("#layui-layer-shade"+o).remove()}})},e=>{console.log(e),layer.msg(e,{time:1e3})},e=>{layer.close(o),e?(console.log(e),layer.msg(A.Lang["导入失败"],{time:1e3})):layer.msg(A.Lang["导入成功"],{time:1e3})}))}).catch(e=>{layer.close(o),console.log(e),layer.msg(A.Lang["导入失败"],{time:1e3})})},C.importFromLocal=(e,t,o,r,i)=>{var l=b.extname(t),a=b.resolve(h.indexDirPath,"./build/lib"),n=b.resolve(h.indexDirPath,"./libraries/ThirdParty");if(f.isfile(t))switch(l){case".py":a===b.resolve(t,"../")?r(A.Lang["此库已导入"]):(o(),C.importFromLocalWithFile(e,t,i));break;case".mil":n===b.resolve(t,"../")?r(A.Lang["此库已导入"]):(o(),C.importFromLocalWithFile(e,t,i));break;case".xml":b.resolve(t,"../../")===n?r(A.Lang["此库已导入"]):(o(),C.importFromLocalWithFile(e,t,i));break;case".zip":o(),C.importFromLocalWithZip(e,t,i);break;default:r(A.Lang["所选文件非配置文件"])}else r(A.Lang["文件不存在"])},C.importFromLocalWithFile=(t,e,o)=>{var r=b.resolve(h.indexDirPath,"./libraries/ThirdParty"),i=b.extname(e),l=b.basename(e),a=[];switch(i){case".xml":var n,s={FILE:["CHANGELOG.md","README.md","config.json",l],DIR:["block","generator","converter","css","media","language","companypin","examples","wiki","libraries"]},c=b.dirname(e),d=b.basename(c);for(n of m.readdirSync(c)){var g,u=b.resolve(c,"./"+n);f.isfile(u)?s.FILE.includes(n)&&(g=b.resolve(r,d,n),a.push(C.copyFile(u,g))):s.DIR.includes(n)&&(g=b.resolve(r,d,n),a.push(C.copyDir(u,g)))}break;case".mil":var p=b.resolve(r,b.basename(e));a.push(C.copyFile(e,p));break;case".py":p=b.resolve(h.indexDirPath,"build/lib",b.basename(e));a.push(C.copyFile(e,p));break;default:layer.msg(A.Lang["文件后缀错误"],{time:1e3}),o(A.Lang["文件后缀错误"])}Promise.all(a).then(e=>{"MIXLY"===t&&C.reloadThirdPartyLibs(),o(null)}).catch(e=>{o(e)}).finally(()=>{})},C.importFromLocalWithZip=(t,e,o)=>{var r=b.resolve(h.indexDirPath,"./libraries/ThirdParty/"),i=b.resolve(h.indexDirPath,"./libraries/myLib/");let l;switch(t){case"MIXLY":l=r;break;case"ARDUINO":l=i;break;default:return void o(A.Lang["解压出错"])}C.unZip(e,l,!1,e=>{"MIXLY"===t&&C.reloadThirdPartyLibs(),o(e)})},C.delLibs=(t,e,o)=>{var r=[];for(let o of e)r.push(new Promise((t,e)=>{p.remove(o,e=>{t(e)})}));Promise.all(r).then(e=>{C.onclickManageLibs(),"MIXLY"===t&&C.reloadThirdPartyLibs()}).catch(e=>{console.log(e)}).finally(()=>{layer.close(o)})},C.showDelLibsProgress=o=>{const e=layer.open({type:1,id:"del-local-lib-layer",title:A.Lang["删除中"]+"...",content:$("#mixly-loader-div"),shade:a.SHADE_ALL,closeBtn:0,success:function(e,t){$("#mixly-loader-btn").css("display","none"),o(t)},end:function(){$("#layui-layer-shade"+e).remove(),$("#mixly-loader-btn").css("display","inline-block")}})},C.unZip=(e,t,o,r=e=>{})=>{var i=b.basename(e,".zip");b.resolve(t,i);n.zip.uncompress(e,t,{zipFileNameEncoding:"GBK"}).then(()=>{if(o)try{m.unlinkSync(e)}catch(e){console.log(e)}r(null)}).catch(e=>{r(e)})},C.copyDir=(o,r)=>new Promise((e,t)=>{p.ensureDir(r).then(()=>p.emptyDir(r)).then(()=>p.copy(o,r)).then(()=>{e({error:null,endPath:r})}).catch(e=>{resolve({error:e,endPath:r})})}),C.copyFile=(r,i)=>new Promise((e,t)=>{var o=b.dirname(i);p.ensureDir(o).then(()=>p.copy(r,i)).then(()=>{e({error:null,endPath:i})}).catch(e=>{resolve({error:e,endPath:i})})}),C.showCloudImportProgress=(o,e=0)=>{const t=$("<div></div>");t.css({overflow:"hidden",width:"100%",height:"100%",display:"none"});var r,i=$("<div></div>");for(r in i.css({"overflow-x":"hidden","overflow-y":"auto",left:"5px",right:"5px",top:"5px",bottom:"5px",position:"absolute"}),o){var l=o[r],l={panelId:r+"-panel-id",name:l.name,progressFilter:r+"-progress-filter",progressStatusId:r+"-progress-status-id"};i.append(y.render(y.TEMPLATE_STR.PROGRESS_BAR_DIV,l))}t.append(i),$("body").append(t),B.render("progress"),a.open({title:A.Lang["导入中"]+"...",id:"setting-menu-layer1",content:t,shade:a.SHADE_ALL,area:["40%","60%"],max:["800px",106*o.length+42+"px"],min:["500px","100px"],success:(e,t)=>{e.find(".layui-layer-setwin").css("display","none"),C.importFromCloud(o,e,t)},end:()=>{t.remove()}})},C.importFromCloud=(e,t,a)=>{var o,r=[];for(o in e)e[o].index=o,r.push(C.importWithUrl(e[o]));Promise.all(r).then(e=>{let t=0,o=0;for(var r of e){var i=$("#"+r.index+"-progress-status-id"),l=$("#"+r.index+"-panel-id").children(".layui-card-header").first();i.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),r.error?(i.addClass("layui-icon-close-fill"),l.html(r.name+" - "+A.Lang["导入失败"]),o++,console.log(r.error)):(i.addClass("layui-icon-ok-circle"),l.html(r.name+" - "+A.Lang["导入完成"]),t++)}layer.title(A.Lang["导入完成"]+" "+t+'<i class="layui-icon layui-icon-ok" style="font-size:13px;color:#41ce28;"></i> '+o+'<i class="layui-icon layui-icon-close" style="font-size:13px;color:#b9063b;"></i>',a)}).catch(e=>{layer.title(A.Lang["导入失败"],a)}).finally(()=>{t.find(".layui-layer-setwin").css("display","block"),C.onclickImportLibs(),C.reloadThirdPartyLibs()})},C.writeLibConfig=e=>{var{desPath:e,version:t,name:o,url:r}=e;if(o){o=b.resolve(e,b.basename(r,".zip"));if(f.isdir(o)){e=b.resolve(o,"config.json"),r={version:t};try{p.outputJsonSync(e,r,{spaces:"    "})}catch(e){console.log(e)}}}},C.importWithUrl=i=>new Promise((r,e)=>{i.url||(i.error="url读取出错",r(i)),C.downloadPromise(i,{desPath:b.resolve(h.clientPath,"./download"),url:i.downloadIndex?i.url:"None",startMessage:A.Lang["下载中"]+"...",endMessage:A.Lang["下载完成"],errorMessage:A.Lang["下载失败"]}).then(e=>{if(e.error)throw e.error;return C.unZipPromise(e,{desPath:e.desPath,zipPath:e.downloadPath,startMessage:A.Lang["解压中"]+"...",endMessage:A.Lang["解压完成"],errorMessage:A.Lang["解压失败"]})}).then(e=>{if(e.error)throw e.error;var t=$("#"+e.index+"-panel-id").children(".layui-card-header").first(),o=$("#"+e.index+"-progress-status-id");i.downloadIndex?C.writeLibConfig(e):(o.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),t.html(e.name+" - "+A.Lang["已是最新版"]),o.addClass("layui-icon-ok-circle"),B.progress(e.index+"-progress-filter","100%"),B.render("progress",e.index+"-progress-filter")),r(e)}).catch(e=>{i.error=e,r(i)})}),C.downloadPromise=(d,g)=>new Promise((t,e)=>{var o={desPath:b.resolve(h.clientPath,"./download"),url:null,startMessage:A.Lang["下载中"]+"...",endMessage:A.Lang["下载完成"],errorMessage:A.Lang["下载失败"]};const{desPath:r,url:i,startMessage:l,endMessage:a,errorMessage:n}=g="object"!=typeof g?o:{...o,...g};if(i&&"None"!==i&&r){try{p.ensureDirSync(r)}catch(e){return d.error=e,d.downloadPath=null,void t(d)}const s=$("#"+d.index+"-panel-id").children(".layui-card-header").first(),c=(s.html(d.name+" - "+l),$("#"+d.index+"-progress-status-id"));c.removeClass("layui-icon-ok-circle layui-icon-close-fill"),c.addClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),B.progress(d.index+"-progress-filter","0%"),B.render("progress",d.index+"-progress-filter"),x.download(i,r,{progress:e=>{var{speed:e,progress:t}=e;let o=0;parseInt(t);let r=e;for(let e=0;e<3&&1<r/1e3;e++)r/=1024,o++;r=r.toFixed(1),s.html(d.name+" - "+l+" - "+r+["B/s","KB/s","MB/s","GB/s"][o]),B.progress(d.index+"-progress-filter",parseInt(t)+"%"),B.render("progress",d.index+"-progress-filter")},error:e=>{c.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),c.addClass("layui-icon-close-fill"),s.html(d.name+" - "+n)},end:e=>{c.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),c.addClass("layui-icon-ok-circle"),s.html(d.name+" - "+a)},timeout:this.error}).then(e=>{if(e[0])throw e[0];d.error=null,d.downloadPath=e[1],t(d)}).catch(e=>{d.error=e,d.downloadPath=null,t(d)})}else d.error=null,d.downloadPath=null,t(d)}),C.unZipPromise=(g,u)=>new Promise((t,e)=>{var o={desPath:b.resolve(h.clientPath,"./download"),zipPath:null,startMessage:A.Lang["解压中"]+"...",endMessage:A.Lang["解压完成"],errorMessage:A.Lang["解压失败"],delZip:!0};const{zipPath:r,desPath:i,delZip:l,startMessage:a,endMessage:n,errorMessage:s}=u="object"!=typeof u?o:{...o,...u};if(r&&i){const c=$("#"+g.index+"-panel-id").children(".layui-card-header").first(),d=(c.html(g.name+" - "+a),$("#"+g.index+"-progress-status-id"));d.removeClass("layui-icon-ok-circle layui-icon-close-fill"),d.addClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),B.progress(g.index+"-progress-filter","0%"),B.render("progress",g.index+"-progress-filter"),C.unZip(r,i,l,e=>{e?(d.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),d.addClass("layui-icon-close-fill"),c.html(g.name+" - "+s),g.error=e,g.unZipPath=null):(d.removeClass("layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"),d.addClass("layui-icon-ok-circle"),c.html(g.name+" - "+n),g.error=null,g.unZipPath=i,B.progress(g.index+"-progress-filter","100%"),B.render("progress",g.index+"-progress-filter")),t(g)})}else g.error=null,g.unZipPath=null,t(g)})}),goog.loadJs("web",()=>{goog.require("Mixly.MString"),goog.require("Mixly.StatusBar"),goog.require("Mixly.Msg"),goog.require("Mixly.Env"),goog.require("Mixly.Web"),goog.provide("Mixly.Web.Ampy");const{Web:e,StatusBar:s,Msg:c,Env:t}=Mixly,i=goog.get(t.templatePath+"/get-files-info.py");e.Ampy=class{constructor(e,t=!0){this.operator_=e,this.encoder_=new TextEncoder,this.decoder_=new TextDecoder,this.writeBuffer_=t}async readUntil(t,o=!0,e,r){var i=Number(new Date);let l=i,a="";for(;l-i<e;){const l=Number(new Date);var n=this.operator_.output.length;if(n)for(let e=0;e<n;e++){var s=this.operator_.output.shift(),c=s.toLowerCase().indexOf(t);if(-1!==c)return this.operator_.output.unshift(s.substring(o?c+t.length:c)),a+=s.substring(0,o?c+t.length:c);a+=e===n-1?s:s+"\n"}if((l-i)%500||"function"!=typeof r||await r(),l-i>=e)return console.log(t+"查找失败"),!1;await this.operator_.sleep(100)}}async getFilesInfo(e=5e3){if(this.exec(i),await this.sleep(100),!await this.readUntil("ok",!0,e))return null;let t=await this.readUntil(">",!1,e);var o={};try{t=(t=t.replaceAll("'",'"')).substring(0,t.lastIndexOf("]")+1);for(var r of JSON.parse(t))o[r[0].substring(r[0].lastIndexOf("/")+1)]=r[1]}catch(e){console.log(e)}return o}async interrupt(e=5e3){return await this.operator_.writeCtrlC(),await this.sleep(100),!!await this.readUntil(">>>",!0,e,this.operator_.writeCtrlC)}async enterRawREPL(e=5e3){return await this.operator_.writeCtrlA(),await this.sleep(100),!!await this.readUntil("raw repl; ctrl-b to exit",!0,e,this.operator_.writeCtrlA)}async exitRawREPL(e=5e3){return await this.operator_.writeCtrlB(),await this.sleep(100),!!await this.readUntil(">>>",e,!0,this.operator_.writeCtrlB)}async exitREPL(e=5e3){return await this.operator_.writeCtrlD(),await this.sleep(100),!!await this.readUntil("soft reboot",!1,e,this.operator_.writeCtrlD)}put(l,a,n=null){return new Promise(async(e,t)=>{try{if(await this.operator_.writeCtrlB(),await this.interrupt())if(await this.enterRawREPL()){if(n){var o,r=await this.getFilesInfo();for(o in n){var i=goog.get(n[o]);i&&new TextEncoder("utf8").encode(i).length!==r[o+".py"]?await this.writeFile(o+".py",i):s.addValue("Skip "+o+".py\n")}}await this.writeFile(l,a),await this.exitRawREPL()?await this.exitREPL()?e():t(c.Lang["无法退出REPL"]):t(c.Lang["无法退出Raw REPL"])}else t(c.Lang["无法进入Raw REPL"]);else t(c.Lang["中断失败"])}catch(e){t(e.toString())}})}async writeFile(e,t){s.addValue(`Writing ${e} `);let o=`file = open('${e}', 'w')
`;var r,i=this.encoder_.encode(t),l=Math.ceil(i.length/500);for(let e=0;e<l;e++){let t="";for(r of i.slice(500*e,Math.min(500*(e+1),i.length))){let e=r.toString(16);1===e.length&&(e="0"+e),t+="\\x"+e}o+=`file.write(b'${t}')
`}o+=`file.close()
`,await this.exec(o),s.addValue("Done!\n")}async exec(t){if(this.writeBuffer_){var o=this.encoder_.encode(t),r=Math.ceil(o.length/250);for(let e=0;e<r;e++){var i=o.slice(250*e,Math.min(250*(e+1),o.length));await this.operator_.writeByteArr(i)}}else for(let e=0;e<t.length/60;e++){var l=t.substring(60*e,60*(e+1));await this.operator_.writeString(l)}await this.operator_.writeByteArr([4])}sleep(t){return new Promise(e=>setTimeout(e,t))}}}),goog.loadJs("web",()=>{goog.require("Mixly.StatusBar"),goog.require("Mixly.Msg"),goog.require("Mixly.Web.Utilities"),goog.require("Mixly.Web.SerialPort"),goog.provide("Mixly.Web.Esptool");const{StatusBar:u,Msg:p,Web:e}=Mixly,{SerialPort:n,Esptool:t}=e;const r=toByteArray(" UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU"),s=33382,d=12882,g=12883,A=12995;const h=3e3,i={ESP8266:{chipId:s,chipName:"ESP8266EX",magicVal:[4293968129],baseFuseAddr:1072693328,macFuseAddr:1072693328,stubFile:"esp8266",spiRegBase:1610613248,spiUsrOffs:28,spiUsr1Offs:32,spiUsr2Offs:36,spiMosiDlenOffs:null,spiMisoDlenOffs:null,spiW0Offs:64},ESP32:{chipId:50,chipName:"ESP32",magicVal:[15736195],baseFuseAddr:1073061888,macFuseAddr:1073061888,stubFile:"esp32",spiRegBase:1072963584,spiUsrOffs:28,spiUsr1Offs:32,spiUsr2Offs:36,spiMosiDlenOffs:40,spiMisoDlenOffs:44,spiW0Offs:128},ESP32S2:{chipId:d,chipName:"ESP32-S2",magicVal:[1990],baseFuseAddr:1061265408,macFuseAddr:1061265476,stubFile:"esp32s2",spiRegBase:1061167104,spiUsrOffs:24,spiUsr1Offs:28,spiUsr2Offs:32,spiMosiDlenOffs:36,spiMisoDlenOffs:40,spiW0Offs:88},ESP32S3:{chipId:g,chipName:"ESP32-S3",magicVal:[9],baseFuseAddr:1610641408,macFuseAddr:1610641476,stubFile:"esp32s3",spiRegBase:1610620928,spiUsrOffs:24,spiUsr1Offs:28,spiUsr2Offs:32,spiMosiDlenOffs:36,spiMisoDlenOffs:40,spiW0Offs:88},ESP32C3:{chipId:A,chipName:"ESP32-C3",magicVal:[1763790959,456216687],baseFuseAddr:1610647552,macFuseAddr:1610647620,stubFile:"esp32c3",spiRegBase:1610620928,spiUsrOffs:24,spiUsr1Offs:28,spiUsr2Offs:32,spiMosiDlenOffs:36,spiMisoDlenOffs:40,spiW0Offs:88}},l={esp8266:{text:"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",text_start:1074847744,entry:1074847748,data:"CIH+PwUFBAACAwcAAwMLAFHnEECH5xBAtecQQFToEEAF9xBAuugQQBDpEEBc6RBABfcQQCLqEECf6hBAYOsQQAX3EEAF9xBA+OsQQAX3EEDX7hBAn+8QQNjvEEAF9xBABfcQQHXwEEAF9xBAW/EQQAHyEEBA8xBA//MQQND0EEAF9xBABfcQQAX3EEAF9xBA/vUQQAX3EED09hBAL+0QQCfoEEBC9RBAS+oQQJjpEEAF9xBAiPYQQM/2EEAF9xBABfcQQAX3EEAF9xBABfcQQAX3EEAF9xBABfcQQMDpEED/6RBAWvUQQAEAAAACAAAAAwAAAAQAAAAFAAAABwAAAAkAAAANAAAAEQAAABkAAAAhAAAAMQAAAEEAAABhAAAAgQAAAMEAAAABAQAAgQEAAAECAAABAwAAAQQAAAEGAAABCAAAAQwAAAEQAAABGAAAASAAAAEwAAABQAAAAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAUAAAAGAAAABgAAAAcAAAAHAAAACAAAAAgAAAAJAAAACQAAAAoAAAAKAAAACwAAAAsAAAAMAAAADAAAAA0AAAANAAAAAAAAAAAAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAANAAAADwAAABEAAAATAAAAFwAAABsAAAAfAAAAIwAAACsAAAAzAAAAOwAAAEMAAABTAAAAYwAAAHMAAACDAAAAowAAAMMAAADjAAAAAgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAgAAAAMAAAADAAAAAwAAAAMAAAAEAAAABAAAAAQAAAAEAAAABQAAAAUAAAAFAAAABQAAAAAAAAAAAAAAAAAAABAREgAIBwkGCgULBAwDDQIOAQ8AAQEAAAEAAAAEAAAA",data_start:1073720488},esp32:{text:"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",text_start:1074520064,entry:1074521496,data:"CMD8Pw==",data_start:1073605544},esp32s2:{text:"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",text_start:1073905664,entry:1073907516,data:"CAD9Pw==",data_start:1073622004},esp32c3:{text:"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",text_start:1077411840,entry:1077413488,data:"DEDIPw==",data_start:1070164904}};class o{constructor(e){this.encoder=new TextEncoder,this.decoder=new TextDecoder,this._chipfamily=null,this.readTimeout=3e3,this._efuses=new Array(4).fill(0),this._flashsize=4194304,this.isFunction(e.updateProgress)?this.updateProgress=e.updateProgress:this.updateProgress=null,this.isFunction(e.logMsg)?this.logMsg=e.logMsg:this.logMsg=console.log,this.debug=!1,this.isFunction(e.debugMsg)?(!1!==e.debug&&(this.debug=!0),this._debugMsg=e.debugMsg):this._debugMsg=this.logMsg(),this.IS_STUB=!1,this.syncStubDetected=!1}isFunction(e){return e&&"[object Function]"==={}.toString.call(e)}toHex(e,t=2){return"0x"+e.toString(16).toUpperCase().padStart(t,"0")}getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}slipEncode(e){let t=[192];for(var o of e)219==o?t=t.concat([219,221]):192==o?t=t.concat([219,220]):t.push(o);return t.push(192),t}macAddr(){var e=new Array(6).fill(0),t=this._efuses[0],o=this._efuses[1],r=this._efuses[2],i=this._efuses[3];let l;if(this._chipfamily==s){if(0!=i)l=[i>>16&255,i>>8&255,255&i];else if(0==(o>>16&255))l=[24,254,52];else{if(1!=(o>>16&255))throw"Couldnt determine OUI";l=[172,208,116]}e[0]=l[0],e[1]=l[1],e[2]=l[2],e[3]=o>>8&255,e[4]=255&o,e[5]=t>>24&255}else if(50==this._chipfamily)e[0]=r>>8&255,e[1]=255&r,e[2]=o>>24&255,e[3]=o>>16&255,e[4]=o>>8&255,e[5]=255&o;else{if(![d,g,A].includes(this._chipfamily))throw"Unknown chip family";e[0]=o>>8&255,e[1]=255&o,e[2]=t>>24&255,e[3]=t>>16&255,e[4]=t>>8&255,e[5]=255&t}return e}debugMsg(e,...t){this.debug&&this._debugMsg(e,...t)}async _readEfuses(){var e=await this.chipType(),t=this.getChipInfo(e);for(let e=0;e<4;e++)this._efuses[e]=await this.readRegister(t.macFuseAddr+4*e)}async readRegister(e){this.debug&&this.debugMsg(1,"Reading from Register "+this.toHex(e,8));var e=struct.pack("<I",e),[e,,]=(await this.command(10,e),await this.getResponse(10));return e}async writeRegister(e,t,o=4294967295,r=0,i=0){this.debug&&this.debugMsg(1,"Writing to Register "+this.toHex(e,8));let l=struct.pack("<IIII",e,t,o,r);return 0<i&&(l=l.concat(struct.pack("<IIII",1610612856,0,0,i))),await this.checkCommand(9,l)}sleep(t){return new Promise(e=>setTimeout(e,t))}async chipType(){return null===this._chipfamily&&(this._chipfamily=await this.detectChip()),this._chipfamily}getChipInfo(e){for(var[t,o]of Object.entries(i))if(o.chipId==e)return o;throw"Chip Id is not Supported"}async detectChip(){var e,t,o=await this.readRegister(1073745920);for([e,t]of Object.entries(i))if(t.magicVal.includes(o))return t.chipId;throw"Unable to detect Chip"}async chipName(){var e=await this.chipType(),t=this.getChipInfo(e);return await this._readEfuses(),e==s&&(16&this._efuses[0]||65536&this._efuses[2])?"ESP8285":t.chipName}async checkCommand(e,t,o=0,r=h){r=Math.min(r,24e4),await this.command(e,t,o);let[i,l]=await this.getResponse(e,r),a;if(null!==l&&(this.IS_STUB||this._chipfamily==s?a=2:[50,d,g,A].includes(this._chipfamily)?a=4:[2,4].includes(l.length)&&(a=l.length)),null===l||l.length<a)throw"Didn't get enough status bytes";t=l.slice(-a,l.length);if(l=l.slice(0,-a),this.debug&&(this.debugMsg(1,"status",t),this.debugMsg(1,"value",i),this.debugMsg(1,"data",l)),1==t[0])throw 5==t[1]?"Invalid (unsupported) command "+this.toHex(e):"Command failure error code "+this.toHex(t[1]);return 0<l.length?l:i}timeoutPerMb(e,t){e=Math.floor(e*(t/486));return e<h?h:e}async command(e,t,o=0){let r=struct.pack("<BBHI",0,e,t.length,o);r=r.concat(t),r=this.slipEncode(r),this.debugMsg(2,"Writing "+r.length+" byte"+(1==r.length?"":"s")+":",r),await n.writeByteArr(r)}async reset(){await n.obj.getSignals();this.logMsg("尝试复位"),Mixly.StatusBar.addValue(p.Lang["尝试复位"]+"\n",!0),await n.obj.setSignals({dataTerminalReady:!1,requestToSend:!0}),await n.obj.setSignals({dataTerminalReady:!0,requestToSend:!1}),await this.sleep(1e3)}hexFormatter(e){return"["+e.map(e=>this.toHex(e)).join(", ")+"]"}async readPacket(){let e=null,t=!1;var o=[];for(this.debugMsg(2,"Read Timeout",this.readTimeout);;){for(var r,i,l=Date.now(),o=[];Date.now()-l<this.readTimeout;){if(0<n.inputBuffer.length){o.push(n.inputBuffer.shift());break}await this.sleep(10)}if(0==o.length)throw r=null===e?"header":"content",this.debugMsg(1,"Timed out waiting for packet "+r),console.error("Timed out waiting for packet "+r),new a("Timed out waiting for packet "+r);this.debugMsg(2,"Read "+o.length+" bytes: "+this.hexFormatter(o));for(i of o)if(null===e){if(192!=i)throw this.debugMsg(1,"Read invalid data: "+this.hexFormatter(o)),this.debugMsg(1,"Remaining data in serial buffer: "+this.hexFormatter(n.inputBuffer)),new a("Invalid head of packet ("+this.toHex(i)+")");e=[]}else if(t)if(t=!1,220==i)e.push(192);else{if(221!=i)throw this.debugMsg(1,"Read invalid data: "+this.hexFormatter(o)),this.debugMsg(1,"Remaining data in serial buffer: "+this.hexFormatter(n.inputBuffer)),new a("Invalid SLIP escape (0xdb, "+this.toHex(i)+")");e.push(219)}else if(219==i)t=!0;else{if(192==i)return this.debugMsg(2,"Received full packet: "+this.hexFormatter(e)),e;e.push(i)}}return""}async getResponse(t,e=h){this.readTimeout=e;let o;var r,i,l,a;for(let e=0;e<100;e++){try{o=await this.readPacket()}catch(e){return this.debugMsg(1,"Timed out after "+this.readTimeout+" milliseconds"),[null,null]}if(!(o.length<8)&&([a,r,i,l]=struct.unpack("<BBHI",o.slice(0,8)),1==a)){if(a=o.slice(8),null==t||r==t)return[l,a];if(0!=a[0]&&5==a[1])throw n.inputBuffer=[],"Invalid (unsupported) command "+this.toHex(t)}}throw"Response doesn't match request"}async readBuffer(e=h){this.readTimeout=e;let t;try{t=await this.readPacket()}catch(e){return this.debugMsg(1,"Timed out after "+this.readTimeout+" milliseconds"),null}return t}checksum(e,t=239){for(var o of e)t^=o;return t}setPortBaudRate(e){this.getChromeVersion()<86?port.baudrate=e:port.baudRate=e}getPortBaudRate(){return this.getChromeVersion()<86?port.baudrate:port.baudRate}async setBaudrate(t){if(this._chipfamily==s)this.logMsg("Baud rate can only change on ESP32 and ESP32-S2"),u.addValue(p.Lang["只能在ESP32和ESP32-S2上修改波特率"]+"\n");else{this.logMsg("Attempting to change baud rate to "+t+"..."),u.addValue(p.Lang["尝试修改波特率为"]+t+"\n");try{var e=this.IS_STUB?this.getPortBaudRate():0,o=struct.pack("<II",t,e);await this.checkCommand(15,o),this.setPortBaudRate(t),await this.sleep(50),this.logMsg("Changed baud rate to "+t),u.addValue(p.Lang["已修改波特率为"]+t+"\n")}catch(e){throw"Unable to change the baud rate, please try setting the connection speed from "+t+" to 115200 and reconnecting."}}}async sync(){this.logMsg("Performing sync...");for(let e=0;e<5;e++){if(n.inputBuffer=[],await this._sync())return await this.sleep(100),this.logMsg("Successfully synced."),!0;await this.sleep(100)}throw"Couldn't sync to ESP. Try resetting."}async _sync(){await this.command(8,r);var[e,,]=await this.getResponse(8,100);this.syncStubDetected=0===e?1:0;for(let e=0;e<8;e++){var[t,o]=await this.getResponse(8,100);if(this.syncStubDetected&=0===t?1:0,null!==o&&(1<o.length&&0==o[0]&&0==o[1]))return!0}return!1}getFlashWriteSize(){return 1024}async flashData(e,t=0,o=0){var r=e.byteLength,i=(this.logMsg("\nWriting data with filesize:"+r),u.addValue(p.Lang["写入数据，文件大小："]+r+"\n"),await this.flashBegin(r,t));let l=[],a=0,n=0;var s=t;let c=0;for(var t=Date.now(),d=this.getFlashWriteSize();0<r-c;){var g=Math.floor(100*(a+1)/i);-1==u.getValue().lastIndexOf("("+g+" %)")&&u.addValue(p.Lang["写入数据到"]+" "+this.toHex(s+a*d,8)+"... ("+g+" %)\n"),null!==this.updateProgress&&this.updateProgress(o,g),l=r-c>=d?Array.from(new Uint8Array(e,c,d)):(l=Array.from(new Uint8Array(e,c,r-c))).concat(new Array(d-l.length).fill(255)),await this.flashBlock(l,a),a+=1,n+=l.length,c+=d}this.logMsg("Took "+(Date.now()-t)+"ms to write "+r+" bytes"),u.addValue(p.Lang["写入"]+" "+r+" bytes "+p.Lang["耗时"]+" "+(Date.now()-t)+" ms\n")}async flashDeflBegin(e,t,o){let r;var i=this.getFlashWriteSize(),l=Math.floor((t+i-1)/i),a=Math.floor((e+i-1)/i),n=Date.now();let s,c;return c=this.IS_STUB?(s=e,h):(s=a*self.FLASH_WRITE_SIZE,this.timeoutPerMb(3e4,s)),this.logMsg("Compressed "+e+" bytes to "+t+"..."),r=struct.pack("<IIII",s,l,i,o),[d,g,A].includes(this._chipfamily)&&!this.IS_STUB&&(r=r.concat(struct.pack("<I",0))),await this.checkCommand(16,r,0,c),0==e||this.IS_STUB||this.logMsg("Took "+(Date.now()-n)+"ms to erase flash block"),l}async flashDeflBlock(e,t,o=h){await this.checkCommand(17,struct.pack("<IIII",e.length,t,0,0).concat(e),this.checksum(e),o)}async flashDeflFinish(e=!1){(e||this.IS_STUB)&&(e=struct.pack("<I",e?0:1),await this.checkCommand(18,e))}async flashBegin(e=0,t=0,o=!1){let r;var i=this.getFlashWriteSize(),l=(this.IS_STUB||[50,d,g,A].includes(this._chipfamily)&&await this.checkCommand(13,new Array(8).fill(0)),50==this._chipfamily&&(r=struct.pack("<IIIIII",0,this._flashsize,65536,4096,256,65535),await this.checkCommand(11,r)),Math.floor((e+i-1)/i)),a=this.getEraseSize(t,e);let n;n=this.IS_STUB?h:this.timeoutPerMb(3e4,e);var s=Date.now();return r=struct.pack("<IIII",a,l,i,t),[d,g,A].includes(this._chipfamily)&&!this.IS_STUB&&(r=r.concat(struct.pack("<I",o?1:0))),this.logMsg("Erase size "+a+", blocks "+l+", block size "+i+", offset "+this.toHex(t,4)+", encrypted "+(o?"yes":"no")),await this.checkCommand(2,r,0,n),0==e||this.IS_STUB||this.logMsg("Took "+(Date.now()-s)+"ms to erase "+l+" bytes"),l}async flashBlock(e,t,o=h){await this.checkCommand(3,struct.pack("<IIII",e.length,t,0,0).concat(e),this.checksum(e),o)}async flashFinish(){var e=struct.pack("<I",1);await this.checkCommand(4,e)}async runSpiflashCommand(e,t=[],o=0,r=null,i=0,l=0){var a=await this.chipType();let n=this.getChipInfo(a);const s=n.spiRegBase,c=s+0;var a=s+4,d=s+n.spiUsrOffs;const g=s+n.spiUsr1Offs;var u=s+n.spiUsr2Offs,p=s+n.spiW0Offs;const A=26,h=1<<18;let y,m;if(y=(y=null!=n.spiMosiDlenOffs?async function(e,t){var o=s+n.spiMosiDlenOffs,r=s+n.spiMisoDlenOffs;0<e&&await this.writeRegister(o,e-1),0<t&&await this.writeRegister(r,t-1),(m=0)<l&&(m|=l-1),0<i&&(m|=i-1<<A),m&&await this.writeRegister(g,m)}:async function(e,t){var o=g,e=0==e?0:e-1,t=0==t?0:t-1;m=t<<8|e<<17,0<l&&(m|=l-1),0<i&&(m|=i-1<<A),await this.writeRegister(o,m)}).bind(this),32<o)throw new v("Reading more than 32 bits back from a SPI flash operation is unsupported");if(64<t.length)throw new v("Writing more than 64 bytes of data with one SPI command is unsupported");var f,b=8*t.length,x=await this.readRegister(d),C=await this.readRegister(u);if(m=1<<31,0<o&&(m|=1<<28),0<b&&(m|=1<<27),0<i&&(m|=1<<30),0<l&&(m|=1<<29),await y(b,o),await this.writeRegister(d,m),await this.writeRegister(u,7<<28|e),null!=r&&0<i&&await this.writeRegister(a,r),0==b)await this.writeRegister(p,0);else{t=t.concat(new Array(4-t.length).fill(0));let e=p;for(f of struct.unpack("I"*Math.floor(t.length/4),t))await this.writeRegister(e,f),e+=4}await this.writeRegister(c,h);await async function(){for(let e=0;e<10;e++)if(0==(await this.readRegister(c)&h))return;throw new v("SPI command did not complete in time")}.bind(this)();o=await this.readRegister(p);return await this.writeRegister(d,x),await this.writeRegister(u,C),o}async flashId(){return this.runSpiflashCommand(159,[],24)}getEraseSize(e,t){if(this._chipfamily!=s||this.IS_STUB)return t;var o=4096,t=Math.floor((t+o-1)/o);let r=16-Math.floor(e/o)%16;return t<2*(r=t<r?t:r)?Math.floor((t+1)/2*o):(t-r)*o}async memBegin(e,t,o,r){if(this.IS_STUB){var i,l,a=await this.getStubCode(),n=r,s=r+e;console.log(n,s),console.log(a.data_start,a.data.length,a.text_start,a.text.length);for([i,l]of[[a.data_start,a.data_start+a.data.length],[a.text_start,a.text_start+a.text.length]])if(n<l&&s>i)throw"Software loader is resident at "+this.toHex(i,8)+"-"+this.toHex(l,8)+". Can't load binary at overlapping address range "+this.toHex(n,8)+"-"+this.toHex(s,8)+". Try changing the binary loading address."}return this.checkCommand(5,struct.pack("<IIII",e,t,o,r))}async memBlock(e,t){return this.checkCommand(7,struct.pack("<IIII",e.length,t,0,0).concat(e),this.checksum(e))}async memFinish(e=0){var t=this.IS_STUB?h:500,e=struct.pack("<II",parseInt(0==e),e);try{return await this.checkCommand(6,e,0,t)}catch(e){if(this.IS_STUB)throw e}}async getStubCode(){var e=await this.chipType(),t=this.getChipInfo(e),o={},r=["text","text_start","entry","data","data_start"];for(let e=0;e<r.length;e++)l[t.stubFile]&&l[t.stubFile][r[e]]&&("text"==r[e]||"data"==r[e]?o[r[e]]=toByteArray(atob(l[t.stubFile][r[e]])):o[r[e]]=parseInt(l[t.stubFile][r[e]]));return o}getStubLoaderClass(){}getRomClass(){}async runStub(o=null){if(null===o&&(o=await this.getStubCode()),this.syncStubDetected||this.IS_STUB)this.logMsg("Stub is already running. No upload is necessary.");else{let t=6144;[d,g,A].includes(this._chipfamily)&&(t=2048),this.logMsg("Uploading stub..."),u.addValue(p.Lang["上传"]+" stub...\n");for(var r of["text","data"])if(Object.keys(o).includes(r)){var i,e=o[r+"_start"],l=o[r].length,a=Math.floor((l+t-1)/t);await this.memBegin(l,a,t,e);for(i of Array(a).keys()){var n=i*t;let e=n+t;e>l&&(e=l),await this.memBlock(o[r].slice(n,e),i)}}this.logMsg("Running stub..."),u.addValue(p.Lang["运行"]+" stub...\n"),await this.memFinish(o.entry);var s=await this.readBuffer(500);if("OHAI"!=(s=String.fromCharCode(...s)))throw"Failed to start stub. Unexpected response: "+s;this.logMsg("Stub is now running..."),u.addValue("Stub "+p.Lang["正在运行中"]+"...\n"),this.stubClass=new c({updateProgress:this.updateProgress,logMsg:this.logMsg,debugMsg:this._debugMsg,debug:this.debug})}return this.stubClass}}class c extends o{constructor(e){super(e),this.IS_STUB=!0}async eraseFlash(){await this.checkCommand(208,[],0,12e4)}getFlashWriteSize(){return 16384}}(class extends c{});class a extends Error{constructor(e){super(e),this.name="SlipReadError"}}class v extends Error{constructor(e){super(e),this.name="FatalError"}}t.EspLoader=o,t.EspStubLoader=c,t.SlipReadError=a,t.FatalError=v}),goog.loadJs("common",()=>{goog.require("layui"),goog.require("Blockly"),goog.require("Base64"),goog.require("Mixly.Config"),goog.require("Mixly.MArray"),goog.require("Mixly.Boards"),goog.require("Mixly.XML"),goog.require("Mixly.LayerExt"),goog.require("Mixly.MicrobitFs"),goog.require("Mixly.Editor"),goog.require("Mixly.Drag"),goog.require("Mixly.Msg"),goog.provide("Mixly.MFile");const{form:t,util:C}=layui,{Config:e,Boards:v,XML:o,LayerExt:a,MicrobitFs:r,Editor:B,Drag:w,Msg:E,MFile:M}=Mixly,{BOARD:n,SOFTWARE:s}=e;M.SAVE_FILTER_TYPE={mix:{name:E.Lang["Mixly文件"],extensions:["mix"]},py:{name:E.Lang["Python文件"],extensions:["py"]},ino:{name:E.Lang["Arduino文件"],extensions:["ino"]},hex:{name:E.Lang["Hex文件"],extensions:["hex"]},bin:{name:E.Lang["Bin文件"],extensions:["bin"]},png:{name:E.Lang["图像文件"],extensions:["png"]},mil:{name:E.Lang["Mixly库文件"],extensions:["mil"]}},M.saveFilters=[M.SAVE_FILTER_TYPE.mix],M.OPEN_FILTER_TYPE=["mix","xml","py","ino","hex","bin"],M.openFilters=["mix"],M.updateSaveFilters=(e,t=null)=>{"object"!=typeof e&&(e=[]),M.saveFilters=[M.SAVE_FILTER_TYPE.mix];var o,r=["mix"];for(o of e)M.SAVE_FILTER_TYPE[o]&&!r.includes(o)&&(r.push(o),o===t?M.saveFilters.unshift(M.SAVE_FILTER_TYPE[o]):M.saveFilters.push(M.SAVE_FILTER_TYPE[o]))},M.updateOpenFilters=(e,t)=>{"object"!=typeof e&&(e=[]),M.openFilters=["mix","xml"];for(var o of e)M.OPEN_FILTER_TYPE.includes(o)&&!M.openFilters.includes(o)&&M.openFilters.push(o)},M.init=()=>{var e,t=n?.nav?.save??{},o=[],r=[];for(e in t)t[e]&&("img"!==e?(o.push(e),r.push(e)):o.push("png"));n?.nav?.setting?.thirdPartyLibrary&&o.push("mil"),M.updateOpenFilters(r),M.updateSaveFilters(o)},M.init(),M.getCode=e=>{let t;return t=e?"py"===e?Blockly.Python:Blockly.Arduino:Blockly?.Python??Blockly.Arduino,"CODE"===B.selected?B.codeEditor.getValue():t.workspaceToCode(B.blockEditor)||""},M.getHex=()=>{var e=M.getCode();return r.getHex(e)},M.loadHex=e=>{r.loadHex("main.py",e)},M.getMix=()=>{var e=$(Blockly.Xml.workspaceToDom(B.blockEditor)),t=s?.version??"Mixly 2.0",o=v.getSelectedBoardName(),r=n?.boardType??"default",i=v.getSelectedBoardConfig();e.removeAttr("xmlns").attr("version",t).attr("board",r+"@"+o);let l=e[0].outerHTML;t=M.getCode();if(i)try{l+=`<config>${JSON.stringify(i)}</config>`}catch(e){console.log(e)}return n.saveMixWithCode&&(t=Base64.encode(t),l+=`<code>${t}</code>`),l},M.getMil=()=>{var t=$(M.getMix());let o,r,i;for(let e=0;t[e];e++)switch(t[e].nodeName){case"XML":o=$(t[e]);break;case"CONFIG":r=$(t[e]);break;case"CODE":i=$(t[e])}if(!o)return"";r&&r.remove(),i&&i.remove(),o.attr("type","lib"),o.find("block,shadow").removeAttr("id varid x y");var l=o.children("block"),a=[];for(let e=0;l[e];e++){var n=l[e].outerHTML;a.includes(n)?l[e].remove():a.push(n)}return o[0].outerHTML},M.getBlocksPng=()=>new Promise((t,e)=>{var o=B.blockEditor.svgBlockCanvas_.cloneNode(!0),r=(o.removeAttribute("width"),o.removeAttribute("height"),o.removeAttribute("transform"),document.createElementNS("http://www.w3.org/2000/svg","style")),r=(Blockly.Css.CONTENT=[".blocklySvg {","background-color: #fff;","outline: none;","overflow: hidden;","position: absolute;","display: block;","}",".blocklyWidgetDiv {","display: none;","position: absolute;","z-index: 99999;","}",".injectionDiv {","height: 100%;","position: relative;","overflow: hidden;","}",".blocklyNonSelectable {","user-select: none;","-moz-user-select: none;","-webkit-user-select: none;","-ms-user-select: none;","}",".blocklyWsDragSurface {","display: none;","position: absolute;","overflow: visible;","top: 0;","left: 0;","}",".blocklyBlockDragSurface {","display: none;","position: absolute;","top: 0;","left: 0;","right: 0;","bottom: 0;","overflow: visible !important;","z-index: 50;","}",".blocklyTooltipDiv {","background-color: #ffffc7;","border: 1px solid #ddc;","box-shadow: 4px 4px 20px 1px rgba(0,0,0,.15);","color: #000;","display: none;","font-family: PingFang SC, sans-serif;","font-size: 9pt;","opacity: 0.9;","padding: 2px;","position: absolute;","z-index: 100000;","}",".blocklyResizeSE {","cursor: se-resize;","fill: #aaa;","}",".blocklyResizeSW {","cursor: sw-resize;","fill: #aaa;","}",".blocklyResizeLine {","stroke: #888;","stroke-width: 1;","}",".blocklyHighlightedConnectionPath {","fill: none;","stroke: #fc3;","stroke-width: 4px;","}",".blocklyPathLight {","fill: none;","stroke-linecap: round;","stroke-width: 1;","}",".blocklySelected>.blocklyPath {","stroke: #fc3;","stroke-width: 3px;","}",".blocklySelected>.blocklyPathLight {","display: none;","}",".blocklyDraggable {",'cursor: url("<<<PATH>>>/handopen.cur"), auto;',"cursor: grab;","cursor: -webkit-grab;","cursor: -moz-grab;","}",".blocklyDragging {",'cursor: url("<<<PATH>>>/handclosed.cur"), auto;',"cursor: grabbing;","cursor: -webkit-grabbing;","cursor: -moz-grabbing;","}",".blocklyDraggable:active {",'cursor: url("<<<PATH>>>/handclosed.cur"), auto;',"cursor: grabbing;","cursor: -webkit-grabbing;","cursor: -moz-grabbing;","}",".blocklyBlockDragSurface .blocklyDraggable {",'cursor: url("<<<PATH>>>/handclosed.cur"), auto;',"cursor: grabbing;","cursor: -webkit-grabbing;","cursor: -moz-grabbing;","}",".blocklyDragging.blocklyDraggingDelete {",'cursor: url("<<<PATH>>>/handdelete.cur"), auto;',"}",".blocklyToolboxDelete {",'cursor: url("<<<PATH>>>/handdelete.cur"), auto;',"}",".blocklyDragging>.blocklyPath,",".blocklyDragging>.blocklyPathLight {","fill-opacity: .8;","stroke-opacity: .8;","}",".blocklyDragging>.blocklyPathDark {","display: none;","}",".blocklyDisabled>.blocklyPath {","fill-opacity: .5;","stroke-opacity: .5;","}",".blocklyDisabled>.blocklyPathLight,",".blocklyDisabled>.blocklyPathDark {","display: none;","}",".blocklyText {","cursor: default;","fill: #fff;","font-family: PingFang SC, sans-serif;","font-size: 11pt;","}",".blocklyNonEditableText>text {","pointer-events: none;","}",".blocklyNonEditableText>rect,",".blocklyEditableText>rect {","fill: #fff;","fill-opacity: .6;","}",".blocklyNonEditableText>text,",".blocklyEditableText>text {","fill: #000;","}",".blocklyEditableText:hover>rect {","stroke: #fff;","stroke-width: 2;","}",".blocklyBubbleText {","fill: #000;","}",".blocklyFlyout {","position: absolute;","z-index: 20;","}",".blocklyFlyoutButton {","fill: #888;","cursor: default;","}",".blocklyFlyoutButtonShadow {","fill: #666;","}",".blocklyFlyoutButton:hover {","fill: #aaa;","}",".blocklyFlyoutLabel {","cursor: default;","}",".blocklyFlyoutLabelBackground {","opacity: 0;","}",".blocklyFlyoutLabelText {","fill: #000;","}",".blocklySvg text, .blocklyBlockDragSurface text {","user-select: none;","-moz-user-select: none;","-webkit-user-select: none;","cursor: inherit;","}",".blocklyHidden {","display: none;","}",".blocklyFieldDropdown:not(.blocklyHidden) {","display: block;","}",".blocklyIconGroup {","cursor: default;","}",".blocklyIconGroup:not(:hover),",".blocklyIconGroupReadonly {","opacity: .6;","}",".blocklyIconShape {","fill: #00f;","stroke: #fff;","stroke-width: 1px;","}",".blocklyIconSymbol {","fill: #fff;","}",".blocklyMinimalBody {","margin: 0;","padding: 0;","}",".blocklyCommentTextarea {","background-color: #ffc;","border: 0;","margin: 0;","padding: 2px;","resize: none;","}",".blocklyHtmlInput {","border: none;","border-radius: 4px;","font-family: PingFang SC, sans-serif;","height: 100%;","margin: 0;","outline: none;","padding: 0 1px;","width: 100%","}",".blocklyMainBackground {","stroke-width: 1;","stroke: #c6c6c6;","}",".blocklyMutatorBackground {","fill: #fff;","stroke: #ddd;","stroke-width: 1;","}",".blocklyFlyoutBackground {","fill: #666;","fill-opacity: .8;","}",".blocklyMainWorkspaceScrollbar {","z-index: 20;","}",".blocklyFlyoutScrollbar {","z-index: 30;","}",".blocklyScrollbarHorizontal, .blocklyScrollbarVertical {","position: absolute;","outline: none;","}",".blocklyScrollbarBackground {","opacity: 0;","}",".blocklyScrollbarHandle {","fill: #ccc;","}",".blocklyScrollbarBackground:hover+.blocklyScrollbarHandle,",".blocklyScrollbarHandle:hover {","fill: #bbb;","}",".blocklyZoom>image {","opacity: .4;","}",".blocklyZoom>image:hover {","opacity: .6;","}",".blocklyZoom>image:active {","opacity: .8;","}",".blocklyFlyout .blocklyScrollbarHandle {","fill: #bbb;","}",".blocklyFlyout .blocklyScrollbarBackground:hover+.blocklyScrollbarHandle,",".blocklyFlyout .blocklyScrollbarHandle:hover {","fill: #aaa;","}",".blocklyInvalidInput {","background: #faa;","}",".blocklyAngleCircle {","stroke: #444;","stroke-width: 1;","fill: #ddd;","fill-opacity: .8;","}",".blocklyAngleMarks {","stroke: #444;","stroke-width: 1;","}",".blocklyAngleGauge {","fill: #f88;","fill-opacity: .8;","}",".blocklyAngleLine {","stroke: #f00;","stroke-width: 2;","stroke-linecap: round;","pointer-events: none;","}",".blocklyContextMenu {","border-radius: 4px;","}",".blocklyDropdownMenu {","padding: 0 !important;","}",".blocklyWidgetDiv .goog-option-selected .goog-menuitem-checkbox,",".blocklyWidgetDiv .goog-option-selected .goog-menuitem-icon {","background: url(<<<PATH>>>/sprites.png) no-repeat -48px -16px !important;","}",".blocklyToolboxDiv {","background-color: #272727;","overflow-x: visible;","overflow-y: auto;","position: absolute;","z-index: 70;","}",".blocklyTreeRoot {","padding: 4px 0;","}",".blocklyTreeRoot:focus {","outline: none;","}",".blocklyTreeRow {","height: 36px;","line-height: 32px;","margin-bottom: 6px;","padding-right: 8px;","border-radius: 4px;","white-space: nowrap;","}",".blocklyHorizontalTree {","float: left;","margin: 1px 5px 8px 0;","}",".blocklyHorizontalTreeRtl {","float: right;","margin: 1px 0 8px 5px;","}",'.blocklyToolboxDiv[dir="RTL"] .blocklyTreeRow {',"margin-left: 8px;","}",".blocklyTreeRow:not(.blocklyTreeSelected):hover {","background-color: #ccc;","}",".blocklyTreeSeparator {","border-bottom: solid #e5e5e5 1px;","height: 0;","margin: 5px 0;","}",".blocklyTreeSeparatorHorizontal {","border-right: solid #e5e5e5 1px;","width: 0;","padding: 5px 0;","margin: 0 5px;","}",".blocklyTreeIcon {","background-image: url(<<<PATH>>>/sprites.png);","height: 16px;","vertical-align: middle;","width: 16px;","}",".blocklyTreeIconClosedLtr {","background-position: -32px -1px;","}",".blocklyTreeIconClosedRtl {","background-position: 0px -1px;","}",".blocklyTreeIconOpen {","background-position: -16px -1px;","}",".blocklyTreeSelected>.blocklyTreeIconClosedLtr {","background-position: -32px -17px;","}",".blocklyTreeSelected>.blocklyTreeIconClosedRtl {","background-position: 0px -17px;","}",".blocklyTreeSelected>.blocklyTreeIconOpen {","background-position: -16px -17px;","}",".blocklyTreeIconNone,",".blocklyTreeSelected>.blocklyTreeIconNone {","background-position: -48px -1px;","}",".blocklyTreeLabel {","cursor: default;","font-family: PingFang SC, sans-serif;","font-size: 16px;","padding: 0 8px;","vertical-align: middle;","}",".blocklyTreeSelected .blocklyTreeLabel {","color: #fff;","}",".blocklyWidgetDiv .goog-palette {","outline: none;","cursor: default;","}",".blocklyWidgetDiv .goog-palette-table {","border: 1px solid #666;","border-collapse: collapse;","}",".blocklyWidgetDiv .goog-palette-cell {","height: 13px;","width: 15px;","margin: 0;","border: 0;","text-align: center;","vertical-align: middle;","border-right: 1px solid #666;","font-size: 1px;","}",".blocklyWidgetDiv .goog-palette-colorswatch {","position: relative;","height: 13px;","width: 15px;","border: 1px solid #666;","}",".blocklyWidgetDiv .goog-palette-cell-hover .goog-palette-colorswatch {","border: 1px solid #FFF;","}",".blocklyWidgetDiv .goog-palette-cell-selected .goog-palette-colorswatch {","border: 1px solid #000;","color: #fff;","}",".blocklyWidgetDiv .goog-menu {","background: #fff;","border-color: #ccc #666 #666 #ccc;","border-style: solid;","border-width: 1px;","cursor: default;","font: normal 13px Arial, sans-serif;","margin: 0;","outline: none;","padding: 4px 0;","position: absolute;","overflow-y: auto;","overflow-x: hidden;","max-height: 100%;","z-index: 20000;","}",".blocklyWidgetDiv .goog-menuitem {","color: #000;","font: normal 13px Arial, sans-serif;","list-style: none;","margin: 0;","padding: 4px 7em 4px 28px;","white-space: nowrap;","}",".blocklyWidgetDiv .goog-menuitem.goog-menuitem-rtl {","padding-left: 7em;","padding-right: 28px;","}",".blocklyWidgetDiv .goog-menu-nocheckbox .goog-menuitem,",".blocklyWidgetDiv .goog-menu-noicon .goog-menuitem {","padding-left: 12px;","}",".blocklyWidgetDiv .goog-menu-noaccel .goog-menuitem {","padding-right: 20px;","}",".blocklyWidgetDiv .goog-menuitem-content {","color: #000;","font: normal 13px Arial, sans-serif;","}",".blocklyWidgetDiv .goog-menuitem-disabled .goog-menuitem-accel,",".blocklyWidgetDiv .goog-menuitem-disabled .goog-menuitem-content {","color: #ccc !important;","}",".blocklyWidgetDiv .goog-menuitem-disabled .goog-menuitem-icon {","opacity: 0.3;","-moz-opacity: 0.3;","filter: alpha(opacity=30);","}",".blocklyWidgetDiv .goog-menuitem-highlight,",".blocklyWidgetDiv .goog-menuitem-hover {","background-color: #d6e9f8;","border-color: #d6e9f8;","border-style: dotted;","border-width: 1px 0;","padding-bottom: 3px;","padding-top: 3px;","}",".blocklyWidgetDiv .goog-menuitem-checkbox,",".blocklyWidgetDiv .goog-menuitem-icon {","background-repeat: no-repeat;","height: 16px;","left: 6px;","position: absolute;","right: auto;","vertical-align: middle;","width: 16px;","}",".blocklyWidgetDiv .goog-menuitem-rtl .goog-menuitem-checkbox,",".blocklyWidgetDiv .goog-menuitem-rtl .goog-menuitem-icon {","left: auto;","right: 6px;","}",".blocklyWidgetDiv .goog-option-selected .goog-menuitem-checkbox,",".blocklyWidgetDiv .goog-option-selected .goog-menuitem-icon {","background: url(//ssl.gstatic.com/editor/editortoolbar.png) no-repeat -512px 0;","}",".blocklyWidgetDiv .goog-menuitem-accel {","color: #999;","direction: ltr;","left: auto;","padding: 0 6px;","position: absolute;","right: 0;","text-align: right;","}",".blocklyWidgetDiv .goog-menuitem-rtl .goog-menuitem-accel {","left: 0;","right: auto;","text-align: left;","}",".blocklyWidgetDiv .goog-menuitem-mnemonic-hint {","text-decoration: underline;","}",".blocklyWidgetDiv .goog-menuitem-mnemonic-separator {","color: #999;","font-size: 12px;","padding-left: 4px;","}",".blocklyWidgetDiv .goog-menuseparator {","border-top: 1px solid #ccc;","margin: 4px 0;","padding: 0;","}",""],r.textContent=Blockly.Css.CONTENT.join(""),o.insertBefore(r,o.firstChild),B.blockEditor.svgBlockCanvas_.getBBox()),o=(new XMLSerializer).serializeToString(o),o='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+r.width+'" height="'+r.height+'" viewBox="'+r.x+" "+r.y+" "+r.width+" "+r.height+'"><rect width="100%" height="100%" style="fill-opacity:0"></rect>'+o+"</svg>",o="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o))),i=new Image,l=(i.src=o,document.createElement("canvas")),a=(l.width=2*Math.ceil(r.width),l.height=2*Math.ceil(r.height),l.getContext("2d"));a.scale(2,2),i.onload=function(){a.drawImage(i,0,0);var e=Base64.toUint8Array(l.toDataURL("image/png").replace("data:image/png;base64,",""));t(e)}}),M.parseMix=(r,i=!1,l=!1,a=e=>{})=>{var n=r;let s,c,d;for(let e=0;n[e];e++)switch(n[e].nodeName){case"XML":s=$(n[e]);break;case"CONFIG":c=$(n[e]);break;case"CODE":d=$(n[e])}if(s||d){for(var g of["version","id","type","varid","name","x","y","items"]){var u=s.find("*["+g+"]");if(u.length)for(let t=0;u[t];t++){let e=$(u[t]).attr(g);try{e=e.replaceAll('\\"',"")}catch(e){console.log(e)}$(u[t]).attr(g,e)}}let e,t=c&&c.html();try{t&&(e=JSON.parse(t))}catch(e){console.log(e)}r=s.attr("board")??"";v.setSelectedBoard(r,e);let o=d?d.html():"";if(Base64.isValid(o))o=Base64.decode(o);else try{o=(o=C.unescape(o)).replace(/(_E[0-9A-F]{1}_[0-9A-F]{2}_[0-9A-F]{2})+/g,function(t){try{return decodeURIComponent(t.replace(/_/g,"%"))}catch(e){return t}})}catch(e){console.log(e)}if(i)return d?(w.items.vDrag.full("NEGATIVE"),B.codeEditor.setValue(o,-1),B.blockEditor.clear(),void a("USE_CODE")):void layer.msg(E.Lang["未找到有效数据"],{time:1e3});var p=n.find("block"),A=n.find("shadow"),h=(p.removeAttr("id varid"),A.removeAttr("id varid"),[]),y=[];for(let e=0;p[e];e++){var m=$(p[e]).attr("type");m&&!h.includes(m)&&h.push(m)}for(let e=0;A[e];e++){var f=$(A[e]).attr("type");f&&!h.includes(f)&&h.push(f)}var b,x=Blockly?.Python??Blockly.Arduino;for(b of h)Blockly.Blocks[b]&&x[b]||y.push(b);y.length?M.showParseMixErrorDialog(n,y,a):(B.blockEditor.clear(),Blockly.Xml.domToWorkspace(B.blockEditor,s[0]),B.blockEditor.scrollCenter(),Blockly.hideChaff(),!l&&d?(M.getCode()!==o&&(w.items.vDrag.full("NEGATIVE"),B.codeEditor.setValue(o,-1)),a()):(w.items.vDrag.full("POSITIVE"),l?a("USE_INCOMPLETE_BLOCKS"):a()))}else layer.msg(E.Lang["未找到有效数据"],{time:1e3})},M.removeUndefinedBlocks=(e,t)=>{for(var o of t)e.find("*[type="+o+"]").remove()},M.showParseMixErrorDialog=(r,i,l=()=>{})=>{var e=o.TEMPLATE_STR["PARSE_MIX_ERROR_DIV"],e=o.render(e,{text:i.join("<br/>"),btn1Name:E.Lang["取消"],btn2Name:E.Lang["忽略未定义块"],btn3Name:E.Lang["读取代码"]});a.open({title:E.Lang["一些图形化模块尚未定义"],id:"parse-mix-error-layer",area:["50%","250px"],max:["500px","250px"],min:["350px","100px"],shade:a.SHADE_ALL,content:e,borderRadius:"5px",success:(e,o)=>{$("#parse-mix-error-layer").css("overflow","hidden"),t.render(null,"parse-mix-error-filter"),e.find("button").click(e=>{switch(layer.close(o),$(e.currentTarget).attr("m-id")){case"0":break;case"1":for(var t of i)r.find("*[type="+t+"]").remove();M.parseMix(r,!1,!0,l);break;case"2":M.parseMix(r,!0,!1,l)}})}})},M.openFile=(e,t="text",o=()=>{})=>{var r=$("<input></input>");r.attr({id:"web-open-file",type:"file",name:"web-open-file",accept:e}),r.change(function(e){M.onclickOpenFile(this,t,e=>{o(e)})}),r.css("display","none"),$("#web-open-file").remove(),$("body").append(r),r.click()},M.onclickOpenFile=(e,t,o)=>{if(5242880<e.files[0].size)return layer.msg("所选择文件大小必须在5MB内",{time:1e3}),$("#web-open-file").remove(),o(null),!1;var r=e.files[0];if(r){const l=r.name;var i=new FileReader;switch(t){case"text":i.readAsText(r);break;case"bin":i.readAsBinaryString(r);break;case"url":i.readAsDataURL(r);break;default:i.readAsArrayBuffer(r)}i.onload=function(e){e=e.target.result;$("#web-open-file").remove(),o({data:e,filename:l})}}else o(null)}}),goog.loadJs("common",()=>{goog.provide("Mixly.StatusBarPort"),goog.require("Mixly.StatusBar"),goog.require("Mixly.Config"),goog.require("layui");const a=layui["element"],{StatusBarPort:n,Config:e,StatusBar:s}=Mixly,c=e["USER"];n.portAce={},n.portsName=[];let{portAce:d,portsName:g}=n;n.addDefaultCommand=e=>{d[e].commands.addCommands([{name:"increaseFontSize",bindKey:"Ctrl-=|Ctrl-+",exec:e=>{var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(t+1)}},{name:"decreaseFontSize",bindKey:"Ctrl+-|Ctrl-_",exec:e=>{var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(t-1||1))}},{name:"resetFontSize",bindKey:"Ctrl+0|Ctrl-Numpad0",exec:e=>{e.setFontSize(12)}}])},n.tabAdd=(t,o=!0,r=e=>{},i=e=>{})=>{if(g.includes(t))n.open(t);else{let e=t;try{e=(e=e.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}var l=`<pre class="tab-ace" id="tab-${e}-ace" align="center"></pre>`;a.tabAdd("status-bar-ace",{title:t+`<span id="tab-ace-${e}-span" class="layui-badge-dot layui-bg-orange"></span>`,content:l,id:"tab-ace-"+e}),g.push(t),d[t]=ace.edit(`tab-${e}-ace`),"dark"===c.theme?d[t].setOption("theme","ace/theme/terminal"):d[t].setOption("theme","ace/theme/xcode"),d[t].getSession().setMode("ace/mode/python"),d[t].setFontSize(document.body.clientWidth/95),d[t].setReadOnly(!1),d[t].setScrollSpeed(.3),d[t].setShowPrintMargin(!1),d[t].renderer.setShowGutter(!1),o&&n.addDefaultCommand(t),"function"==typeof r&&r(t),a.on("tabDelete(status-bar-ace)",e=>{var t=g[e.index-1];d[t].destroy(),d[t].container.remove(),g.splice(e.index-1,1),delete d[t],"function"==typeof i&&i(t)}),a.on("tab(status-bar-ace)",e=>{0==e.index?s.scrollToTheBottom():n.scrollToTheBottom(g[e.index-1])})}},n.tabChange=e=>{let t=e;try{t=(t=t.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}a.tabChange("status-bar-ace","tab-ace-"+t)},n.tabDelete=e=>{let t=e;try{t=(t=t.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}a.tabDelete("status-bar-ace","tab-ace-"+t)},n.setValue=(e,t,o=!0)=>{var r,i;d[e]&&(d[e].updateSelectionMarkers(),r=d[e]["selection"],i=r.getCursor(),n.getValue(e)!==t)&&(d[e].setValue(t),o?(d[e].gotoLine(d[e].session.getLength()),r.moveCursorLineEnd()):(r.moveCursorTo(i.row,i.column,!0),r.clearSelection()))},n.getValue=e=>d[e]?d[e].getValue():"",n.getValueRange=(e,t,o)=>{return d[e]&&t&&o&&"object"==typeof t&&"object"==typeof o?d[e].getSession().getTextRange(new ace.Range(t.row,t.column,o.row,o.column)):""},n.addValue=(e,t,o=!0)=>{var r,i;d[e]&&(d[e].updateSelectionMarkers(),r=d[e]["selection"],i=r.getCursor(),d[e].gotoLine(d[e].session.getLength()),r.moveCursorLineEnd(),d[e].insert(t),o?(d[e].gotoLine(d[e].session.getLength()),r.moveCursorLineEnd()):r.moveCursorTo(i.row,i.column,!0))},n.getEndPos=e=>{var t;if(d[e])return{row:t=(e=d[e].getSession()).getLength()-1,column:e.getLine(t).length}},n.scrollToTheBottom=e=>{d[e]&&(d[e].updateSelectionMarkers(),d[e].gotoLine(d[e].session.getLength()),d[e].selection.moveCursorLineEnd())},n.scrollToTheTop=e=>{d[e]&&d[e].gotoLine(0)},n.open=e=>{let t=e;try{t=(t=t.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}e=$(`#tab-ace-${t}-span`);e&&e[0]&&(e[0].className="layui-badge-dot layui-bg-orange")},n.close=e=>{let t=e;try{t=(t=t.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}e=$(`#tab-ace-${t}-span`);e&&e[0]&&(e[0].className="layui-badge-dot layui-bg-blue")}}),goog.loadJs("common",()=>{goog.require("Blockly"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Editor"),goog.provide("Mixly.Theme");const{Theme:t,StatusBar:a,StatusBarPort:n,Editor:s}=Mixly;t.changeTo=function(e){var{blockEditor:t,codeEditor:o}=s;let r,i,l;if(l="dark"===e?($("#nav").removeClass("layui-bg-green").addClass("layui-bg-cyan"),$("body").removeClass("light").addClass("dark"),r=Blockly.Themes.Dark,i="ace/theme/dracula","ace/theme/terminal"):($("#nav").removeClass("layui-bg-cyan").addClass("layui-bg-green"),$("body").removeClass("dark").addClass("light"),r=Blockly.Themes.Classic,i="ace/theme/crimson_editor",Blockly.Arduino&&(i="ace/theme/xcode"),"ace/theme/xcode"),t.setTheme(r),o.setOption("theme",i),a.Ace&&a.Ace.setOption("theme",l),n?.portsName)for(let e=0,t=n.portsName.length;e<t;e++)n.portAce[n.portsName[e]].setOption("theme",l)},t.changeEditorTheme_dark=function(){$("#nav").removeClass("layui-nav layui-bg-green"),$("#nav").addClass("layui-nav layui-bg-cyan"),$("body").removeClass("light"),$("body").addClass("dark");var e="ace/theme/dracula";null!=editor&&(editor.setOption("theme",e),$("#content_arduino").css("background-color","#282a36"));try{if(null!=editor_side_code&&editor_side_code.setOption("theme",e),null!=a.Ace&&a.Ace.setOption("theme","ace/theme/terminal"),n?.portsName)for(let e=0,t=n.portsName.length;e<t;e++)n.portAce[n.portsName[e]].setOption("theme","ace/theme/terminal")}catch(e){}},window.matchMedia("(prefers-color-scheme: light)").addListener(e=>{e.matches?t.changeTo("light"):t.changeTo("dark")})}),goog.loadJs("electron",()=>{goog.require("Mixly.Modules"),goog.require("Mixly.MFile"),goog.require("Mixly.StatusBar"),goog.require("Mixly.Env"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron"),goog.provide("Mixly.Electron.PythonShell");const{Electron:e,Modules:t,StatusBar:l,Env:a,Msg:n}=Mixly,o=e["PythonShell"];t.iconvLite=require("iconv-lite"),t.PythonShell=require("python-shell").PythonShell;var s="",c=-1,d=-1,g=-1,u={pythonPath:a.python3Path,pythonOptions:["-u"],encoding:"binary",mode:"utf-8"};let p=null;function A(e){if(e)try{return unescape(e.replace(/_([0-9a-fA-F]{3})/gm,"%$1"))}catch(e){}return e}o.run=function(){const i=o.addEvent();l.show(1),l.setValue(n.Lang["程序正在运行"]+"...\n");var e=(e=Mixly.MFile.getCode()).replace(/(_[0-9A-F]{2}_[0-9A-F]{2}_[0-9A-F]{2})+/g,function(e){return decodeURIComponent(e.replace(/_/g,"%"))});try{e.match(/(?<![\w+])input\(/g)&&(e=(e="import pyinput\n"+e).replace(/(?<![\w+])input\(/g,"pyinput.input("))}catch(e){console.log(e)}-1!=e.indexOf("import turtle")&&(e+="\nturtle.done()\n"),p&&p.terminate("SIGKILL"),t.fs.writeFile(a.pyFilePath,e,"utf8",function(e){if(e=A(e))layer.msg(n.Lang["写文件出错了，错误是："]+e,{time:1e3}),l.setValue(n.Lang["写文件出错了，错误是："]+e+"\n"),l.show(1);else{p=new t.PythonShell(a.pyFilePath,u);let o=t.iconvLite;var r=Number(new Date);p.childProcess.on("exit",e=>{l.Ace.getSession().selection.removeEventListener("changeCursor",i);var t=Number(new Date)-r,t=(parseInt(t/60),t+"ms");l.getValue().lastIndexOf("\n")==l.getValue().length-1?l.addValue("=="+n.Lang["程序运行完成"]+"("+n.Lang["用时"]+" "+t+")==\n"):l.addValue("\n=="+n.Lang["程序运行完成"]+"("+n.Lang["用时"]+" "+t+")==\n"),l.scrollToTheBottom(),p=null}),p.stdout.setEncoding("binary"),p.stdout.on("data",function(e){try{e=(e=A(e="darwin"===a.currentPlatform?decode(o.decode(o.encode(e,"iso-8859-1"),"utf-8")):decode(o.decode(o.encode(e,"iso-8859-1"),"gbk")))).replace(/(?<![\w+])pyinput.input\(/g,"input(")}catch(e){console.log(e)}l.addValue(e),-1!=e.lastIndexOf(">>>")&&p&&(s=e.substring(e.lastIndexOf(">>>")),c=l.Ace.session.getLength(),l.Ace.selection.moveCursorLineEnd(),d=l.Ace.selection.getCursor().row,g=l.Ace.selection.getCursor().column)}),p.stderr.setEncoding("binary"),p.stderr.on("data",function(t){console.log("stderr: "+t);try{t=t.replace(/(?<![\w+])pyinput.input\(/g,"input(")}catch(e){console.log(e)}try{"darwin"===a.currentPlatform?l.addValue(o.decode(o.encode(t,"iso-8859-1"),"utf-8")):l.addValue(o.decode(o.encode(t,"iso-8859-1"),"gbk")),t=A(t)}catch(e){t=A(t),l.addValue(t)}l.scrollToTheBottom(),p=null})}})},o.stop=function(){l.show(1),p?(p.terminate("SIGKILL"),p=null):l.addValue("\n=="+n.Lang["无程序在运行"]+"==\n"),l.scrollToTheBottom()},o.clearOutput=function(){l.setValue("")},o.addEvent=()=>l.Ace.getSession().selection.on("changeCursor",function(e){p&&-1!=c&&((l.Ace.selection.getCursor().row<d||l.Ace.selection.getCursor().row<=d&&l.Ace.selection.getCursor().column<=g)&&l.Ace.selection.moveCursorTo(d,g,!0),-1!=(last_row_data=l.Ace.session.getLine(c-1)).indexOf(">>>"))&&l.Ace.selection.getCursor().row==c&&0==l.Ace.selection.getCursor().column&&(-1==last_row_data.indexOf(s)?(last_row_data=(last_row_data=last_row_data.replace(">>> ","")).replace(">>>",""),p.stdin.write(escape(last_row_data.replace(">>>",""))+"\n")):p.stdin.write(escape(last_row_data.replace(s,""))+"\n"),c=-1,last_row_data="")})}),goog.loadJs("electron",()=>{goog.require("layui"),goog.require("Mixly.Modules"),goog.require("Mixly.Charts"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Config"),goog.require("Mixly.Tools"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.XML"),goog.require("Mixly.MArray"),goog.require("Mixly.Msg"),goog.provide("Mixly.Electron.Serial");const r=layui["laytpl"],{Electron:e,Modules:t,Charts:s,StatusBar:c,StatusBarPort:d,Config:o,Tools:g,Env:a,LayerExt:n,XML:u,MArray:l,Msg:p}=Mixly,A=e["Serial"],{BOARD:i,USER:h}=o,{serialport:y,child_process:m,minimist:f}=(t.serialport=require("serialport"),t.minimist=require("minimist"),t),b=y["SerialPort"],x=d["portAce"];A.TOOL_DEFAULT_CONFIG={ctrlCBtn:!1,ctrlDBtn:!1,baudRates:115200,yMax:100,yMin:0,pointNum:100,rts:!1,dtr:!1,scroll:!0,sendStr:!0,receiveStr:!0,sendWith:"\\r\\n",tabIndex:0,...i?.serial??{}},A.DEFAULT_BAUD=[9600,19200,28800,38400,57600,115200],A.DEFAULT_SEND_WITH=["\\r\\n","\\r","\\n","no"],A.PORT_SELECT={BURN:i?.burn?.portSelect??"all",UPLOAD:i?.upload?.portSelect??"all"},A.UPLOAD_RESET=i?.upload?.reset??{},A.HAS_PORT={BURN:i?.nav?.burn??!1,UPLOAD:i?.nav?.upload??!1},A.MAX_OUTPUT_LINE=500,A.REFRESH_OUTPUT_TIME=100,A.BAUDRATES=[9600,19200,28800,38400,57600,115200],A.TERMINAL_COMMAND={config:{"-d|--dtr":{help:"设置DTR, 可选值: [0, 1], 例如: config -d 1",key:"DTR"},"-r|--rts":{help:"设置RTS, 可选值: [0, 1], 例如: config -r 1",key:"RTS"},"-b|--baud":{help:"设置波特率, 可选值: ["+A.DEFAULT_BAUD.join(", ")+"], 例如: config -b "+A.DEFAULT_BAUD[0],key:"BAUD"},"-t|--rtype":{help:"设置串口接收数据的类型, 可选值: [0, 1], 例如: config -t 1",key:"RTYPE"},"-w|--swith":{help:"设置发送数据时的结尾字符串, 可选值: ["+A.DEFAULT_SEND_WITH.join(", ")+"], 例如: config -w "+A.DEFAULT_SEND_WITH[0],key:"SWITH"},"-s|--scroll":{help:"设置接收框滑动条是否一直在最下方, 可选值: [0, 1], 例如: config -s 1",key:"SCROLL"},"-h|--help":{help:"输出帮助信息, 例如: config -h",key:"HELP"},callback:"terminalConfigCallback"},port:{"-o|--open":{help:"打开当前串口, 例如: port -o",key:"OPEN"},"-c|--close":{help:"关闭当前串口, 例如: port -c",key:"CLOSE"},"-h|--help":{help:"输出帮助信息, 例如: port -h",key:"HELP"},callback:"terminalPortCallback"},send:{"-s|--str":{help:"发送字符串, 可选值: 字符串, 例如: send -s 你好Mixly",key:"STR"},"-b|--bytes":{help:"发送字节数组, 可选值: 字符串, 例如: send -b 0x01,0x02,0x03",key:"BYTES"},"-w|--with":{help:"发送数据时的结尾字符串, 可选值: ["+A.DEFAULT_SEND_WITH.join(", ")+"], 例如: send -s 你好Mixly -w \\r\\n",key:"WITH"},"-h|--help":{help:"输出帮助信息, 例如: send -h",key:"HELP"},callback:"terminalSendCallback"},exit:{callback:"terminalExitCallback"}},A.portsOperator={},A.deadPortsOperator={},A.selectedUploadPort={},A.selectedBurnPort={},A.ports=[],A.burnPorts=[],A.uploadPorts=[],A.initPorts=(l=e=>{})=>{b.list().then(t=>{var o=[];for(let e=0;e<t.length;e++){var r=t[e];"linux"===a.currentPlatform&&-1!==r.path.indexOf("ttyS")||o.push({vendorId:r.vendorId,productId:r.productId,name:r.path})}l(o)}).catch(e=>{console.log(e),m.exec("ls /dev/ttyACM* /dev/ttyUSB*",(e,t,o)=>{var r=t.split("\n"),i=[];for(let e=0;e<r.length;e++)r[e]&&i.push({vendorId:"None",productId:"None",name:r[e]});l(i)})})},A.getPorts=(t,o)=>{if("object"!=typeof t)return[];var r=[];if("string"==typeof o&&"all"===o)for(let e=0;e<t.length;e++){var i={...t[e]};"linux"!==a.currentPlatform?(i.vendorId||(i.vendorId="None"),i.productId||(i.productId="None"),r.push(i)):i.vendorId&&i.productId&&r.push(i)}else if("object"==typeof o)for(let e=0;e<t.length;e++){var l={...t[e]};for(let e=0;e<o.length;e++)if(o[e].vendorId&&o[e].productId&&l.vendorId&&l.productId&&o[e].vendorId.toLowerCase()===l.vendorId.toLowerCase()&&o[e].productId.toLowerCase()===l.productId.toLowerCase()){r.push(l);break}}return r},A.getBurnPorts=()=>A.getPorts(A.ports,A.PORT_SELECT.BURN),A.getUploadPorts=()=>A.getPorts(A.ports,A.PORT_SELECT.UPLOAD),A.refreshPorts=()=>{A.initPorts(e=>{if(!l.equals(e,A.ports)){A.ports=e,A.HAS_PORT.BURN?A.burnPorts=A.getBurnPorts():A.burnPorts=[],A.HAS_PORT.UPLOAD?A.uploadPorts=A.getUploadPorts():A.uploadPorts=[];var t,o,r=[...A.burnPorts],i=[];for(t of r)i.push(t.name);for(o of A.uploadPorts)i.includes(o.name)||r.push({...o});A.refreshPortOperator(r),A.refreshUploadPortSelectBox(r)}})},A.refreshUploadPortSelectBox=e=>{var t=layui["form"];const o=$("#ports-type"),r=o.val();o.empty(),e.map(e=>{e=e.name;r==e?o.append($(`<option value="${e}" selected>${e}</option>`)):o.append($(`<option value="${e}">${e}</option>`))}),t.render("select","ports-type-filter"),e.length?($("#mixly-footer-port-div").css("display","inline-flex"),$("#mixly-footer-port").html(A.getSelectedPortName())):($("#mixly-footer-port-div").hide(),$("#mixly-footer-port").html(""))},A.refreshToolPortSelectBox=e=>{var t,o=layui["form"];for(t in A.portsOperator){var r,i=A.portsOperator[t]["dom"];i&&(r=i.id["selectPortId"],i=i.filter["formFilter"],(r=$("#"+r)).empty(),r.append($(`<option value="${t}" selected>${t}</option>`)),o.render("select",i))}},A.refreshPortOperator=t=>{var e,o,r,i,l,a,n={...A.portsOperator},s=(A.portsOperator={},[]);for(let e=0;e<t.length;e++){var c,d=t[e];s.push(d.name),n[d.name]?A.portsOperator[d.name]=n[d.name]:A.deadPortsOperator[d.name]?(A.portsOperator[d.name]={...A.deadPortsOperator[d.name]},delete A.deadPortsOperator[d.name],A.refreshToolPortSelectBox(d.name)):(c={toolConfig:{...A.TOOL_DEFAULT_CONFIG},toolOpened:!1,portOpened:!1,vendorId:d.vendorId,productId:d.productId,dom:null,serialport:null,output:[]},A.portsOperator[d.name]=c),A.refreshTerminalMenu(d.name)}for(e in n)s.includes(e)||(r=(o=n[e])["dom"],r&&(o.toolOpened?(i=layui["form"],l=r.id["selectPortId"],a=r.filter["formFilter"],$("#"+l).empty(),i.render("select",a),A.deadPortsOperator[e]={...o}):r.destroy()),A.refreshTerminalMenu(e))},window.addEventListener("DOMContentLoaded",()=>{A.refreshPorts(),A.refreshPortsTimer=setInterval(()=>{A.refreshPorts()},1e4)}),A.getOpenedPortsName=()=>{var e,t=[];for(e in A.portsOperator)A.portsOperator[e].portOpened&&t.push(e);return t},A.getSelectedPortName=()=>{return $("#ports-type").val()},A.refreshOutputBox=t=>{var o=A.portsOperator[t];if(o){var{toolConfig:r,toolOpened:i,output:l,endPos:a}=o;for(let e=l.length;e>A.MAX_OUTPUT_LINE;e--)l.shift();let e=l.join("\n");if(i)A.receiveBoxSetValue(t,e,r.scroll);else{if(e=e.replaceAll("\r\n","\n"),a&&"object"==typeof a){i=d.getValueRange(t,{row:0,column:0},a);if(e===i)return}d.setValue(t,e,r.scroll),o.endPos=d.getEndPos(t),x[t]&&x[t].setReadOnly(!1)}}},A.openTool=()=>{var e=A.getSelectedPortName();if(e){let r=A.portsOperator[e];e=r["toolConfig"];const l=e["baudRates"];var t=e=>{r.dom||(r.dom=e),A.refreshToolPortSelectBox(A.uploadPorts);var t=e.id["selectPortId"],t=(r.toolOpened=!0,c.show(1),e.nowPort=$("#"+t+" option:selected").val(),e.prevPort=null,layui.element),o=e.filter["tabFilter"];t.tabChange(o,r.toolConfig.tabIndex),A.refreshConnectStatus(e.nowPort),A.connect(e.nowPort,l??9600)},o=e=>{try{s.chart&&s.chart.destroy(),s.chart=null}catch(e){console.log(e)}s.draw&&clearInterval(s.draw),s.addData&&clearInterval(s.addData);var t=A.portsOperator[e],o=A.deadPortsOperator[e];t?t.toolOpened=!1:o&&(o.dom.destroy(),delete A.deadPortsOperator[e]),A.refreshTerminalMenu(e)};let i=r.dom;r.dom?(i.updateTool(e),i.open(t,o)):i=n.openSerialTool(e,t,o),i.onClickSetDtr((e,t)=>{A.portsOperator[e].toolConfig.dtr=t.elem.checked,A.updateDtrAndRts(e)}),i.onClickSetRts((e,t)=>{A.portsOperator[e].toolConfig.rts=t.elem.checked,A.updateDtrAndRts(e)}),i.onClickSendType((e,t)=>{var o=i.id["sendId"],o=$("#"+o);A.portsOperator[e].toolConfig.sendStr=t.elem.checked,t.elem.checked?o.attr("placeholder",p.Lang["请输入内容"]):o.attr("placeholder",p.Lang["请输入内容"]+"  "+p.Lang["例如"]+":0x03,0x04")}),i.onClickSelectPort((e,t,o)=>{const r=A.portsOperator[t];e=A.portsOperator[e],r.toolConfig={...e.toolConfig},r.dom=e.dom,e.dom=null,e.toolOpened=!1,r.toolOpened=!0,e=e.serialport;e&&e.isOpen&&e.close(()=>{A.connect(t,r.toolConfig.baudRates)})}),i.onClickSelectBaud((e,t)=>{A.portsOperator[e].toolConfig.baudRates=t.elem.value,A.setBaudRate(e,t.elem.value)}),i.onClickTab((e,t)=>{A.portsOperator[e].toolConfig.tabIndex=t.index,1===t.index?(e=(t=A.portsOperator[e])["dom"],s.init(t.portOpened,e)):Mixly.Charts.destroy()}),i.onClickConnectBtn(e=>{A.portOpenOrClose(e)}),i.onClickSendBtn(e=>{A.write(e,0)}),i.onClickClearBtn(e=>{A.clearContent(e)}),i.onClickChartSendBtn(e=>{A.write(e,1)}),i.onClickCtrlCBtn(e=>{A.writeCtrlC(e)}),i.onClickCtrlDBtn(e=>{A.writeCtrlD(e)}),i.onClickScroll((e,t)=>{A.portsOperator[e].toolConfig.scroll=t.elem.checked}),i.onClickReceiveType((e,t)=>{A.portsOperator[e].toolConfig.receiveStr=t.elem.checked}),i.onClickSelectPointNum((e,t)=>{A.portsOperator[e].toolConfig.pointNum=t.elem.value}),i.onClickSelectSendWith((e,t)=>{A.portsOperator[e].toolConfig.sendWith=t.elem.value})}else layer.msg(p.Lang["无可用设备"]+"!",{time:1e3})},A.refreshConnectStatus=e=>{var t=A.portsOperator[e],e=A.deadPortsOperator[e];(t||e)&&({dom:t,portOpened:e}=t??e,t)&&(t=t.id["connectBtnId"],t=$("#"+t),e?(t.text(p.Lang["关闭"]),t.attr("class","layui-btn layui-btn-danger")):(t.text(p.Lang["打开"]),t.attr("class","layui-btn layui-btn-normal")))},A.receiveBoxAddValue=(e,t,o=!1)=>{t=A.receiveBoxGetValue(e)+t;A.receiveBoxSetValue(e,t,o)},A.receiveBoxSetValue=(e,t,o=!1)=>{var e=A.portsOperator[e];e&&(e=e["dom"],e)&&(e=e.id["receiveId"],(e=$("#"+e)).val(t),o)&&e.scrollTop(e[0].scrollHeight)},A.receiveBoxGetValue=e=>{var e=A.portsOperator[e];return e&&(e=e.dom,e)?(e=e.id["receiveId"],$("#"+e).val()):""},A.receiveBoxScrollToTheBottom=()=>{var e=A.portsOperator[port]["dom"];e&&(e=e.id["receiveId"],(e=$("#"+e)).scrollTop(e[0].scrollHeight))},A.receiveBoxScrollToTheTop=()=>{},A.statusBarPortAddHotKey=r=>{const i=x[r].getSession();x[r].commands.addCommands([{name:"Empty",bindKey:"Ctrl-E",exec:e=>{var t=A.portsOperator[r];t&&(t.output=[])}},{name:"Terminal",bindKey:"Ctrl-T",exec:e=>{A.statusBarPortEnterTerminal(r)}},{name:"ChangeEditor",bindKey:"Delete|Ctrl-X|Backspace",exec:e=>{var t,o=A.portsOperator[r];return!(!o||!o.portOpened)&&(o=o["endPos"],o&&"object"==typeof o?(t=i.selection.getCursor()).row<o.row||t.row===o.row&&t.column<=o.column:(x[r].setReadOnly(!0),!1))}},{name:"Enter",bindKey:"Enter",exec:e=>{var t,o=A.portsOperator[r];return o&&o.portOpened&&(o=o["endPos"],o)&&"object"==typeof o&&i.selection.getCursor().row===o.row&&(t=d.getEndPos(r),o=d.getValueRange(r,o,t),A.writeString(r,o,"\r\n")),!1}}]),i.selection.on("changeCursor",function(){var e,t=A.portsOperator[r];t&&t.portOpened&&(t=t.endPos,t)&&"object"==typeof t&&((e=i.selection.getCursor()).row<t.row||e.row===t.row&&e.column<t.column)?x[r].setReadOnly(!0):x[r].setReadOnly(!1)}),A.portsOperator[r]&&A.refreshTerminalMenu(r)},A.statusBarPortEnterTerminal=e=>{var t=A.portsOperator[e];t&&!t.toolOpened&&(A.statusBarPortRemoveCursorEvent(e),t.refreshOutputBoxTimer&&clearInterval(t.refreshOutputBoxTimer),t.refreshOutputBoxTimer=null,setTimeout(()=>{A.statusBarPortAddCursorEvent(e)},A.REFRESH_OUTPUT_TIME+100))},A.refreshTerminalMenu=r=>{const i=A.portsOperator[r];let l=r;try{l=(l=l.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}var e,t='<div style="float:left;">{{d.name}}&nbsp</div><div style="float:right;">{{d.hotKey}}</div>',o={elem:`#tab-${l}-ace`,trigger:"contextmenu",isAllowSpread:!0,id:`tab-${l}-ace-terminal`,className:"editor-dropdown-menu",click:function(e,t){var o;e.id===`tab-${l}-ace-terminal-exit`?A.statusBarPortAddCommand(r,"exit"):e.id===`tab-${l}-ace-terminal-open`?A.statusBarPortEnterTerminal(r):e.id===`tab-${l}-ace-terminal-close`?d.tabDelete(r):e.id===`tab-${l}-ace-terminal-help`?A.statusBarPortAddCommand(r,"config port send -h"):e.id===`tab-${l}-ace-fontsize-decrease`?(o=parseInt(x[r].getFontSize(),10)||12,x[r].setFontSize(Math.max(o-1||1))):e.id===`tab-${l}-ace-fontsize-increase`?(o=parseInt(x[r].getFontSize(),10)||12,x[r].setFontSize(o+1)):e.id===`tab-${l}-ace-fontsize-default`?x[r].setFontSize(12):e.id===`tab-${l}-ace-terminal-port-close`?A.statusBarPortAddCommand(r,"port -c"):e.id===`tab-${l}-ace-terminal-port-open`?A.statusBarPortAddCommand(r,"port -o"):e.id===`tab-${l}-ace-terminal-send-ctrlc`?A.statusBarPortAddCommand(r,"send -b 0x03,0x0d,0x0a -w no"):e.id===`tab-${l}-ace-terminal-send-ctrld`?A.statusBarPortAddCommand(r,"send -b 0x03,0x04 -w no"):e.id===`tab-${l}-ace-terminal-send-str`?A.statusBarPortAddCommand(r,"send -w \\r\\n -s ",!1):e.id===`tab-${l}-tool-close`?i.dom.close():e.id===`tab-${l}-ace-close`?d.tabDelete(r):e.id===`tab-${l}-ace-empty`?i.output=[]:e.id===`tab-${l}-serial-send-ctrlc`?A.writeCtrlC(r):e.id===`tab-${l}-serial-send-ctrld`&&A.writeCtrlD(r)}};i?i&&i.toolOpened?o.data=[{title:p.Lang["关闭串口工具"],id:`tab-${l}-tool-close`}]:(e=i["toolConfig"],e={portOpend:{terminalOpend:[{title:u.render(t,{name:p.Lang["关闭串口"],hotKey:"port -c"}),id:`tab-${l}-ace-terminal-port-close`},e.ctrlCBtn?{title:u.render(t,{name:p.Lang["中断"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrlc`}:{},e.ctrlDBtn?{title:u.render(t,{name:p.Lang["复位"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrld`}:{},{title:u.render(t,{name:p.Lang["发送字符串"],hotKey:""}),id:`tab-${l}-ace-terminal-send-str`},{title:u.render(t,{name:p.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`},{type:"-"},{title:u.render(t,{name:p.Lang["退出串口终端"],hotKey:"exit"}),id:`tab-${l}-ace-terminal-exit`}],terminalClosed:[{title:u.render(t,{name:p.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:u.render(t,{name:p.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:u.render(t,{name:p.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:u.render(t,{name:p.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`},{type:"-"},e.ctrlCBtn?{title:u.render(t,{name:p.Lang["中断"],hotKey:""}),id:`tab-${l}-serial-send-ctrlc`}:{},e.ctrlDBtn?{title:u.render(t,{name:p.Lang["复位"],hotKey:""}),id:`tab-${l}-serial-send-ctrld`}:{},{title:u.render(t,{name:p.Lang["打开串口终端"],hotKey:"Ctrl+T"}),id:`tab-${l}-ace-terminal-open`}]},portClosed:{terminalOpend:[{title:u.render(t,{name:p.Lang["打开串口"],hotKey:"port -o"}),id:`tab-${l}-ace-terminal-port-open`},{title:u.render(t,{name:p.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`},{type:"-"},{title:u.render(t,{name:p.Lang["退出串口终端"],hotKey:"exit"}),id:`tab-${l}-ace-terminal-exit`}],terminalClosed:[{title:u.render(t,{name:p.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:u.render(t,{name:p.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:u.render(t,{name:p.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:u.render(t,{name:p.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`},{type:"-"},{title:u.render(t,{name:p.Lang["打开串口终端"],hotKey:"Ctrl+T"}),id:`tab-${l}-ace-terminal-open`}]}},o.data=e[i.portOpened?"portOpend":"portClosed"][i.terminalOpend?"terminalOpend":"terminalClosed"]):o.data=[{title:p.Lang["关闭串口输出框"],id:`tab-${l}-ace-close`}],layui.dropdown.render(o)},A.statusBarPortAddCursorEvent=o=>{const r=A.portsOperator[o];""===r.output[r.output.length-1]?A.outputBoxAdd(o,">>>",!1):A.outputBoxAdd(o,">>>",!0),A.refreshOutputBox(o),r.terminalOpend=!0,A.refreshTerminalMenu(o);var e=x[o];const i=e["selection"],l=e.getSession(),a=l.getLength(),n=(e.gotoLine(a),i.moveCursorLineEnd(),i.getCursor());r.cursorCallback=l.selection.on("changeCursor",function(e){if(r.terminalOpend){var t=i.getCursor();(t.row<n.row||t.row===n.row&&t.column<=n.column)&&i.moveCursorTo(n.row,n.column,!0);let e=l.getLine(t.row-1);-1!==e.indexOf(">>>")&&t.row===n.row+1&&0===t.column?(e=e.replace(">>>",""),A.outputBoxAdd(o,e),A.handleCommand(o,e),A.statusBarPortRemoveCursorEvent(o)):l.getLength()!==a&&A.statusBarPortRemoveCursorEvent(o)}})},A.statusBarPortRemoveCursorEvent=e=>{var t=x[e],o=A.portsOperator[e];o&&t&&(t=t.getSession(),o.cursorCallback)&&(t.selection.removeEventListener("changeCursor",o.cursorCallback),A.refreshOutputBox(e),o.terminalOpend=!1,A.refreshTerminalMenu(e),o.portOpened)&&!o.refreshOutputBoxTimer&&(o.refreshOutputBoxTimer=setInterval(()=>{A.refreshOutputBox(e)},A.REFRESH_OUTPUT_TIME))},A.outputBoxAdd=(e,t,o=!1)=>{e=A.portsOperator[e];o&&e.output.push(""),e.output[e.output.length-1]+=t},A.handleCommand=(e,t)=>{A.portsOperator[e];var t=t.split(" "),o=f(t);if(1<=o._.length)for(var r of o._){var i;Object.keys(A.TERMINAL_COMMAND).includes(r)?(i=A.TERMINAL_COMMAND[r].callback,A[i]&&A[i](e,o)):(A.outputBoxAdd(e,r+"为无效指令",!0),A.outputBoxAdd(e,"",!0))}else A.outputBoxAdd(e,"无可用指令",!0),A.outputBoxAdd(e,"",!0)},A.parseOptions=(e,t)=>{var o,r=[],i=[],l=[];for(o in t){var a=o.split("|"),n=t[o]?.key;if(2===a.length&&n&&(-1!==a[0].indexOf("-")&&-1!==a[1].indexOf("-"))){l.push(n);for(var s of a)(2===s.length?r:i).push(s)}}var c,d=[r,i,l],g={};for(c in e)option=e[c],d[0].includes("-"+c)?(g[d[2][d[0].indexOf("-"+c)]]=option,d[1][c]=null):d[1].includes("--"+c)&&(g[d[2][d[1].indexOf("--"+c)]]=option);return g},A.terminalAddHelpInfo=(e,t,o)=>{var r,i;this.getSpace=e=>{return new Array(e).fill(" ").join("")},A.outputBoxAdd(e,t+"指令可用选项如下：",!0);let l=0;for(r of Object.keys(o))r.length>l&&(l=r.length);for(i in o)if("callback"!==i)try{A.outputBoxAdd(e,i+this.getSpace(l-i.length)+"    "+(o[i].help??""),!0)}catch(e){console.log(e)}A.outputBoxAdd(e,"",!0)},A.terminalConfigCallback=(e,t)=>{var o=A.portsOperator[e],r=o["toolConfig"];o&&(o=A.TERMINAL_COMMAND.config,(t=A.parseOptions(t,o)).HELP?A.terminalAddHelpInfo(e,"config",o):(A.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),A.outputBoxAdd(e,"",!0),r.dtr=t.DTR??r.dtr,r.rts=t.RTS??r.rts,r.scroll=t.SCROLL??r.scroll,r.baudRates=t.BAUD&&A.DEFAULT_BAUD.includes(t.BAUD)?t.BAUD:r.baudRates,r.receiveStr=t.RTYPE??r.receiveStr,r.sendWith=t.SWITH&&A.DEFAULT_SEND_WITH.includes(t.SWITH)?t.SWITH:r.sendWith,A.setDtrAndRts(e,r.dtr,r.rts),A.setBaudRate(e,r.baudRates)))},A.terminalPortCallback=(e,t)=>{var o,r=A.portsOperator[e],{}=r;r&&(o=A.TERMINAL_COMMAND.port,(t=A.parseOptions(t,o)).HELP?A.terminalAddHelpInfo(e,"port",o):(A.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),A.outputBoxAdd(e,"",!0),t.OPEN?r.portOpened||A.connect(e,r.toolConfig.baudRates):t.CLOSE?r.portOpened&&A.portClose(e):(A.outputBoxAdd(e,"无效指令",!1),A.outputBoxAdd(e,"",!0))))},A.terminalSendCallback=(t,o)=>{var e=A.portsOperator[t],r=e["toolConfig"];if(e){var i=A.TERMINAL_COMMAND.send,o=A.parseOptions(o,i);if(o.HELP)A.terminalAddHelpInfo(t,"send",i);else if(A.outputBoxAdd(t,"获取指令"+JSON.stringify(o),!0),A.outputBoxAdd(t,"",!0),e.portOpened){let e=r.sendWith??"\\r\\n";o.WITH&&A.DEFAULT_SEND_WITH.includes(o.WITH)&&(e=o.WITH),o.STR?A.writeString(t,o.STR,e):o.BYTES?A.writeByteArr(t,o.BYTES,e):(A.outputBoxAdd(t,"无效指令",!1),A.outputBoxAdd(t,"",!0))}else A.outputBoxAdd(t,"串口已关闭，无法发送数据！",!1),A.outputBoxAdd(t,"",!0)}},A.terminalExitCallback=(e,t)=>{A.portsOperator[e]&&A.outputBoxAdd(e,"",!0)},A.statusBarPortAddCommand=(e,t,o=!0)=>{d.addValue(e,t+(o?"\n":""),!0),o&&A.refreshOutputBox(e)},A.connect=function(l=null,e=null,t=e=>{}){if(l){d.tabChange(l);const n=A.portsOperator[l];var a=n["toolConfig"],{}=(e=e||(a.baudRates??9600),n);if(n.serialport&&(n.serialport.isOpen||n.serialport.opening))return n.serialport.path===l?void 0:void n.serialport.close();n.serialport=new b({path:l,baudRate:+e,dataBits:8,parity:"none",stopBits:1,flowControl:!1,autoOpen:!1},!1);a=y.ReadlineParser,e=y.ByteLengthParser;let o=[],r="",i=0;a=new a,e=n.serialport.pipe(new e({length:1}));n.serialport.pipe(a),n.refreshOutputBoxTimer=null,n.serialport.open(function(e){d.tabAdd(l,!0,e=>{A.$menu[0].hide(),A.statusBarPortAddHotKey(e)},e=>{var t=A.portsOperator[e];t&&t.serialport&&t.serialport.isOpen&&(t.serialport.close(),d.tabChange("output"),c.getValue().lastIndexOf("\n")!=c.getValue().length-1?c.addValue("\n"+p.Lang["已关闭串口"]+e+"\n"):c.addValue(p.Lang["已关闭串口"]+e+"\n"))}),d.tabChange(l),e?(d.close(l),console.log("failed to open: "+e),d.setValue(l,e+"\n",!0),A.receiveBoxAddValue(l,e+"\n",!0),n.serialport=null,A.refreshConnectStatus(l),n.portOpened=!1,t(0)):(t(1),n.portOpened=!0,A.refreshTerminalMenu(l),A.refreshConnectStatus(l),d.setValue(l,p.Lang["已打开串口"]+": "+l+"\n",!0),A.receiveBoxSetValue(l,p.Lang["已打开串口"]+": "+l+"\n",!0),n.output.push(""),A.outputBoxAdd(l,p.Lang["已打开串口"]+": "+l),n.output.push(""),n.refreshOutputBoxTimer=setInterval(()=>{A.refreshOutputBox(l)},A.REFRESH_OUTPUT_TIME))}),e.on("data",function(t){if(n.refreshOutputBoxTimer)if(n.toolConfig&&!n.toolConfig.receiveStr)if(10===t[0])A.outputBoxAdd(l,"0x0A",!1),A.outputBoxAdd(l,"",!0);else{let e=t[0].toString(16).toUpperCase();1===e.length&&(e="0"+e),A.outputBoxAdd(l,"0x"+e+" ",!1)}else if(0==(128&t[0]))if(o=[],""!==r)try{var e=String.fromCharCode(t[0]).match(/[\w|\\]/g);e&&0<e.length?r+=t:(A.outputBoxAdd(l,g.messageDecode(r)),A.outputBoxAdd(l,String.fromCharCode(t[0])),r="")}catch(e){console.log(e),A.outputBoxAdd(l,g.messageDecode(r)),A.outputBoxAdd(l,t[0]),r=""}else 10===t[0]?n.output.push(""):[92,95].includes(t[0])?r=String.fromCharCode(t[0]):A.outputBoxAdd(l,t);else if(128==(192&t[0]))o.push(t[0]),o.length>=i&&(A.outputBoxAdd(l,Buffer.from(o)),o=[]);else{switch(224&t[0]){case 252:i=6;break;case 248:i=5;break;case 240:i=4;break;case 224:i=3;break;default:i=2}o.push(t[0])}}),a.on("data",function(e){s.addData(e),n&&"function"==typeof n.userOnData&&n.userOnData(e)}),n.serialport.on("error",function(e){d.tabChange("output"),A.showErrorData(l,n.toolOpened,e)}),n.serialport.on("open",async()=>{await A.reset(l),A.updateDtrAndRts(l)}),n.serialport.on("close",()=>{n.portOpened=!1,d.close(l),A.refreshConnectStatus(l),A.refreshTerminalMenu(l),n.refreshOutputBoxTimer&&clearInterval(n.refreshOutputBoxTimer),n.refreshOutputBoxTimer=null,s.stopRefresh();var e=A.receiveBoxGetValue(l);e&&e.lastIndexOf("\n")!=e.length-1?A.receiveBoxAddValue(l,"\n"+p.Lang["已关闭串口"]+": "+l+"\n",!0):A.receiveBoxAddValue(l,p.Lang["已关闭串口"]+": "+l+"\n",!0),d.getValue(l).lastIndexOf("\n")!=d.getValue(l).length-1?d.addValue(l,"\n"+p.Lang["已关闭串口"]+": "+l+"\n",!0):d.addValue(l,p.Lang["已关闭串口"]+": "+l+"\n",!0),n.serialport=null,n.output=[]})}},A.portOpenOrClose=function(e){var t,o=A.portsOperator[e];o&&(t=o["toolConfig"],(o=o.serialport)&&(o.isOpen||o.opening)?o.close():(A.connect(e,t.baudRates),c.show(1)))},A.portClose=(e,t=()=>{})=>{var o,e=A.portsOperator[e];e&&(o=e.serialport,e.portOpened)?o.close(t):t()},A.showErrorData=function(e,t,o){var{toolOpened:r,toolConfig:i}=A.portsOperator[e];i.receiveStr||(o=(o=g.uint8ArrayToStr(g.strToByte(o))).replace(/^\s*/,""),o+="\n"),r?A.receiveBoxAddValue(e,o,i.scroll):d.addValue(e,o,!0)},A.writeByteArr=function(e,t,o){e=A.portsOperator[e].serialport;let r="";for(var i=(r="string"!=typeof t?t.toString():t).trim().split(/,+/),l=[],a=0;a<i.length;a++)isNaN(i[a])?l=[...l,...g.strToByte(i[a])]:(i[a]=i[a].toLowerCase(),2<i[a].length&&"0o"===i[a].substring(0,2)?l.push(parseInt(i[a].substring(2),8)):l.push(parseInt(+i[a],10)));e.write(l),(o="no"==(o=(o=o.replace("\\r","\r")).replace("\\n","\n"))?"":o)&&e.write(o)},A.writeString=function(e,t,o){e=A.portsOperator[e].serialport;e&&("no"===(o=(o=o.replace("\\r","\r")).replace("\\n","\n"))&&(o=""),t)&&e.write(t+o)},A.write=function(t,o=0){var r=A.portsOperator[t],i=r["dom"];if(r.serialport){var{sendId:r,sendWithId:i,sendTypeId:l,chartSendId:a}=i.id,r=$("#"+r),a=$("#"+a);let e="";(o?(e=a.val(),a):(e=r.val(),r)).val("");o=$("#"+i+" option:selected").val();0==$("#"+l)[0].checked?A.writeByteArr(t,e,o):A.writeString(t,e,o)}},A.writeCtrlC=function(e){e=A.portsOperator[e].serialport;e&&e.write([3,13,10])},A.writeCtrlD=function(e){e=A.portsOperator[e].serialport;e&&e.write([3,4])},A.clearContent=function(e){A.receiveBoxSetValue(e,"");e=A.portsOperator[e];e&&(e.output=[])},A.updateDtrAndRts=function(e){var e=A.portsOperator[e],t=e["toolConfig"],e=e.serialport;e&&e.isOpen&&e.set({dtr:t.dtr,rts:t.rts})},A.reset=async function(e){var t=A.UPLOAD_RESET;if("object"==typeof t)for(var o,r,i=t.length,l=0;l<i;l++)void 0!==t[l].dtr||void 0!==t[l].rts?(o=r=!1,t[l]?.dtr&&(r=!0),t[l]?.rts&&(o=!0),await A.setDtrAndRts(e,r,o)):t[l]?.sleep&&(r=parseInt(t[l].sleep)||100,await A.sleep(r))},A.setDtrAndRts=function(r,i,l){return new Promise((t,e)=>{const o=A.portsOperator[r].serialport;console.log("dtr:"+i,"rts:"+l),o.set({brk:!1,cts:!1,dsr:!1,dtr:i,rts:l},e=>{e&&o&&o.isOpen&&o.close(),t()})})},A.setBaudRate=(e,t)=>{e=A.portsOperator[e].serialport;e&&e.isOpen&&e.update({baudRate:+t},e=>{})},A.sleep=async function(t){return new Promise(e=>setTimeout(e,t))},A.getMenu=e=>{var t,o=[];for(t of e)d.portsName.includes(t.name)||o.push(t.name);return o},A.addBtnToStatusBar=()=>{var e=`
    <button type="button" id="tab-ace-add-btn" class="layui-btn${"dark"===h.theme?" layui-btn-normal":""} layui-btn-xs m-btn" style="
        display: inline-flex;
        justify-content: center;
        align-items: center;
    ">
        <i class="layui-icon layui-icon-addition"></i>
    </button>`;$("#tab-ace-output").after(e);const o=`
    <div class="mixly-scrollbar" style="width: 100%; height: 100%;">
        <div style="max-height: 100px; overflow-x: hidden; overflow-y: auto; padding: 0 2px;">
            {{#  layui.each(d.list, function(index, item){ }}
                <li class="tab-ace-port-add-btn m-btn" value="{{ item }}" lay-unselect style="
                    display: block;
                    padding: 0 3px;
                ">{{ item }}</li>
            {{#  }); }}
            {{#  if(d.list.length === 0){ }}
                ${p.Lang["无可用串口"]}
            {{#  } }}
        </div>
    </div>`;A.$menu=tippy("#tab-ace-add-btn",{allowHTML:!0,content:"",trigger:"click",interactive:!0,maxWidth:"none",offset:[0,6],onMount(e){var t=r(o).render({list:A.getMenu(A.uploadPorts)});e.setContent(t),$(".tab-ace-port-add-btn").off().click(e=>{var e=$(e.currentTarget).attr("value"),t=A.portsOperator[e];A.connect(e,t.toolConfig.baudRates),A.$menu[0].hide(500)})}}),$(window).on("resize",()=>{A.$menu[0].hide()})}}),goog.loadJs("web",()=>{goog.require("Blockly"),goog.require("Mixly.MFile"),goog.require("Mixly.Editor"),goog.require("Mixly.Drag"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Msg"),goog.provide("Mixly.Web.File");const{MFile:l,Editor:o,Drag:r,Web:e,LayerExt:t,Msg:i}=Mixly,a=Blockly.Msg["MSG"],n=e["File"];n.obj=null,n.open=async()=>{if("https:"===window.location.protocol){let t=[];l.openFilters.map(e=>{t.push("."+e)});var e={multiple:!1,types:[{description:"Mixly File",accept:{"application/xml":t}}],suggestedStartLocation:"pictures-library"};try{var o,r,[i]=await window.showOpenFilePicker(e);i&&(o=(n.obj=i).name.substring(i.name.lastIndexOf(".")),r=await n.obj.getFile())&&n.parseData(o,await r.text())}catch(e){console.log(e)}}else{e="."+l.openFilters.join(",.");l.openFile(e,"text",e=>{var{data:e,filename:t}=e,t=t.substring(t.lastIndexOf("."));n.parseData(t,e)})}},n.parseData=(e,t)=>{switch(e){case".mix":case".xml":try{t=t.replace(/\\(u[0-9a-fA-F]{4})/g,function(e){return unescape(e.replace(/\\(u[0-9a-fA-F]{4})/g,"%$1"))})}catch(e){console.log(e)}l.parseMix($(t),!1,!1,e=>{e&&(o.blockEditor.scrollCenter(),Blockly.hideChaff())});break;case".ino":case".py":r.items.vDrag.full("NEGATIVE"),o.codeEditor.setValue(t,-1);break;case".bin":case".hex":l.loadHex(t);break;default:layer.msg(i.Lang["文件后缀错误"],{time:1e3}),n.obj=null}},n.save=async()=>{if(n.obj){let e="";switch(n.obj.name.substring(n.obj.name.lastIndexOf("."))){case".mix":case".xml":e=l.getMix();break;case".ino":case".py":e=l.getCode();break;default:return}try{var t=await n.obj.createWritable();await t.write(e),layer.msg("写入新数据到"+n.obj.name,{time:1e3}),await t.close()}catch(e){console.log(e)}}else n.saveAs()},n.saveAs=async()=>{let t=[];l.saveFilters.map(e=>{t.push("."+e.extensions[0])});var e={types:[{description:"Mixly File",accept:{"application/xml":t}}]};try{var o=await window.showSaveFilePicker(e);o&&(n.obj=o,n.save())}catch(e){console.log(e)}},n.new=async()=>{layer.confirm(a.confirm_newfile,{title:!1,shade:t.SHADE_ALL,resize:!1,success:e=>{e[0].childNodes[1].childNodes[0].classList.remove("layui-layer-close2"),e[0].childNodes[1].childNodes[0].classList.add("layui-layer-close1")},btn:[a.newfile_yes,a.newfile_no],btn2:function(e,t){layer.close(e)}},async function(e,t){mixlyjs.createFn(),layer.close(e),n.obj=null})},n.saveCode=()=>{},n.saveMix=()=>{},n.saveImg=()=>{},n.saveHex=()=>{}}),goog.loadJs("web",()=>{goog.require("Mixly.Charts"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Config"),goog.require("Mixly.Tools"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.XML"),goog.require("Mixly.MArray"),goog.require("Mixly.Msg"),goog.require("Mixly.Web.USB"),goog.require("Mixly.Web.SerialPort"),goog.require("Mixly.Web.Bluetooth"),goog.provide("Mixly.Web.Serial");const{Web:e,Charts:a,StatusBar:n,StatusBarPort:s,Config:t,Tools:c,LayerExt:d,XML:g,Msg:u}=Mixly,{Serial:p,USB:l,SerialPort:A,Bluetooth:h}=e,{BOARD:o,SELECTED_BOARD:r}=t,y=s["portAce"];p.TOOL_DEFAULT_CONFIG={ctrlCBtn:!1,ctrlDBtn:!1,baudRates:115200,yMax:100,yMin:0,pointNum:100,rts:!1,dtr:!1,scroll:!0,sendStr:!0,receiveStr:!0,sendWith:"\\r\\n",tabIndex:0,...o?.serial??{}},p.DEFAULT_BAUD=[9600,19200,28800,38400,57600,115200],p.DEFAULT_SEND_WITH=["\\r\\n","\\r","\\n","no"],p.PORT_SELECT={BURN:o?.burn?.portSelect??"all",UPLOAD:o?.upload?.portSelect??"all"},p.UPLOAD_RESET=o?.upload?.reset??{},p.HAS_PORT={BURN:o?.nav?.burn??!1,UPLOAD:o?.nav?.upload??!1},p.MAX_OUTPUT_LINE=500,p.REFRESH_OUTPUT_TIME=100,p.BAUDRATES=[9600,19200,28800,38400,57600,115200],p.TERMINAL_COMMAND={config:{"-d|--dtr":{help:"设置DTR, 可选值: [0, 1], 例如: config -d 1",key:"DTR"},"-r|--rts":{help:"设置RTS, 可选值: [0, 1], 例如: config -r 1",key:"RTS"},"-b|--baud":{help:"设置波特率, 可选值: ["+p.DEFAULT_BAUD.join(", ")+"], 例如: config -b "+p.DEFAULT_BAUD[0],key:"BAUD"},"-t|--rtype":{help:"设置串口接收数据的类型, 可选值: [0, 1], 例如: config -t 1",key:"RTYPE"},"-w|--swith":{help:"设置发送数据时的结尾字符串, 可选值: ["+p.DEFAULT_SEND_WITH.join(", ")+"], 例如: config -w "+p.DEFAULT_SEND_WITH[0],key:"SWITH"},"-s|--scroll":{help:"设置接收框滑动条是否一直在最下方, 可选值: [0, 1], 例如: config -s 1",key:"SCROLL"},"-h|--help":{help:"输出帮助信息, 例如: config -h",key:"HELP"},callback:"terminalConfigCallback"},port:{"-o|--open":{help:"打开当前串口, 例如: port -o",key:"OPEN"},"-c|--close":{help:"关闭当前串口, 例如: port -c",key:"CLOSE"},"-h|--help":{help:"输出帮助信息, 例如: port -h",key:"HELP"},callback:"terminalPortCallback"},send:{"-s|--str":{help:"发送字符串, 可选值: 字符串, 例如: send -s 你好Mixly",key:"STR"},"-b|--bytes":{help:"发送字节数组, 可选值: 字符串, 例如: send -b 0x01,0x02,0x03",key:"BYTES"},"-w|--with":{help:"发送数据时的结尾字符串, 可选值: ["+p.DEFAULT_SEND_WITH.join(", ")+"], 例如: send -s 你好Mixly -w \\r\\n",key:"WITH"},"-h|--help":{help:"输出帮助信息, 例如: send -h",key:"HELP"},callback:"terminalSendCallback"},exit:{callback:"terminalExitCallback"}},p.portsOperator={},p.deadPortsOperator={},p.refreshToolPortSelectBox=()=>{var e,t=layui["form"];for(e in p.portsOperator){var o,r=p.portsOperator[e]["dom"];r&&(o=r.id["selectPortId"],r=r.filter["formFilter"],(o=$("#"+o)).empty(),o.append($(`<option value="${e}" selected>${e}</option>`)),t.render("select",r))}},p.refreshPortOperator=t=>{var e,o,r,i,l,a,n={...p.portsOperator},s=(p.portsOperator={},[]);for(let e=0;e<t.length;e++){var c,d=t[e];s.push(d.name),n[d.name]?p.portsOperator[d.name]=n[d.name]:p.deadPortsOperator[d.name]?(p.portsOperator[d.name]={...p.deadPortsOperator[d.name]},delete p.deadPortsOperator[d.name],p.refreshToolPortSelectBox()):(c={toolConfig:{...p.TOOL_DEFAULT_CONFIG},toolOpened:!1,portOpened:!1,vendorId:d.vendorId,productId:d.productId,dom:null,serialport:null,output:[]},p.portsOperator[d.name]=c),p.refreshTerminalMenu(d.name)}for(e in n)s.includes(e)||(r=(o=n[e])["dom"],r&&(o.toolOpened?(i=layui["form"],l=r.id["selectPortId"],a=r.filter["formFilter"],$("#"+l).empty(),i.render("select",a),p.deadPortsOperator[e]={...o}):r.destroy()),p.refreshTerminalMenu(e))},p.refreshOutputBox=t=>{var o=p.portsOperator[t];if(o&&!o.busy){var{toolConfig:r,toolOpened:i,endPos:l,serialport:a}=o;if(a){var n=a.output;for(let e=n.length;e>p.MAX_OUTPUT_LINE;e--)n.shift();let e=n.join("\n");if(i)p.receiveBoxSetValue(t,e,r.scroll);else{if(e=e.replaceAll("\r\n","\n"),l&&"object"==typeof l){a=s.getValueRange(t,{row:0,column:0},l);if(e===a)return}s.setValue(t,e,r.scroll),o.endPos=s.getEndPos(t),y[t]&&y[t].setReadOnly(!1)}}}},p.openTool=()=>{let e="web-"+(r.web.com??"serial");navigator.serial&&navigator.usb||(e="web-bluetooth");var t=p.portsOperator[e]?.toolConfig?.baudRates??p.TOOL_DEFAULT_CONFIG.baudRates;p.connect(e,t,l=>{if(l){let r=p.portsOperator[l];var e=r["toolConfig"],{}=e,t=e=>{r.dom||(r.dom=e),p.refreshToolPortSelectBox();var{}=e.id,t=(r.toolOpened=!0,n.show(1),e.nowPort=l,e.prevPort=null,layui.element),o=e.filter["tabFilter"];t.tabChange(o,r.toolConfig.tabIndex),p.refreshConnectStatus(e.nowPort)},o=e=>{try{a.chart&&a.chart.destroy(),a.chart=null}catch(e){console.log(e)}a.draw&&clearInterval(a.draw),a.addData&&clearInterval(a.addData);var t=p.portsOperator[e],o=p.deadPortsOperator[e];t?t.toolOpened=!1:o&&(o.dom.destroy(),delete p.deadPortsOperator[e]),p.refreshTerminalMenu(e)};let i=r.dom;r.dom?(i.updateTool(e),i.open(t,o)):i=d.openSerialTool(e,t,o),i.onClickSetDtr((e,t)=>{var e=p.portsOperator[e],{portOpened:o,serialport:r,toolConfig:i}=e,{dtr:i,rts:t}=(i.dtr=t.elem.checked,e.toolConfig);o&&r.setSignals(i,t)}),i.onClickSetRts((e,t)=>{var e=p.portsOperator[e],{portOpened:o,serialport:r,toolConfig:i}=e,{dtr:i,rts:t}=(i.rts=t.elem.checked,e.toolConfig);o&&r.setSignals(i,t)}),i.onClickSendType((e,t)=>{var o=i.id["sendId"],o=$("#"+o);p.portsOperator[e].toolConfig.sendStr=t.elem.checked,t.elem.checked?o.attr("placeholder",u.Lang["请输入内容"]):o.attr("placeholder",u.Lang["请输入内容"]+"  "+u.Lang["例如"]+":0x03,0x04")}),i.onClickSelectBaud((e,t)=>{var{portOpened:e,serialport:o,toolConfig:r}=p.portsOperator[e];r.baudRates=+t.elem.value,e&&o.setBaudRate(+t.elem.value)}),i.onClickTab((e,t)=>{p.portsOperator[e].toolConfig.tabIndex=t.index,1===t.index?(e=(t=p.portsOperator[e])["dom"],a.init(t.portOpened,e)):Mixly.Charts.destroy()}),i.onClickConnectBtn(e=>{p.portsOperator[e].portOpened?p.portClose(e):p.openTool()}),i.onClickSendBtn(e=>{p.write(e,0)}),i.onClickClearBtn(e=>{p.clearContent(e)}),i.onClickChartSendBtn(e=>{p.write(e,1)}),i.onClickCtrlCBtn(e=>{p.writeCtrlC(e)}),i.onClickCtrlDBtn(e=>{p.writeCtrlD(e)}),i.onClickScroll((e,t)=>{p.portsOperator[e].toolConfig.scroll=t.elem.checked}),i.onClickReceiveType((e,t)=>{p.portsOperator[e].toolConfig.receiveStr=t.elem.checked}),i.onClickSelectPointNum((e,t)=>{p.portsOperator[e].toolConfig.pointNum=t.elem.value}),i.onClickSelectSendWith((e,t)=>{p.portsOperator[e].toolConfig.sendWith=t.elem.value})}else layer.msg(u.Lang["已取消连接"],{time:1e3})})},p.refreshConnectStatus=e=>{var t=p.portsOperator[e],e=p.deadPortsOperator[e];(t||e)&&({dom:t,portOpened:e}=t??e,t&&(t=t.id["connectBtnId"],t=$("#"+t),e?(t.text(u.Lang["关闭"]),t.attr("class","layui-btn layui-btn-danger")):(t.text(u.Lang["打开"]),t.attr("class","layui-btn layui-btn-normal"))),e?($("#operate-connect-btn").html(MSG.disconnect),$("#operate-connect-btn").removeClass("icon-link").addClass("icon-unlink"),$("#connect-btn").html(MSG.disconnect),$("#connect-btn").removeClass("icon-link").addClass("icon-unlink")):($("#operate-connect-btn").html(MSG.connect),$("#operate-connect-btn").removeClass("icon-unlink").addClass("icon-link"),$("#connect-btn").html(MSG.connect),$("#connect-btn").removeClass("icon-unlink").addClass("icon-link")))},p.receiveBoxAddValue=(e,t,o=!1)=>{t=p.receiveBoxGetValue(e)+t;p.receiveBoxSetValue(e,t,o)},p.receiveBoxSetValue=(e,t,o=!1)=>{var e=p.portsOperator[e];e&&(e=e["dom"],e)&&(e=e.id["receiveId"],(e=$("#"+e)).val(t),o)&&e.scrollTop(e[0].scrollHeight)},p.receiveBoxGetValue=e=>{var e=p.portsOperator[e];return e&&(e=e.dom,e)?(e=e.id["receiveId"],$("#"+e).val()):""},p.receiveBoxScrollToTheBottom=()=>{var e=p.portsOperator[port]["dom"];e&&(e=e.id["receiveId"],(e=$("#"+e)).scrollTop(e[0].scrollHeight))},p.receiveBoxScrollToTheTop=()=>{},p.statusBarPortAddHotKey=r=>{const i=y[r].getSession();y[r].commands.addCommands([{name:"Empty",bindKey:"Ctrl-E",exec:e=>{var t=p.portsOperator[r];t&&(t.output=[])}},{name:"Terminal",bindKey:"Ctrl-T",exec:e=>{p.statusBarPortEnterTerminal(r)}},{name:"ChangeEditor",bindKey:"Delete|Ctrl-X|Backspace",exec:e=>{var t,o=p.portsOperator[r];return!(!o||!o.portOpened)&&(o=o["endPos"],o&&"object"==typeof o?(t=i.selection.getCursor()).row<o.row||t.row===o.row&&t.column<=o.column:(y[r].setReadOnly(!0),!1))}},{name:"Enter",bindKey:"Enter",exec:e=>{var t,o=p.portsOperator[r];return o&&o.portOpened&&(o=o["endPos"],o)&&"object"==typeof o&&i.selection.getCursor().row===o.row&&(t=s.getEndPos(r),o=s.getValueRange(r,o,t),p.writeString(r,o,"\r\n")),!1}}]),i.selection.on("changeCursor",function(){var e,t=p.portsOperator[r];t&&t.portOpened&&(t=t.endPos,t)&&"object"==typeof t&&((e=i.selection.getCursor()).row<t.row||e.row===t.row&&e.column<t.column)?y[r].setReadOnly(!0):y[r].setReadOnly(!1)}),p.portsOperator[r]&&p.refreshTerminalMenu(r)},p.statusBarPortEnterTerminal=e=>{var t=p.portsOperator[e];t&&!t.toolOpened&&(p.statusBarPortRemoveCursorEvent(e),t.refreshOutputBoxTimer&&clearInterval(t.refreshOutputBoxTimer),t.refreshOutputBoxTimer=null,setTimeout(()=>{p.statusBarPortAddCursorEvent(e)},p.REFRESH_OUTPUT_TIME+100))},p.refreshTerminalMenu=r=>{const i=p.portsOperator[r];let l=r;try{l=(l=l.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}var e,t='<div style="float:left;">{{d.name}}&nbsp</div><div style="float:right;">{{d.hotKey}}</div>',o={elem:`#tab-${l}-ace`,trigger:"contextmenu",isAllowSpread:!0,id:`tab-${l}-ace-terminal`,className:"editor-dropdown-menu",click:function(e,t){var o;e.id===`tab-${l}-ace-terminal-exit`?p.statusBarPortAddCommand(r,"exit"):e.id===`tab-${l}-ace-terminal-open`?p.statusBarPortEnterTerminal(r):e.id===`tab-${l}-ace-terminal-close`?s.tabDelete(r):e.id===`tab-${l}-ace-terminal-help`?p.statusBarPortAddCommand(r,"config port send -h"):e.id===`tab-${l}-ace-fontsize-decrease`?(o=parseInt(y[r].getFontSize(),10)||12,y[r].setFontSize(Math.max(o-1||1))):e.id===`tab-${l}-ace-fontsize-increase`?(o=parseInt(y[r].getFontSize(),10)||12,y[r].setFontSize(o+1)):e.id===`tab-${l}-ace-fontsize-default`?y[r].setFontSize(12):e.id===`tab-${l}-ace-terminal-port-close`?p.statusBarPortAddCommand(r,"port -c"):e.id===`tab-${l}-ace-terminal-port-open`?p.statusBarPortAddCommand(r,"port -o"):e.id===`tab-${l}-ace-terminal-send-ctrlc`?p.statusBarPortAddCommand(r,"send -b 0x03,0x0d,0x0a -w no"):e.id===`tab-${l}-ace-terminal-send-ctrld`?p.statusBarPortAddCommand(r,"send -b 0x03,0x04 -w no"):e.id===`tab-${l}-ace-terminal-send-str`?p.statusBarPortAddCommand(r,"send -w \\r\\n -s ",!1):e.id===`tab-${l}-tool-close`?i.dom.close():e.id===`tab-${l}-ace-close`?s.tabDelete(r):e.id===`tab-${l}-ace-empty`?p.clearContent(r):e.id===`tab-${l}-serial-send-ctrlc`?p.writeCtrlC(r):e.id===`tab-${l}-serial-send-ctrld`&&p.writeCtrlD(r)}};i?i&&i.toolOpened?o.data=[{title:u.Lang["关闭串口工具"],id:`tab-${l}-tool-close`}]:(e=i["toolConfig"],e={portOpend:{terminalOpend:[{title:g.render(t,{name:u.Lang["关闭串口"],hotKey:"port -c"}),id:`tab-${l}-ace-terminal-port-close`},e.ctrlCBtn?{title:g.render(t,{name:u.Lang["中断"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrlc`}:{},e.ctrlDBtn?{title:g.render(t,{name:u.Lang["复位"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrld`}:{},{title:g.render(t,{name:u.Lang["发送字符串"],hotKey:""}),id:`tab-${l}-ace-terminal-send-str`},{title:g.render(t,{name:u.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`}],terminalClosed:[{title:g.render(t,{name:u.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:g.render(t,{name:u.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:g.render(t,{name:u.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:g.render(t,{name:u.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`},{type:"-"},e.ctrlCBtn?{title:g.render(t,{name:u.Lang["中断"],hotKey:""}),id:`tab-${l}-serial-send-ctrlc`}:{},e.ctrlDBtn?{title:g.render(t,{name:u.Lang["复位"],hotKey:""}),id:`tab-${l}-serial-send-ctrld`}:{}]},portClosed:{terminalOpend:[{title:g.render(t,{name:u.Lang["打开串口"],hotKey:"port -o"}),id:`tab-${l}-ace-terminal-port-open`},{title:g.render(t,{name:u.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`}],terminalClosed:[{title:g.render(t,{name:u.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:g.render(t,{name:u.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:g.render(t,{name:u.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:g.render(t,{name:u.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`}]}},o.data=e[i.portOpened?"portOpend":"portClosed"][i.terminalOpend?"terminalOpend":"terminalClosed"]):o.data=[{title:u.Lang["关闭串口输出框"],id:`tab-${l}-ace-close`}],layui.dropdown.render(o)},p.statusBarPortAddCursorEvent=o=>{const r=p.portsOperator[o];""===r.output[r.output.length-1]?p.outputBoxAdd(o,">>>",!1):p.outputBoxAdd(o,">>>",!0),p.refreshOutputBox(o),r.terminalOpend=!0,p.refreshTerminalMenu(o);var e=y[o];const i=e["selection"],l=e.getSession(),a=l.getLength(),n=(e.gotoLine(a),i.moveCursorLineEnd(),i.getCursor());r.cursorCallback=l.selection.on("changeCursor",function(e){if(r.terminalOpend){var t=i.getCursor();(t.row<n.row||t.row===n.row&&t.column<=n.column)&&i.moveCursorTo(n.row,n.column,!0);let e=l.getLine(t.row-1);-1!==e.indexOf(">>>")&&t.row===n.row+1&&0===t.column?(e=e.replace(">>>",""),p.outputBoxAdd(o,e),p.handleCommand(o,e),p.statusBarPortRemoveCursorEvent(o)):l.getLength()!==a&&p.statusBarPortRemoveCursorEvent(o)}})},p.statusBarPortRemoveCursorEvent=e=>{var t=y[e],o=p.portsOperator[e];o&&t&&(t=t.getSession(),o.cursorCallback)&&(t.selection.removeEventListener("changeCursor",o.cursorCallback),p.refreshOutputBox(e),o.terminalOpend=!1,p.refreshTerminalMenu(e),o.portOpened)&&!o.refreshOutputBoxTimer&&(o.refreshOutputBoxTimer=setInterval(()=>{p.refreshOutputBox(e)},p.REFRESH_OUTPUT_TIME))},p.outputBoxAdd=(e,t,o=!1)=>{e=p.portsOperator[e].serialport;o&&e.output.push(""),e.output[e.output.length-1]+=t},p.handleCommand=(e,t)=>{p.portsOperator[e];var t=t.split(" "),o=minimist(t);if(1<=o._.length)for(var r of o._){var i;Object.keys(p.TERMINAL_COMMAND).includes(r)?(i=p.TERMINAL_COMMAND[r].callback,p[i]&&p[i](e,o)):(p.outputBoxAdd(e,r+"为无效指令",!0),p.outputBoxAdd(e,"",!0))}else p.outputBoxAdd(e,"无可用指令",!0),p.outputBoxAdd(e,"",!0)},p.parseOptions=(e,t)=>{var o,r=[],i=[],l=[];for(o in t){var a=o.split("|"),n=t[o]?.key;if(2===a.length&&n&&(-1!==a[0].indexOf("-")&&-1!==a[1].indexOf("-"))){l.push(n);for(var s of a)(2===s.length?r:i).push(s)}}var c,d=[r,i,l],g={};for(c in e)option=e[c],d[0].includes("-"+c)?(g[d[2][d[0].indexOf("-"+c)]]=option,d[1][c]=null):d[1].includes("--"+c)&&(g[d[2][d[1].indexOf("--"+c)]]=option);return g},p.terminalAddHelpInfo=(e,t,o)=>{var r,i;this.getSpace=e=>{return new Array(e).fill(" ").join("")},p.outputBoxAdd(e,t+"指令可用选项如下：",!0);let l=0;for(r of Object.keys(o))r.length>l&&(l=r.length);for(i in o)if("callback"!==i)try{p.outputBoxAdd(e,i+this.getSpace(l-i.length)+"    "+(o[i].help??""),!0)}catch(e){console.log(e)}p.outputBoxAdd(e,"",!0)},p.terminalConfigCallback=(e,t)=>{var o=p.portsOperator[e],r=o["toolConfig"];o&&(o=p.TERMINAL_COMMAND.config,(t=p.parseOptions(t,o)).HELP?p.terminalAddHelpInfo(e,"config",o):(p.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),p.outputBoxAdd(e,"",!0),r.dtr=t.DTR??r.dtr,r.rts=t.RTS??r.rts,r.scroll=t.SCROLL??r.scroll,r.baudRates=t.BAUD&&p.DEFAULT_BAUD.includes(t.BAUD)?t.BAUD:r.baudRates,r.receiveStr=t.RTYPE??r.receiveStr,r.sendWith=t.SWITH&&p.DEFAULT_SEND_WITH.includes(t.SWITH)?t.SWITH:r.sendWith,p.setDtrAndRts(e,r.dtr,r.rts),p.setBaudRate(e,r.baudRates)))},p.terminalPortCallback=(e,t)=>{var o,r=p.portsOperator[e],{}=r;r&&(o=p.TERMINAL_COMMAND.port,(t=p.parseOptions(t,o)).HELP?p.terminalAddHelpInfo(e,"port",o):(p.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),p.outputBoxAdd(e,"",!0),t.OPEN?r.portOpened||p.connect(e,r.toolConfig.baudRates):t.CLOSE?r.portOpened&&p.portClose(e):(p.outputBoxAdd(e,"无效指令",!1),p.outputBoxAdd(e,"",!0))))},p.terminalSendCallback=(t,o)=>{var e=p.portsOperator[t],r=e["toolConfig"];if(e){var i=p.TERMINAL_COMMAND.send,o=p.parseOptions(o,i);if(o.HELP)p.terminalAddHelpInfo(t,"send",i);else if(p.outputBoxAdd(t,"获取指令"+JSON.stringify(o),!0),p.outputBoxAdd(t,"",!0),e.portOpened){let e=r.sendWith??"\\r\\n";o.WITH&&p.DEFAULT_SEND_WITH.includes(o.WITH)&&(e=o.WITH),o.STR?p.writeString(t,o.STR,e):o.BYTES?p.writeByteArr(t,o.BYTES,e):(p.outputBoxAdd(t,"无效指令",!1),p.outputBoxAdd(t,"",!0))}else p.outputBoxAdd(t,"串口已关闭，无法发送数据！",!1),p.outputBoxAdd(t,"",!0)}},p.terminalExitCallback=(e,t)=>{p.portsOperator[e]&&p.outputBoxAdd(e,"",!0)},p.statusBarPortAddCommand=(e,t,o=!0)=>{s.addValue(e,t+(o?"\n":""),!0),o&&p.refreshOutputBox(e)},p.connect=function(t=null,e=null,o=e=>{}){if(t){s.tabChange(t),p.refreshPortOperator([{name:t,vendorId:"None",productId:"None"}]);const i=p.portsOperator[t];var r=i["toolConfig"],{}=(e=e||(r.baudRates??9600),i);i.portOpened?o(t):(i.refreshOutputBoxTimer=null,i.serialport="web-usb"===t?l:"web-bluetooth"===t?h:A,i.serialport.connect(e,e=>{a.addData(e)}).then(()=>(p.onConnect(t),i.serialport.AddOnDisconnectEvent(()=>{p.onDisconnect(t)}),o(t),p.reset(t,"upload"))).catch(e=>{console.log(e),p.onDisconnect(t),o(null)}).finally(()=>{p.refreshConnectStatus(t)}))}else o(null)},p.onConnect=e=>{var t=p.portsOperator[e],o=t["serialport"];t.portOpened=!0,s.tabAdd(e,!0,p.statusBarPortAddHotKey,e=>{var t=p.portsOperator[e];t&&t.serialport&&t.portOpened&&(p.portClose(e),s.tabChange("output"),n.getValue().lastIndexOf("\n")!=n.getValue().length-1?n.addValue("\n"+u.Lang["已关闭串口"]+e+"\n"):n.addValue(u.Lang["已关闭串口"]+e+"\n"))}),s.tabChange(e),p.refreshTerminalMenu(e),s.setValue(e,u.Lang["已打开串口"]+": "+e+"\n",!0),p.receiveBoxSetValue(e,u.Lang["已打开串口"]+": "+e+"\n",!0),o.output.push(""),p.outputBoxAdd(e,u.Lang["已打开串口"]+": "+e),o.output.push(""),t.refreshOutputBoxTimer=setInterval(()=>{p.refreshOutputBox(e)},p.REFRESH_OUTPUT_TIME),$("#operate-connect-btn").html(MSG.disconnect),$("#operate-connect-btn").removeClass("icon-link").addClass("icon-unlink"),$("#connect-btn").html(MSG.disconnect),$("#connect-btn").removeClass("icon-link").addClass("icon-unlink")},p.onDisconnect=e=>{layer.closeAll();var t,o=p.portsOperator[e],r=o["serialport"];l.DAPLink&&l.DAPLink.connected&&l.DAPLink.removeAllListeners(DAPjs.DAPLink.EVENT_SERIAL_DATA),o.portOpened&&(o.portOpened=!1,s.close(e),p.refreshConnectStatus(e),p.refreshTerminalMenu(e),o.refreshOutputBoxTimer&&clearInterval(o.refreshOutputBoxTimer),o.refreshOutputBoxTimer=null,a.stopRefresh(),(t=p.receiveBoxGetValue(e))&&t.lastIndexOf("\n")!=t.length-1?p.receiveBoxAddValue(e,"\n"+u.Lang["已关闭串口"]+": "+e+"\n",!0):p.receiveBoxAddValue(e,u.Lang["已关闭串口"]+": "+e+"\n",!0),s.getValue(e).lastIndexOf("\n")!=s.getValue(e).length-1?s.addValue(e,"\n"+u.Lang["已关闭串口"]+": "+e+"\n",!0):s.addValue(e,u.Lang["已关闭串口"]+": "+e+"\n",!0),r&&(r.output=[],o.serialport=null),$("#operate-connect-btn").html(MSG.connect),$("#operate-connect-btn").removeClass("icon-unlink").addClass("icon-link"),$("#connect-btn").html(MSG.connect),$("#connect-btn").removeClass("icon-unlink").addClass("icon-link"))},p.portClose=(e,t=()=>{})=>{var o=p.portsOperator[e];o&&o.portOpened&&(o.serialport.close(),p.onDisconnect(e)),t()},p.showErrorData=function(e,t,o){var{toolOpened:r,toolConfig:i}=p.portsOperator[e];i.receiveStr||(o=(o=c.uint8ArrayToStr(c.strToByte(o))).replace(/^\s*/,""),o+="\n"),r?p.receiveBoxAddValue(e,o,i.scroll):s.addValue(e,o,!0)},p.writeByteArr=function(e,t,o){const r=p.portsOperator[e].serialport;let i="";for(var l=(i="string"!=typeof t?t.toString():t).trim().split(/,+/),a=[],n=0;n<l.length;n++)isNaN(l[n])?a=[...a,...c.strToByte(l[n])]:(l[n]=l[n].toLowerCase(),2<l[n].length&&"0o"===l[n].substring(0,2)?a.push(parseInt(l[n].substring(2),8)):a.push(parseInt(+l[n],10)));r.writeByteArr(a).then(()=>{(o="no"==(o=(o=o.replace("\\r","\r")).replace("\\n","\n"))?"":o)&&r.writeString(o)}).catch(console.log)},p.writeString=function(e,t,o){e=p.portsOperator[e].serialport;e&&("no"===(o=(o=o.replace("\\r","\r")).replace("\\n","\n"))&&(o=""),t)&&e.writeString(t+o)},p.write=function(t,o=0){var r=p.portsOperator[t],i=r["dom"];if(r.serialport){var{sendId:r,sendWithId:i,sendTypeId:l,chartSendId:a}=i.id,r=$("#"+r),a=$("#"+a);let e="";(o?(e=a.val(),a):(e=r.val(),r)).val("");o=$("#"+i+" option:selected").val();0==$("#"+l)[0].checked?p.writeByteArr(t,e,o):p.writeString(t,e,o)}},p.writeCtrlC=function(e){e=p.portsOperator[e].serialport;e&&e.writeCtrlC()},p.writeCtrlD=function(e){e=p.portsOperator[e].serialport;e&&e.writeCtrlD()},p.clearContent=function(e){p.receiveBoxSetValue(e,"");var t=(p.portsOperator[e]??{})["serialport"];t?t.output=[]:s.setValue(e,"")},p.updateDtrAndRts=async function(e){var e=p.portsOperator[e],t=e["toolConfig"],o=e.serialport;e.portOpened&&o&&await o.setSignals(t.dtr,t.rts)},p.reset=async function(e,t){var o=p.getResetConfig(t),r=p.portsOperator[e].serialport;if("object"==typeof o)for(var i,l,a=o.length,n=0;n<a;n++)void 0!==o[n].dtr||void 0!==o[n].rts?(i=l=!1,o[n]?.dtr&&(l=!0),o[n]?.rts&&(i=!0),await r.setSignals(l,i)):o[n]?.sleep&&(l=parseInt(o[n].sleep)||100,await p.sleep(l))},p.setBaudRate=(e,t)=>{e=p.portsOperator[e].serialport;e&&e.isOpen&&e.setBaudRate(t)},p.sleep=async function(t){return new Promise(e=>setTimeout(e,t))},p.getResetConfig=e=>{if("object"!=typeof r)return null;let t=null;return r.web&&r.web[e]&&r.web[e].reset?t=r.web[e].reset:r[e]&&(t=r[e].reset),t}}),goog.loadJs("web",()=>{goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Boards"),goog.require("Mixly.Charts"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Command"),goog.require("Mixly.MJSON"),goog.require("Mixly.LayerExt"),goog.require("Mixly.WebSocket"),goog.provide("Mixly.WebSocket.Socket");const{Env:t,Config:e,Boards:o,StatusBar:r,StatusBarPort:i,Command:l,MJSON:a,LayerExt:n}=Mixly,{BOARD:s,SOFTWARE:c}=e,d=Mixly.WebSocket["Socket"];d.obj=null,d.url="ws://127.0.0.1/socket",d.jsonArr=[],d.connected=!1,d.initFunc=null,d.debug=c.debug,s.server={...c.webSocket};let{hostname:g,protocol:u,port:p}=window.location,A=(d.protocol="http:"===u?"ws:":"wss:",p=p&&":"+p,d.url=d.protocol+"//"+g+p+"/socket",d.IPAddress=g,!1),h=!0,y,m=0;function f(){A||(A=!0,setTimeout(function(){h=!0,d.init(),console.info(`正在重连第${m+1}次`),m++,A=!1},5e3))}const b={timeout:5e3,timeoutObj:null,serverTimeoutObj:null,reset:function(){return clearInterval(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this},start:function(){let e=0,t=d;this.timeoutObj=setInterval(()=>{e<3?(1===t.obj.readyState&&(t.obj.send("HeartBeat"),console.info(`HeartBeat第${e+1}次`)),e++):(clearInterval(this.timeoutObj),(e=0)===t.obj.readyState&&1===t.obj.readyState&&t.obj.close())},this.timeout)}};d.init=(e=e=>{},t=()=>{})=>{if(d.connected)d.initFunc&&(d.initFunc(),d.initFunc=null),t();else{y=setTimeout(()=>{h&&m<3&&(console.info("重连"),m++,d.init())},5e3);let o=d;o.obj=new WebSocket(o.url),o.obj.onopen=()=>{console.log("已连接"+o.url),r.show(1),i.tabChange("output"),r.setValue(o.url+"连接成功\n"),o.connected=!0,d.toggleUIToolbar(!0),d.initFunc=t,m=0,h=!1,clearTimeout(y),b.reset().start(),e(o)},o.obj.onmessage=e=>{b.reset().start();var t=l.parse(e.data),t=a.decode(t);d.debug&&console.log("receive -> ",e.data),l.run(t)},o.obj.onerror=e=>{console.log("WebSocket error: ",e),f()},o.obj.onclose=e=>{o.connected=!1,console.log("已断开"+o.url),r.show(1),i.tabChange("output"),r.setValue(o.url+"连接断开，请在设置中重新连接\n");var t=i.portsName;for(let e=0;e<t.length;e++)i.close(t[e]);d.toggleUIToolbar(!1),layer.closeAll(),Mixly.WebSocket.BU.burning=!1,Mixly.WebSocket.BU.uploading=!1,Mixly.WebSocket.ArduShell.compiling=!1,Mixly.WebSocket.ArduShell.uploading=!1,console.info("关闭",e.code),1e3!==e.code?(h=!1,clearTimeout(y),f()):(clearInterval(b.timeoutObj),clearTimeout(b.serverTimeoutObj))}}},d.sendCommand=t=>{var o=Mixly.WebSocket.Socket;if(o.connected){let e="";try{e=JSON.stringify(a.encode(t)),d.debug&&console.log("send -> ",e)}catch(e){return void console.log(e)}o.obj.send(e)}else layer.msg("未连接"+o.url,{time:1e3})},d.clickConnect=()=>{d.connected?d.disconnect():d.connect(e=>{layer.closeAll(),layer.msg(e.url+"连接成功",{time:1e3})})},d.openLoadingBox=(e,t=()=>{},o=()=>{})=>{layer.open({type:1,title:e,content:$("#mixly-loader-div"),shade:n.SHADE_ALL,closeBtn:0,success:function(){$("#webusb-cancel").css("display","none"),$(".layui-layer-page").css("z-index","198910151"),t()},end:function(){$("#mixly-loader-div").css("display","none"),$(".layui-layer-shade").remove(),$("#webusb-cancel").css("display","unset"),d.connected&&o()}})},d.connect=(e=e=>{},t=()=>{})=>{d.connected?t():d.openLoadingBox("连接中...",()=>{setTimeout(()=>{d.init(e)},1e3)},t)},d.disconnect=()=>{d.connected&&d.openLoadingBox("断开中...",()=>{d.obj.close()})},d.toggleUIToolbar=e=>{try{e?($("#socket-connect-btn").html(MSG.disconnect),$("#socket-connect-btn").removeClass("icon-link").addClass("icon-unlink")):($("#socket-connect-btn").html(MSG.connect),$("#socket-connect-btn").removeClass("icon-unlink").addClass("icon-link"))}catch(e){console.log(e)}},d.updateSelectedBoardConfig=e=>{t.currentPlatform=e.currentPlatform,e.clientPath=e.clientPath.replaceAll("\\","/"),t.clientPath=e.clientPath,e.appPath=e.appPath.replaceAll("\\","/"),t.srcPath=e.appPath,t.indexDirPath=goog.normalizePath_(t.srcPath+"/"+s.boardIndex+"/../"),t.python3Path=e.python3Path;e=o.getSelectedBoardName();o.changeTo(e)}}),goog.loadJs("common",()=>{goog.require("tippy"),goog.require("layui"),goog.require("Mixly.MFile"),goog.require("Mixly.Title"),goog.require("Mixly.XML"),goog.require("Mixly.Editor"),goog.require("Mixly.Msg"),goog.provide("Mixly.Example");const{MFile:o,Title:r,XML:i,Editor:l,Msg:a}=Mixly,n=layui["tree"];Mixly.Example=function(e,t){this.DEPTH=5,this.containerId_=e,this.exampleBtnId_=t,this.$container_=$("#"+e),this.$container_.children().first().prepend(`
        <button
            id="${t}"
            type="button"
            m-title="${a.Lang["例程"]}"
            class="layui-btn layui-btn-xs layui-btn-primary m-btn"
            style="cursor:pointer;border:none;margin-left:7px;padding:3px;display:inline-flex;align-items:center;"
        >
            <a
                class="icon-doc-text"
                style="color:#fff;font-size:12px;line-height:12px;"
            >${a.Lang["例程"]}</a>
        </button>
    `),(_this=this).menuHTML=i.render(i.TEMPLATE_STR.EXAMPLE_MENU_DIV,{id:_this.exampleBtnId_,close:a.Lang["关闭窗口"]}),$("#"+_this.exampleBtnId_).off().click(function(){_this.menu&&_this.menu.length&&!_this.menu[0].state.isDestroyed?_this.menu[0].state.isShown?(_this.menu[0].destroy(),_this.menu=null):_this.menu[0].show():(_this.render(),_this.menu[0].show())})},Mixly.Example.prototype.render=function(){const t=this;t.menu=tippy("#"+t.exampleBtnId_,{allowHTML:!0,content:t.menuHTML,trigger:"manual",interactive:!0,hideOnClick:!1,maxWidth:"none",offset:[0,6],onMount(e){$(`#${t.exampleBtnId_}-tree-colse`).off().click(function(){t.menu[0].destroy(),t.menu=null}),t.examplesTree_=n.render({elem:`#${t.exampleBtnId_}-tree-body`,data:t.getExampleList(),id:t.exampleBtnId_+"-tree-dom",accordion:!0,anim:!1,icon:["icon-folder-empty","icon-folder-open-empty-1","icon-file-code"],getChildren:function(e){return t.getExamples(e.data.id)},click:function(e){e.data.children||t.dataToWorkspace(e.data.id)},statusChange:function(){t.menu[0].setProps({})}}),t.examplesTree_.config.statusChange()}})},Mixly.Example.prototype.getExampleList=function(){},Mixly.Example.prototype.getExamples=function(e){},Mixly.Example.prototype.dataToWorkspace=function(e){},Mixly.Example.prototype.updateCode=(e,t)=>{switch(e){case".mix":case".xml":try{t=(t=i.convert(t,!0)).replace(/\\(u[0-9a-fA-F]{4})/g,function(e){return unescape(e.replace(/\\(u[0-9a-fA-F]{4})/g,"%$1"))})}catch(e){console.log(e)}"CODE"===l.selected&&l.items.vDrag.full("POSITIVE"),o.parseMix($(t),!1,!1,e=>{l.blockEditor.scrollCenter(),Blockly.hideChaff()});break;case".ino":case".py":editor.setValue(t,-1)}r.updateTitle(r.title)}}),goog.loadJs("electron",()=>{goog.require("layui"),goog.require("Blockly"),goog.require("Mixly.Modules"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Title"),goog.require("Mixly.Boards"),goog.require("Mixly.MFile"),goog.require("Mixly.MArray"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron.Serial"),goog.provide("Mixly.Electron.ArduShell");const{Modules:e,Env:u,Electron:t,LayerExt:p,StatusBar:A,StatusBarPort:h,Title:s,Boards:r,MFile:y,MArray:i,Msg:m,Config:o}=Mixly,{SOFTWARE:l,USER:f}=o,{fs:b,fs_extend:x,fs_extra:c,path:C,child_process:d}=e,{ArduShell:v,Serial:B}=t;v.DEFAULT_CONFIG={board_manager:{additional_urls:[]},daemon:{port:"50051"},directories:{data:"",downloads:"",user:""},library:{enable_unsafe_install:!1},logging:{file:"",format:"text",level:"info"},metrics:{addr:"9090",enabled:!0},sketch:{always_export_binaries:!1}},v.binFilePath="",v.shellPath=null,v.shell=null,v.updateShellPath=()=>{let e=C.resolve(u.clientPath,"./arduino-cli");var t;e="win32"===u.currentPlatform?C.resolve(e,"./arduino-cli.exe"):C.resolve(e,"./arduino-cli"),x.isfile(e)||({defaultPath:t={}}=l,"object"==typeof t[u.currentPlatform]&&(t=t[u.currentPlatform].arduinoCli??"",t=C.resolve(u.clientPath,t),e=x.isfile(t)?t:null)),v.shellPath=e},v.updateConfig=e=>{var t,o;v.shellPath&&(t=C.resolve(v.shellPath,"../arduino-cli.json"),o=c.readJsonSync(t,{throws:!1})??{...v.DEFAULT_CONFIG},"object"!=typeof e||i.equals(o.directories,e.directories)||(o={...o,...e},c.outputJson(t,o,{spaces:"    "}).then(()=>{console.log("arduino-cli.json已更新")}).catch(e=>{console.log(e)})))},v.init=()=>{v.updateShellPath(),v.shellPath&&v.updateConfig({directories:{data:C.resolve(v.shellPath,"../Arduino15"),downloads:C.resolve(v.shellPath,"../staging"),user:C.resolve(v.shellPath,"../Arduino")}})},v.init(),v.burn=()=>{Mixly.Electron.BU.initBurn()},v.initCompile=()=>{v.compile(()=>{})},v.compile=(c=()=>{})=>{v.shellPath||(v.shellPath=""),h.tabChange("output"),v.compiling=!0,v.uploading=!1;const d=r.getSelectedBoardCommandParam(),g=(A.show(1),layer.open({type:1,title:m.Lang["编译中"]+"...",content:$("#mixly-loader-div"),shade:p.SHADE_NAV,resize:!1,closeBtn:0,success:()=>{$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),layer.title(m.Lang["编译终止中"]+"...",g),v.cancel()})},end:()=>{$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+g).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}}));setTimeout(()=>{A.setValue(m.Lang["编译中"]+"...\n");let e=u.indexDirPath+"/libraries/myLib/";x.isdir(e)?e+='","':e="";var t,o=C.resolve(u.indexDirPath,"libraries/ThirdParty");if(x.isdir(o))for(t of b.readdirSync(o)){var r=C.resolve(o,t,"libraries");x.isdir(r)&&(e+=r+",")}var i=C.resolve(v.shellPath,"../arduino-cli.json"),l=C.resolve(v.shellPath,"../libraries"),a=C.resolve(u.clientPath,"./mixlyBuild"),n=C.resolve(u.clientPath,"./mixlyBuildCache"),s=C.resolve(u.clientPath,"./testArduino/testArduino.ino"),i='"'+v.shellPath+'" compile -b '+d+' --config-file "'+i+'" --build-cache-path "'+n+'" --verbose --libraries "'+e+l+'" --build-path "'+a+'" "'+s+'" --no-color';v.runCmd(g,"compile",i,c)},100)},v.initUpload=()=>{v.compiling=!1,v.uploading=!0;const e=r.getSelectedBoardCommandParam();var t=r.getSelectedBoardConfigParam("upload_method");let o=B.getSelectedPortName();switch(t){case"STLinkMethod":case"jlinkMethod":case"usb":o="None"}o?B.portClose(o,()=>{v.upload(e,o)}):layer.msg(m.Lang["无可用设备"]+"!",{time:1e3})},v.upload=(t,o)=>{v.shellPath||(v.shellPath=""),h.tabChange("output");const e=layer.open({type:1,title:m.Lang["上传中"]+"...",content:$("#mixly-loader-div"),shade:p.SHADE_NAV,resize:!1,closeBtn:0,success:function(){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),layer.title(m.Lang["上传终止中"]+"...",e),v.cancel()})},end:function(){$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+e).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}});A.show(1),A.setValue(m.Lang["上传中"]+"...\n");var r=C.resolve(v.shellPath,"../arduino-cli.json"),i=C.resolve(v.shellPath,"../libraries"),l=C.resolve(u.clientPath,"./mixlyBuild"),a=C.resolve(u.clientPath,"./mixlyBuildCache"),n=C.resolve(u.clientPath,"./testArduino/testArduino.ino");let s="";if(""!==v.binFilePath)s='"'+v.shellPath+'" -b '+t+" upload -p "+o+' --config-file "'+r+'" --verbose -i "'+v.binFilePath+'" --no-color',v.binFilePath="";else{let e=u.indexDirPath+"/libraries/myLib/";x.isdir(e)?e+='","':e="";var c,d=C.resolve(u.indexDirPath,"libraries/ThirdParty");if(x.isdir(d))for(c of b.readdirSync(d)){var g=C.resolve(d,c,"libraries");x.isdir(g)&&(e+=g+",")}s='"'+v.shellPath+'" compile -b '+t+" --upload -p "+o+' --config-file "'+r+'" --build-cache-path "'+a+'" --verbose --libraries "'+e+i+'" --build-path "'+l+'" "'+n+'" --no-color'}v.runCmd(e,"upload",s,function(){var e=y.getCode(),t=(A.show(1),B.portsOperator[o]);t&&(t=t["toolConfig"],(e=e.match(/(?<=Serial.begin[\s]*\([\s]*)[0-9]*(?=[\s]*\))/g))&&B.BAUDRATES.includes(+e[0])&&(t.baudRates=+e[0]),"no"!==f.autoOpenPort)&&B.connect(o,t.baudRates)})},v.cancel=function(){v.shell&&(v.shell.stdin.end(),v.shell.stdout.end(),"win32"===u.currentPlatform?d.exec("taskkill /pid "+v.shell.pid+" /f /t"):v.shell.kill("SIGTERM"),v.shell=null)},v.checkFileNameExtension=(e,t)=>{var o;return!!e&&(o=e.length,e=e.substring(e.lastIndexOf("."),o),!!t.includes(e))},v.isCppOrHpp=e=>v.checkFileNameExtension(e,[".c",".cpp",".h",".hpp"]),v.isMixOrIno=e=>v.checkFileNameExtension(e,[".mix",".xml",".ino"]),v.clearDirCppAndHppFiles=t=>{if(x.isdir(t)){var o,r=b.readdirSync(t);for(let e=0;e<r.length;e++)v.isCppOrHpp(r[e])&&(o=C.resolve(t,r[e]),b.unlinkSync(o))}},v.copyHppAndCppFiles=(t,o)=>{if(x.isdir(t)&&x.isdir(o)){var r=b.readdirSync(t);for(let e=0;e<r.length;e++)if(v.isCppOrHpp(r[e])){var i=C.resolve(t,r[e]),l=C.resolve(o,r[e]);try{b.copyFileSync(i,l)}catch(e){console.log(e)}}}},v.writeLibFiles=a=>new Promise((e,t)=>{var o,r=[];for(o in Blockly.Arduino.libs_){const i=Blockly.Arduino.libs_[o],l=C.resolve(a,o+".h");r.push(new Promise((e,t)=>{c.outputFile(l,i).finally(()=>{e()})}))}r.length?Promise.all(r).finally(()=>{e()}):e()}),v.runCmd=(i,l,e,a)=>{const t=y.getCode();var o=C.resolve(u.clientPath,"testArduino");const r=C.resolve(o,"testArduino.ino");v.clearDirCppAndHppFiles(o);var n=s.getFilePath();"yes"===f.compileCAndH&&x.isfile(n)&&v.isMixOrIno(n)&&(n=C.dirname(n),v.copyHppAndCppFiles(n,o)),v.writeLibFiles(o).then(()=>c.outputFile(r,t)).then(()=>{let r=Number(new Date);v.shell=d.exec(e,{maxBuffer:4096e6},(e,t,o)=>{null!==e&&console.log("exec error"+e)}),v.shell.stdout.on("data",e=>{e.length<1e3&&A.addValue(e)}),v.shell.stderr.on("data",e=>{try{e=e.replace(/(_[0-9A-F]{2}_[0-9A-F]{2}_[0-9A-F]{2})+/g,function(e){return decodeURIComponent(e.replace(/_/g,"%"))})}catch(e){console.log(e)}A.addValue(e)}),v.shell.on("close",e=>{layer.close(i);var t=parseInt((Number(new Date)-r)/1e3),o=t%60,t=parseInt(t/60),t=(t?t+"m":"")+o+"s";0===e?(o="compile"===l?m.Lang["编译成功"]:m.Lang["上传成功"],A.addValue("=="+o+"("+m.Lang["用时"]+" "+t+")==\n"),layer.msg(o+"！",{time:1e3}),a()):(e="compile"===l?m.Lang["编译失败"]:m.Lang["上传失败"],A.addValue("=="+e+"==\n")),A.scrollToTheBottom()})}).catch(e=>{console.log(e),layer.close(i);e="compile"===l?m.Lang["编译失败"]:m.Lang["上传失败"];A.addValue("=="+e+"==\n")})},v.saveBinOrHex=function(e){v.writeFile(u.clientPath+"/mixlyBuild",e)},v.writeFile=function(d,g){v.compile(function(){window.setTimeout(function(){const c=layer.open({type:1,title:m.Lang["保存中"]+"...",content:$("#mixly-loader-div"),shade:p.SHADE_ALL,resize:!1,closeBtn:0,success:function(){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{layer.close(c),v.cancel()}),window.setTimeout(function(){try{d=d.replace(/\\/g,"/"),g=g.replace(/\\/g,"/")}catch(e){console.log(e)}try{var t=g.substring(0,g.lastIndexOf(".")),o=g.substring(g.lastIndexOf("/")+1,g.lastIndexOf(".")),e=g.substring(g.lastIndexOf(".")+1),r=(b.existsSync(t)||b.mkdirSync(t),b.existsSync(g)&&b.unlinkSync(g),d+"/testArduino.ino."+e),i=b.readFileSync(r),l=(b.writeFileSync(g,i),[".eep",".hex",".with_bootloader.bin",".with_bootloader.hex",".bin",".elf",".map",".partitions.bin",".bootloader.bin"]);for(let e=0;e<l.length;e++){var a,n=d+"/testArduino.ino"+l[e],s=t+"/"+o+l[e];b.existsSync(n)&&(a=b.readFileSync(n),b.writeFileSync(s,a))}layer.msg(m.Lang["保存成功"]+"！",{time:1e3})}catch(e){console.log(e),A.addValue(e+"\n")}layer.close(c)},500)},end:function(){$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+c).remove(),$("#mixly-loader-btn").off("click")}})},1e3)})},v.showUploadBox=function(e){var t=C.dirname(e),o=C.basename(e,C.extname(e));x.isdir(C.resolve(t,o))&&(e=C.resolve(t,o,C.basename(e)));const r=layer.msg(m.Lang["所打开文件可直接上传"],{time:-1,btn:[m.Lang["取消"],m.Lang["上传"]],shade:p.SHADE_ALL,btnAlign:"c",yes:function(){layer.close(r),v.binFilePath="",layer.msg(m.Lang["已取消上传"],{time:1e3})},btn2:function(){layer.close(r),v.uploadWithBinOrHex(e)},end:function(){v.binFilePath=""}})},v.uploadWithBinOrHex=function(e){layer.closeAll(),v.binFilePath=e,v.initUpload()}}),goog.loadJs("electron",()=>{goog.require("layui"),goog.require("Mixly.Config"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Modules"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Env"),goog.require("Mixly.Boards"),goog.require("Mixly.MFile"),goog.require("Mixly.MString"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron.Serial"),goog.provide("Mixly.Electron.BU");const{Electron:e,Config:t,StatusBar:m,StatusBarPort:n,Modules:o,LayerExt:d,Env:g,MFile:u,MString:r,Msg:f}=Mixly,{BU:b,Serial:s}=e,{SELECTED_BOARD:x,USER:c}=t;o.iconv_lite=require("iconv-lite");const p=layui["form"],{fs:C,fs_extra:A,fs_extend:v,iconv_lite:h,os:y,child_process:B,path:w}=o;b.uploading=!1,b.burning=!1,b.shell=null,b.checkNumOfDisks=function(o,e,r){let t=e,i=(t=(t=t.replace(/\s+/g,"")).replace("DeviceID","")).split(":"),l="win32"===g.currentPlatform?":":"";if(e.indexOf(":")!=e.lastIndexOf(":")){var e=layui.form,a=$("#mixly-selector-type"),n=$("#mixly-selector-type option:selected").val();a.empty();for(let e=0;e<i.length;e++)i[e]&&(n==i[e]+l?a.append('<option value="'+i[e]+l+'" selected>'+i[e]+l+"</option>"):a.append('<option value="'+i[e]+l+'">'+i[e]+l+"</option>"));e.render();let t=!1;const s=layer.open({type:1,id:"serial-select",title:f.Lang["检测到多个同类型设备，请选择："],area:["350px","150px"],content:$("#mixly-selector-div"),shade:d.SHADE_ALL,resize:!1,closeBtn:0,success:function(e){$("#serial-select").css("height","195px"),$(".layui-layer-page").css("z-index","198910151"),$("#mixly-selector-btn1").off("click").click(()=>{layer.close(s),b.cancel()}),$("#mixly-selector-btn2").off("click").click(()=>{layer.close(s),t=!0})},end:function(){$("#mixly-selector-div").css("display","none"),$("#layui-layer-shade"+s).remove(),t&&b.initWithDropdownBox(o,r),$("#mixly-selector-btn1").off("click"),$("#mixly-selector-btn2").off("click")}})}else{const c=layer.open({type:1,title:("burn"===o?f.Lang["烧录中"]:f.Lang["上传中"])+"...",content:$("#mixly-loader-div"),shade:d.SHADE_ALL,resize:!1,closeBtn:0,success:function(e,t){"burn"===o?b.copyFiles(o,t,r,i[0]+l+"/"):A.outputFile(r,u.getCode()).then(()=>{b.copyFiles(o,t,r,i[0]+l+"/")}).catch(e=>{layer.close(t),b.burning=!1,b.uploading=!1,layer.msg(f.Lang["写文件出错了，错误是："]+e,{time:1e3}),m.setValue(f.Lang["写文件出错了，错误是："]+e+"\n")}),$("#mixly-loader-btn").off("click").click(()=>{layer.close(t),b.cancel()})},end:function(){$("#mixly-selector-div").css("display","none"),$("#layui-layer-shade"+c).remove(),$("#mixly-loader-btn").off("click")}})}},b.copyFiles=(t,o,e,r)=>{var i=x["upload"];"upload"===t&&i.copyLib&&(w.dirname(i.filePath),b.copyLib(e,u.getCode()),e=w.dirname(e)),v.isfile(e)&&(r=w.resolve(r,w.basename(e))),A.copy(e,r).then(()=>{layer.close(o);var e="burn"===t?f.Lang["烧录成功"]:f.Lang["上传成功"];layer.msg(e+"!",{time:1e3}),m.setValue(`==${e}==`),"upload"===t&&1===s.uploadPorts.length&&"no"!==c.autoOpenPort&&s.connect(s.uploadPorts[0].name,null,e=>{e&&s.writeCtrlD(s.uploadPorts[0].name)})}).catch(e=>{layer.close(o),layer.msg(f.Lang["写文件出错了，错误是："]+e,{time:1e3}),m.setValue(f.Lang["写文件出错了，错误是："]+e+"\n"),console.log(e)}).finally(()=>{b.burning=!1,b.uploading=!1})},b.initWithDropdownBox=function(r,i){const e=layer.open({type:1,title:("burn"===r?f.Lang["烧录中"]:f.Lang["上传中"])+"...",content:$("#mixly-loader-div"),shade:d.SHADE_ALL,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{layer.close(t),b.cancel()});const o=$("#mixly-selector-type option:selected").val();"burn"===r?b.copyFiles(r,t,i,o):A.outputFile(i,u.getCode()).then(()=>{b.copyFiles(r,t,i,o)}).catch(e=>{layer.close(t),b.burning=!1,b.uploading=!1,layer.msg(f.Lang["写文件出错了，错误是："]+err,{time:1e3}),m.setValue(f.Lang["写文件出错了，错误是："]+e+"\n")})},end:function(){$("#mixly-loader-div").css("display","none"),$("#layui-layer-shade"+e).remove()}})},b.getDisksWithVolumesName=function(i,l,a){var e=w.dirname(a);if(A.ensureDirSync(e),"win32"===g.currentPlatform)B.exec('wmic logicaldisk where "'+l+'" get DeviceID',function(e,t,o){e||o?($("#mixly-loader-div").css("display","none"),console.log("root path open failed"+e+o),layer.msg(f.Lang["无可用设备"]+"!",{time:1e3}),b.burning=!1,b.uploading=!1):b.checkNumOfDisks(i,t,a)});else{let e="/Volumes/",t=" ",o=("linux"===g.currentPlatform&&(e="/media/",t=""),"");var n=l.split("/");let r=0;for(var s=0;s<n.length;s++)if(""!==n[s])for(var c=0;;c++){if(v.isdir(e+n[s]+(0==c?"":t+c)))o+=e+n[s]+(0==c?"":t+c)+":";else{if(!v.isdir(e+y.userInfo().username+"/"+n[s]+(0==c?"":t+c)))break;o+=e+y.userInfo().username+"/"+n[s]+(0==c?"":t+c)+":"}r++}0===r?(layer.msg(f.Lang["无可用设备"]+"!",{time:1e3}),b.burning=!1,b.uploading=!1):b.checkNumOfDisks(i,o,a)}},b.cancel=function(){b.shell?(b.shell.stdout.end(),b.shell.stdin.end(),"win32"===g.currentPlatform?B.exec("taskkill /pid "+b.shell.pid+" /f /t"):b.shell.kill("SIGTERM"),b.shell=null):b.uploading?(b.uploading=!1,layer.msg(f.Lang["已取消上传"],{time:1e3})):b.burning&&(b.burning=!1,layer.msg(f.Lang["已取消烧录"],{time:1e3}))},b.initBurn=function(){var e,t;b.burning||(e=x["burn"],m.setValue(""),n.tabChange("output"),m.show(1),b.burning=!0,b.uploading=!1,"volume"===e.type?b.getDisksWithVolumesName("burn",e.volume,e.filePath):(t=s.getSelectedPortName(),b.burnWithPort(t,e.command)))},b.initUpload=function(){var e,t;b.uploading||(e=x["upload"],m.setValue(""),n.tabChange("output"),m.show(1),b.burning=!1,b.uploading=!0,"volume"===e.type?b.getDisksWithVolumesName("upload",e.volume,e.filePath):(t=s.getSelectedPortName(),b.uploadWithPort(t,e.command)))},b.copyLib=function(e,t){var o,r=w.dirname(e),i=w.basename(e);A.ensureDirSync(r);try{for(o of C.readdirSync(r))o!==i&&C.unlinkSync(w.resolve(r,o))}catch(e){console.log(e)}e=[];return b.searchLibs(r,t,e)},b.searchLibs=function(i,l,a){var n=x["upload"];let s=new Array,c=(l.trim().split("\n").forEach(function(e,t){s.push(e)}),"");var d=[];for(let r=0;r<s.length;r++){let t=s[r].indexOf("from"),o=s[r].indexOf("import");if(s[r].substring(0,-1===t?o:t).split("").forEach(e=>{" "!==e&&"\t"!==e&&(t=-1,o=-1)}),-1!==t)c=s[r].substring(t+4,s[r].indexOf("import"));else{if(-1===o)continue;{let e=s[r].indexOf("as");-1===e&&(e=s[r].length),c=s[r].substring(o+6,e)}}var g,u,p=(c=(c=c.replaceAll(" ","")).replaceAll("\r","")).split(",");for(let t=0;t<p.length;t++)if(!a.includes(p[t]+".py")&&!a.includes(p[t]+".mpy"))try{let e=null;if(!n.libPath||!n.libPath.length)return;for(var A of n.libPath){var h=w.resolve(A,p[t]+".mpy"),y=w.resolve(A,p[t]+".py");if(v.isfile(h)){e=h;break}v.isfile(y)&&(e=y)}e&&(g=w.extname(e),u=w.resolve(i,p[t]+g),m.addValue(f.Lang["拷贝库"]+" "+p[t]+"\n"),C.copyFileSync(e,u),a.push(p[t]+g),".py"===g)&&(d.push(p[t]+g),l=C.readFileSync(e,"utf8"),a=b.searchLibs(i,l,a))}catch(e){console.log(e)}}return a},b.burnByCmd=function(e,t,o){b.runCmd(e,"burn",t,o)},b.uploadByCmd=async function(t,e,o){var r=x["upload"],i=u.getCode();r.copyLib&&b.copyLib(r.filePath,i),A.outputFile(r.filePath,i).then(()=>{m.addValue(f.Lang["上传中"]+"...\n"),b.runCmd(t,"upload",e,o)}).catch(e=>{m.setValue(e.toString()+"\n"),console.log(e),layer.close(t),b.uploading=!1})},b.runCmd=function(i,l,a,e,t){e=r.tpl(e,{com:a});b.shell=B.exec(e,function(e,t,o){layer.close(i),b.burning=!1,b.uploading=!1,b.shell=null;var r=m.getValue();if(r.lastIndexOf("\n")!==r.length-1&&m.addValue("\n"),e){try{e=decode(h.decode(h.encode(e,"iso-8859-1"),"gbk"))}catch(e){console.log(e)}m.addValue(e+"\n")}else layer.msg("burn"===l?f.Lang["烧录成功"]+"！":f.Lang["上传成功"]+"！",{time:1e3}),m.addValue(("burn"===l?f.Lang["烧录成功"]+"！":f.Lang["上传成功"]+"！")+"\n"),"upload"===l&&(m.show(1),"no"!==c.autoOpenPort)&&s.connect(a,null,e=>{e&&s.writeCtrlD(a)})}),b.shell.stdout.on("data",function(e){if(b.uploading||b.burning){try{e=decode(h.decode(h.encode(e,"iso-8859-1"),"gbk"))}catch(e){console.log(e)}m.addValue(e)}})},b.burnWithSpecialBin=()=>{var e,t=$("#mixly-selector-type"),o=$("#mixly-selector-type option:selected").val(),r=(t.empty(),x.burn.special);let i={};for(e of r){if(!e?.name&&!e?.command)return;i[e.name]=e.command,""+e.name==o?t.append($(`<option value="${e.name}" selected>${e.name}</option>`)):t.append($(`<option value="${e.name}">${e.name}</option>`))}p.render();let l=!1;const a=layer.open({type:1,id:"serial-select",title:"请选择固件：",area:["350px","150px"],content:$("#mixly-selector-div"),shade:Mixly.LayerExt.SHADE_ALL,resize:!1,closeBtn:0,success:function(e){$("#serial-select").css("height","180px"),$("#serial-select").css("overflow","inherit"),$(".layui-layer-page").css("z-index","198910151"),$("#mixly-selector-btn1").off("click").click(()=>{layer.close(a)}),$("#mixly-selector-btn2").click(()=>{layer.close(a),l=!0})},end:function(){var e,t;$("#mixly-selector-btn1").off("click"),$("#mixly-selector-btn2").off("click"),$("#mixly-selector-div").css("display","none"),$(".layui-layer-shade").remove(),l?(e=$("#mixly-selector-type option:selected").val(),m.setValue(""),n.tabChange("output"),m.show(1),b.burning=!0,b.uploading=!1,t=s.getSelectedPortName(),b.burnWithPort(t,i[e])):layer.msg(f.Lang["已取消烧录"],{time:1e3})}})},b.operateWithPort=(o,r,i)=>{if(r){const t=("burn"===o?f.Lang["烧录中"]:f.Lang["上传中"])+"...";s.portClose(r,()=>{const e=layer.open({type:1,title:t,content:$("#mixly-loader-div"),shade:d.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),"burn"===o?b.burnByCmd(t,r,i):b.uploadByCmd(t,r,i),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),"burn"===o?layer.title(f.Lang["烧录终止中"]+"...",t):layer.title(f.Lang["上传终止中"]+"...",t),b.cancel(o)})},end:function(){$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+e).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}})})}else layer.msg(f.Lang["无可用设备"]+"!",{time:1e3}),b.burning=!1,b.uploading=!1},b.burnWithPort=(e,t)=>{b.operateWithPort("burn",e,t)},b.uploadWithPort=(e,t)=>{b.operateWithPort("upload",e,t)}}),goog.loadJs("electron",()=>{goog.require("Mixly.Modules"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.Title"),goog.require("Mixly.MFile"),goog.require("Mixly.XML"),goog.require("Mixly.Editor"),goog.require("Mixly.Drag"),goog.require("Mixly.Msg"),goog.require("Mixly.Electron.ArduShell"),goog.require("Mixly.Electron.BU"),goog.provide("Mixly.Electron.File");const{Modules:i,LayerExt:n,Config:e,Title:s,MFile:l,XML:r,Editor:c,Drag:a,Msg:d,Electron:t}=Mixly,g=e["BOARD"],{File:u,ArduShell:p}=t,{fs_extra:A,fs_extend:h,fs:y,path:m,electron_remote:o,app:f}=i,b=o["dialog"],x=Blockly.Msg["MSG"];u.DEFAULT_PATH=m.resolve(f.getAppPath(),"src/sample"),u.workingPath=u.DEFAULT_PATH,u.openedFilePath=null,u.userPath={img:null,mix:null,code:null,hex:null},u.showSaveDialog=(e,t,o)=>{var r=i["currentWindow"];r.focus(),b.showSaveDialog(r,{title:e,defaultPath:u.workingPath,filters:t,showsTagField:!0,properties:["showHiddenFiles"],message:e}).then(e=>{e=e.filePath;e&&o(e)}).catch(e=>{console.log(e)})},u.showOpenDialog=(e,t,o)=>{var r=i["currentWindow"];r.focus(),b.showOpenDialog(r,{title:e,defaultPath:u.workingPath,filters:t,properties:["openFile","showHiddenFiles"],message:e}).then(e=>{e=e.filePaths[0];e&&o(e)}).catch(e=>{console.log(e)})},u.save=(t=()=>{})=>{if(u.openedFilePath){let e="";switch(m.extname(u.openedFilePath)){case".mix":e=l.getMix();break;case".py":case".ino":e=l.getCode();break;default:return void layer.msg(d.Lang["文件后缀错误"],{time:1e3})}A.outputFile(u.openedFilePath,e).then(()=>{s.updeteFilePath(u.openedFilePath),layer.msg(d.Lang["保存成功"],{time:1e3})}).catch(e=>{u.openedFilePath=null,console.log(e),layer.msg(d.Lang["写文件出错"],{time:1e3})}).finally(()=>{t()})}else u.saveAs(t)},u.saveAs=(r=()=>{})=>{u.showSaveDialog(d.Lang["另存为"],l.saveFilters,t=>{var e=m.extname(t);if([".mix",".py",".ino"].includes(e))u.openedFilePath=t,u.workingPath=m.dirname(t),u.save(r);else switch(e){case".bin":case".hex":g?.nav?.compile?p.saveBinOrHex(t):(o=l.getHex(),A.outputFile(t,o).then(()=>{layer.msg(d.Lang["保存成功"],{time:1e3})}).catch(e=>{console.log(e),layer.msg(d.Lang["写文件出错"],{time:1e3})}).finally(()=>{r()}));break;case".png":l.getBlocksPng().then(e=>A.outputFile(t,e)).then(()=>{layer.msg(d.Lang["保存成功"],{time:1e3})}).catch(e=>{console.log(e),layer.msg(d.Lang["写文件出错"],{time:1e3})}).finally(()=>{r()});break;case".mil":var o=l.getMil(),o=$(o);o.attr("name",m.basename(t,".mil")),A.outputFile(t,o[0].outerHTML).then(()=>{layer.msg("库导出成功",{time:1e3})}).catch(e=>{console.log(e),layer.msg(d.Lang["写文件出错"],{time:1e3})}).finally(()=>{r()});break;default:layer.msg(d.Lang["文件后缀错误"],{time:1e3}),r()}})},u.exportLib=(o=()=>{})=>{u.showSaveDialog("导出库",[l.SAVE_FILTER_TYPE.mil],e=>{var t=l.getMil(),t=$(t);t.attr("name",m.basename(e,".mil")),A.outputFile(e,t[0].outerHTML).then(()=>{layer.msg("库导出成功",{time:1e3})}).catch(e=>{console.log(e),layer.msg(d.Lang["写文件出错"],{time:1e3})}).finally(()=>{o()})})},u.newFile=()=>{var e=c.blockEditor.getAllBlocks();const{blockEditor:o,codeEditor:r,selected:t}=c,i=Blockly?.Python??Blockly.Arduino;if("CODE"===t){var l=r.getValue(),a=i.workspaceToCode(o)||"";if(!e.length&&a===l)return layer.msg(d.Lang["代码区已清空"],{time:1e3}),u.openedFilePath=null,void s.updateTitle(s.title)}else if(!e.length)return layer.msg(d.Lang["工作区已清空"],{time:1e3}),u.openedFilePath=null,void s.updateTitle(s.title);layer.confirm(x.confirm_newfile,{title:!1,shade:n.SHADE_ALL,resize:!1,success:e=>{e[0].childNodes[1].childNodes[0].classList.remove("layui-layer-close2"),e[0].childNodes[1].childNodes[0].classList.add("layui-layer-close1")},btn:[x.newfile_yes,x.newfile_no],btn2:(e,t)=>{layer.close(e)}},(e,t)=>{layer.close(e),o.clear(),o.scrollCenter(),Blockly.hideChaff(),r.setValue(i.workspaceToCode(o)||"",-1),u.openedFilePath=null,s.updateTitle(s.title)})},u.open=()=>{u.showOpenDialog(d.Lang["打开"],[{name:d.Lang["Mixly文件"],extensions:l.openFilters}],e=>{u.openFile(e)})},u.openFile=t=>{var e=m.extname(t);let o;if(h.isfile(t)){try{o=y.readFileSync(t,"utf-8")}catch(e){return void console.log(e)}switch(e){case".mix":case".xml":try{o=(o=r.convert(o,!0)).replace(/\\(u[0-9a-fA-F]{4})/g,function(e){return unescape(e.replace(/\\(u[0-9a-fA-F]{4})/g,"%$1"))})}catch(e){console.log(e)}l.parseMix($(o),!1,!1,e=>{e?(c.blockEditor.scrollCenter(),Blockly.hideChaff(),u.openedFilePath=null,s.updateTitle(s.title)):(u.openedFilePath=t,u.workingPath=m.dirname(t),s.updeteFilePath(u.openedFilePath))});break;case".ino":case".py":a.items.vDrag.full("NEGATIVE"),c.codeEditor.setValue(o,-1),u.openedFilePath=t,u.workingPath=m.dirname(t),s.updeteFilePath(u.openedFilePath);break;case".bin":case".hex":g?.nav?.compile?p.showUploadBox(t):l.loadHex(o);break;default:layer.msg(d.Lang["文件后缀错误"],{time:1e3})}}else console.log(t+"不存在")}}),goog.loadJs("electron",()=>{goog.require("Mixly.Url"),goog.require("Mixly.Config"),goog.require("Mixly.Modules"),goog.require("Mixly.Env"),goog.require("Mixly.Electron.Serial"),goog.provide("Mixly.Electron.Loader");const{Url:n,Config:s,Electron:e,Env:c}=Mixly,d=s["BOARD"],{Serial:g,Loader:u}=e;u.onbeforeunload=function(t=!1){const e=e=>{t?window.location.reload(!0):window.location.replace(e)};let o=s.pathPrefix+"/index.html?"+n.jsonToUrl({boardType:d.boardType??"None"});g?.refreshPortsTimer&&clearInterval(g?.refreshPortsTimer);var r=g?.portsOperator??null;if(c.isElectron&&r&&"object"==typeof r&&Object.keys(r).length){var i,l=[];for(i in r){var a=r[i]["serialport"];a&&(a.isOpen||a.opening)&&l.push(u.closePort(a))}Promise.all(l).then(()=>{}).catch(e=>{}).finally(()=>{e(o)})}else e(o)},u.closePort=o=>new Promise((e,t)=>{o.close(()=>{e()})}),u.reload=()=>{u.onbeforeunload(!0)}}),goog.loadJs("web",()=>{goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.MFile"),goog.require("Mixly.Boards"),goog.require("Mixly.Msg"),goog.require("Mixly.Web.Serial"),goog.require("Mixly.Web.Esptool"),goog.require("Mixly.Web.USB"),goog.require("Mixly.Web.SerialPort"),goog.require("Mixly.Web.Ampy"),goog.provide("Mixly.Web.BU");const{StatusBar:g,StatusBarPort:u,Web:e,LayerExt:r,Config:t,MFile:p,Msg:A}=Mixly,{Serial:h,Esptool:o,BU:y,USB:n,SerialPort:m,Ampy:c}=e,d=t["SELECTED_BOARD"];y.uploading=!1,y.burning=!1;let f=null;const b=new o.EspLoader({updateProgress:!1,logMsg:!1,debugMsg:!1,debug:!1});y.clickConnect=async function(){let e="web-"+(d.web.com??"serial");navigator.serial&&navigator.usb||(e="web-bluetooth");var t=h.portsOperator[e];t&&t.portOpened?h.portClose(e):h.connect(e,115200,e=>{e?g.show(1):layer.msg(A.Lang["已取消连接"],{time:1e3})})};async function x(){return await b.sync()?(g.addValue(A.Lang["正在连接"]+" "+await b.chipName()+"\n"),g.addValue(A.Lang["MAC地址"]+"："+b.macAddr().map(e=>e.toString(16).toUpperCase().padStart(2,"0")).join(":")+"\n"),f=await b.runStub(),1):0}function C(t){return new Promise(e=>setTimeout(e,t))}async function v(e,t=null){g.addValue(A.Lang["正在烧录固件"]+"\n");e=parseInt(e,16);await f.flashData(t,e),await C(100)}y.initBurn=()=>{"usb"===d.web.com?y.burnByUSB():y.burnWithEsptool()},y.burnByUSB=()=>{h.connect("web-usb",115200,async e=>{if(e){const{toolConfig:o,serialport:i}=h.portsOperator["web-usb"],l=o.baudRates;115200!==l&&(o.baudRates=115200,await i.setBaudRate(o.baudRates));e=d["web"],e=e["burn"],e=goog.get(e.filePath);const a=await new Blob([e],{type:"text/plain"}).arrayBuffer();if(a){y.burning=!0,y.uploading=!1,g.setValue(A.Lang["烧录中"]+"...\n"),g.show(1),u.tabChange("output");const t=layer.open({type:1,title:A.Lang["烧录中"]+"...",content:$("#mixly-loader-div"),shade:r.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").hide();let r=0;n.DAPLink.on(DAPjs.DAPLink.EVENT_PROGRESS,e=>{var t,o,e=Math.floor(100*e);e>r&&(r=e,o=Math.floor(e/2),t=new Array(o).fill("=").join(""),o=new Array(50-o).fill("-").join(""),g.addValue(`[${t}${o}] ${e}%
`))}),n.flash(a).then(()=>{layer.close(t),layer.msg(A.Lang["烧录成功"],{time:1e3}),g.addValue(`==${A.Lang["烧录成功"]}==
`)}).catch(e=>{console.log(e),layer.close(t),g.addValue(`==${A.Lang["烧录失败"]}==
`)}).finally(async()=>{y.burning=!1,y.uploading=!1,o.baudRates!==l&&(o.baudRates=l,await i.setBaudRate(l)),n.DAPLink.removeAllListeners(DAPjs.DAPLink.EVENT_PROGRESS)})},end:function(){$("#mixly-loader-btn").css("display","inline-block"),$("#mixly-loader-div").css("display","none"),$("#layui-layer-shade"+t).remove()}})}else layer.msg(A.Lang["固件读取出错"],{time:1e3})}else layer.msg(A.Lang["已取消连接"],{time:1e3})})},y.burnWithEsptool=()=>{const c="web-serial";h.connect(c,115200,async e=>{if(e){const{toolConfig:l,serialport:a}=h.portsOperator[c],n=l.baudRates;115200!==n&&(l.baudRates=115200,await a.setBaudRate(l.baudRates));e=d["web"];const s=e["burn"];if(g.setValue(A.Lang["固件读取中"]+"..."),"object"!=typeof s.binFile)g.addValue(" Failed!\n"+A.Lang["配置文件读取出错"]+"！\n");else{var t,e=s["binFile"],o=[];g.addValue("\n");for(t of e)t.path&&t.offset&&(g.addValue(A.Lang["读取固件"]+" "+A.Lang["路径"]+`:${t.path}, ${A.Lang["偏移"]}:${t.offset}
`),o.push(((o,r)=>new Promise((t,e)=>{fetch(o).then(e=>e.blob()).then(e=>{t({offset:r,blob:e})}).catch(e=>{t({offset:r,blob:null})})}))(t.path,t.offset)));Promise.all(o).then(async e=>{console.log(e);let i=[];for(var t of e)t.blob&&t.offset&&i.push({offset:t.offset,binBuf:await(o=>{const r=new FileReader;return new Promise((e,t)=>{r.onerror=()=>{r.abort(),t(new DOMException("Problem parsing input file."))},r.onload=()=>{e(r.result)},r.readAsArrayBuffer(o)})})(t.blob)});if(!i.length)throw"";g.addValue("Done!\n"+A.Lang["即将开始烧录"]+"...\n"),y.burning=!0,y.uploading=!1,g.addValue(A.Lang["烧录中"]+"...\n"),g.show(1),u.tabChange("output");const o=layer.open({type:1,title:A.Lang["烧录中"]+"...",content:$("#mixly-loader-div"),shade:r.SHADE_NAV,resize:!1,closeBtn:0,success:async function(e,t){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").hide();try{if(m.refreshOutputBuffer=!1,m.refreshInputBuffer=!0,await b.reset(),await x()){s.erase&&(g.addValue(A.Lang["正在擦除闪存，请稍等"]+"...\n"),r=Date.now(),await f.eraseFlash(),g.addValue(A.Lang["擦除完成，擦除耗时"]+(Date.now()-r)+"ms\n"),await C(100));for(var o of i)await v(o.offset,o.binBuf)}layer.close(t),layer.msg(A.Lang["烧录成功"],{time:1e3}),g.addValue(`==${A.Lang["烧录成功"]}==
`),h.reset(c,"burn")}catch(e){console.log(e),layer.close(t),g.addValue(`==${A.Lang["烧录失败"]}==
`)}finally{m.refreshOutputBuffer=!0,m.refreshInputBuffer=!1,l.baudRates!==n&&(l.baudRates=n,await a.setBaudRate(n))}var r},end:function(){$("#mixly-loader-btn").css("display","inline-block"),$("#mixly-loader-div").css("display","none"),$("#layui-layer-shade"+o).remove()}})}).catch(async e=>{g.addValue("Failed!\n"+A.Lang["无法获取文件，请检查网络"]+"！\n"),g.addValue("\n"+e+"\n",!0)})}}else layer.msg(A.Lang["已取消连接"],{time:1e3})})},y.getImportModulesName=e=>{var r,{web:t={}}=d,t=t["lib"];if(!(t instanceof Object))return[];let o=[],i=(e.trim().split("\n").forEach(function(e,t){o.push(e)}),""),l=[];for(r of o){let t=r.indexOf("from"),o=r.indexOf("import");if(r.substring(0,-1===t?o:t).split("").forEach(e=>{" "!==e&&"\t"!==e&&(t=-1,o=-1)}),-1!==t)i=r.substring(t+4,r.indexOf("import"));else{if(-1===o)continue;i=r.substring(o+6)}i=(i=i.replaceAll(" ","")).replaceAll("\r",""),l=[...l,...i.split(",")]}return l},y.searchLibs=(e,t=[])=>{var o,{web:r={}}=d,i=r["lib"];if(!(i instanceof Object))return[];for(o of e)t.includes(o)||i[o]&&(t.push(o),g.addValue(A.Lang["拷贝库"]+" "+o+".py\n"),i[o].import.length)&&(t=y.searchLibs(i[o].import,t));return t},y.initUpload=()=>{let e="web-"+(d.web.com??"serial");navigator.serial&&navigator.usb||(e="web-bluetooth"),y.uploadWithAmpy(e)},y.uploadWithAmpy=e=>{h.connect(e,115200,async i=>{if(i){const l=h.portsOperator[i],{serialport:a,toolConfig:n}=l,s=n.baudRates,e=(115200!==s&&(n.baudRates=115200,await a.setBaudRate(n.baudRates)),y.burning=!1,y.uploading=!0,g.setValue(A.Lang["上传中"]+"...\n"),g.show(1),u.tabChange("output"),layer.open({type:1,title:A.Lang["上传中"]+"...",content:$("#mixly-loader-div"),shade:r.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$("#mixly-loader-btn").hide(),$(".layui-layer-page").css("z-index","198910151");const o=new c(a,"web-serial"===i),r=p.getCode();l.busy=!0,h.reset(i,"upload").then(()=>o.put("main.py",r)).then(()=>{layer.close(t),layer.msg(A.Lang["上传成功"],{time:1e3}),g.addValue(`==${A.Lang["上传成功"]}==
`),u.tabChange(i),u.scrollToTheBottom(i)}).catch(e=>{console.log(e),layer.close(t),g.addValue(`[Error] ${e}
`),g.addValue(`==${A.Lang["上传失败"]}==
`)}).finally(async()=>{l.busy=!1,y.burning=!1,y.uploading=!1,n.baudRates!==s&&(n.baudRates=s,await a.setBaudRate(s))})},end:function(){$("#mixly-loader-btn").css("display","inline-block"),$("#mixly-loader-div").css("display","none"),$("#layui-layer-shade"+e).remove()}}))}else layer.msg(A.Lang["已取消连接"],{time:1e3})})},y.uploadWithEsptool=async(e,t,o)=>{var r="web-serial",{serialport:i,toolConfig:l}=h.portsOperator[r];let a=l.baudRates;115200!==a&&(l.baudRates=115200,await i.setBaudRate(l.baudRates));t=t.data;if(e||"object"!=typeof t)g.addValue(A.Lang["固件获取失败"]+"！\n"),layer.close(o);else{layer.title(A.Lang["上传中"]+"...",o),g.addValue(A.Lang["固件读取中"]+"... ");var n,s,c=[];for(n of t)n.offset&&n.data&&(s={offset:n.offset,binBuf:(s=n.data,new Uint8Array(s.match(/[\da-f]{2}/gi).map(function(e){return parseInt(e,16)})).buffer)},c.push(s));g.addValue("Done!\n"+A.Lang["即将开始烧录"]+"...\n"),y.burning=!0,y.uploading=!1,g.addValue(A.Lang["上传中"]+"...\n"),g.show(1),u.tabChange("output");try{if(m.refreshOutputBuffer=!1,m.refreshInputBuffer=!0,await b.reset(),await x())for(var d of c)await v(d.offset,d.binBuf);layer.close(o),layer.msg(A.Lang["上传成功"],{time:1e3}),g.addValue(`==${A.Lang["上传成功"]}==
`),h.reset(r,"upload"),u.tabChange(r)}catch(e){console.log(e),layer.close(o),g.addValue(`==${A.Lang["上传失败"]}==
`)}finally{m.refreshOutputBuffer=!0,m.refreshInputBuffer=!1;e=p.getCode().match(/(?<=Serial.begin[\s]*\([\s]*)[0-9]*(?=[\s]*\))/g);e&&h.BAUDRATES.includes(+e[0])&&(a=+e[0]),l.baudRates!==a&&(l.baudRates=a,await i.setBaudRate(a))}}},y.uploadWithAvrUploader=async(e,o,r)=>{o=o.data;if(e||"object"!=typeof o)g.addValue(A.Lang["固件获取失败"]+"！\n"),layer.close(r);else{g.addValue(A.Lang["上传中"]+"...\n"),layer.title(A.Lang["上传中"]+"...",r);let t=!0;AvrUploader.upload(o[0].data,e=>{100<=e&&t&&(g.addValue(`==${A.Lang["上传成功"]}==
`),layer.msg(A.Lang["上传成功"],{time:1e3}),layer.close(r),t=!1)},!0).catch(e=>{layer.close(r),g.addValue(`==${A.Lang["上传失败"]}==
`)})}}}),goog.loadJs("web",()=>{goog.require("Mixly.Config"),goog.require("Mixly.Env"),goog.require("Mixly.MJSON"),goog.require("Mixly.Example"),goog.require("Mixly.Boards"),goog.provide("Mixly.Web.ExampleExt");const{Config:o,Env:e,Example:t,MJSON:r,Boards:i}=Mixly,l=o["BOARD"];class n extends t{constructor(e,t){super(e,t),this.render()}getExampleList(){var e=n["DIR_TREE"];let t=[];return t=e instanceof Object&&e[l.boardType]?[{title:l.boardType,id:l.boardType,children:[]}]:t}getExamples(e){var t,o=n["DIR_TREE"];let r=o;for(t of e.split("/")){if(!r[t])return[];r=r[t]}if(!(r instanceof Object))return[];var i,l=[];for(i in r){var a={title:i,id:e+"/"+i};r[i]instanceof Object&&(a.children=[]),l.push(a)}return l}dataToWorkspace(e){var t=goog.get(o.pathPrefix+"../sample/"+e);this.updateCode(e.substring(e.lastIndexOf(".")),t)}}Object.defineProperty(Mixly.Web,"ExampleExt",{value:n,writable:!0,enumerable:!0,configurable:!0}),e.isElectron||(n.DIR_TREE=r.get(`../../../sample/${i.getType()}.json`)??[])}),goog.loadJs("web",()=>{goog.require("Mixly.Url"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Config"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Url"),goog.require("Mixly.Boards"),goog.require("Mixly.MFile"),goog.require("Mixly.Msg"),goog.require("Mixly.Web.BU"),goog.require("Mixly.Web.Serial"),goog.provide("Mixly.WebCompiler.Compiler");const{WebCompiler:e,Url:l,Boards:a,MFile:n,StatusBar:s,StatusBarPort:r,Config:t,LayerExt:c,Msg:d,Web:o}=Mixly,{SOFTWARE:i,BOARD:g}=t,u=e["Compiler"],{BU:p,Serial:A}=o;u.CONFIG={enabled:!0,protocol:"http:",ip:"localhost",domain:null,...i?.webCompiler??{}};var{}=u;let{hostname:h,protocol:y,port:m}=window.location;m=m&&":"+m,u.protocol=y,u.URL=u.protocol+"//"+h+m+"/compile",u.compile=()=>{s.show(1),s.setValue(""),u.generateCommand("compile",(e,t,o)=>{layer.close(o);let r=d.Lang["编译成功"];e&&(r=d.Lang["编译失败"]),layer.msg(r,{time:1e3}),s.addValue("=="+r+"("+d.Lang["用时"]+" "+t.timeCost+")==\n")})},u.upload=async()=>{s.show(1),s.setValue(""),p.burning=!1,p.uploading=!0;var t=a.getSelectedBoardCommandParam().split(":"),o="web-serial";if("avr"===t[1]){let e;switch(t[2]){case"uno":e="uno";break;case"nano":e=3<t.length&&"cpu=atmega328old"===t[3]?"nanoOldBootloader":"nano";break;case"pro":e="proMini"}A.portClose(o,async()=>{r.tabChange("output");try{await AvrUploader.connect(e,{}),u.generateCommand("upload",p.uploadWithAvrUploader)}catch(e){s.addValue(e.toString()+"\n")}})}else A.connect(o,115200,async e=>{e?(r.tabChange("output"),u.generateCommand("upload",p.uploadWithEsptool)):layer.msg(d.Lang["已取消连接"],{time:1e3})})},u.generateCommand=(e,t=(e,t,o)=>{})=>{var o=n.getCode(),r=a.getSelectedBoardCommandParam(),r={board:encodeURIComponent(r),code:encodeURIComponent(o),visitorId:g.visitorId.str32CRC32b,operate:e},o=u.URL+"?"+l.jsonToUrl(r);s.setValue(d.Lang["编译中"]+"...\n"),console.log("send -> ",o);const i=layer.open({type:1,title:d.Lang["编译中"]+"...",content:$("#mixly-loader-div"),shade:c.SHADE_NAV,closeBtn:0,success:function(){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{layer.close(i),layer.msg("已取消编译",{time:1e3})})},end:function(){$("#mixly-loader-div").css("display","none"),$(".layui-layer-shade").remove()}});u.sendCommand(i,o,t)},u.sendCommand=(t,e,o=(e,t,o)=>{})=>{e=new Request(e);fetch(e,{credentials:"omit",mode:"cors"}).then(e=>e.text()).then(e=>{e=JSON.parse(e);console.log(e),e.error?(s.addValue(decodeURIComponent(e.error)),o(!0,null,t)):(s.addValue(decodeURIComponent(e.compileMessage)),o(!1,{data:e.data,timeCost:decodeURIComponent(e.timeCost)},t))}).catch(e=>{o(!0,e.toString(),t)})}}),goog.loadJs("web",()=>{goog.require("layui"),goog.require("Blockly"),goog.require("Mixly.XML"),goog.require("Mixly.Editor"),goog.require("Mixly.MFile"),goog.require("Mixly.Boards"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Msg"),goog.require("Mixly.WebSocket.Socket"),goog.provide("Mixly.WebSocket.File");const{XML:o,Editor:r,MFile:i,Boards:e,LayerExt:t,Msg:l}=Mixly,{Socket:a,File:n}=Mixly.WebSocket,s=e.getType(),c=layui["form"];n.saveToCloud=()=>{a.connect(e=>{layer.closeAll()},()=>{layer.prompt({title:MSG.save_ser,shade:t.SHADE_ALL,value:"main.mix",success:function(e,t){$(e).find("input").attr("spellcheck",!1)}},function(t,o,e){layer.close(o);o=t.substring(t.lastIndexOf(".")).toLowerCase();let r=[];if(i.saveFilters.map(e=>{r=[...r,...e.extensions]}),r.includes(o.substring(1))){let e;switch(o){case".mix":e=i.getMix();break;case".ino":case".py":e=i.getCode();default:layer.msg(l.Lang["文件后缀错误"],{time:1e3})}e&&a.sendCommand({obj:"File",func:"saveAs",args:[s,t,e]})}else layer.msg(l.Lang["文件后缀错误"],{time:1e3})})})},n.saveSuccess=e=>{layer.msg(e+" "+l.Lang["保存成功"],{time:1e3})},n.saveError=(e,t)=>{layer.msg(e+" 保存失败",{time:1e3})},n.openFromCloud=()=>{a.sendCommand({obj:"File",func:"getUserFilesInfo",args:[s]})},n.showOpenDialog=e=>{const t=$("#mixly-selector-type");t.empty(),e.map(e=>{t.append($(`<option value="${e.path}">${e.name}</option>`))}),c.render();let o=!1;const r=layer.open({type:1,id:"serial-select",title:"请选择需要打开的文件：",area:["350px","150px"],content:$("#mixly-selector-div"),shade:Mixly.LayerExt.SHADE_ALL,resize:!1,closeBtn:0,success:function(e){$("#serial-select").css("height","180px"),$("#serial-select").css("overflow","inherit"),$(".layui-layer-page").css("z-index","198910151"),$("#mixly-selector-btn1").off("click").click(()=>{layer.close(r)}),$("#mixly-selector-btn2").click(()=>{layer.close(r),o=!0})},end:function(){var e;$("#mixly-selector-btn1").off("click"),$("#mixly-selector-btn2").off("click"),$("#mixly-selector-div").css("display","none"),$(".layui-layer-shade").remove(),o&&(e=$("#mixly-selector-type option:selected").val(),a.sendCommand({obj:"File",func:"open",args:[s,e]}))}})},n.open=(e,t)=>{switch(e){case".mix":case".xml":r.items.vDrag.full("POSITIVE");try{t=(t=o.convert(t,!0)).replace(/\\(u[0-9a-fA-F]{4})/g,function(e){return unescape(e.replace(/\\(u[0-9a-fA-F]{4})/g,"%$1"))})}catch(e){console.log(e)}i.parseMix($(t),!1,!1,e=>{r.blockEditor.scrollCenter(),Blockly.hideChaff()});break;case".ino":case".py":r.items.vDrag.full("NEGATIVE"),r.codeEditor.setValue(t,-1)}},n.openSuccess=e=>{layer.msg(e+" 打开成功",{time:1e3})},n.openError=(e,t)=>{layer.msg(e+" 打开失败",{time:1e3})}}),goog.loadJs("web",()=>{goog.require("Mixly.Modules"),goog.require("Mixly.Charts"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Config"),goog.require("Mixly.Tools"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.XML"),goog.require("Mixly.MArray"),goog.require("Mixly.Msg"),goog.require("Mixly.WebSocket.Socket"),goog.provide("Mixly.WebSocket.Serial");const{Charts:a,StatusBar:n,StatusBarPort:s,Config:e,Tools:l,LayerExt:c,XML:d,MArray:t,Msg:g}=Mixly,{Socket:u,Serial:p}=Mixly.WebSocket,{BOARD:o,SELECTED_BOARD:A}=e,h=s["portAce"];p.TOOL_DEFAULT_CONFIG={ctrlCBtn:!1,ctrlDBtn:!1,baudRates:115200,yMax:100,yMin:0,pointNum:100,rts:!1,dtr:!1,scroll:!0,sendStr:!0,receiveStr:!0,sendWith:"\\r\\n",tabIndex:0,...o?.serial??{}},p.DEFAULT_BAUD=[9600,19200,28800,38400,57600,115200],p.DEFAULT_SEND_WITH=["\\r\\n","\\r","\\n","no"],p.PORT_SELECT={BURN:o?.burn?.portSelect??"all",UPLOAD:o?.upload?.portSelect??"all"},p.UPLOAD_RESET=o?.upload?.reset??{},p.HAS_PORT={BURN:o?.nav?.burn??!1,UPLOAD:o?.nav?.upload??!1},p.MAX_OUTPUT_LINE=500,p.REFRESH_OUTPUT_TIME=100,p.BAUDRATES=[9600,19200,28800,38400,57600,115200],p.TERMINAL_COMMAND={config:{"-d|--dtr":{help:"设置DTR, 可选值: [0, 1], 例如: config -d 1",key:"DTR"},"-r|--rts":{help:"设置RTS, 可选值: [0, 1], 例如: config -r 1",key:"RTS"},"-b|--baud":{help:"设置波特率, 可选值: ["+p.DEFAULT_BAUD.join(", ")+"], 例如: config -b "+p.DEFAULT_BAUD[0],key:"BAUD"},"-t|--rtype":{help:"设置串口接收数据的类型, 可选值: [0, 1], 例如: config -t 1",key:"RTYPE"},"-w|--swith":{help:"设置发送数据时的结尾字符串, 可选值: ["+p.DEFAULT_SEND_WITH.join(", ")+"], 例如: config -w "+p.DEFAULT_SEND_WITH[0],key:"SWITH"},"-s|--scroll":{help:"设置接收框滑动条是否一直在最下方, 可选值: [0, 1], 例如: config -s 1",key:"SCROLL"},"-h|--help":{help:"输出帮助信息, 例如: config -h",key:"HELP"},callback:"terminalConfigCallback"},port:{"-o|--open":{help:"打开当前串口, 例如: port -o",key:"OPEN"},"-c|--close":{help:"关闭当前串口, 例如: port -c",key:"CLOSE"},"-h|--help":{help:"输出帮助信息, 例如: port -h",key:"HELP"},callback:"terminalPortCallback"},send:{"-s|--str":{help:"发送字符串, 可选值: 字符串, 例如: send -s 你好Mixly",key:"STR"},"-b|--bytes":{help:"发送字节数组, 可选值: 字符串, 例如: send -b 0x01,0x02,0x03",key:"BYTES"},"-w|--with":{help:"发送数据时的结尾字符串, 可选值: ["+p.DEFAULT_SEND_WITH.join(", ")+"], 例如: send -s 你好Mixly -w \\r\\n",key:"WITH"},"-h|--help":{help:"输出帮助信息, 例如: send -h",key:"HELP"},callback:"terminalSendCallback"},exit:{callback:"terminalExitCallback"}},p.portsOperator={},p.deadPortsOperator={},p.selectedUploadPort={},p.selectedBurnPort={},p.ports=[],p.burnPorts=[],p.uploadPorts=[],p.initPorts=(t,e=e=>{})=>{var o=[];for(let e=0;e<t.length;e++){var r=t[e];o.push({vendorId:r.vendorId,productId:r.productId,name:r.path})}e(o)},p.getPorts=(t,o)=>{if("object"!=typeof t)return[];var r=[];if("string"==typeof o&&"all"===o)for(let e=0;e<t.length;e++){var i=t[e];i.vendorId||(i.vendorId="None"),i.productId||(i.productId="None"),r.push(i)}else if("object"==typeof o)for(let e=0;e<t.length;e++){var l=t[e];for(let e=0;e<o.length;e++)if(o[e].vendorId&&o[e].productId&&l.vendorId&&l.productId&&o[e].vendorId.toLowerCase()===l.vendorId.toLowerCase()&&o[e].productId.toLowerCase()===l.productId.toLowerCase()){r.push(l);break}}return r},p.getBurnPorts=()=>p.getPorts(p.ports,p.PORT_SELECT.BURN),p.getUploadPorts=()=>p.getPorts(p.ports,p.PORT_SELECT.UPLOAD),p.refreshPorts=e=>{t.equals(e,p.ports)||(p.ports=e,p.HAS_PORT.BURN?p.burnPorts=p.getBurnPorts():p.burnPorts=[],p.HAS_PORT.UPLOAD?p.uploadPorts=p.getUploadPorts():p.uploadPorts=[],e=[...p.burnPorts,...p.uploadPorts],e=t.unique(e),p.refreshPortOperator(e),p.refreshUploadPortSelectBox(e))},p.refreshUploadPortSelectBox=e=>{var t=layui["form"];const o=$("#ports-type"),r=o.val();o.empty(),e.map(e=>{e=e.name;r==e?o.append($(`<option value="${e}" selected>${e}</option>`)):o.append($(`<option value="${e}">${e}</option>`))}),t.render("select","ports-type-filter"),e.length?($("#mixly-footer-port-div").css("display","inline-flex"),$("#mixly-footer-port").html(p.getSelectedPortName())):($("#mixly-footer-port-div").hide(),$("#mixly-footer-port").html(""))},p.refreshToolPortSelectBox=e=>{var t,o=layui["form"];p.getOpenedPortsName();for(t in p.portsOperator){var r,i=p.portsOperator[t]["dom"];i&&(r=i.id["selectPortId"],i=i.filter["formFilter"],(r=$("#"+r)).empty(),r.append($(`<option value="${t}" selected>${t}</option>`)),o.render("select",i))}},p.refreshPortOperator=t=>{var e,o,r,i,l,a,n={...p.portsOperator},s=(p.portsOperator={},[]);for(let e=0;e<t.length;e++){var c,d=t[e];s.push(d.name),n[d.name]?p.portsOperator[d.name]=n[d.name]:p.deadPortsOperator[d.name]?(p.portsOperator[d.name]={...p.deadPortsOperator[d.name]},delete p.deadPortsOperator[d.name],p.refreshToolPortSelectBox(d.name)):(c={toolConfig:{...p.TOOL_DEFAULT_CONFIG},toolOpened:!1,portOpened:!1,vendorId:d.vendorId,productId:d.productId,dom:null,serialport:null,output:[]},p.portsOperator[d.name]=c),p.refreshTerminalMenu(d.name)}for(e in n)s.includes(e)||(r=(o=n[e])["dom"],r&&(o.toolOpened?(i=layui["form"],l=r.id["selectPortId"],a=r.filter["formFilter"],$("#"+l).empty(),i.render("select",a),p.deadPortsOperator[e]={...o}):r.destroy()),p.refreshTerminalMenu(e))},p.getOpenedPortsName=()=>{var e,t=[];for(e in p.portsOperator)p.portsOperator[e].portOpened&&t.push(e);return t},p.getSelectedPortName=()=>{return $("#ports-type").val()},p.refreshOutputBox=t=>{var o=p.portsOperator[t];if(o){var{toolConfig:r,toolOpened:i,output:l,endPos:a}=o;for(let e=l.length;e>p.MAX_OUTPUT_LINE;e--)l.shift();let e=l.join("\n");if(i)p.receiveBoxSetValue(t,e,r.scroll);else{if(e=e.replaceAll("\r\n","\n"),a&&"object"==typeof a){i=s.getValueRange(t,{row:0,column:0},a);if(e===i)return}s.setValue(t,e,r.scroll),o.endPos=s.getEndPos(t),h[t]&&h[t].setReadOnly(!1)}}},p.openTool=()=>{var e=p.getSelectedPortName();if(e){let r=p.portsOperator[e];e=r["toolConfig"];const l=e["baudRates"];var t=e=>{r.dom||(r.dom=e),p.refreshToolPortSelectBox(p.uploadPorts);var t=e.id["selectPortId"],t=(r.toolOpened=!0,n.show(1),e.nowPort=$("#"+t+" option:selected").val(),e.prevPort=null,layui.element),o=e.filter["tabFilter"];t.tabChange(o,r.toolConfig.tabIndex),p.refreshConnectStatus(e.nowPort),p.connect(e.nowPort,l??9600)},o=e=>{try{a.chart&&a.chart.destroy(),a.chart=null}catch(e){console.log(e)}a.draw&&clearInterval(a.draw),a.addData&&clearInterval(a.addData);var t=p.portsOperator[e],o=p.deadPortsOperator[e];t?t.toolOpened=!1:o&&(o.dom.destroy(),delete p.deadPortsOperator[e]),p.refreshTerminalMenu(e)};let i=r.dom;r.dom?(i.updateTool(e),i.open(t,o)):i=c.openSerialTool(e,t,o),i.onClickSetDtr((e,t)=>{p.portsOperator[e].toolConfig.dtr=t.elem.checked,p.updateDtrAndRts(e)}),i.onClickSetRts((e,t)=>{p.portsOperator[e].toolConfig.rts=t.elem.checked,p.updateDtrAndRts(e)}),i.onClickSendType((e,t)=>{var o=i.id["sendId"],o=$("#"+o);p.portsOperator[e].toolConfig.sendStr=t.elem.checked,t.elem.checked?o.attr("placeholder",g.Lang["请输入内容"]):o.attr("placeholder",g.Lang["请输入内容"]+"  "+g.Lang["例如"]+":0x03,0x04")}),i.onClickSelectPort((e,t,o)=>{const r=p.portsOperator[t];e=p.portsOperator[e],r.toolConfig={...e.toolConfig},r.dom=e.dom,e.dom=null,e.toolOpened=!1,r.toolOpened=!0,e=e.serialport;e&&e.isOpen&&e.close(()=>{p.connect(t,r.toolConfig.baudRates)})}),i.onClickSelectBaud((e,t)=>{p.portsOperator[e].toolConfig.baudRates=t.elem.value,p.setBaudRate(e,t.elem.value)}),i.onClickTab((e,t)=>{p.portsOperator[e].toolConfig.tabIndex=t.index,1===t.index?(e=(t=p.portsOperator[e])["dom"],a.init(t.portOpened,e)):Mixly.Charts.destroy()}),i.onClickConnectBtn(e=>{p.portOpenOrClose(e)}),i.onClickSendBtn(e=>{p.write(e,0)}),i.onClickClearBtn(e=>{p.clearContent(e)}),i.onClickChartSendBtn(e=>{p.write(e,1)}),i.onClickCtrlCBtn(e=>{p.writeCtrlC(e)}),i.onClickCtrlDBtn(e=>{p.writeCtrlD(e)}),i.onClickScroll((e,t)=>{p.portsOperator[e].toolConfig.scroll=t.elem.checked}),i.onClickReceiveType((e,t)=>{p.portsOperator[e].toolConfig.receiveStr=t.elem.checked}),i.onClickSelectPointNum((e,t)=>{p.portsOperator[e].toolConfig.pointNum=t.elem.value}),i.onClickSelectSendWith((e,t)=>{p.portsOperator[e].toolConfig.sendWith=t.elem.value})}else layer.msg(g.Lang["无可用设备"]+"!",{time:1e3})},p.refreshConnectStatus=e=>{var t=p.portsOperator[e],e=p.deadPortsOperator[e];(t||e)&&({dom:t,portOpened:e}=t??e,t)&&(t=t.id["connectBtnId"],t=$("#"+t),e?(t.text(g.Lang["关闭"]),t.attr("class","layui-btn layui-btn-danger")):(t.text(g.Lang["打开"]),t.attr("class","layui-btn layui-btn-normal")))},p.receiveBoxAddValue=(e,t,o=!1)=>{t=p.receiveBoxGetValue(e)+t;p.receiveBoxSetValue(e,t,o)},p.receiveBoxSetValue=(e,t,o=!1)=>{var e=p.portsOperator[e];e&&(e=e["dom"],e)&&(e=e.id["receiveId"],(e=$("#"+e)).val(t),o)&&e.scrollTop(e[0].scrollHeight)},p.receiveBoxGetValue=e=>{var e=p.portsOperator[e];return e&&(e=e.dom,e)?(e=e.id["receiveId"],$("#"+e).val()):""},p.receiveBoxScrollToTheBottom=()=>{var e=p.portsOperator[port]["dom"];e&&(e=e.id["receiveId"],(e=$("#"+e)).scrollTop(e[0].scrollHeight))},p.receiveBoxScrollToTheTop=()=>{},p.statusBarPortAddHotKey=r=>{const i=h[r].getSession();h[r].commands.addCommands([{name:"Empty",bindKey:"Ctrl-E",exec:e=>{var t=p.portsOperator[r];t&&(t.output=[])}},{name:"Terminal",bindKey:"Ctrl-T",exec:e=>{p.statusBarPortEnterTerminal(r)}},{name:"ChangeEditor",bindKey:"Delete|Ctrl-X|Backspace",exec:e=>{var t,o=p.portsOperator[r];return!(!o||!o.portOpened)&&(o=o["endPos"],o&&"object"==typeof o?(t=i.selection.getCursor()).row<o.row||t.row===o.row&&t.column<=o.column:(h[r].setReadOnly(!0),!1))}},{name:"Enter",bindKey:"Enter",exec:e=>{var t,o=p.portsOperator[r];return o&&o.portOpened&&(o=o["endPos"],o)&&"object"==typeof o&&i.selection.getCursor().row===o.row&&(t=s.getEndPos(r),o=s.getValueRange(r,o,t),p.writeString(r,o,"\r\n")),!1}}]),i.selection.on("changeCursor",function(){var e,t=p.portsOperator[r];t&&t.portOpened&&(t=t.endPos,t)&&"object"==typeof t&&((e=i.selection.getCursor()).row<t.row||e.row===t.row&&e.column<t.column)?h[r].setReadOnly(!0):h[r].setReadOnly(!1)}),p.portsOperator[r]&&p.refreshTerminalMenu(r)},p.statusBarPortEnterTerminal=e=>{var t=p.portsOperator[e];t&&!t.toolOpened&&(p.statusBarPortRemoveCursorEvent(e),t.refreshOutputBoxTimer&&clearInterval(t.refreshOutputBoxTimer),t.refreshOutputBoxTimer=null,setTimeout(()=>{p.statusBarPortAddCursorEvent(e)},p.REFRESH_OUTPUT_TIME+100))},p.refreshTerminalMenu=r=>{const i=p.portsOperator[r];let l=r;try{l=(l=l.replaceAll("/","-")).replaceAll(".","-")}catch(e){console.log(e)}var e,t='<div style="float:left;">{{d.name}}&nbsp</div><div style="float:right;">{{d.hotKey}}</div>',o={elem:`#tab-${l}-ace`,trigger:"contextmenu",isAllowSpread:!0,id:`tab-${l}-ace-terminal`,className:"editor-dropdown-menu",click:function(e,t){var o;e.id===`tab-${l}-ace-terminal-exit`?p.statusBarPortAddCommand(r,"exit"):e.id===`tab-${l}-ace-terminal-open`?p.statusBarPortEnterTerminal(r):e.id===`tab-${l}-ace-terminal-close`?s.tabDelete(r):e.id===`tab-${l}-ace-terminal-help`?p.statusBarPortAddCommand(r,"config port send -h"):e.id===`tab-${l}-ace-fontsize-decrease`?(o=parseInt(h[r].getFontSize(),10)||12,h[r].setFontSize(Math.max(o-1||1))):e.id===`tab-${l}-ace-fontsize-increase`?(o=parseInt(h[r].getFontSize(),10)||12,h[r].setFontSize(o+1)):e.id===`tab-${l}-ace-fontsize-default`?h[r].setFontSize(12):e.id===`tab-${l}-ace-terminal-port-close`?p.statusBarPortAddCommand(r,"port -c"):e.id===`tab-${l}-ace-terminal-port-open`?p.statusBarPortAddCommand(r,"port -o"):e.id===`tab-${l}-ace-terminal-send-ctrlc`?p.statusBarPortAddCommand(r,"send -b 0x03,0x0d,0x0a -w no"):e.id===`tab-${l}-ace-terminal-send-ctrld`?p.statusBarPortAddCommand(r,"send -b 0x03,0x04 -w no"):e.id===`tab-${l}-ace-terminal-send-str`?p.statusBarPortAddCommand(r,"send -w \\r\\n -s ",!1):e.id===`tab-${l}-tool-close`?i.dom.close():e.id===`tab-${l}-ace-close`?s.tabDelete(r):e.id===`tab-${l}-ace-empty`?i.output=[]:e.id===`tab-${l}-serial-send-ctrlc`?p.writeCtrlC(r):e.id===`tab-${l}-serial-send-ctrld`&&p.writeCtrlD(r)}};i?i&&i.toolOpened?o.data=[{title:g.Lang["关闭串口工具"],id:`tab-${l}-tool-close`}]:(e=i["toolConfig"],e={portOpend:{terminalOpend:[{title:d.render(t,{name:g.Lang["关闭串口"],hotKey:"port -c"}),id:`tab-${l}-ace-terminal-port-close`},e.ctrlCBtn?{title:d.render(t,{name:g.Lang["中断"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrlc`}:{},e.ctrlDBtn?{title:d.render(t,{name:g.Lang["复位"],hotKey:""}),id:`tab-${l}-ace-terminal-send-ctrld`}:{},{title:d.render(t,{name:g.Lang["发送字符串"],hotKey:""}),id:`tab-${l}-ace-terminal-send-str`},{title:d.render(t,{name:g.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`},{type:"-"},{title:d.render(t,{name:g.Lang["退出串口终端"],hotKey:"exit"}),id:`tab-${l}-ace-terminal-exit`}],terminalClosed:[{title:d.render(t,{name:g.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:d.render(t,{name:g.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:d.render(t,{name:g.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:d.render(t,{name:g.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`},{type:"-"},e.ctrlCBtn?{title:d.render(t,{name:g.Lang["中断"],hotKey:""}),id:`tab-${l}-serial-send-ctrlc`}:{},e.ctrlDBtn?{title:d.render(t,{name:g.Lang["复位"],hotKey:""}),id:`tab-${l}-serial-send-ctrld`}:{},{title:d.render(t,{name:g.Lang["打开串口终端"],hotKey:"Ctrl+T"}),id:`tab-${l}-ace-terminal-open`}]},portClosed:{terminalOpend:[{title:d.render(t,{name:g.Lang["打开串口"],hotKey:"port -o"}),id:`tab-${l}-ace-terminal-port-open`},{title:d.render(t,{name:g.Lang["帮助"],hotKey:""}),id:`tab-${l}-ace-terminal-help`},{type:"-"},{title:d.render(t,{name:g.Lang["退出串口终端"],hotKey:"exit"}),id:`tab-${l}-ace-terminal-exit`}],terminalClosed:[{title:d.render(t,{name:g.Lang["清空"],hotKey:"Ctrl+E"}),id:`tab-${l}-ace-empty`},{type:"-"},{title:d.render(t,{name:g.Lang["增大字号"],hotKey:"Ctrl+="}),id:`tab-${l}-ace-fontsize-increase`},{title:d.render(t,{name:g.Lang["减小字号"],hotKey:"Ctrl+-"}),id:`tab-${l}-ace-fontsize-decrease`},{title:d.render(t,{name:g.Lang["默认字号"],hotKey:"Ctrl+0"}),id:`tab-${l}-ace-fontsize-default`},{type:"-"},{title:d.render(t,{name:g.Lang["打开串口终端"],hotKey:"Ctrl+T"}),id:`tab-${l}-ace-terminal-open`}]}},o.data=e[i.portOpened?"portOpend":"portClosed"][i.terminalOpend?"terminalOpend":"terminalClosed"]):o.data=[{title:g.Lang["关闭串口输出框"],id:`tab-${l}-ace-close`}],layui.dropdown.render(o)},p.statusBarPortAddCursorEvent=o=>{const r=p.portsOperator[o];""===r.output[r.output.length-1]?p.outputBoxAdd(o,">>>",!1):p.outputBoxAdd(o,">>>",!0),p.refreshOutputBox(o),r.terminalOpend=!0,p.refreshTerminalMenu(o);var e=h[o];const i=e["selection"],l=e.getSession(),a=l.getLength(),n=(e.gotoLine(a),i.moveCursorLineEnd(),i.getCursor());r.cursorCallback=l.selection.on("changeCursor",function(e){if(r.terminalOpend){var t=i.getCursor();(t.row<n.row||t.row===n.row&&t.column<=n.column)&&i.moveCursorTo(n.row,n.column,!0);let e=l.getLine(t.row-1);-1!==e.indexOf(">>>")&&t.row===n.row+1&&0===t.column?(e=e.replace(">>>",""),p.outputBoxAdd(o,e),p.handleCommand(o,e),p.statusBarPortRemoveCursorEvent(o)):l.getLength()!==a&&p.statusBarPortRemoveCursorEvent(o)}})},p.statusBarPortRemoveCursorEvent=e=>{var t=h[e],o=p.portsOperator[e];o&&t&&(t=t.getSession(),o.cursorCallback)&&(t.selection.removeEventListener("changeCursor",o.cursorCallback),p.refreshOutputBox(e),o.terminalOpend=!1,p.refreshTerminalMenu(e),o.portOpened)&&!o.refreshOutputBoxTimer&&(o.refreshOutputBoxTimer=setInterval(()=>{p.refreshOutputBox(e)},p.REFRESH_OUTPUT_TIME))},p.outputBoxAdd=(e,t,o=!1)=>{e=p.portsOperator[e];o&&e.output.push(""),e.output[e.output.length-1]+=t},p.handleCommand=(e,t)=>{p.portsOperator[e];var t=t.split(" "),o=minimist(t);if(1<=o._.length)for(var r of o._){var i;Object.keys(p.TERMINAL_COMMAND).includes(r)?(i=p.TERMINAL_COMMAND[r].callback,p[i]&&p[i](e,o)):(p.outputBoxAdd(e,r+"为无效指令",!0),p.outputBoxAdd(e,"",!0))}else p.outputBoxAdd(e,"无可用指令",!0),p.outputBoxAdd(e,"",!0)},p.parseOptions=(e,t)=>{var o,r=[],i=[],l=[];for(o in t){var a=o.split("|"),n=t[o]?.key;if(2===a.length&&n&&(-1!==a[0].indexOf("-")&&-1!==a[1].indexOf("-"))){l.push(n);for(var s of a)(2===s.length?r:i).push(s)}}var c,d=[r,i,l],g={};for(c in e)option=e[c],d[0].includes("-"+c)?(g[d[2][d[0].indexOf("-"+c)]]=option,d[1][c]=null):d[1].includes("--"+c)&&(g[d[2][d[1].indexOf("--"+c)]]=option);return g},p.terminalAddHelpInfo=(e,t,o)=>{var r,i;this.getSpace=e=>{return new Array(e).fill(" ").join("")},p.outputBoxAdd(e,t+"指令可用选项如下：",!0);let l=0;for(r of Object.keys(o))r.length>l&&(l=r.length);for(i in o)if("callback"!==i)try{p.outputBoxAdd(e,i+this.getSpace(l-i.length)+"    "+(o[i].help??""),!0)}catch(e){console.log(e)}p.outputBoxAdd(e,"",!0)},p.terminalConfigCallback=(e,t)=>{var o=p.portsOperator[e],r=o["toolConfig"];o&&(o=p.TERMINAL_COMMAND.config,(t=p.parseOptions(t,o)).HELP?p.terminalAddHelpInfo(e,"config",o):(p.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),p.outputBoxAdd(e,"",!0),r.dtr=t.DTR??r.dtr,r.rts=t.RTS??r.rts,r.scroll=t.SCROLL??r.scroll,r.baudRates=t.BAUD&&p.DEFAULT_BAUD.includes(t.BAUD)?t.BAUD:r.baudRates,r.receiveStr=t.RTYPE??r.receiveStr,r.sendWith=t.SWITH&&p.DEFAULT_SEND_WITH.includes(t.SWITH)?t.SWITH:r.sendWith,p.setDtrAndRts(e,r.dtr,r.rts),p.setBaudRate(e,r.baudRates)))},p.terminalPortCallback=(e,t)=>{var o,r=p.portsOperator[e],{}=r;r&&(o=p.TERMINAL_COMMAND.port,(t=p.parseOptions(t,o)).HELP?p.terminalAddHelpInfo(e,"port",o):(p.outputBoxAdd(e,"获取指令"+JSON.stringify(t),!0),p.outputBoxAdd(e,"",!0),t.OPEN?r.portOpened||p.connect(e,r.toolConfig.baudRates):t.CLOSE?r.portOpened&&p.portClose(e):(p.outputBoxAdd(e,"无效指令",!1),p.outputBoxAdd(e,"",!0))))},p.terminalSendCallback=(t,o)=>{var e=p.portsOperator[t];if(e){var r=e["toolConfig"],i=p.TERMINAL_COMMAND.send,o=p.parseOptions(o,i);if(o.HELP)p.terminalAddHelpInfo(t,"send",i);else if(p.outputBoxAdd(t,"获取指令"+JSON.stringify(o),!0),p.outputBoxAdd(t,"",!0),e.portOpened){let e=r.sendWith??"\\r\\n";o.WITH&&p.DEFAULT_SEND_WITH.includes(o.WITH)&&(e=o.WITH),o.STR?p.writeString(t,o.STR,e):o.BYTES?p.writeByteArr(t,o.BYTES,e):(p.outputBoxAdd(t,"无效指令",!1),p.outputBoxAdd(t,"",!0))}else p.outputBoxAdd(t,"串口已关闭，无法发送数据！",!1),p.outputBoxAdd(t,"",!0)}},p.terminalExitCallback=(e,t)=>{p.portsOperator[e]&&p.outputBoxAdd(e,"",!0)},p.statusBarPortAddCommand=(e,t,o=!0)=>{s.addValue(e,t+(o?"\n":""),!0),o&&p.refreshOutputBox(e)},p.connect=function(e=null,t=null){var o,r,i,l;e&&(l=p.portsOperator[e])&&(s.tabChange(e),l.portOpened||(l=l["toolConfig"],{baudRates:o=9600,dtr:r,rts:i}=l,t=t??o,p.DEFAULT_BAUD.includes(t)?l.baudRates=t:t=o,l=A.upload.reset??[],u.sendCommand({obj:"Serial",func:"open",args:[e,t,l,r,i]})))},p.onopen=o=>{var e=p.portsOperator[o];e&&(e.portOpened=!0,s.tabAdd(o,!0,p.statusBarPortAddHotKey,e=>{var t=p.portsOperator[e];t&&t.portOpened&&(p.portClose(o),s.tabChange("output"),n.getValue().lastIndexOf("\n")!=n.getValue().length-1?n.addValue("\n"+g.Lang["已关闭串口"]+e+"\n"):n.addValue(g.Lang["已关闭串口"]+e+"\n"))}),s.tabChange(o),p.refreshTerminalMenu(o),p.refreshConnectStatus(o),s.setValue(o,g.Lang["已打开串口"]+": "+o+"\n",!0),p.receiveBoxSetValue(o,g.Lang["已打开串口"]+": "+o+"\n",!0),e.output.push(""),p.outputBoxAdd(o,g.Lang["已打开串口"]+": "+o),e.output.push(""),e.refreshOutputBoxTimer=setInterval(()=>{p.refreshOutputBox(o)},p.REFRESH_OUTPUT_TIME),A.serial?.ctrlDBtn)&&p.writeCtrlD(o)},p.ondata=(e,t)=>{e=p.portsOperator[e];e&&(a.addData(t),e)&&"function"==typeof e.userOnData&&e.userOnData(t)},p.onbytes=(t,o)=>{o=+o;var r=p.portsOperator[t];if(r&&r.refreshOutputBoxTimer)if(r.receiveBuff=r.receiveBuff??[],r.chineseStr=r.chineseStr??"",r.buffLength=r.buffLength??0,r.toolConfig&&!r.toolConfig.receiveStr)if(10===o)p.outputBoxAdd(t,"0x0A",!1),p.outputBoxAdd(t,"",!0);else{let e=o.toString(16).toUpperCase();1===e.length&&(e="0"+e),p.outputBoxAdd(t,"0x"+e+" ",!1)}else if(0==(128&o))if(r.receiveBuff=[],""!==r.chineseStr)try{var e=String.fromCharCode(o).match(/[\w|\\]/g);e&&0<e.length?r.chineseStr+=String.fromCharCode(o):(p.outputBoxAdd(t,l.messageDecode(r.chineseStr)),p.outputBoxAdd(t,String.fromCharCode(o)),r.chineseStr="")}catch(e){console.log(e),p.outputBoxAdd(t,l.messageDecode(r.chineseStr)),p.outputBoxAdd(t,o),r.chineseStr=""}else 10===o?r.output.push(""):[92,95].includes(o)?r.chineseStr=String.fromCharCode(o):p.outputBoxAdd(t,String.fromCharCode(o));else if(128==(192&o))r.receiveBuff.push(o),r.receiveBuff.length>=r.buffLength&&(p.outputBoxAdd(t,Buffer.from(r.receiveBuff)),r.receiveBuff=[]);else{switch(224&o){case 252:r.buffLength=6;break;case 248:r.buffLength=5;break;case 240:r.buffLength=4;break;case 224:r.buffLength=3;break;default:r.buffLength=2}r.receiveBuff.push(o)}},p.onerror=(e,t)=>{var o=p.portsOperator[e];o&&(s.tabChange("output"),p.showErrorData(e,o.toolOpened,t))},p.onclose=e=>{var t,o=p.portsOperator[e];o&&(o.portOpened=!1,s.close(e),p.refreshConnectStatus(e),p.refreshTerminalMenu(e),o.refreshOutputBoxTimer&&clearInterval(o.refreshOutputBoxTimer),o.refreshOutputBoxTimer=null,a.stopRefresh(),(t=p.receiveBoxGetValue(e))&&t.lastIndexOf("\n")!=t.length-1?p.receiveBoxAddValue(e,"\n"+g.Lang["已关闭串口"]+": "+e+"\n",!0):p.receiveBoxAddValue(e,g.Lang["已关闭串口"]+": "+e+"\n",!0),s.getValue(e).lastIndexOf("\n")!=s.getValue(e).length-1?s.addValue(e,"\n"+g.Lang["已关闭串口"]+": "+e+"\n",!0):s.addValue(e,g.Lang["已关闭串口"]+": "+e+"\n",!0),o.output=[])},p.portOpenOrClose=function(e){var t,o=p.portsOperator[e];o&&(t=o["toolConfig"],o.portOpened?u.sendCommand({obj:"Serial",func:"close",args:[e]}):(p.connect(e,t.baudRates),n.show(1)))},p.portClose=(e,t=0)=>{var o=p.portsOperator[e];o&&o.portOpened&&u.sendCommand({obj:"Serial",func:"close",args:[e]})},p.showErrorData=function(e,t,o){var{toolOpened:r,toolConfig:i}=p.portsOperator[e];i.receiveStr||(o=(o=l.uint8ArrayToStr(l.strToByte(o))).replace(/^\s*/,""),o+="\n"),r?p.receiveBoxAddValue(e,o,i.scroll):s.addValue(e,o,!0)},p.writeByteArr=function(t,o,r){if(p.portsOperator[t].portOpened){let e="";e="string"!=typeof o?o.toString():o,"no"==(r=(r=r.replace("\\r","\r")).replace("\\n","\n"))&&(r=""),u.sendCommand({obj:"Serial",func:"sendByteArr",args:[t,e,r]})}},p.writeString=function(e,t,o){p.portsOperator[e].portOpened&&("no"===(o=(o=o.replace("\\r","\r")).replace("\\n","\n"))&&(o=""),t)&&u.sendCommand({obj:"Serial",func:"sendString",args:[e,t,o]})},p.write=function(t,o=0){var r=p.portsOperator[t],i=r["dom"];if(r.portOpened){var{sendId:r,sendWithId:i,sendTypeId:l,chartSendId:a}=i.id,r=$("#"+r),a=$("#"+a);let e="";(o?(e=a.val(),a):(e=r.val(),r)).val("");o=$("#"+i+" option:selected").val();0==$("#"+l)[0].checked?p.writeByteArr(t,e,o):p.writeString(t,e,o)}},p.writeCtrlC=function(e){p.portsOperator[e].portOpened&&u.sendCommand({obj:"Serial",func:"sendCtrlC",args:[e]})},p.writeCtrlD=function(e){p.portsOperator[e].portOpened&&u.sendCommand({obj:"Serial",func:"sendCtrlD",args:[e]})},p.clearContent=function(e){p.receiveBoxSetValue(e,"");e=p.portsOperator[e];e&&(e.output=[])},p.updateDtrAndRts=function(e){var t=p.portsOperator[e];t.portOpened&&(t=t["toolConfig"],u.sendCommand({obj:"Serial",func:"updateDtrAndRts",args:[e,t.dtr,t.rts]}))},p.reset=async function(e){var t=p.UPLOAD_RESET;"object"==typeof t&&u.sendCommand({obj:"Serial",func:"reset",args:[e,t]})},p.setDtrAndRts=function(e,t,o){p.portsOperator[e].portOpened&&u.sendCommand({obj:"Serial",func:"updateDtrAndRts",args:[e,t,o]})},p.setBaudRate=(e,t)=>{p.portsOperator[e].portOpened&&u.sendCommand({obj:"Serial",func:"onClickSelectBaud",args:[e,t]})}}),goog.loadJs("electron",()=>{goog.require("layui"),goog.require("Mixly.Env"),goog.require("Mixly.Config"),goog.require("Mixly.Modules"),goog.require("Mixly.MFile"),goog.require("Mixly.Title"),goog.require("Mixly.XML"),goog.require("Mixly.Example"),goog.require("Mixly.Electron.BU"),goog.require("Mixly.Electron.File"),goog.provide("Mixly.Electron.ExampleExt");const{Env:l,Config:e,Modules:t,Example:o,Electron:r}=Mixly;var{}=layui;const i=r["File"],a=e["BOARD"],{fs:n,fs_extend:s,path:c,app:d}=t;function g(e,t){o.call(this,e,t),this.render()}g.prototype=Object.create(o.prototype),(g.constructor=g).prototype.getExampleList=function(){var e=[];let t;t=a.thirdPartyBoard?c.resolve(l.indexDirPath,"examples"):c.resolve(d.getAppPath(),"src/sample",a.boardType);this.getExamplesByPath(t,".mix").length&&e.push({id:t,title:a.boardType,children:[]});var o,r=c.resolve(l.indexDirPath,"libraries/ThirdParty");if(s.isdir(r))for(o of n.readdirSync(r)){var i=c.resolve(r,o);s.isfile(i)||(i=c.resolve(i,"examples"),s.isfile(i))||this.getExamplesByPath(i,".mix").length&&e.push({id:i,title:o,children:[]})}return e},g.prototype.getExamples=function(e){return this.getExamplesByPath(e,".mix")},g.prototype.dataToWorkspace=function(e){var t;s.isfile(e)&&(t=n.readFileSync(e,"utf8"),e=c.extname(e),this.updateCode(e,t),i.openedFilePath=null)},g.prototype.getExamplesByPath=function(e,t){var o,r=[];if(s.isdir(e))for(o of n.readdirSync(e)){var i=c.resolve(e,o);s.isdir(i)?r.push({title:o,id:i,children:[]}):c.extname(o)===t&&r.push({title:o,id:i})}return r},Object.defineProperty(Mixly.Electron,"ExampleExt",{value:g,writable:!0,enumerable:!0,configurable:!0})}),goog.loadJs("web",()=>{goog.require("layui"),goog.require("Mixly.Modules"),goog.require("Mixly.Env"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Config"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.Title"),goog.require("Mixly.Boards"),goog.require("Mixly.MFile"),goog.require("Mixly.MArray"),goog.require("Mixly.Msg"),goog.require("Mixly.WebSocket.Socket"),goog.require("Mixly.WebSocket.Serial"),goog.provide("Mixly.WebSocket.ArduShell");const{LayerExt:t,StatusBar:a,StatusBarPort:o,Boards:i,MFile:l,Msg:n,Config:e}=Mixly;var{}=e;const{Socket:s,ArduShell:c,Serial:d}=Mixly.WebSocket;c.initCompile=()=>{s.connect(e=>{layer.closeAll()},()=>{c.compile()})},c.compile=()=>{o.tabChange("output"),c.compiling=!0,c.uploading=!1;const r=i.getSelectedBoardCommandParam(),e=(a.show(1),layer.open({type:1,title:n.Lang["编译中"]+"...",content:$("#mixly-loader-div"),shade:t.SHADE_NAV,resize:!1,closeBtn:0,success:(e,t)=>{$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),layer.title(n.Lang["编译终止中"]+"...",t),c.cancel()}),a.setValue(n.Lang["编译中"]+"...\n");var o=l.getCode();s.sendCommand({obj:"ArduShell",func:"compile",args:[t,r,o]})},end:()=>{$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+e).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}}))},c.initUpload=()=>{s.connect(e=>{layer.closeAll()},()=>{c.compiling=!1,c.uploading=!0;var e=i.getSelectedBoardCommandParam(),t=i.getSelectedBoardConfigParam("upload_method");let o=d.getSelectedPortName();switch(t){case"STLinkMethod":case"jlinkMethod":case"usb":o="None"}o?c.upload(e,o):layer.msg(n.Lang["无可用设备"]+"!",{time:1e3})})},c.upload=(r,i)=>{o.tabChange("output");const e=layer.open({type:1,title:n.Lang["上传中"]+"...",content:$("#mixly-loader-div"),shade:t.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),layer.title(n.Lang["上传终止中"]+"...",t),c.cancel()}),a.show(1),a.setValue(n.Lang["上传中"]+"...\n");var o=l.getCode();s.sendCommand({obj:"ArduShell",func:"upload",args:[t,r,i,o]})},end:function(){$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+e).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}})},c.operateSuccess=(e,t,o,r,i)=>{layer.close(t);t=a.getValue();let l="";t.lastIndexOf("\n")!==t.length-1&&(l="\n"),a.addValue(l);t="compile"===e?n.Lang["编译成功"]:n.Lang["上传成功"];a.addValue("=="+t+"("+n.Lang["用时"]+" "+i+")==\n"),layer.msg(t+"！",{time:1e3}),"upload"===e&&o&&d.connect(o,+r),c.compiling=!1,c.uploading=!1},c.operateOnError=(e,t,o)=>{a.addValue(o)},c.operateEndError=(e,t,o)=>{layer.close(t);t=a.getValue();let r="";t.lastIndexOf("\n")!==t.length-1&&(r="\n"),a.addValue(r),o&&a.addValue(o+"\n");t="compile"===e?n.Lang["编译失败"]:n.Lang["上传失败"];a.addValue("=="+t+"==\n"),c.compiling=!1,c.uploading=!1},c.cancel=function(){s.sendCommand({obj:"ArduShell",func:"cancel",args:[]})}}),goog.loadJs("web",()=>{goog.require("layui"),goog.require("Mixly.Config"),goog.require("Mixly.StatusBar"),goog.require("Mixly.StatusBarPort"),goog.require("Mixly.LayerExt"),goog.require("Mixly.Env"),goog.require("Mixly.Boards"),goog.require("Mixly.MFile"),goog.require("Mixly.MString"),goog.require("Mixly.Msg"),goog.require("Mixly.WebSocket.Serial"),goog.require("Mixly.WebSocket.Socket"),goog.provide("Mixly.WebSocket.BU");const{Config:e,StatusBar:n,StatusBarPort:s,LayerExt:d,Env:g,MFile:c,MString:u,Msg:p}=Mixly,{BU:A,Serial:h,Socket:y}=Mixly.WebSocket,{BOARD:m,SELECTED_BOARD:f}=e,b=layui["form"];A.uploading=!1,A.burning=!1,A.shell=null,A.checkNumOfDisks=function(o,e,r){let t=e,i=(t=(t=t.replace(/\s+/g,"")).replace("DeviceID","")).split(":"),l="win32"===g.currentPlatform?":":"";if(e.indexOf(":")!=e.lastIndexOf(":")){var e=layui.form,a=$("#mixly-selector-type"),n=$("#mixly-selector-type option:selected").val();a.empty();for(let e=0;e<i.length;e++)i[e]&&(n==i[e]+l?a.append('<option value="'+i[e]+l+'" selected>'+i[e]+l+"</option>"):a.append('<option value="'+i[e]+l+'">'+i[e]+l+"</option>"));e.render();let t=!1;const s=layer.open({type:1,id:"serial-select",title:p.Lang["检测到多个同类型设备，请选择："],area:["350px","150px"],content:$("#mixly-selector-div"),shade:d.SHADE_ALL,resize:!1,closeBtn:0,success:function(e){$("#serial-select").css("height","195px"),$(".layui-layer-page").css("z-index","198910151"),$("#mixly-selector-btn1").off("click").click(()=>{layer.close(s),A.cancel()}),$("#mixly-selector-btn2").off("click").click(()=>{layer.close(s),t=!0})},end:function(){$("#mixly-selector-div").css("display","none"),$("#layui-layer-shade"+s).remove(),t&&A.initWithDropdownBox(o,r),$("#mixly-selector-btn1").off("click"),$("#mixly-selector-btn2").off("click")}})}else{const c=layer.open({type:1,title:("burn"===o?p.Lang["烧录中"]:p.Lang["上传中"])+"...",content:$("#mixly-loader-div"),shade:d.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){A.copyFiles(o,t,r,i[0]+l+"/"),$("#mixly-loader-btn").off("click").click(()=>{layer.close(t),A.cancel()})},end:function(){$("#mixly-selector-div").css("display","none"),$("#layui-layer-shade"+c).remove(),$("#mixly-loader-btn").off("click")}})}},A.copyFiles=(e,t,o,r)=>{var i=c.getCode(),{copyLib:l=!1,libPath:a=[]}=f.upload;y.sendCommand({obj:"BU",func:"copyFiles",args:[e,t,o,r,i,l,a]})},A.operateSuccess=(e,t,o)=>{layer.close(t);var t="burn"===e?p.Lang["烧录成功"]:p.Lang["上传成功"],r=(layer.msg(t+"!",{time:1e3}),n.getValue());let i="";r.lastIndexOf("\n")!==r.length-1&&(i="\n"),n.addValue(i+`==${t}==
`),"upload"!==e||1!==h.uploadPorts.length&&!o||h.connect(o??h.uploadPorts[0].name,null),A.burning=!1,A.uploading=!1},A.operateError=(e,t,o)=>{layer.close(t);t=n.getValue();let r="";t.lastIndexOf("\n")!==t.length-1&&(r="\n"),n.addValue(r+o+"\n"),console.log(o),A.burning=!1,A.uploading=!1},A.noDevice=()=>{layer.msg(p.Lang["无可用设备"]+"!",{time:1e3}),A.burning=!1,A.uploading=!1},A.initWithDropdownBox=function(r,i){const e=layer.open({type:1,title:("burn"===r?p.Lang["烧录中"]:p.Lang["上传中"])+"...",content:$("#mixly-loader-div"),shade:d.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),$("#mixly-loader-btn").off("click").click(()=>{layer.close(t),A.cancel()});var o=$("#mixly-selector-type option:selected").val();A.copyFiles(r,t,i,o)},end:function(){$("#mixly-loader-div").css("display","none"),$("#layui-layer-shade"+e).remove()}})},A.cancel=function(){y.sendCommand({obj:"BU",func:"cancel",args:[]}),A.uploading?(A.uploading=!1,layer.msg(p.Lang["已取消上传"],{time:1e3})):A.burning&&(A.burning=!1,layer.msg(p.Lang["已取消烧录"],{time:1e3}))},A.initBurn=function(){y.connect(e=>{layer.closeAll()},()=>{var e,t;A.burning||(e=f["burn"],n.setValue(""),s.tabChange("output"),n.show(1),A.burning=!0,A.uploading=!1,"volume"===e.type?y.sendCommand({obj:"BU",func:"getDisksWithVolumesName",args:["burn",e.volume,e.filePath]}):(t=h.getSelectedPortName(),A.burnWithPort(t,e.command)))})},A.initUpload=function(){y.connect(e=>{layer.closeAll()},()=>{var e,t;A.uploading||(e=f["upload"],n.setValue(""),s.tabChange("output"),n.show(1),A.burning=!1,A.uploading=!0,"volume"===e.type?y.sendCommand({obj:"BU",func:"getDisksWithVolumesName",args:["upload",e.volume,e.filePath]}):(t=h.getSelectedPortName(),A.uploadWithPort(t,e.command)))})},A.burnByCmd=function(e,t,o){o=u.tpl(o,{com:t});y.sendCommand({obj:"BU",func:"burnByCmd",args:[e,t,o]})},A.uploadByCmd=function(e,t,o){var o=u.tpl(o,{com:t}),r=f["upload"],{filePath:r,copyLib:i=!1,libPath:l=[]}=r,a=c.getCode();n.addValue(p.Lang["上传中"]+"...\n"),y.sendCommand({obj:"BU",func:"uploadByCmd",args:[e,t,o,a,r,i,l]})},A.burnWithSpecialBin=()=>{const t=$("#mixly-selector-type");let o=$("#mixly-selector-type option:selected").val();t.empty();var r=m.burn.special;let i={};for(let e=0;e<r.length;e++)i[r[e].name]=r[e].command;r.map(e=>{(e?.name||e?.command)&&(""+e.name==o?t.append($(`<option value="${e.name}" selected>${e.name}</option>`)):t.append($(`<option value="${e.name}">${e.name}</option>`)))}),b.render();let l=!1;const a=layer.open({type:1,id:"serial-select",title:"请选择固件：",area:["350px","150px"],content:$("#mixly-selector-div"),shade:Mixly.LayerExt.SHADE_ALL,resize:!1,closeBtn:0,success:function(e){$("#serial-select").css("height","180px"),$("#serial-select").css("overflow","inherit"),$(".layui-layer-page").css("z-index","198910151"),$("#mixly-selector-btn1").off("click").click(()=>{layer.close(a)}),$("#mixly-selector-btn2").click(()=>{layer.close(a),l=!0})},end:function(){if($("#mixly-selector-btn1").off("click"),$("#mixly-selector-btn2").off("click"),$("#mixly-selector-div").css("display","none"),$(".layui-layer-shade").remove(),l){var o=$("#mixly-selector-type option:selected").val();try{i[o]=i[o].replace(/\\/g,"/")}catch(e){console.log(e)}var r=["esptool","kflash","stm32loader","stm32bl"];let t="{path}/mixpyBuild/win_python3/Lib/site-packages/";"darwin"!=g.currentPlatform&&"linux"!=g.currentPlatform||(t="{path}/pyTools/");for(let e=0;e<r.length;e++)-1!=i[o].indexOf('"')?i[o]=replaceWithReg(i[o],g.python3Path+'" "'+t+r[e]+".py",r[e]):i[o]=replaceWithReg(i[o],g.python3Path+" "+t+r[e]+".py",r[e]);i[o]=replaceWithReg(i[o],g.clientPath,"path"),i[o]=replaceWithReg(i[o],g.indexDirPath,"indexPath"),n.setValue(""),s.tabChange("output"),n.show(1),A.burning=!0,A.uploading=!1;var e=h.getSelectedPortName();A.burnWithPort(e,i[o])}else layer.msg(p.Lang["已取消烧录"],{time:1e3})}})},A.operateWithPort=(o,r,i)=>{if(r){const e=("burn"===o?p.Lang["烧录中"]:p.Lang["上传中"])+"...";{const t=layer.open({type:1,title:e,content:$("#mixly-loader-div"),shade:d.SHADE_NAV,resize:!1,closeBtn:0,success:function(e,t){$(".layui-layer-page").css("z-index","198910151"),"burn"===o?A.burnByCmd(t,r,i):A.uploadByCmd(t,r,i),$("#mixly-loader-btn").off("click").click(()=>{$("#mixly-loader-btn").css("display","none"),"burn"===o?layer.title(p.Lang["烧录终止中"]+"...",t):layer.title(p.Lang["上传终止中"]+"...",t),A.cancel(o)})},end:function(){$("#mixly-loader-div").css("display","none"),$("layui-layer-shade"+t).remove(),$("#mixly-loader-btn").off("click"),$("#mixly-loader-btn").css("display","inline-block")}})}}else layer.msg(p.Lang["无可用设备"]+"!",{time:1e3}),A.burning=!1,A.uploading=!1},A.burnWithPort=(e,t)=>{A.operateWithPort("burn",e,t)},A.uploadWithPort=(e,t)=>{A.operateWithPort("upload",e,t)}}),goog.loadJs("common",()=>{goog.require("Mixly.Url"),goog.require("Mixly.Config"),goog.require("Mixly.NavEvents"),goog.require("Mixly.StatusBar"),goog.require("Mixly.XML"),goog.require("Mixly.Nav"),goog.require("Mixly.Env"),goog.require("Mixly.Boards"),goog.require("Mixly.Modules"),goog.require("Mixly.ToolboxSearcher"),goog.require("Mixly.Drag"),goog.require("Mixly.Editor"),goog.require("Mixly.LevelSelector"),goog.require("WorkspaceSearch"),goog.require("Backpack"),goog.require("ContentHighlight"),goog.require("ZoomToFitControl"),goog.require("Mixly.Electron.LibManager"),goog.require("Mixly.Electron.WikiManager"),goog.require("Mixly.Electron.ExampleExt"),goog.require("Mixly.Electron.Serial"),goog.require("Mixly.WebSocket.Socket"),goog.require("Mixly.Web.ExampleExt"),goog.require("Mixly.Electron.Loader"),goog.provide("Mixly.Interface");const{Url:o,Config:r,NavEvents:l,StatusBar:a,XML:n,Nav:s,Boards:c,Modules:i,Interface:d,Env:g,ToolboxSearcher:u,Drag:p,Editor:A,LevelSelector:h}=Mixly,{BOARD:y,USER:m}=r;d.init=()=>{$("body").append(n.TEMPLATE_DOM.APP_DIV);var e=(g.isElectron?Mixly.Electron:Mixly.Web)["ExampleExt"],e=(e instanceof Object&&(e.obj=new e("mixly-footer","mixly-examples")),s.init(),Code.init(),c.init(),g.isElectron?(e=Mixly["Electron"],{LibManager:e=void 0,WikiManager:t=void 0,Serial:r=void 0}=e,"object"==typeof e&&e.init(),"object"==typeof t&&s.CONFIG.setting.wiki&&t.registerContextMenu(),"object"!=typeof r||s.CONFIG.run||s.CONFIG.webrun||r.addBtnToStatusBar()):g.defaultXML=$("#toolbox").html(),c.getSelectedBoardName());if(c.changeTo(e),c.updateCategories(e),A.init(),window.addEventListener("resize",d.onresize,!1),d.onresize(),p.init(),y.nav.levelSelector){h.init();const i=$(".loading");var t=$(".blocklyToolboxDiv").width();i.children(".left-div").animate({width:t+"px"},()=>{i.fadeOut("fast",()=>{i.remove()})}),h.xmlToWorkspace(1)}else auto_save_and_restore_blocks();l.init(),a.init(),new ZoomToFitControl(A.blockEditor).init(),u.init();const o=new WorkspaceSearch(A.blockEditor);o.init();new Backpack(A.blockEditor).init(),"yes"===m.blocklyContentHighlight&&new ContentHighlight(A.blockEditor).init();var r={displayText:Blockly.Msg.WORKSPACE_SEARCH_OPEN,preconditionFn:function(e){return A.blockEditor.getAllBlocks().length?"enabled":"hidden"},callback:function(){o.open()},scopeType:Blockly.ContextMenuRegistry.ScopeType.WORKSPACE,id:"workspaceSearch_open",weight:200};Blockly.ContextMenuRegistry.registry.register(r),g.hasSocketServer&&(e=Mixly.WebSocket["Socket"],e.init())},d.onresize=e=>{var t=$("#nav"),o=$("#nav-left-btn-list"),r=$("#nav-right-btn-list"),i=$("#li_operate");if(r.offset().left<s.leftWidth+70||t[0].scrollWidth>t[0].offsetWidth){for(let e=0;e<s.navItemId.length;e++)$("#"+s.navItemId[e]).css("display","none");i.css("display","inline-block");t=o.offset().left+o.width();r.offset().left-t<70?$("#copyright").css("display","none"):$("#copyright").css("display","-webkit-box")}else{$("#copyright").css("display","-webkit-box"),i.css("display","none");for(let e=0;e<s.navItemId.length;e++)$("#"+s.navItemId[e]).css("display","inline-block");s.leftWidth=o.offset().left+o.width()}A.codeEditor.resize(),A.blockEditor.resize()},window.addEventListener("load",()=>{}),window.addEventListener("DOMContentLoaded",()=>{d.init()}),d.onbeforeunload=(e=!1)=>{var t=r.pathPrefix+"/index.html?"+o.jsonToUrl({boardType:y.boardType});t=t,e?window.location.reload(!0):window.location.replace(t)},d.feedback=()=>{var e,t="https://gitee.com/mixly2/mixly2.0_src/issues";g.isElectron?(e=i["electron"],e=e["shell"],e.openExternal(t)):window.open(t,"_blank")}});